"use strict";var __awaiter=this&&this.__awaiter||function(e,u,c,i){return new(c=c||Promise)(function(t,r){function n(e){try{s(i.next(e))}catch(e){r(e)}}function o(e){try{s(i.throw(e))}catch(e){r(e)}}function s(e){var r;e.done?t(e.value):((r=e.value)instanceof c?r:new c(function(e){e(r)})).then(n,o)}s((i=i.apply(e,u||[])).next())})},__generator=this&&this.__generator||function(t,n){var o,s,u,c={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]},e={next:r(0),throw:r(1),return:r(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function r(r){return function(e){return function(r){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,s&&(u=2&r[0]?s.return:r[0]?s.throw||((u=s.return)&&u.call(s),0):s.next)&&!(u=u.call(s,r[1])).done)return u;switch(s=0,(r=u?[2&r[0],u.value]:r)[0]){case 0:case 1:u=r;break;case 4:return c.label++,{value:r[1],done:!1};case 5:c.label++,s=r[1],r=[0];continue;case 7:r=c.ops.pop(),c.trys.pop();continue;default:if(!(u=0<(u=c.trys).length&&u[u.length-1])&&(6===r[0]||2===r[0])){c=0;continue}if(3===r[0]&&(!u||r[1]>u[0]&&r[1]<u[3])){c.label=r[1];break}if(6===r[0]&&c.label<u[1]){c.label=u[1],u=r;break}if(u&&c.label<u[2]){c.label=u[2],c.ops.push(r);break}u[2]&&c.ops.pop(),c.trys.pop();continue}r=n.call(t,c)}catch(e){r=[6,e],s=0}finally{o=u=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,e])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkUrl=void 0;var url=require("url"),cross_fetch_1=require("cross-fetch");require("../../global");var rest_common_1=require("../rest-common"),utils_1=require("../utils");function checkUrl(o,s){return __awaiter(this,void 0,void 0,function(){var r,t,n;return __generator(this,function(e){switch(e.label){case 0:return r=new rest_common_1.APIResult,n=o.request.body||{},[4,utils_1.checkToken(null==n?void 0:n.token)];case 1:return e.sent()?[3,3]:(r.setError(rest_common_1.COMMON_ERRORS.invalidCookie),responseResult(o,r),[4,s()]);case 2:return e.sent(),[2];case 3:return(t=!!n.url&&isUrlSecurity(n.url),n.url&&t)?[3,5]:(setAPIResultError(r,rest_common_1.COMMON_ERRORS.invalidParam),responseResult(o,r),[4,s()]);case 4:return e.sent(),[2];case 5:return[4,fetchUrlInfo(n.url).catch(function(e){})];case 6:return(n=e.sent())?(r.success=!0,r.data=n):setAPIResultError(r,rest_common_1.COMMON_ERRORS.fetchUrlError),responseResult(o,r),[4,s()];case 7:return e.sent(),[2]}})})}function fetchUrlInfo(n){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t={url:n},process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",[4,cross_fetch_1.default(n,{method:"HEAD"}).catch(function(e){})];case 1:return(r=e.sent())?(t.status=r.status,t.statusText=r.statusText,400<=r.status||(t.headers={},r.headers&&r.headers.forEach(function(e,r){t.headers[r]=e})),[2,Promise.resolve(t)]):[2,Promise.resolve(null)]}})})}function setAPIResultError(e,r){e.success=!1,e.error=r}function responseResult(e,r){e.type="json",e.body=JSON.stringify(r)}function isUrlSecurity(e){if(!e)return!1;try{var r=url.parse(e),t=null==r?void 0:r.protocol,n=null==r?void 0:r.hostname,o="https:"!==t?!1:!0;return 0==n.indexOf("localhost")&&(o=!1),o=0==n.indexOf("127")||"169.254.169.254"==n||-1<e.indexOf("::1")?!1:o}catch(e){return!1}}exports.checkUrl=checkUrl;