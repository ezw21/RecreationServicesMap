"use strict";var __awaiter=this&&this.__awaiter||function(e,a,o,c){return new(o=o||Promise)(function(r,t){function n(e){try{s(c.next(e))}catch(e){t(e)}}function i(e){try{s(c.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?r(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(n,i)}s((c=c.apply(e,a||[])).next())})},__generator=this&&this.__generator||function(r,n){var i,s,a,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,s&&(a=2&t[0]?s.return:t[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,t[1])).done)return a;switch(s=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,s=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(a=0<(a=o.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){o.label=t[1];break}if(6===t[0]&&o.label<a[1]){o.label=a[1],a=t;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(t);break}a[2]&&o.ops.pop(),o.trys.pop();continue}t=n.call(r,o)}catch(e){t=[6,e],s=0}finally{i=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.download=void 0;var path=require("path"),fs=require("fs-extra"),AdmZip=require("adm-zip"),fetch=require("cross-fetch");require("isomorphic-form-data"),require("../../../global");var i18n_utils_1=require("../../../i18n-utils"),utils_1=require("../../utils");function download(j,v){return __awaiter(this,void 0,void 0,function(){var t,r,n,i,s,a,o,c,u,p,l,f,h,d;return __generator(this,function(e){switch(e.label){case 0:return s=j.params.appId,i=path.join(__dirname,"../../../.."),t=j.query.locale||"en",r=path.join(i,"../client/dist"),n=path.join(i,"temp"),i=path.join(i,"public/apps",s),s=path.join(n,s),[4,utils_1.checkToken(j.query.token)];case 1:if(!e.sent())return j.body="Please log in.",[2];e.label=2;case 2:return e.trys.push([2,14,,15]),c=(o=JSON).parse,[4,fs.readFile(path.join(i,"config.json"),"utf-8")];case 3:return a=c.apply(o,[e.sent()]),p=(u=JSON).parse,[4,fs.readFile(path.join(i,"info.json"),"utf-8")];case 4:return(h=p.apply(u,[e.sent()]),!0!==a.__not_publish)?[3,6]:(l=j,[4,i18n_utils_1.getMessage("notPublished",t)]);case 5:return l.body=e.sent(),[2];case 6:return[4,fs.pathExists(s)];case 7:return e.sent()?[4,fs.remove(s)]:[3,9];case 8:e.sent(),e.label=9;case 9:return[4,fs.ensureDir(s)];case 10:return e.sent(),[4,copyAppCode(r,s,a,h.title)];case 11:return e.sent(),a.attributes.clientId="",a.attributes.title=h.title,a.attributes.description=h.snippet,f=path.join(s,cdnString),[4,fs.writeFile(path.join(f,"config.json"),JSON.stringify(a,null,2),"utf-8")];case 12:return e.sent(),[4,fs.copy(path.join(i,"resources"),path.join(f,"resources"))];case 13:return e.sent(),(d=new AdmZip).addLocalFolder(s),h=encodeURI(h.title),j.response.set("Content-disposition","attachment; filename="+h+".zip"),j.body=d.toBuffer(),[3,15];case 14:return d=e.sent(),console.error(d),[3,15];case 15:return[4,v()];case 16:return e.sent(),[2]}})})}global.fetch=fetch,exports.download=download;var cdnString="cdn/0";function copyAppCode(i,s,a,o){return __awaiter(this,void 0,void 0,function(){var r,t,n=this;return __generator(this,function(e){switch(e.label){case 0:return[4,fs.copy(path.join(i,"experience/index.html"),path.join(s,"index.html"))];case 1:return e.sent(),[4,fs.copy(path.join(i,"experience/web.config"),path.join(s,"web.config"))];case 2:return e.sent(),[4,fixIndexFile(path.join(s,"index.html"),o)];case 3:return e.sent(),fs.existsSync(path.join(i,"service-worker.prod.js"))?[4,fs.copy(path.join(i,"service-worker.prod.js"),path.join(s,"service-worker.js"))]:[3,5];case 4:return e.sent(),[3,7];case 5:return[4,fs.copy(path.join(i,"service-worker.js"),path.join(s,"service-worker.js"))];case 6:e.sent(),e.label=7;case 7:return r=path.join(s,cdnString),[4,fs.copy(path.join(i,"experience/index.js"),path.join(r,"index.js"))];case 8:return e.sent(),[4,fs.copy(path.join(i,"experience/assets"),path.join(r,"assets"))];case 9:return e.sent(),[4,fs.copy(path.join(i,"service-worker-registration.js"),path.join(r,"service-worker-registration.js"))];case 10:return e.sent(),[4,fixServiceWorkerFile(path.join(r,"service-worker-registration.js"))];case 11:return e.sent(),[4,fs.copy(path.join(i,"jimu-core"),path.join(r,"jimu-core"))];case 12:return e.sent(),[4,fs.copy(path.join(i,"jimu-ui"),path.join(r,"jimu-ui"))];case 13:return e.sent(),[4,fs.copy(path.join(i,"jimu-layouts"),path.join(r,"jimu-layouts"))];case 14:return e.sent(),[4,fs.copy(path.join(i,"jimu-arcgis"),path.join(r,"jimu-arcgis"))];case 15:return e.sent(),[4,fs.copy(path.join(i,a.theme),path.join(r,a.theme))];case 16:return e.sent(),[4,fs.pathExists(path.join(i,"arcgis-charts"))];case 17:return e.sent()?[4,fs.copy(path.join(i,"arcgis-charts"),path.join(r,"arcgis-charts"))]:[3,19];case 18:e.sent(),e.label=19;case 19:return t=[],a.widgets&&Object.keys(a.widgets).forEach(function(e){e=a.widgets[e];t.indexOf(e.uri)<0&&t.push(e.uri)}),[4,Promise.all(t.map(function(t){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(e){return[2,fs.copy(path.join(i,t),path.join(r,t))]})})}))];case 20:return e.sent(),[2]}})})}function fixIndexFile(r,n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,fs.readFile(r,"utf-8")];case 1:return t=(t=e.sent()).replace(/<base.*\/>/,'<base href="./'+cdnString+'/"/>').replace("var mountPath = '/';","var mountPath = getPath();").replace("var isOutOfExb = false;","var isOutOfExb = true;").replace("var isDevEdition = true;","var isDevEdition = false;").replace("var useStructuralUrl = true;","var useStructuralUrl = false;").replace(/var\sbuildNumber.+;/,"var buildNumber = '0';").replace("var appFolderName = 'experience';","var appFolderName = '.';").replace('<script src="../service-worker-registration.js"><\/script>','<script src="./service-worker-registration.js"><\/script>').replace('<script src="../jimu-core/init.js"><\/script>','<script src="./jimu-core/init.js"><\/script>').replace("<title>Experience</title>","<title>"+n+"</title>"),[4,fs.writeFile(r,t,"utf-8")];case 2:return e.sent(),[2]}})})}function fixServiceWorkerFile(r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,fs.readFile(r,"utf-8")];case 1:return t=(t=e.sent()).replace("register('/service-worker.js')","register('../../service-worker.js')"),[4,fs.writeFile(r,t,"utf-8")];case 2:return e.sent(),[2]}})})}