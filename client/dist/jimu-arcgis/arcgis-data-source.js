System.register(["jimu-core","jimu-core/data-source"],(function(e){var t,r;return{setters:[function(e){t=e},function(e){r=e}],execute:function(){e(function(e){var t={};function r(a){if(t[a])return t[a].exports;var o=t[a]={i:a,l:!1,exports:{}};return e[a].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(a,o,function(t){return e[t]}.bind(null,o));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=4)}([function(e,r){e.exports=t},function(e,t,r){"use strict";var a,o;r.d(t,"b",(function(){return a})),r.d(t,"c",(function(){return o})),r.d(t,"a",(function(){return a})),function(e){e.Map="MAP",e.WebMap="WEB_MAP",e.WebScene="WEB_SCENE"}(a||(a={})),function(e){e.BaseDynamicLayer="base-dynamic",e.BaseElevationLayer="base-elevation",e.BaseTileLayer="base-tile",e.BuildingSceneLayer="building-scene",e.CSVLayer="csv",e.ElevationLayer="elevation",e.FeatureLayer="feature",e.GeoJSONLayer="geojson",e.GeoRSSLayer="geo-rss",e.GraphicsLayer="graphics",e.GroupLayer="group",e.ImageryLayer="imagery",e.IntegratedMeshLayer="integrated-mesh",e.KMLLayer="kml",e.MapImageLayer="map-image",e.MapNotesLayer="map-notes",e.PointCloudLayer="point-cloud",e.SceneLayer="scene",e.TileLayer="tile",e.UnknownLayer="unknown",e.UnsupportedLayer="unsupported",e.VectorTileLayer="vector-tile",e.WMSLayer="wms",e.WMTSLayer="wmts",e.WebTileLayer="web-tile"}(o||(o={}))},function(e,t){e.exports=r},,function(e,t,r){"use strict";r.r(t),r.d(t,"ArcGISDataSourceFactory",(function(){return h})),r.d(t,"MapDataSourceImpl",(function(){return n})),r.d(t,"WebMapDataSourceImpl",(function(){return c})),r.d(t,"WebSceneDataSourceImpl",(function(){return d})),r.d(t,"DataSourceTypes",(function(){return a.b})),r.d(t,"LayerTypes",(function(){return a.c})),r.d(t,"ArcGISDataSourceTypes",(function(){return a.a}));var a=r(1),o=r(2),i=r(0),s=function(e,t,r,a){return new(r||(r=Promise))((function(o,i){function s(e){try{u(a.next(e))}catch(e){i(e)}}function n(e){try{u(a.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((a=a.apply(e,t||[])).next())}))};class n extends o.AbstractSetDataSource{constructor(e){super(e),this.type=a.b.Map,this.map=e.map}ready(){return s(this,void 0,void 0,(function*(){return yield Object(i.loadArcGISJSAPIModules)(["esri/Map","esri/layers/FeatureLayer"]).then(e=>s(this,void 0,void 0,(function*(){return[this.Map,this.FeatureLayer]=e,this.map||this.createMap(),yield this.createChildDataSources()})))}))}fetchSchema(){var e,t;return s(this,void 0,void 0,(function*(){const r=this.getChildDataSources();let a=Object(i.Immutable)({childSchemas:{},label:null===(t=null===(e=this.map)||void 0===e?void 0:e.portalItem)||void 0===t?void 0:t.title});return r.forEach((e,t)=>{const r=e.getFetchedSchema();a=a.setIn(["childSchemas",e.jimuChildId],r)}),Promise.resolve(a)}))}getDataSourceByLayer(e,t){return"number"==typeof e&&(e=""+e),e?this.deepSearchDataSourceByLayer(this,e,t):null}getDataSourcesByType(e){if(!e)return[];const t=[];return this.traverseToGetDataSourcesByType(e,this,t),t}createChildDataSources(){return s(this,void 0,void 0,(function*(){const e=[],t=[];return i.dataSourceUtils.getWhetherUseProxy()&&this.map.allLayers.toArray().forEach(e=>{const t=i.dataSourceUtils.getUrlByLayer(e);if(!t)return;const r=i.dataSourceUtils.getDataSourceProxyUrl(t);r&&(e.url=r)}),this.map.layers.toArray().forEach(r=>{const a=i.dataSourceUtils.getUrlByLayer(r),o=i.dataSourceUtils.getDataSourceSourceUrl(a),s=i.dataSourceUtils.getFixedLayerIdByLayer(r);t.push(this.getDataSourceConstructorOptions(s,o,this.getDataSourceJson(),r).then(t=>{t.forEach(t=>{e.push(this.dataSourceManager.createDataSource(t))})}))}),this.childDataSourcesPromise=Promise.allSettled(t).then(()=>s(this,void 0,void 0,(function*(){return yield Promise.allSettled(e).then(e=>s(this,void 0,void 0,(function*(){const t=[],r=e.filter(e=>"fulfilled"===e.status).map(e=>e.value);return r&&r.length>0&&r.forEach(e=>this.traverseToCreateLayerForDataSource(e,t)),Promise.allSettled(t.map(e=>s(this,void 0,void 0,(function*(){return yield e.load()})))).then(e=>r)})))}))),this.childDataSourcesPromise}))}deepSearchDataSourceByLayer(e,t,r){if(!e||!t)return null;if(this.isDataSourceWithLayer(e,t,r))return e;let a=null;const o=e.isDataSourceSet&&e.getChildDataSources();if(o)for(let e=0;e<o.length&&(a=this.deepSearchDataSourceByLayer(o[e],t,r),!a);e++);return a}traverseToGetDataSourcesByType(e,t,r){if(!e||!t||!r)return;t.type===e&&r.push(t);const a=t.isDataSourceSet&&t.getChildDataSources();a&&a.forEach(t=>{this.traverseToGetDataSourcesByType(e,t,r)})}traverseToCreateLayerForDataSource(e,t){if(!e)return;this.getWhetherNeedToCreateLayer(e)&&e.type===o.DataSourceTypes.FeatureLayer&&e.layer.url&&(e.layer=new this.FeatureLayer({id:e.layer.id,url:i.dataSourceUtils.getUrlByLayer(e.layer),renderer:e.layer.renderer,popupTemplate:e.layer.popupTemplate}),t.push(e.layer));const r=e.isDataSourceSet&&e.getChildDataSources();r&&r.forEach(e=>{this.traverseToCreateLayerForDataSource(e,t)})}getWhetherNeedToCreateLayer(e){return!!e&&(!e.layer||"esri.layers.support.Sublayer"===e.layer.declaredClass)}isDataSourceWithLayer(e,t,r){var a,i,s;if(""+(null===(i=null===(a=e)||void 0===a?void 0:a.layer)||void 0===i?void 0:i.id)==""+t){if(r){let t=null,a=null==e?void 0:e.parentDataSource;for(;a;){if(a.type===o.DataSourceTypes.MapService){t=a;break}a=a.parentDataSource}return r===(null===(s=null==t?void 0:t.layer)||void 0===s?void 0:s.id)}return!0}return!1}createMap(){this.map=new this.Map,this.getDataSourceJson().layers.forEach(e=>{this.map.layers.add(new this.FeatureLayer(e))})}getDataSourceConstructorOptions(e,t,r,a){return s(this,void 0,void 0,(function*(){if(!e)return yield Promise.resolve([]);const n=[],u=[],c=[];return this.getJimuChildId(e).forEach(e=>{var l;const d=this.getDataSourceJson().schema?this.getDataSourceJson().schema.childSchemas[e]:null,h=this.getChildDataSourceId(e),p=(null==r?void 0:r.childDataSourceJsons)&&r.childDataSourceJsons[e]?r.childDataSourceJsons[e]:null;let y,S=Object(i.Immutable)({id:h,type:o.DataSourceTypes.FeatureLayer});if(p&&(S=S.merge(p.asMutable({deep:!0}))),t&&(S=S.set("url",t.replace(/^http:/,"https:"))),d&&(S=S.set("schema",d)),a){if((null===(l=a.portalItem)||void 0===l?void 0:l.id)&&(S=S.set("portalUrl",a.portalItem.portal.url).set("itemId",a.portalItem.id)),a.type===i.SupportedLayerTypes.SceneLayer)u.push(a.load().then(()=>s(this,void 0,void 0,(function*(){return a.associatedLayer?yield Promise.resolve({id:S.id,dataSourceJson:S.set("type",o.DataSourceTypes.SceneLayer),layer:a,parentDataSource:this,jimuChildId:e}):yield Promise.reject(null)}))));else switch(a.type){case i.SupportedLayerTypes.FeatureLayer:c.push(a.load().then(()=>s(this,void 0,void 0,(function*(){var t,r;if("multipatch"===a.geometryType||"mesh"===a.geometryType){const e="Do not support feature layer which geometry type is multipatch or mesh.";return console.error(e,a),yield Promise.reject(e)}const o=`esriGeometry${null===(t=a.geometryType)||void 0===t?void 0:t.charAt(0).toUpperCase()}${null===(r=a.geometryType)||void 0===r?void 0:r.slice(1)}`;return yield Promise.resolve({id:S.id,dataSourceJson:S.set("geometryType",o),layer:a,parentDataSource:this,jimuChildId:e})}))));break;case i.SupportedLayerTypes.MapImageLayer:case i.SupportedLayerTypes.TileLayer:y={id:S.id,dataSourceJson:S.set("type",o.DataSourceTypes.MapService),layer:a,parentDataSource:this,jimuChildId:e};break;case i.SupportedLayerTypes.GroupLayer:y={id:S.id,dataSourceJson:S.set("type",o.DataSourceTypes.GroupLayer),layer:a,parentDataSource:this,jimuChildId:e}}y&&n.push(Promise.resolve(y))}else y={id:S.id,dataSourceJson:S,parentDataSource:this,jimuChildId:e},n.push(Promise.resolve(y))}),yield Promise.allSettled(n.concat(u).concat(c)).then(e=>e.filter(e=>"fulfilled"===e.status).map(e=>e.value))}))}}var u=function(e,t,r,a){return new(r||(r=Promise))((function(o,i){function s(e){try{u(a.next(e))}catch(e){i(e)}}function n(e){try{u(a.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((a=a.apply(e,t||[])).next())}))};class c extends n{constructor(){super(...arguments),this.type=a.b.WebMap}ready(){return u(this,void 0,void 0,(function*(){return yield Object(i.loadArcGISJSAPIModules)(["esri/WebMap","esri/portal/Portal","esri/portal/PortalItem","esri/layers/FeatureLayer"]).then(e=>u(this,void 0,void 0,(function*(){return[this.WebMap,this.Portal,this.PortalItem,this.FeatureLayer]=e,this.map||this.createMap(),yield this.createChildDataSources()})))}))}createMap(){if(this.getDataSourceJson().portalUrl){const e=new this.Portal({url:i.portalUrlUtils.getHostUrlByOrgUrl(this.getDataSourceJson().portalUrl)});this.map=new this.WebMap({portalItem:new this.PortalItem({id:this.getDataSourceJson().itemId,portal:e})})}else this.map=new this.WebMap({portalItem:new this.PortalItem({id:this.getDataSourceJson().itemId})});this.map.isFulfilled()||this.map.load()}createChildDataSources(){const e=Object.create(null,{createChildDataSources:{get:()=>super.createChildDataSources}});return u(this,void 0,void 0,(function*(){return this.childDataSourcesPromise=this.map.when(()=>u(this,void 0,void 0,(function*(){const t=this.map.tables?this.map.tables.toArray():[];i.dataSourceUtils.getWhetherUseProxy()&&t.forEach(e=>{const t=i.dataSourceUtils.getUrlByLayer(e);if(!t)return;const r=i.dataSourceUtils.getDataSourceProxyUrl(t);r&&(e.url=r)});const r=[],a=[];t.forEach(e=>{a.push(this.getDataSourceConstructorOptions(i.dataSourceUtils.getFixedLayerIdByLayer(e),i.dataSourceUtils.getDataSourceSourceUrl(i.dataSourceUtils.getUrlByLayer(e)),this.getDataSourceJson()).then(e=>{e.forEach(e=>{r.push(this.dataSourceManager.createDataSource(e))})}))});const o=e.createChildDataSources.call(this),s=Promise.allSettled(a).then(()=>u(this,void 0,void 0,(function*(){return yield Promise.allSettled(r).then(e=>e.filter(e=>"fulfilled"===e.status).map(e=>e.value))})));return Promise.all([o,s]).then(e=>e[0].concat(e[1]))}))),this.childDataSourcesPromise}))}}var l=function(e,t,r,a){return new(r||(r=Promise))((function(o,i){function s(e){try{u(a.next(e))}catch(e){i(e)}}function n(e){try{u(a.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((a=a.apply(e,t||[])).next())}))};class d extends n{constructor(){super(...arguments),this.type=a.b.WebScene}ready(){return l(this,void 0,void 0,(function*(){return yield Object(i.loadArcGISJSAPIModules)(["esri/WebScene","esri/portal/Portal","esri/portal/PortalItem","esri/layers/FeatureLayer"]).then(e=>l(this,void 0,void 0,(function*(){return[this.WebScene,this.Portal,this.PortalItem,this.FeatureLayer]=e,this.map||this.createMap(),yield this.createChildDataSources()})))}))}createMap(){if(this.getDataSourceJson().portalUrl){const e=new this.Portal({url:i.portalUrlUtils.getHostUrlByOrgUrl(this.getDataSourceJson().portalUrl)});this.map=new this.WebScene({portalItem:new this.PortalItem({id:this.getDataSourceJson().itemId,portal:e})})}else this.map=new this.WebScene({portalItem:new this.PortalItem({id:this.getDataSourceJson().itemId})});this.map.isFulfilled()||this.map.load()}createChildDataSources(){const e=Object.create(null,{createChildDataSources:{get:()=>super.createChildDataSources}});return l(this,void 0,void 0,(function*(){return this.childDataSourcesPromise=this.map.when(()=>l(this,void 0,void 0,(function*(){return yield e.createChildDataSources.call(this)})))}))}}class h{createDataSource(e){var t;const r=null!==(t=e.dataSourceJson)&&void 0!==t?t:e.belongToDataSource.getMainDataSource().getDataSourceJson(),o=e.dataViewId&&r.dataViews&&r.dataViews[e.dataViewId]&&r.dataViews[e.dataViewId].type||r.type;return o===a.b.Map?new n(e):o===a.b.WebMap?new c(e):o===a.b.WebScene?new d(e):void console.error("Unimplemented data source type.",o)}}t.default=h}]))}}}));