System.register(["jimu-core"],(function(e){var t;return{setters:[function(e){t=e}],execute:function(){e(function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=3)}([function(e,i){e.exports=t},function(e,t,i){"use strict";var r,s;i.d(t,"b",(function(){return r})),i.d(t,"c",(function(){return s})),i.d(t,"a",(function(){return r})),function(e){e.Map="MAP",e.WebMap="WEB_MAP",e.WebScene="WEB_SCENE"}(r||(r={})),function(e){e.BaseDynamicLayer="base-dynamic",e.BaseElevationLayer="base-elevation",e.BaseTileLayer="base-tile",e.BuildingSceneLayer="building-scene",e.CSVLayer="csv",e.ElevationLayer="elevation",e.FeatureLayer="feature",e.GeoJSONLayer="geojson",e.GeoRSSLayer="geo-rss",e.GraphicsLayer="graphics",e.GroupLayer="group",e.ImageryLayer="imagery",e.IntegratedMeshLayer="integrated-mesh",e.KMLLayer="kml",e.MapImageLayer="map-image",e.MapNotesLayer="map-notes",e.PointCloudLayer="point-cloud",e.SceneLayer="scene",e.TileLayer="tile",e.UnknownLayer="unknown",e.UnsupportedLayer="unsupported",e.VectorTileLayer="vector-tile",e.WMSLayer="wms",e.WMTSLayer="wmts",e.WebTileLayer="web-tile"}(s||(s={}))},,function(e,t,i){"use strict";i.r(t),i.d(t,"JimuLayerView",(function(){return R})),i.d(t,"JimuFeatureLayerView",(function(){return Y})),i.d(t,"JimuSceneLayerView",(function(){return B})),i.d(t,"ShowOnMapDataType",(function(){return H})),i.d(t,"SHOW_ON_MAP_DATA_ID_PREFIX",(function(){return q})),i.d(t,"JimuMapView",(function(){return _})),i.d(t,"JimuMapViewGroup",(function(){return N})),i.d(t,"MapViewManager",(function(){return $})),i.d(t,"DataSourceTypes",(function(){return E.b})),i.d(t,"LayerTypes",(function(){return E.c})),i.d(t,"ArcGISDataSourceTypes",(function(){return E.a})),i.d(t,"ArcGISDependencyDefineExtension",(function(){return K})),i.d(t,"ArcGISDataSourceFactoryUriExtension",(function(){return Z})),i.d(t,"loadArcGISJSAPIModules",(function(){return u})),i.d(t,"JimuMapViewComponent",(function(){return te})),i.d(t,"JimuLayerViewComponent",(function(){return re})),i.d(t,"init",(function(){return ae})),i.d(t,"geometryUtils",(function(){return r})),i.d(t,"zoomToUtils",(function(){return s})),i.d(t,"portalUtils",(function(){return a})),i.d(t,"defaultMessages",(function(){return O}));var r={};i.r(r),i.d(r,"projectToSpatialReference",(function(){return d}));var s={};i.r(s),i.d(s,"zoomTo",(function(){return y}));var a={};i.r(a),i.d(a,"checkDefaultBaseMapIsExist",(function(){return A})),i.d(a,"getDefaultWebMap",(function(){return C}));var n=i(0),o=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{u(r.next(e))}catch(e){a(e)}}function o(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}u((r=r.apply(e,t||[])).next())}))};function u(e){return o(this,void 0,void 0,(function*(){return yield Object(n.loadArcGISJSAPIModules)(e)}))}var l=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{u(r.next(e))}catch(e){a(e)}}function o(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}u((r=r.apply(e,t||[])).next())}))};function d(e,t){return l(this,void 0,void 0,(function*(){return e&&0!==e.length&&e[0]&&t.wkid!==e[0].spatialReference.wkid&&!t.equals(e[0].spatialReference)?yield u(["esri/tasks/GeometryService","esri/tasks/support/ProjectParameters","esri/geometry/projection"]).then(i=>l(this,void 0,void 0,(function*(){let r,s,a;if([r,s,a]=i,a.isSupported()){if(a.isLoaded()){const i=function(e,t,i){return i.project(e,t)}(e,t,a);return yield Promise.resolve(i)}return a.load(),yield c(e,t,r,s).then(e=>l(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})),e=>l(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject(e)})))}return yield c(e,t,r,s).then(e=>l(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})),e=>l(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject(e)})))}))):yield Promise.resolve(e)}))}function c(e,t,i,r){return l(this,void 0,void 0,(function*(){const s=Object(n.getAppStore)().getState().portalSelf.helperServices.geometry.url,a=new i({url:s}),o=new r({geometries:e,outSpatialReference:t});return yield a.project(o)}))}var h=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{u(r.next(e))}catch(e){a(e)}}function o(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}u((r=r.apply(e,t||[])).next())}))};let p=null;function y(e,t,i){return h(this,void 0,void 0,(function*(){return e&&t?(i||(i={}),yield u(["esri/Graphic","esri/geometry/Extent","esri/layers/Layer","esri/layers/support/TileInfo"]).then(r=>h(this,void 0,void 0,(function*(){let s,a,n;return[s,a,n,p]=r,t instanceof a?yield m(e,t,i.scale):Array.isArray(t)&&t.length&&t[0]instanceof s?yield function(e,t,i){return h(this,void 0,void 0,(function*(){return"3d"!==e.type||i?yield S(e,t).then(t=>h(this,void 0,void 0,(function*(){return yield m(e,t,i)}))).catch(e=>h(this,void 0,void 0,(function*(){return yield Promise.reject(e)}))):e.goTo(t)}))}(e,t,i.scale):t instanceof n?yield g(e,t,null,null,i.scale):t.layer&&t.layer instanceof n&&t.extent&&t.extent instanceof a?yield g(e,t.layer,null,t.extent,i.scale):t.layer&&t.layer instanceof n&&Array.isArray(t.graphics)&&t.graphics.length&&t.graphics[0]instanceof s?yield g(e,t.layer,t.graphics,null,i.scale):yield Promise.reject(new Error("Invalid target."))})))):yield Promise.reject(new Error("Invalid target."))}))}function g(e,t,i,r,s){return h(this,void 0,void 0,(function*(){let a;if(r&&v(r)){if("3d"===e.type&&!s)return yield d([r],e.spatialReference).then(t=>e.goTo(t));a=Promise.resolve(r)}else if(i){if("3d"===e.type&&!s)return e.goTo(i);a=S(e,i)}else a=function(e,t){return h(this,void 0,void 0,(function*(){return"feature"===t.type?yield function(e,t){return h(this,void 0,void 0,(function*(){const i=t.fullExtent.clone();if(!t.url)return yield Promise.resolve(i);const r=t.capabilities.query;return r?yield u(["esri/tasks/support/Query"]).then(s=>{let a;[a]=s;const n=new a;return n.where=t.definitionExpression?t.definitionExpression:"1=1",n.outSpatialReference=e.spatialReference,n.returnGeometry=!0,r.supportsExtent?t.queryExtent(n).then(e=>e.extent).catch(e=>h(this,void 0,void 0,(function*(){return yield Promise.resolve(i)}))):t.queryFeatures(n).then(t=>h(this,void 0,void 0,(function*(){return yield S(e,t.features)}))).catch(e=>h(this,void 0,void 0,(function*(){return yield Promise.resolve(i)})))}).catch(e=>h(this,void 0,void 0,(function*(){return yield Promise.resolve(i)}))):yield Promise.resolve(i)}))}(e,t):yield Promise.resolve(t.fullExtent.clone())}))}(e,t);return a.then(t=>h(this,void 0,void 0,(function*(){return yield d([t],e.spatialReference).then(e=>e&&e[0])}))).then(i=>h(this,void 0,void 0,(function*(){if(!v(i))return yield Promise.reject(new Error("Invalid extent."));if(s)return i=D(e,i),yield P(e,i,s).then(t=>f(e,t));let r=t.minScale||0,a=t.maxScale||0;if(!L(i))return i=function(e,t){const i=e.size[0]/e.size[1],r=t.width/t.height;if(r>i){const e=t.width/i/2;t.ymin=t.center.y-e,t.ymax=t.center.y+e}else if(r<i){const e=t.height*i/2;t.xmin=t.center.x-e,t.xmax=t.center.x+e}return t}(e,i),function(e,t){return h(this,void 0,void 0,(function*(){return yield u(["esri/config","esri/geometry/support/WKIDUnitConversion"]).then(i=>{let r,s,a;[r,s]=i;const n=e.size[0],o=s;let u,l,d=t.spatialReference;d&&(u=d.wkid,l=d.wkt);let c=null;if(u)c=o.values[o[u]];else if(l&&-1!==l.search(/^PROJCS/i)){const e=/UNIT\[([^\]]+)\]\]$/i.exec(l);e&&e[1]&&(c=parseFloat(e[1].split(",")[1]))}return a=t.width/n*(c||20015077/180)*39.37*(r.screenDPI||96),a}).catch(e=>h(this,void 0,void 0,(function*(){return yield Promise.reject()})))}))}(e,i).then(t=>r>0&&t>r?(r=j(e,r,!0),i=D(e,i),P(e,i,r).then(t=>f(e,t))):t<a?(a=j(e,a,!1),i=D(e,i),P(e,i,a).then(t=>f(e,t))):f(e,i));{let t=b(e,r,a,3);if(t)return"3d"===e.type&&4513.9887>t&&(t=0===r||4513.9887<r?4513.9887:r),i=D(e,i),P(e,i,t).then(t=>f(e,t))}}))).catch(e=>h(this,void 0,void 0,(function*(){return yield Promise.reject(e)})))}))}function m(e,t,i){return h(this,void 0,void 0,(function*(){return v(t=t.clone())?yield d([t],e.spatialReference).then(i=>{let r=i&&i[0];return r||(r=t),L(r)?function(e,t){return h(this,void 0,void 0,(function*(){const i=b(e,0,0,3);return i?(t=D(e,t),yield P(e,t,i)):yield Promise.reject()}))}(e,r):r}).then(t=>i?P(e,t,i):t).then(t=>f(e,t)).catch(e=>h(this,void 0,void 0,(function*(){return yield Promise.reject(e)}))):yield Promise.reject(new Error("Invalid extent."))}))}function f(e,t){return e.goTo(t)}function v(e){return e&&w(e.xmin)&&w(e.ymin)&&w(e.xmax)&&w(e.ymax)}function w(e){return 0===e||!!e}var I;function L(e){return e.xmin+I.X===e.xmax-I.X&&e.ymin+I.Y===e.ymax-I.Y}function S(e,t,i={}){return h(this,void 0,void 0,(function*(){let r=t&&t[0]&&t[0].layer;return r&&"scene"===r.type?yield function(e,t,i){return h(this,void 0,void 0,(function*(){return yield u(["esri/tasks/support/Query"]).then(i=>h(this,void 0,void 0,(function*(){const[r]=i;if(t){const i=new r;return i.objectIds=e.map(e=>e.attributes[t.objectIdField]),i.returnGeometry=!0,t.queryExtent(i).then(e=>1===e.count?e.extent.expand(3.5):e.extent.expand(2))}return Promise.reject()}))).catch(e=>h(this,void 0,void 0,(function*(){return yield Promise.reject(e)})))}))}(t,r,i.factor):"3d"===e.type?yield M(t,3):yield M(t)}))}function M(e,t){return h(this,void 0,void 0,(function*(){return yield u(["esri/Graphic","esri/geometry/Extent","esri/geometry/Point"]).then(i=>{let r,s,a,n=null,o=e;[r,s,a]=i;try{if(o&&1===o.length&&o[0].geometry&&"esri.geometry.Multipoint"===o[0].geometry.declaredClass&&1===o[0].geometry.points.length){const e=o[0].geometry.points[0];o=[new r({geometry:new a({x:e[0],y:e[1],spatialReference:o[0].geometry.spatialReference})})]}if(o&&1===o.length&&o[0].geometry&&"esri.geometry.Point"===o[0].geometry.declaredClass){const e=o[0].geometry;n=new s({xmin:e.x-I.X,ymin:e.y-I.Y,xmax:e.x+I.X,ymax:e.y+I.Y,spatialReference:e.spatialReference})}else o&&o.length>0&&(n=function(e,t){if(!e||!e.length)return null;let i,r=null,s=e.length;for(i=0;i<s;i++){const s=e[i].geometry;if(!s)continue;let a=s.extent;a||"point"!==s.type||null==s.x||null==s.y||(a=new t({xmin:s.x,ymin:s.y,xmax:s.x,ymax:s.y,spatialReference:s.spatialReference})),a&&(r=r?r.union(a):a)}if(!r||r.width<0||r.height<0)return null;return r}(o,s),n&&t&&t>0&&(n=n.expand(t)));return n}catch(e){return console.error(e),Promise.reject()}}).catch(e=>h(this,void 0,void 0,(function*(){return yield Promise.reject()})))}))}function V(e){let t=[];return e.map.basemap.baseLayers.forEach(e=>{e&&e.tileInfo&&e.tileInfo.lods&&t.length<e.tileInfo.lods.length&&(t=e.tileInfo.lods)}),0===t.length?p.create().lods:t}function b(e,t,i,r){const s=V(e);let a,n=1;if(s){const e=[],o=[];let u;s.forEach(r=>{t>0&&r.scale>t||(r.scale<i?o.push(r.scale):e.push(r.scale))}),e.reverse(),e.length>=1?(n=o.length?o.length/s.length:1,u=Math.floor((e.length-1)/(r/n)),a=e[u]):a=null}else a=0===t?null:(t-i)/r;return a}function j(e,t,i){let r;const s=V(e);if(s){if(i){for(r=0;r<s.length;r++)if(s[r].scale<t)return s[r].scale-1;return s[s.length-1].scale-1}for(r=s.length-1;r>=0;r--)if(s[r].scale>t)return s[r].scale+1;return s[0].scale+1}return i?t-1:t+1}function D(e,t){const i=t.width*(e.size[1]/e.size[0])/5;return t.ymin=t.center.y-i,t.ymax=t.center.y+i,t}function P(e,t,i){return h(this,void 0,void 0,(function*(){return yield u(["esri/config","esri/geometry/support/WKIDUnitConversion"]).then(r=>{let s,a;[s,a]=r;const n=e.size[0],o=a;let u,l,d=t.spatialReference;d&&(u=d.wkid,l=d.wkt);let c=null;if(u)c=o.values[o[u]];else if(l&&-1!==l.search(/^PROJCS/i)){const e=/UNIT\[([^\]]+)\]\]$/i.exec(l);e&&e[1]&&(c=parseFloat(e[1].split(",")[1]))}return t.expand(i*n/(39.37*(c||20015077/180)*(s.screenDPI||96))/t.width)}).catch(e=>h(this,void 0,void 0,(function*(){return yield Promise.reject()})))}))}!function(e){e[e.X=1e-4]="X",e[e.Y=1e-4]="Y"}(I||(I={}));var x=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{u(r.next(e))}catch(e){a(e)}}function o(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}u((r=r.apply(e,t||[])).next())}))};const F=" "+function(e){var t="",i=function(){var e=[];return e=(e=e.concat(["Web Map","Web Scene","CityEngine Web Scene"]).concat(["Feature Service","Map Service","Image Service","KML","WMS","Feature Collection","Feature Collection Template","Geodata Service","Globe Service"]).concat(["Geometry Service","Geocoding Service","Network Analysis Service","Geoprocessing Service"]).concat(["Web Mapping Application","Mobile Application","Code Attachment","Operations Dashboard Add In","Operation View"]).concat(["Symbol Set","Color Set","Shapefile","CSV","Service Definition","Document Link","Microsoft Word","Microsoft PowerPoint","Microsoft Excel","PDF","Image","Visio Document"])).concat(["Map Document","Map Package","Tile Package","ArcPad Package","Explorer Map","Globe Document","Scene Document","Published Map","Map Template","Windows Mobile Package"]).concat(["Layer","Layer Package","Explorer Layer"]).concat(["Geoprocessing Package","Geoprocessing Sample","Locator Package","Rule Package"]).concat(["Workflow Manager Package","Desktop Application","Desktop Application Template","Code Sample","Desktop Add In","Explorer Add In"])}();if(e&&e.length>0&&e.length>0){var r="";for(let t=0;t<e.length;t++){var s=' type:"'+e[t]+'" ';r+=s,t!==e.length-1&&(r+=" OR ")}t=" ( "+r+" ) ";var a=e.concat(i).filter(t=>e.every(e=>!e.toLowerCase().includes(t.toLowerCase())));for(let e=0;e<a.length;e++){s=' -type:"'+a[e]+'" ';t+=s}}return t}(["Web Map"])+" ";let J=null;function A(){const e=Object(n.getAppStore)().getState().portalSelf;return!!(e&&e.defaultBasemap&&e.defaultBasemap.baseMapLayers&&e.defaultBasemap.baseMapLayers[0]&&e.defaultBasemap.baseMapLayers[0].url)}function C(e){return x(this,void 0,void 0,(function*(){return J||(J=u(["esri/portal/Portal"]).then(t=>x(this,void 0,void 0,(function*(){let i=null;[i]=t;const r=new i({url:e});return yield r.load().then(()=>x(this,void 0,void 0,(function*(){const e=r.sourceJSON,t=e.defaultBasemap&&e.defaultBasemap.id,i=e.defaultExtent;return t?yield Promise.resolve({defaultMapId:t,defaultExtent:i}):yield function(e,t,i){return x(this,void 0,void 0,(function*(){var e=t.defaultBasemap&&t.defaultBasemap.title;return yield i.queryGroups({f:"json",query:t.basemapGalleryGroupQuery}).then(t=>x(this,void 0,void 0,(function*(){var r=t.results;if(r.length>0){var s=r[0],a=F+" AND group:"+s.id+" AND title:"+e;return yield i.queryItems({start:1,num:1,f:"json",query:a}).then(t=>x(this,void 0,void 0,(function*(){var r=t.results;if((r=r.filter(e=>e.type&&"web map"===e.type.toLowerCase())).length>0){var s=r[0];return Promise.resolve(s.id)}var a=F+" AND title:"+e;return i.queryItems({start:1,num:1,f:"json",query:a}).then(e=>x(this,void 0,void 0,(function*(){var t=e.results;if((t=t.filter(e=>e.type&&"web map"===e.type.toLowerCase())).length>0){var i=t[0];return Promise.resolve(i.id)}return Promise.resolve(null)})))})))}})))}))}(0,e,r).then(e=>x(this,void 0,void 0,(function*(){return e?yield Promise.resolve({defaultMapId:e,defaultExtent:i}):yield function(e){return x(this,void 0,void 0,(function*(){var t={start:1,num:1,f:"json",query:F+" AND access:public AND owner:esri_en",sortField:"num-views",sortOrder:"desc"};return yield e.queryItems(t).then(e=>x(this,void 0,void 0,(function*(){var t=e.results;if((t=t.filter(e=>e.type&&"web map"===e.type.toLowerCase())).length>0){var i=t[0];return Promise.resolve(i.id)}return Promise.resolve(null)})))}))}(r).then(e=>x(this,void 0,void 0,(function*(){return yield Promise.resolve({defaultMapId:e,defaultExtent:i})})))})))})))}))),J)}))}var O={layerIsNotSupported:"This layer type is not supported."};class R{constructor(e){var t;if(this.runTimeIsHidden=!1,e.parentJimuLayerViewId?this.id=e.parentJimuLayerViewId+"-"+e.jimuLayerId:this.id=e.jimuMapViewId+"-"+e.jimuLayerId,this.view=e.view,this.type=e.type,this.layerDataSourceId=e.layerDataSourceId,this.jimuMapViewId=e.jimuMapViewId,this.jimuLayerId=e.jimuLayerId,this.layer=e.layer,this.layerIndex=e.layerIndex,this.parentJimuLayerViewId=e.parentJimuLayerViewId,this.dataSourceInfoObserver=Object(n.observeStore)(this.onLayerDataSourceInfoChange.bind(this),["dataSourcesInfo",this.layerDataSourceId]),this.getLayerDataSource()){const e=this.getLayerDataSource(),i=null===(t=e.getDataSourceJson())||void 0===t?void 0:t.isHidden;this.runTimeIsHidden=i,i&&(this.layer.visible=!i);const r=e.getRootDataSource();this.layerDataSourceJsonObserver=Object(n.observeStore)(this.onLayerDatasourceJsonChange.bind(this),["appConfig","dataSources",r.id])}}onLayerDataSourceInfoChange(e,t){}onLayerDatasourceJsonChange(e,t){var i,r;const s=null===(r=null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getDataSourceJson())||void 0===r?void 0:r.isHidden;this.runTimeIsHidden!==s&&(this.runTimeIsHidden=s,this.layer.visible=!s)}getLayerDataSource(){return n.DataSourceManager.getInstance().getDataSource(this.layerDataSourceId)}selectFeaturesByIds(e){}selectFeatureById(e){}destroy(){this.dataSourceInfoObserver&&this.dataSourceInfoObserver()}}var W=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{u(r.next(e))}catch(e){a(e)}}function o(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}u((r=r.apply(e,t||[])).next())}))};class B extends R{constructor(e){super(e),this.features=[],this.isReservePopup=!1,this.selectedIds="",this.localDefinitionExpression="",this.getViewForMap().popup.watch("selectedFeature",e=>{if(e){if(!e||!e.layer)return;if(e.layer===this.layer){const t=String(e.attributes[e.layer.objectIdField]);if(t===this.selectedIds)return;const i=this.getLayerDataSource(),r=$.getInstance().getJimuMapViewById(this.jimuMapViewId);null==i||i.queryById(t).then(e=>{this.selectFeatureById(t,e),this.isReservePopup=!0,n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(r.mapWidgetId,[e]))})}else this.isReservePopup=!1,this.selectFeatureById(null)}}),this.getViewForMap().popup.watch("visible",e=>{const t=this.getViewForMap();if(!e&&t.popup.selectedFeature&&t.popup.selectedFeature.layer===this.layer){const e=$.getInstance().getJimuMapViewById(this.jimuMapViewId);n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(e.mapWidgetId,[])),this.isReservePopup=!1,this.selectFeatureById(null)}}),this.getSelectedRecordIds().length>0?this.moveFeatureToCenter(this.getSelectedRecordIds()[0]).then(()=>{this.highLightSelectedFeatures()}):this.getLayerDataSource()&&this.getLayerDataSource().getSelectedRecordIds().length>0&&this.moveFeatureToCenter(this.getLayerDataSource().getSelectedRecordIds()[0]).then(()=>{this.highLightFeatures(this.getLayerDataSource().getSelectedRecordIds().map(e=>parseInt(e)))},e=>console.error(e))}doQuery(e){return W(this,void 0,void 0,(function*(){return yield new Promise(t=>{this.view.updating?(this.updateWatchHandle&&(this.updateWatchHandle.remove(),this.updateWatchHandle=null),this.updateWatchHandle=this.view.watch("updating",i=>{i||this.view.queryFeatures(e).then(e=>{this.features=e.features,t(this.features)})})):this.view.queryFeatures(e).then(e=>{this.features=e.features,t(this.features)},e=>{console.error(e)})})}))}doQueryById(e){return W(this,void 0,void 0,(function*(){const t={objectIds:[parseInt(e)],returnGeometry:!0};return yield this.doQuery(t).then(e=>e[0])}))}mergeQuery(e,t){const i=`(${e.where}) and (${t.where})`;return Object.assign(Object.assign(Object.assign({},e),t),{where:i})}setRefreshIntervalForLayer(e){if(!this.view||null==e)return;Object(n.getAppStore)().getState().appRuntimeInfo.appMode===n.AppMode.Design?this.layer.refreshInterval=0:this.layer.refreshInterval=e/60}setDefinitionExpressionForLayer(e){var t,i;if(e){if(this.view&&this.view.layer){const i={outFields:["*"],where:this.localDefinitionExpression,returnGeometry:!0},r=null===(t=this.getLayerDataSource())||void 0===t?void 0:t.getRealQueryParams(i,"query");if(r&&(this.view.layer.definitionExpression=r.where),e.geometry){if(this.view.filter&&this.view.filter.geometry===e.geometry)return;u(["esri/geometry/support/jsonUtils"]).then(t=>{const i=t[0];this.view.filter={geometry:i.fromJSON(e.geometry)}})}else this.view.filter&&(this.view.filter=null);return}if(!this.view&&this.layer){const e={outFields:["*"],where:this.localDefinitionExpression,returnGeometry:!0},t=null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getRealQueryParams(e,"query");t&&(this.layer.definitionExpression=t.where)}}}setLocalDefinitionExpression(e){var t;this.localDefinitionExpression=e,(null===(t=this.getLayerDataSource())||void 0===t?void 0:t.getCurrentQueryParams())&&this.setDefinitionExpressionForLayer(this.getLayerDataSource().getCurrentQueryParams())}highLightSelectedFeatures(){this.highLightFeatures(this.getSelectedRecordIds().map(e=>parseInt(e)))}highLightFeatures(e){this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null),this.view&&this.view.when(()=>{this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null),this.highLightHandle=this.view.highlight(e)})}clearHighLight(){this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null,this.isReservePopup&&(this.getViewForMap().popup.close(),this.isReservePopup=!1))}selectFeatureById(e,t){var i;null===(i=this.getLayerDataSource())||void 0===i||i.selectRecordById(e,t),null==e?this.clearHighLight():this.highLightSelectedFeatures()}selectFeaturesByIds(e,t){var i;null===(i=this.getLayerDataSource())||void 0===i||i.selectRecordsByIds(e,t),e&&e.length>0?this.highLightSelectedFeatures():this.clearHighLight()}onAppModeInfoChange(e,t){var i;this.setRefreshIntervalForLayer(null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getAutoRefreshInterval())}onLayerDataSourceInfoChange(e,t){var i,r,s,a;(null===(i=null==t?void 0:t.selectedIds)||void 0===i?void 0:i.length)>0||(null===(r=null==t?void 0:t.selectedIndexes)||void 0===r?void 0:r.length)>0?this.selectedIds!==t.selectedIds.join(",")&&(this.selectedIds=t.selectedIds.join(","),this.highLightSelectedFeatures()):(this.selectedIds="",this.clearHighLight()),(null===(s=this.getLayerDataSource())||void 0===s?void 0:s.getCurrentQueryParams())&&this.setDefinitionExpressionForLayer(this.getLayerDataSource().getCurrentQueryParams()),this.setRefreshIntervalForLayer(null===(a=this.getLayerDataSource())||void 0===a?void 0:a.getAutoRefreshInterval())}getViewForMap(){const e=$.getInstance().getJimuMapViewById(this.jimuMapViewId);return e&&e.view}handleFeatureNavigationAtPopUp(e){const t=this.getLayerDataSource();this.isReservePopup=!0,null==t||t.selectRecordById(e)}moveFeatureToCenter(e){return W(this,void 0,void 0,(function*(){return yield this.doQueryById(e).then(t=>t||(this.getLayerDataSource()?this.getLayerDataSource().queryById(e).then(e=>e&&e.feature):null)).then(t=>W(this,void 0,void 0,(function*(){if(t){const e=this.getCenterPoint(t.geometry);return e?yield this.getViewForMap().goTo(e):yield Promise.reject("Does not find center point.")}return yield Promise.reject("Dose not find feature."+e)})))}))}getCenterPoint(e){switch(e.type){case"point":return e;case"extent":return e.center;case"polygon":return e.centroid;case"polyline":return e.extent.center;default:return e&&e.extent?e.extent.center:void 0}}getSelectedRecordIds(){return Object(n.getAppStore)().getState().dataSourcesInfo[this.layerDataSourceId]?Object(n.getAppStore)().getState().dataSourcesInfo[this.layerDataSourceId].selectedIds?Object(n.getAppStore)().getState().dataSourcesInfo[this.layerDataSourceId].selectedIds.asMutable():Object(n.getAppStore)().getState().dataSourcesInfo[this.layerDataSourceId].selectedIndexes?Object(n.getAppStore)().getState().dataSourcesInfo[this.layerDataSourceId].selectedIndexes.asMutable().map(e=>this.features[e].attributes[this.getIdField()]):[]:[]}getIdField(){let e=this.view.layer.objectIdField;if(!e){const t=this.view.layer.fields.find(e=>"oid"===e.type);t&&(e=t.name)}return e||(e="OBJECTID"),e}getLayerDataSource(){return n.DataSourceManager.getInstance().getDataSource(this.layerDataSourceId)}selectRecordsByQuery(e){return W(this,void 0,void 0,(function*(){return yield u(["esri/layers/FeatureLayer"]).then(t=>W(this,void 0,void 0,(function*(){const t=$.getInstance().getJimuMapViewById(this.jimuMapViewId),i=t.getParentLayerViews(this.id);let r=!0;for(let e=0;e<i.length;e++)if(!i[e].layer.visible){r=!1;break}if(!r||!this.layer.visible)return yield Promise.resolve([]);const s=this.getLayerDataSource();e.geometry=e.geometry.toJSON?e.geometry.toJSON():e.geometry;const a=null==s?void 0:s.dataSourceManager.createLocalDataSource(s,"view");return a&&a.layer?yield a.load(e,{widgetId:"view"}).then(e=>W(this,void 0,void 0,(function*(){if(e&&e.length>0){const i=[],r=[],s=[];for(let t=0;t<e.length;t++)i.push(e[t].getId()),r.push(e[t].feature),s.push(e[t]);return n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(t.mapWidgetId,s)),a.selectRecordsByIds(i),yield Promise.resolve(r)}return yield Promise.resolve([])}))):yield Promise.resolve([])})),()=>W(this,void 0,void 0,(function*(){return yield Promise.resolve([])}))).then(e=>W(this,void 0,void 0,(function*(){if(!e||e&&0===e.length){const e=this.getLayerDataSource();null==e||e.selectRecordsByIds([])}return yield Promise.resolve(e)})))}))}getObjectIdField(e,t){let i=null;for(let r=0;r<e.length;r++)if(e[r].name===t)return i=e[r],i;return i}}var E=i(1);class G extends R{constructor(e){super(e),this.url=null,this.url=e.url,this.layer&&this.layer.watch("visible",e=>{const t=$.getInstance().getJimuMapViewById(this.jimuMapViewId).getChildLayerViews(this.id);if(t&&t.length>0)for(let i=0;i<t.length;i++)t[i].virtualLayer&&(t[i].virtualLayer.visible=e&&t[i].layer.visible),t[i].view||t[i].type!==E.c.FeatureLayer||t[i].highLightSelectedFeaturesWithVirtualLayer()})}}class k extends R{constructor(e){super(e),this.url=null,this.url=e.url,this.layer&&this.layer.watch("visible",e=>{const t=$.getInstance().getJimuMapViewById(this.jimuMapViewId).getChildLayerViews(this.id);if(t&&t.length>0)for(let i=0;i<t.length;i++)t[i].virtualLayer&&(t[i].virtualLayer.visible=e&&t[i].layer.visible),t[i].view||t[i].type!==E.c.FeatureLayer||t[i].highLightSelectedFeaturesWithVirtualLayer()})}}class T extends R{constructor(e){super(e),this.url=null,this.url=e.url,this.layer&&this.layer.watch("visible",e=>{const t=$.getInstance().getJimuMapViewById(this.jimuMapViewId).getChildLayerViews(this.id);if(t&&t.length>0)for(let i=0;i<t.length;i++)t[i].virtualLayer&&(t[i].virtualLayer.visible=e&&t[i].layer.visible),t[i].view||t[i].type!==E.c.FeatureLayer||t[i].highLightSelectedFeaturesWithVirtualLayer()})}}var H,U=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{u(r.next(e))}catch(e){a(e)}}function o(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}u((r=r.apply(e,t||[])).next())}))};!function(e){e.DataAction="DATA_ACTION",e.MessageAction="MESSAGE_ACTION"}(H||(H={}));const q="layer_of_showOnMap_action_";class _{constructor(e){this.jimuLayerViewLoadPromises={},this.isEnableHighlight=!0,this.getJimuLayerViewId=(e,t)=>{const i=n.DataSourceManager.getInstance().getDataSource(e);if(!i)return null;const r=i.getJimuChildId(t)[0];return this.id+"-"+r},this.clearSelectedFeatures=()=>{const e=this.jimuLayerViews,t=Object.keys(e);for(let i=0;i<t.length;i++){const r=e[t[i]];r.type!==E.c.FeatureLayer&&r.type!==E.c.SceneLayer||r.selectFeaturesByIds([])}n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(this.mapWidgetId,[]))},this.getSelectRecordsByQueryPromise=(e,t)=>U(this,void 0,void 0,(function*(){return yield e.selectRecordsByQuery(t)})),this.id=e.mapWidgetId+"-"+e.dataSourceId,this.mapWidgetId=e.mapWidgetId,this.isActive=e.isActive,this.dataSourceId=e.dataSourceId,this.view=e.view,this.jimuLayerViews={},this.status=n.JimuMapViewStatus.Loading,this.isEnablePopup=void 0===e.isEnablePopup||null===e.isEnablePopup||e.isEnablePopup,this.isEditing=!1,this.showOnMapDatas={},this.initView(this.view)}startEdit(){this.isEditing=!0}exitEdit(){this.isEditing=!1}getIsEditing(){return this.isEditing}enablePopup(){this.isEditing&&!this.isEnablePopup&&this.view&&this.view.popup&&(this.view.popup.autoOpenEnabled=!0,this.isEnablePopup=!0)}disablePopup(){this.isEditing&&this.isEnablePopup&&this.view&&this.view.popup&&(this.view.popup.autoOpenEnabled=!1,this.isEnablePopup=!1)}getIsEnablePopup(){return this.isEnablePopup}enableHighlight(){this.isEditing&&!this.isEnableHighlight&&(this.isEnableHighlight=!0)}disableHighlight(){this.isEditing&&this.isEnableHighlight&&(this.isEnableHighlight=!1)}getIsEnableHighlight(){return this.isEnableHighlight}setIsActive(e){this.isActive=e,$.getInstance().setJimuMapView(this)}initView(e){e&&e.when(()=>{e.on("click",this.onClick.bind(this))})}onClick(e){const t={x:e.x,y:e.y};this.view.hitTest(t).then(e=>{if(this.isEnableHighlight&&(e&&e.results&&0!==e.results.length||(this.clearAllJimuLayerViewsSelectRecord(),n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(this.mapWidgetId,[]))),e.results.length)){const t=this.jimuLayerViews,i=Object.keys(t),r=Object.keys(t);if("2d"==this.view.type){let t=!1;this.isEnablePopup||this.isEditing||(t=!0),e.results.forEach((e,r)=>{const s=e.graphic;if(!s||!s.layer)return;const a=s.layer.id,o=this.getJimuLayerViewId(this.dataSourceId,a),u=this.jimuLayerViews[o];if(u)switch(u.type){case E.c.FeatureLayer:if(t&&s.layer.popupEnabled){i.splice(i.indexOf(o),1),u.clearHighLight();const e=String(s.attributes[s.layer.objectIdField]),r=u.getLayerDataSource();u.selectedIds=e,null==r||r.queryById(e).then(t=>{u.selectFeatureById(e,t),n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(this.mapWidgetId,[t]))}),t=!1}}})}else e.results.forEach((e,t)=>{const r=e.graphic;if(!r||!r.layer)return;const s=r.layer.id,a=this.getJimuLayerViewId(this.dataSourceId,s),o=this.jimuLayerViews[a];if(o)switch(o.type){case E.c.FeatureLayer:if(0===t&&r.layer.popupEnabled){i.splice(i.indexOf(a),1),o.clearHighLight();const e=String(r.attributes[r.layer.objectIdField]),t=o.getLayerDataSource();o.selectedIds=e,t&&t.queryById(e).then(t=>{o.selectFeatureById(e,t),n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(this.mapWidgetId,[t]))})}break;case E.c.SceneLayer:if(0===t&&r.layer.popupEnabled){i.splice(i.indexOf(a),1),o.clearHighLight();const e=String(r.attributes[r.layer.objectIdField]),t=o.getLayerDataSource();o.selectedIds=e,t&&t.queryById(e).then(t=>{o.selectFeatureById(e,t),n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(this.mapWidgetId,[t]))})}}});if(i)for(let e=0;e<i.length;e++){const t=this.jimuLayerViews[i[e]];if(t)switch(t.type){case E.c.FeatureLayer:t.selectFeaturesByIds([])}}r&&i&&r.length===i.length&&r.length>0&&n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(this.mapWidgetId,[]))}},()=>{this.clearAllJimuLayerViewsSelectRecord()})}clearAllJimuLayerViewsSelectRecord(){const e=this.jimuLayerViews,t=Object.keys(e);for(let i=0;i<t.length;i++){e[t[i]].selectFeaturesByIds([])}}createJimuLayerViews(){return U(this,void 0,void 0,(function*(){return yield this.whenAllJimuLayerViewsLoaded(this.view)}))}addJimuLayerView(e){this.jimuLayerViews[e.id]=e}whenJimuMapViewLoaded(){return U(this,void 0,void 0,(function*(){return this.jimuMapViewLoadPromise?yield this.jimuMapViewLoadPromise:this.view?(this.jimuMapViewLoadPromise=this.view.when().then(()=>U(this,void 0,void 0,(function*(){return yield this.createJimuLayerViews().then(()=>U(this,void 0,void 0,(function*(){return this.status=n.JimuMapViewStatus.Loaded,$.getInstance().setJimuMapView(this),yield Promise.resolve(this)})))})),e=>U(this,void 0,void 0,(function*(){return console.error(e),this.status=n.JimuMapViewStatus.Failed,$.getInstance().setJimuMapView(this),yield Promise.reject(this)}))),yield this.jimuMapViewLoadPromise):(this.status=n.JimuMapViewStatus.Failed,$.getInstance().setJimuMapView(this),this.jimuMapViewLoadPromise=Promise.reject(this),yield this.jimuMapViewLoadPromise)}))}whenAllJimuLayerViewsLoaded(e){return U(this,void 0,void 0,(function*(){const t=[],i=this;return e.map.layers.toArray().map((r,s)=>{const a=n.DataSourceManager.getInstance().getDataSource(this.dataSourceId);if(!a)return;const o=a.getJimuChildId(n.dataSourceUtils.fixLayerId(r.id))[0];this.maxLayerIndex=e.map.layers.length-1;const u=e.whenLayerView(r).then(e=>U(this,void 0,void 0,(function*(){var t;let i=null,u=null;const l=a.getDataSourceByLayer(r.id,null===(t=n.dataSourceUtils.getJSAPILayerBySublayer(r))||void 0===t?void 0:t.id);switch(r.type){case E.c.SceneLayer:i={jimuLayerId:o,layerDataSourceId:l&&l.id,view:e,jimuMapViewId:this.id,type:r.type,layer:r,layerIndex:s,parentJimuLayerViewId:null},u=new B(i),this.addJimuLayerView(u);break;case E.c.FeatureLayer:i={jimuLayerId:o,layerDataSourceId:l&&l.id,view:e,jimuMapViewId:this.id,type:r.type,layer:r,layerIndex:s,parentJimuLayerViewId:null},u=new Y(i),this.addJimuLayerView(u);break;case E.c.MapImageLayer:case E.c.TileLayer:i={jimuLayerId:o,layerDataSourceId:l&&l.id,view:e,jimuMapViewId:this.id,type:r.type,layer:r,layerIndex:s,parentJimuLayerViewId:null},r.type===E.c.MapImageLayer&&(u=new T(i)),r.type===E.c.TileLayer&&(u=new k(i)),this.addJimuLayerView(u);const t=r.sublayers;if(t&&t.length>0)for(let e=0;e<t.length;e++){const i=t.getItemAt(e);this.createJimuLayerViewInSublayersOfImageLayer(i,u.id)}break;case E.c.GroupLayer:i={jimuLayerId:o,layerDataSourceId:l&&l.id,view:null,jimuMapViewId:this.id,type:r.type,layer:r,layerIndex:s,parentJimuLayerViewId:null},u=new G(i),this.addJimuLayerView(u);const a=r.layers;if(a&&a.length>0)for(let e=0;e<a.length;e++){const t=a.getItemAt(e);this.createJimuLayerViewInlayersOfGroupLayer(t,u.id)}break;default:i={jimuLayerId:o,layerDataSourceId:l&&l.id,view:e,jimuMapViewId:this.id,type:r.type,layer:r,layerIndex:s,parentJimuLayerViewId:null},u=new R(i),this.addJimuLayerView(u)}return yield Promise.resolve(u)})),()=>U(this,void 0,void 0,(function*(){return yield Promise.resolve(null)})));t.push(u),i.jimuLayerViewLoadPromises[""+(this.id+"-"+o)]=u}),yield Promise.all(t)}))}getParentLayerViews(e){const t=[];let i=this.jimuLayerViews[e];for(;i.parentJimuLayerViewId;){const e=this.jimuLayerViews[i.parentJimuLayerViewId];t.push(e),i=e}return t}getChildLayerViews(e){const t=[];return this.findChildLayerView(e,t),t}findChildLayerView(e,t){const i=this.jimuLayerViews,r=Object.keys(i);for(let s=0;s<r.length;s++){if(i[r[s]].parentJimuLayerViewId===e){const e=i[r[s]];t.push(e),this.findChildLayerView(e.id,t)}}}updateMaxLayerIndex(){return this.maxLayerIndex=this.maxLayerIndex+1,this.maxLayerIndex}createJimuLayerViewInlayersOfGroupLayer(e,t){var i,r,s;const a=n.DataSourceManager.getInstance().getDataSource(this.dataSourceId);if(e.type===E.c.GroupLayer&&e.layers&&e.layers.length>0){const r=a.getDataSourceByLayer(e.id,null===(i=n.dataSourceUtils.getJSAPILayerBySublayer(e))||void 0===i?void 0:i.id);if(!r)return;const s={jimuLayerId:e.id,layerDataSourceId:r&&r.id,view:null,url:e.url,jimuMapViewId:this.id,type:E.c.GroupLayer,layer:e,parentJimuLayerViewId:t,layerIndex:this.updateMaxLayerIndex()},o=new G(s);this.addJimuLayerView(o);for(let t=0;t<e.layers.length;t++)this.createJimuLayerViewInlayersOfGroupLayer(e.layers.getItemAt(t),o.id)}else if((e.type===E.c.TileLayer||e.type===E.c.MapImageLayer)&&e.sublayers&&e.sublayers.length>0){const i=a.getDataSourceByLayer(e.id,null===(r=n.dataSourceUtils.getJSAPILayerBySublayer(e))||void 0===r?void 0:r.id);if(!i)return;const s={jimuLayerId:e.id,layerDataSourceId:i&&i.id,view:null,url:e.url,jimuMapViewId:this.id,type:e.type,layer:e,parentJimuLayerViewId:t,layerIndex:this.updateMaxLayerIndex()},o=new G(s);this.addJimuLayerView(o);for(let t=0;t<e.sublayers.length;t++)this.createJimuLayerViewInSublayersOfImageLayer(e.sublayers.getItemAt(t),o.id)}else{const i=a.getDataSourceByLayer(e.id,null===(s=n.dataSourceUtils.getJSAPILayerBySublayer(e))||void 0===s?void 0:s.id);if(!i)return;const r=this.updateMaxLayerIndex();this.view.whenLayerView(e).then(s=>{const a={jimuLayerId:e.id,layerDataSourceId:i&&i.id,view:s,url:e.url,jimuMapViewId:this.id,type:e.type,layer:e,parentJimuLayerViewId:t,layerIndex:r},n=new Y(a);this.addJimuLayerView(n)})}}createJimuLayerViewInSublayersOfImageLayer(e,t){var i,r;const s=n.DataSourceManager.getInstance().getDataSource(this.dataSourceId);if(e.sublayers&&e.sublayers.length>0){const r=s.getDataSourceByLayer(e.id,null===(i=n.dataSourceUtils.getJSAPILayerBySublayer(e))||void 0===i?void 0:i.id);if(!r)return;const a={jimuLayerId:e.id,layerDataSourceId:r&&r.id,view:null,url:e.url,jimuMapViewId:this.id,type:E.c.GroupLayer,layer:e,parentJimuLayerViewId:t,layerIndex:this.updateMaxLayerIndex()},o=new G(a);this.addJimuLayerView(o);for(let t=0;t<e.sublayers.length;t++)this.createJimuLayerViewInSublayersOfImageLayer(e.sublayers.getItemAt(t),o.id)}else{const i=s.getDataSourceByLayer(e.id,null===(r=n.dataSourceUtils.getJSAPILayerBySublayer(e))||void 0===r?void 0:r.id);if(!i)return;const a={jimuLayerId:e.id,layerDataSourceId:i&&i.id,view:null,url:e.url,jimuMapViewId:this.id,type:E.c.FeatureLayer,layer:e,parentJimuLayerViewId:t,layerIndex:this.updateMaxLayerIndex()},o=new Y(a);this.addJimuLayerView(o)}}getJimuLayerViewLoadPromiseById(e){return U(this,void 0,void 0,(function*(){return yield this.jimuLayerViewLoadPromises[e]}))}selectFeaturesByGraphic(e,t){return U(this,void 0,void 0,(function*(){return yield u(["esri/geometry/geometryEngine"]).then(i=>U(this,void 0,void 0,(function*(){const r=i[0];let s=e.geometry;if("point"===s.type||"polyline"===s.type){const e=2.54*this.view.scale/9600;s=r.buffer(s,10*e,"meters")}const a={geometry:s,spatialRelationship:t,returnGeometry:!0,outFields:["*"]},n=this.jimuLayerViews,o=Object.keys(n),u=[];for(let e=0;e<o.length;e++){const t=n[o[e]];if(t.type===E.c.FeatureLayer||t.type===E.c.SceneLayer){const e=this.getSelectRecordsByQueryPromise(t,a);u.push(e)}}return yield Promise.all(u)})))}))}destroy(){const e=this.jimuLayerViews,t=Object.keys(e);for(let i=0;i<t.length;i++){e[t[i]].destroy()}if(this.view&&!this.view.destroyed){this.view.graphics&&this.view.graphics.destroyed&&this.view.graphics.destroy(),this.view.container=null,this.view.allLayerViews&&this.view.allLayerViews.destroyed&&this.view.allLayerViews.destroy(),this.view.layerViews&&this.view.layerViews.destroyed&&this.view.layerViews.destroy();const e=this.view.ui;e.exbMapTools&&0!==Object.keys(e.exbMapTools).length&&Object.keys(e.exbMapTools).map((t,i)=>{e.exbMapTools[t].destroy()}),e.exbMapTools={},this.view.destroy(),this.view=null}}_getDefaultJimuMapViewId(){const e=Object(n.getAppStore)().getState().jimuMapViewsInfo;return Object.keys(e||{}).find(t=>e[t].mapWidgetId===this.mapWidgetId)}drawDataOnMap(e){Object.entries(e).forEach(e=>{let t=e[1].jimuMapViewId;t||e[1].mapWidgetId!==this.mapWidgetId||(t=this._getDefaultJimuMapViewId()),this.showOnMapDatas[e[0]]||t!==this.id?t===this.id&&this.updateDrawFeatureSet(e[1].dataSource,e[1].records,e[0],e[1].title):this.drawFeatureSet(e[1].dataSource,e[1].records,e[0],e[1].title),this.showOnMapDatas[e[0]]=e[1]}),Object.entries(this.showOnMapDatas).forEach(t=>{if(!e[t[0]]){const e=this.view.map.findLayerById(t[0]);delete this.showOnMapDatas[t[0]],e&&this.view.map.remove(e)}})}drawFeatureSet(e,t,i,r){return U(this,void 0,void 0,(function*(){u(["esri/layers/GraphicsLayer"]).then(s=>U(this,void 0,void 0,(function*(){const[a]=s;var n=new a({id:i,title:r,listMode:"hide",graphics:yield this.getGraphicsFromRecords(e,t)});this.view.map.add(n)}))).catch(e=>{console.warn(e)})}))}updateDrawFeatureSet(e,t,i,r){return U(this,void 0,void 0,(function*(){const r=this.view.map.findLayerById(i);r&&t.some((e,t)=>{var r,s;return e.getId()!==(null===(s=null===(r=this.showOnMapDatas[i])||void 0===r?void 0:r.records[t])||void 0===s?void 0:s.getId())})&&(r.removeAll(),r.addMany(yield this.getGraphicsFromRecords(e,t)))}))}getGraphicsFromRecords(e,t){return U(this,void 0,void 0,(function*(){return yield u(["esri/Graphic","esri/symbols/support/symbolUtils"]).then(i=>U(this,void 0,void 0,(function*(){const[r,s]=i,a=t.map(t=>U(this,void 0,void 0,(function*(){let i,a;switch(e.getGeometryType()){case"esriGeometryPoint":a="point";break;case"esriGeometryPolygon":a="polygon";break;case"esriGeometryPolyline":a="polyline"}const n=t.feature;return"esri.Graphic"===(null==n?void 0:n.declaredClass)?(i=n.clone(),i.symbol||(i.symbol=yield this.getDefaultSymbol(s,i,a))):(n.geometry.type=a,i=new r({geometry:n.geometry,attributes:n.attributes,symbol:yield this.getDefaultSymbol(s,i,a)})),i})));return yield Promise.allSettled(a).then(e=>e.map(e=>e.value))}))).catch(e=>(console.warn(e),null))}))}getDefaultSymbol(e,t,i){return U(this,void 0,void 0,(function*(){let r=null;switch(i){case"point":r={type:"simple-marker",color:[255,255,0,.6],outline:{color:[255,255,0,.6],width:1}};break;case"polyline":let s;r={type:"simple-line",color:[255,255,0,.6]},(null==t?void 0:t.layer)&&(s=yield this.getDefaultSymbolByRenderer(e,t,i)),(null==s?void 0:s.color)?s.color=r.color:(null==s?void 0:s.material)&&(s.material.color=r.color),r=s||r;break;case"polygon":r={type:"simple-fill",color:[255,255,0,.6],outline:{color:[255,255,0,.6],width:1}}}return Promise.resolve(r)}))}getDefaultSymbolByRenderer(e,t,i){return U(this,void 0,void 0,(function*(){return e.getDisplayedSymbol(t).then(e=>e).catch(()=>null)}))}}var Q=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{u(r.next(e))}catch(e){a(e)}}function o(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}u((r=r.apply(e,t||[])).next())}))};class N{constructor(e){this.switchMap=()=>Q(this,void 0,void 0,(function*(){return this.mapWidgetInstance?yield this.mapWidgetInstance.switchMap():yield Promise.resolve()})),this.fullScreenMap=()=>{this.mapWidgetInstance&&this.mapWidgetInstance.fullScreenMap()},this.mapWidgetId=e,this.jimuMapViews={}}setMapWidgetInstance(e){this.mapWidgetInstance=e}addJimuMapView(e){this.jimuMapViews[e.id]=e}setJimuMapView(e){this.jimuMapViews[e.id]=e}removeJimuMapView(e){delete this.jimuMapViews[e.id]}getActiveJimuMapView(){const e=Object.keys(this.jimuMapViews);for(let t=0;t<e.length;t++)if(this.jimuMapViews[e[t]].isActive)return this.jimuMapViews[e[t]];return null}}var z=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{u(r.next(e))}catch(e){a(e)}}function o(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}u((r=r.apply(e,t||[])).next())}))};class ${constructor(){this.jimuMapViewGroups={}}static getInstance(){return window.jimuConfig.isBuilder?window._appWindow&&window._appWindow._mapViewManager:($._instance||($._instance=new $,window._mapViewManager=$._instance),$._instance)}getJimuMapViewById(e){const t=Object.keys(this.jimuMapViewGroups);if(0===t.length)return null;for(let i=0;i<t.length;i++){const r=t[i];if(Object.keys(this.jimuMapViewGroups[r].jimuMapViews).includes(e))return this.jimuMapViewGroups[r].jimuMapViews[e]}return null}getJimuMapViewGroup(e){return this.jimuMapViewGroups[e]?this.jimuMapViewGroups[e]:null}createJimuMapView(e){return z(this,void 0,void 0,(function*(){const t=e.mapWidgetId+"-"+e.dataSourceId;if(this.getJimuMapViewById(t))return yield Promise.resolve(this.getJimuMapViewById(t));const i=new _(e);return this.addJimuMapView(i),yield i.whenJimuMapViewLoaded()}))}addJimuMapView(e){if(this.jimuMapViewGroups[e.mapWidgetId])this.jimuMapViewGroups[e.mapWidgetId].addJimuMapView(e);else{const t=new N(e.mapWidgetId);t.addJimuMapView(e),this.jimuMapViewGroups[e.mapWidgetId]=t}Object(n.getAppStore)().dispatch(n.appActions.jimuMapViewAdded(e.id,Object(n.Immutable)({id:e.id,mapWidgetId:e.mapWidgetId,dataSourceId:e.dataSourceId,status:e.status})))}setJimuMapView(e){if(this.jimuMapViewGroups[e.mapWidgetId])this.jimuMapViewGroups[e.mapWidgetId].setJimuMapView(e);else{const t=new N(e.mapWidgetId);t.addJimuMapView(e),this.jimuMapViewGroups[e.mapWidgetId]=t}Object(n.getAppStore)().dispatch(n.appActions.jimuMapViewUpdated(e.id,Object(n.Immutable)({id:e.id,mapWidgetId:e.mapWidgetId,dataSourceId:e.dataSourceId,isActive:e.isActive,status:e.status})))}destroyJimuMapView(e){const t=this.getJimuMapViewById(e);t&&t.destroy();const i=Object.keys(this.jimuMapViewGroups);if(0===i.length);else for(let t=0;t<i.length;t++){const r=i[t];if(Object.keys(this.jimuMapViewGroups[r].jimuMapViews).includes(e)){delete this.jimuMapViewGroups[r].jimuMapViews[e],0===Object.keys(this.jimuMapViewGroups[r].jimuMapViews).length&&delete this.jimuMapViewGroups[r],Object(n.getAppStore)().dispatch(n.appActions.jimuMapViewRemoved(e));break}}}getAllJimuMapViewIds(){const e=[];return Object.keys(this.jimuMapViewGroups).forEach(t=>{Object.keys(this.jimuMapViewGroups[t].jimuMapViews).forEach(t=>{e.push(t)})}),e}destroyAllJimuMapViews(){this.getAllJimuMapViewIds().forEach(e=>{this.destroyJimuMapView(e)})}}var X=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{u(r.next(e))}catch(e){a(e)}}function o(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}u((r=r.apply(e,t||[])).next())}))};class Y extends R{constructor(e){super(e),this.features=[],this.isReservePopup=!1,this.virtualLayer=null,this.selectedIds="",this.localDefinitionExpression="",this.originalGdbVersion=null,this.view&&(this.originalGdbVersion=this.layer.gdbVersion),this.layer&&this.layer.watch("visible",(e,t)=>{this.virtualLayer&&(this.virtualLayer.visible=e),this.view||this.highLightSelectedFeaturesWithVirtualLayer()}),this.getViewForMap().popup.watch("selectedFeature",e=>{if(e){if(!e||!e.layer)return;if(e.layer===this.layer){const t=String(e.attributes[e.layer.objectIdField]);if(t===this.selectedIds)return;const i=this.getLayerDataSource(),r=$.getInstance().getJimuMapViewById(this.jimuMapViewId);null==i||i.queryById(t).then(e=>{this.selectFeatureById(t,e),this.isReservePopup=!0,n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(r.mapWidgetId,[e]))})}else this.isReservePopup=!1,this.selectFeatureById(null)}}),this.getViewForMap().popup.watch("visible",e=>{const t=this.getViewForMap();if(!e&&t.popup.selectedFeature&&t.popup.selectedFeature.layer===this.layer){const e=$.getInstance().getJimuMapViewById(this.jimuMapViewId);n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(e.mapWidgetId,[])),this.isReservePopup=!1,this.selectFeatureById(null)}}),this.getSelectedRecordIds().length>0?this.moveFeatureToCenter(this.getSelectedRecordIds()[0]).then(()=>{this.highLightSelectedFeatures()}):this.getLayerDataSource()&&this.getLayerDataSource().getSelectedRecordIds().length>0&&this.moveFeatureToCenter(this.getLayerDataSource().getSelectedRecordIds()[0]).then(()=>{this.highLightFeatures(this.getLayerDataSource().getSelectedRecordIds().map(e=>parseInt(e)))},e=>console.error(e));window&&window.jimuConfig&&window.jimuConfig.isInBuilder&&(this.appModeObserver=Object(n.observeStore)(this.onAppModeInfoChange.bind(this),["appRuntimeInfo","appMode"]))}doQuery(e){return X(this,void 0,void 0,(function*(){return yield new Promise(t=>{this.view.updating?(this.updateWatchHandle&&(this.updateWatchHandle.remove(),this.updateWatchHandle=null),this.updateWatchHandle=this.view.watch("updating",i=>{i||this.view.queryFeatures(e).then(e=>{this.features=e.features,t(this.features)})})):this.view.queryFeatures(e).then(e=>{this.features=e.features,t(this.features)},e=>{console.error(e)})})}))}doQueryById(e){return X(this,void 0,void 0,(function*(){const t={objectIds:[parseInt(e)],returnGeometry:!0};return yield this.doQuery(t).then(e=>e[0])}))}mergeQuery(e,t){const i=`(${e.where}) and (${t.where})`;return Object.assign(Object.assign(Object.assign({},e),t),{where:i})}setRefreshIntervalForLayer(e){if(!this.view||null==e)return;Object(n.getAppStore)().getState().appRuntimeInfo.appMode===n.AppMode.Design?this.layer.refreshInterval=0:this.layer.refreshInterval=e/60}setDefinitionExpressionForLayer(e){var t,i;if(e){if(this.view&&this.view.layer){const i={outFields:["*"],where:this.localDefinitionExpression,returnGeometry:!0},r=null===(t=this.getLayerDataSource())||void 0===t?void 0:t.getRealQueryParams(i,"query");if(r&&(this.view.layer.definitionExpression=r.where),e.geometry){if(this.view.filter&&this.view.filter.geometry===e.geometry)return;u(["esri/geometry/support/jsonUtils"]).then(t=>{const i=t[0];this.view.filter={geometry:i.fromJSON(e.geometry)}})}else this.view.filter&&(this.view.filter=null);return}if(!this.view&&this.layer){const e={outFields:["*"],where:this.localDefinitionExpression,returnGeometry:!0},t=null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getRealQueryParams(e,"query");t&&(this.layer.definitionExpression=t.where)}}}setLocalDefinitionExpression(e){var t;this.localDefinitionExpression=e,(null===(t=this.getLayerDataSource())||void 0===t?void 0:t.getCurrentQueryParams())&&this.setDefinitionExpressionForLayer(this.getLayerDataSource().getCurrentQueryParams())}highLightSelectedFeatures(){this.view?this.highLightFeatures(this.getSelectedRecordIds().map(e=>parseInt(e))):this.highLightSelectedFeaturesWithVirtualLayer()}highLightSelectedFeaturesWithVirtualLayer(){const e=$.getInstance().getJimuMapViewById(this.jimuMapViewId),t=e.getParentLayerViews(this.id);let i=!0;for(let e=0;e<t.length;e++)if(!t[e].layer.visible){i=!1;break}if(!i||!this.layer.visible)return;this.virtualLayer&&(e.view.map.remove(this.virtualLayer),this.virtualLayer=null,this.clearHighLight());const r=this.getLayerDataSource(),s=null==r?void 0:r.getSelectedRecords();if(s&&s.length>0){const t=r.layer,i=this.getObjectIdField(t.fields,t.objectIdField),a=[];for(let e=0;e<s.length;e++){const i=s[e].feature.clone(),r=i.attributes[t.objectIdField];i.attributes={},i.attributes[t.objectIdField]=r,a.push(i)}u(["esri/layers/FeatureLayer"]).then(r=>{const s=r[0];this.virtualLayer=new s({title:t.title,source:a,fields:i?[i]:[],objectIdField:t.objectIdField,renderer:this.getRendererForVirtualLayer(a[0].geometry.type),listMode:"hide",legendEnabled:!1}),e.view.map.add(this.virtualLayer,this.layerIndex),this.virtualLayer.on("layerview-create",e=>{const t=e.layerView;this.highLightHandle=t.highlight(a)})})}}highLightFeatures(e){this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null),this.view&&this.view.when(()=>{this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null),this.highLightHandle=this.view.highlight(e)})}clearHighLight(){if(this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null,this.isReservePopup&&(this.getViewForMap().popup.close(),this.isReservePopup=!1)),this.virtualLayer){$.getInstance().getJimuMapViewById(this.jimuMapViewId).view.map.remove(this.virtualLayer),this.virtualLayer=null}}selectFeatureById(e,t){var i;const r=e?[e]:[],s=t?[t]:[];null===(i=this.getLayerDataSource())||void 0===i||i.selectRecordsByIds(r,s),null==e?this.clearHighLight():this.highLightSelectedFeatures()}selectFeaturesByIds(e,t){var i;null===(i=this.getLayerDataSource())||void 0===i||i.selectRecordsByIds(e,t),e&&e.length>0?this.highLightSelectedFeatures():this.clearHighLight()}onAppModeInfoChange(e,t){var i;this.setRefreshIntervalForLayer(null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getAutoRefreshInterval())}onLayerDataSourceInfoChange(e,t){var i,r,s,a;(null===(i=null==t?void 0:t.selectedIds)||void 0===i?void 0:i.length)>0||(null===(r=null==t?void 0:t.selectedIndexes)||void 0===r?void 0:r.length)>0?this.selectedIds!==t.selectedIds.join(",")&&(this.selectedIds=t.selectedIds.join(","),this.highLightSelectedFeatures()):(this.selectedIds="",this.clearHighLight()),(null===(s=this.getLayerDataSource())||void 0===s?void 0:s.getCurrentQueryParams())&&this.setDefinitionExpressionForLayer(this.getLayerDataSource().getCurrentQueryParams()),this.view&&((null==t?void 0:t.gdbVersion)&&(this.layer.gdbVersion=t.gdbVersion),(null==t?void 0:t.gdbVersion)||(this.layer.gdbVersion=this.originalGdbVersion)),this.setRefreshIntervalForLayer(null===(a=this.getLayerDataSource())||void 0===a?void 0:a.getAutoRefreshInterval())}getViewForMap(){const e=$.getInstance().getJimuMapViewById(this.jimuMapViewId);return e&&e.view}handleFeatureNavigationAtPopUp(e){const t=this.getLayerDataSource();this.isReservePopup=!0;const i=e?[e]:[];null==t||t.selectRecordsByIds(i)}moveFeatureToCenter(e){return X(this,void 0,void 0,(function*(){return yield this.doQueryById(e).then(t=>t||(this.getLayerDataSource()?this.getLayerDataSource().queryById(e).then(e=>e&&e.feature):null)).then(t=>X(this,void 0,void 0,(function*(){if(t){const e=this.getCenterPoint(t.geometry);return e?yield this.getViewForMap().goTo(e):yield Promise.reject("Does not find center point.")}return yield Promise.reject("Dose not find feature."+e)})))}))}getCenterPoint(e){switch(e.type){case"point":return e;case"extent":return e.center;case"polygon":return e.centroid;case"polyline":return e.extent.center;default:return e&&e.extent?e.extent.center:void 0}}getSelectedRecordIds(){return Object(n.getAppStore)().getState().dataSourcesInfo[this.layerDataSourceId]?Object(n.getAppStore)().getState().dataSourcesInfo[this.layerDataSourceId].selectedIds?Object(n.getAppStore)().getState().dataSourcesInfo[this.layerDataSourceId].selectedIds.asMutable():Object(n.getAppStore)().getState().dataSourcesInfo[this.layerDataSourceId].selectedIndexes?Object(n.getAppStore)().getState().dataSourcesInfo[this.layerDataSourceId].selectedIndexes.asMutable().map(e=>this.features[e].attributes[this.getIdField()]):[]:[]}getIdField(){let e=this.view.layer.objectIdField;if(!e){const t=this.view.layer.fields.find(e=>"oid"===e.type);t&&(e=t.name)}return e||(e="OBJECTID"),e}getLayerDataSource(){return n.DataSourceManager.getInstance().getDataSource(this.layerDataSourceId)}selectRecordsByQuery(e){return X(this,void 0,void 0,(function*(){return yield u(["esri/layers/FeatureLayer"]).then(t=>X(this,void 0,void 0,(function*(){const t=$.getInstance().getJimuMapViewById(this.jimuMapViewId),i=t.getParentLayerViews(this.id);let r=!0;for(let e=0;e<i.length;e++)if(!i[e].layer.visible){r=!1;break}if(!r||!this.layer.visible)return yield Promise.resolve([]);this.virtualLayer&&(t.view.map.remove(this.virtualLayer),this.virtualLayer=null,this.clearHighLight());const s=this.getLayerDataSource();e.geometry=e.geometry.toJSON?e.geometry.toJSON():e.geometry;const a=null==s?void 0:s.dataSourceManager.createLocalDataSource(s,"view");return a&&a.layer?yield a.load(e,{widgetId:"view"}).then(e=>X(this,void 0,void 0,(function*(){if(e&&e.length>0){const i=[],r=[],s=[];for(let t=0;t<e.length;t++)i.push(e[t].getId()),r.push(e[t].feature),s.push(e[t]);return n.MessageManager.getInstance().publishMessage(new n.DataRecordsSelectionChangeMessage(t.mapWidgetId,s)),a.selectRecordsByIds(i),yield Promise.resolve(r)}return yield Promise.resolve([])}))):yield Promise.resolve([])})),()=>X(this,void 0,void 0,(function*(){return yield Promise.resolve([])}))).then(e=>X(this,void 0,void 0,(function*(){if(!e||e&&0===e.length){const e=this.getLayerDataSource();null==e||e.selectRecordsByIds([])}return yield Promise.resolve(e)})))}))}getObjectIdField(e,t){let i=null;for(let r=0;r<e.length;r++)if(e[r].name===t)return i=e[r],i;return i}getRendererForVirtualLayer(e){return["point","multipoint"].includes(e)?{type:"simple",symbol:{type:"simple-marker",style:"circle",color:this.getViewForMap().highlightOptions.color,size:"16px",outline:{color:this.getViewForMap().highlightOptions.color,width:1}}}:["polyline"].includes(e)?{type:"simple",symbol:{type:"simple-line",color:this.getViewForMap().highlightOptions.color,width:1,style:"solid"}}:["polygon","extent"].includes(e)?{type:"simple",symbol:{type:"simple-fill",color:[0,255,255,0],style:"solid",outline:{color:this.getViewForMap().highlightOptions.color,width:1}}}:["mesh"].includes(e)?{type:"simple",symbol:{type:"mesh-3d",symbolLayers:[{type:"fill",material:{color:this.getViewForMap().highlightOptions.color}}]}}:null}}class K{constructor(){this.id="arcgis-dependency-define"}getDependencyKey(){return"jimu-arcgis"}getResources(){var e;this.themeChangeObserver||(this.themeChangeObserver=Object(n.observeStore)(this.onThemeChange.bind(this),["theme"]));let t=window.jimuConfig.arcgisJsApiUrl;if(Object(n.getAppStore)().getState().queryObject.apiurl&&(t=Object(n.getAppStore)().getState().queryObject.apiurl,!this.checkApiUrl(t)))return void console.log("Bad apiurl.",t);/\/$/.test(t)||(t+="/"),window.jimuConfig.arcgisJsApiUrl=t;const i=[{url:t+"init.js"}];return(null===(e=Object(n.getAppStore)().getState().theme)||void 0===e?void 0:e.darkTheme)?i.push({url:this.getAPIThemeUrl(t,!0)}):i.push({url:this.getAPIThemeUrl(t,!1)}),[{url:"jimu-arcgis",dependencies:i}]}onThemeChange(e,t){e&&t&&(null==e?void 0:e.darkTheme)!==(null==t?void 0:t.darkTheme)&&(this.removeApiThemeStyle(this.getAPIThemeUrl(window.jimuConfig.arcgisJsApiUrl,e.darkTheme)),n.moduleLoader.loadModule(this.getAPIThemeUrl(window.jimuConfig.arcgisJsApiUrl,t.darkTheme)))}removeApiThemeStyle(e){var t;n.moduleLoader.deleteModule(e),null===(t=document.querySelector(`link[href="${e}"]`))||void 0===t||t.remove()}getAPIThemeUrl(e,t){return t?e+"esri/themes/dark/main.css":e+"esri/css/main.css"}checkApiUrl(e){return"development"===window.env||(!/^\/\//.test(e)&&!/^https?:\/\//.test(e)||/(?:[\w\-\_]+\.)+(?:esri|arcgis)\.com/.test(e))}}class Z{constructor(){this.id="arcgis-ds-factory"}getFactoryUri(e){if(Object.keys(E.a).map(e=>E.a[e]).includes(e))return"jimu-arcgis/arcgis-data-source"}}class ee extends n.React.PureComponent{constructor(){super(...arguments),this.viewManager=$.getInstance(),this.onViewsCreate=e=>{this.props.onViewsCreate&&this.props.onViewsCreate(e)},this.onViewGroupCreate=()=>{if(this.props.onViewGroupCreate&&this.viewManager&&this.props.useMapWidgetId){const e=this.viewManager.getJimuMapViewGroup(this.props.useMapWidgetId);this.props.onViewGroupCreate(e)}},this.onActiveViewChange=e=>{if(!this.props.onActiveViewChange)return;const t=this.viewManager&&this.viewManager.getJimuMapViewById(this.getActiveViewId(this.props.useMapWidgetId,this.props.viewInfos))||null;this.props.onActiveViewChange(t,e)},this.getActiveViewId=(e,t)=>t&&Object.keys(t).find(i=>t[i].mapWidgetId===e&&t[i].isActive),this.getWhetherAllViewsCreated=(e=[],t)=>e.length>0&&!e.some(e=>!this.getWhetherViewCreated(e,t)),this.getWhetherViewCreated=(e,t)=>!!(e&&t&&t[e]&&t[e].status&&t[e].status===n.JimuMapViewStatus.Loaded),this.getViewIdsFromMapWidgetId=(e,t)=>t?Object.keys(t).filter(i=>t[i].mapWidgetId===e):[],this.getViews=e=>{if(!e)return null;const t={};return e.forEach(e=>{t[e]=this.viewManager.getJimuMapViewById(e)}),t}}componentDidMount(){const{useMapWidgetId:e,viewInfos:t}=this.props,i=this.getViewIdsFromMapWidgetId(e,t);if(i.length>0&&this.onViewGroupCreate(),this.getWhetherAllViewsCreated(i,t)){const e=this.getViews(i);this.onViewsCreate(e)}const r=this.getActiveViewId(e,t);r&&this.getWhetherViewCreated(r,t)&&this.onActiveViewChange(null)}componentDidUpdate(e){const t=this.getViewIdsFromMapWidgetId(e.useMapWidgetId,e.viewInfos),i=this.getViewIdsFromMapWidgetId(this.props.useMapWidgetId,this.props.viewInfos);if(0===t.length&&i.length>0&&this.onViewGroupCreate(),!this.getWhetherAllViewsCreated(t,e.viewInfos)&&this.getWhetherAllViewsCreated(i,this.props.viewInfos)){const e=this.getViews(i);this.onViewsCreate(e)}this.getActiveViewId(e.useMapWidgetId,e.viewInfos)!==this.getActiveViewId(this.props.useMapWidgetId,this.props.viewInfos)&&this.onActiveViewChange(null)}render(){if(!this.props.useMapWidgetId||!this.props.viewInfos||!this.props.children)return null;const e=this.getViewIdsFromMapWidgetId(this.props.useMapWidgetId,this.props.viewInfos),t=this.getViews(e);return"function"==typeof this.props.children?this.props.children(t):this.props.children}}const te=n.ReactRedux.connect((e,t)=>{if(e.appStateInBuilder){return{viewInfos:e.appStateInBuilder&&e.appStateInBuilder.jimuMapViewsInfo}}return{viewInfos:e&&e.jimuMapViewsInfo}})(ee);class ie extends n.React.PureComponent{constructor(e){super(e),this.getJimuMapViewIdsFromUseMapWidgetIds=(e,t,i)=>{let r=[];return e&&e.forEach(e=>{r=r.concat(this.getJimuMapViewIdsFromMapWidgetId(e,t,i))}),r},this.getJimuMapViewIdsFromMapWidgetId=(e,t,i)=>i&&t?Object.keys(t).filter(r=>t[r].mapWidgetId===e&&t[r].dataSourceId===i):[]}componentDidMount(){const e=this.getJimuMapViewIdsFromUseMapWidgetIds(this.props.useMapWidgetIds,this.props.viewInfos,this.props.jimuLayerViewInfo&&this.props.jimuLayerViewInfo.rootDataSourceId);if(e[0]&&this.props.viewInfos[e[0]].status===n.JimuMapViewStatus.Loaded&&this.props.jimuLayerViewInfo&&this.props.jimuLayerViewInfo.jimuMapViewId&&this.props.jimuLayerViewInfo.jimuLayerId){const t=$.getInstance().getJimuMapViewById(e[0]).getJimuLayerViewLoadPromiseById(this.props.jimuLayerViewInfo.jimuMapViewId+"-"+this.props.jimuLayerViewInfo.jimuLayerId);t?t.then(e=>{this.props.onLayerViewCreated&&this.props.onLayerViewCreated(e)},e=>{this.props.onLayerViewFailed&&this.props.onLayerViewFailed(e)}):this.props.onLayerViewCreated&&this.props.onLayerViewCreated(null)}e[0]&&this.props.viewInfos[e[0]].status===n.JimuMapViewStatus.Failed&&this.props.jimuLayerViewInfo&&this.props.jimuLayerViewInfo.jimuMapViewId&&this.props.jimuLayerViewInfo.jimuLayerId&&this.props.onLayerViewFailed&&this.props.onLayerViewFailed(null)}componentDidUpdate(e,t){const i=this.getJimuMapViewIdsFromUseMapWidgetIds(e.useMapWidgetIds,e.viewInfos,e.jimuLayerViewInfo&&e.jimuLayerViewInfo.rootDataSourceId),r=e.viewInfos[i[0]],s=r&&r.status,a=this.getJimuMapViewIdsFromUseMapWidgetIds(this.props.useMapWidgetIds,this.props.viewInfos,this.props.jimuLayerViewInfo&&this.props.jimuLayerViewInfo.rootDataSourceId),o=this.props.viewInfos[a[0]],u=o&&o.status;if(s!==u||s===u&&i.join("")===a.join(""))if(o){if(o.status===n.JimuMapViewStatus.Loaded){const e=$.getInstance().getJimuMapViewById(a[0]).getJimuLayerViewLoadPromiseById(this.props.jimuLayerViewInfo.jimuMapViewId+"-"+this.props.jimuLayerViewInfo.jimuLayerId);e?e.then(e=>{this.props.onLayerViewCreated&&this.props.onLayerViewCreated(e)},e=>{this.props.onLayerViewFailed&&this.props.onLayerViewFailed(e)}):this.props.onLayerViewCreated&&this.props.onLayerViewCreated(null)}o.status===n.JimuMapViewStatus.Failed&&this.props.onLayerViewFailed&&this.props.onLayerViewFailed(null)}else this.props.onLayerViewCreated&&this.props.onLayerViewCreated(null)}render(){return null}}const re=n.ReactRedux.connect((e,t)=>({viewInfos:e&&e.jimuMapViewsInfo}))(ie);var se=function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{u(r.next(e))}catch(e){a(e)}}function o(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}u((r=r.apply(e,t||[])).next())}))};function ae(){return se(this,void 0,void 0,(function*(){return yield Promise.resolve()}))}}]))}}}));