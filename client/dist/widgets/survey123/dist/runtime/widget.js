System.register(["jimu-core","jimu-ui","jimu-arcgis","esri/tasks/support/Query","esri/geometry/SpatialReference"],(function(e){var t,r,s,o,i;return{setters:[function(e){t=e},function(e){r=e},function(e){s=e},function(e){o=e},function(e){i=e}],execute:function(){e(function(e){var t={};function r(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(s,o,function(t){return e[t]}.bind(null,o));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=529)}({0:function(e,r){e.exports=t},1:function(e,t){e.exports=r},185:function(e,t){e.exports=i},4:function(e,t){e.exports=s},475:function(e,t){e.exports='<svg viewBox="0 0 15 16" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero"><path d="M2 10.5v.5-2 .5h1v1H2v.5-2 1.5zm0-4V7 5v.5h1v1H2V7 5v1.5zM2 13h1v1a1 1 0 001 1h9a1 1 0 001-1V2a1 1 0 00-1-1H4a1 1 0 00-1 1v1H2V2a2 2 0 012-2h9a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2v-1zm0 0h1v1a1 1 0 001 1h9a1 1 0 001-1V2a1 1 0 00-1-1H4a1 1 0 00-1 1v1H2V2a2 2 0 012-2h9a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2v-1zm10.071-6.464l-.707-.708-2.828 2.829L7.12 7.243l-.707.707 2.122 2.121 3.535-3.535zm.707.707l-3.535 3.535a1 1 0 01-1.415 0l-2.12-2.121a1 1 0 010-1.414l.706-.707a1 1 0 011.414 0l.708.707 2.12-2.122a1 1 0 011.415 0l.707.707a1 1 0 010 1.415z"></path><path d="M1.5 3.5v1h2v-1h-2zm0-1h2a1 1 0 011 1v1a1 1 0 01-1 1h-2a1 1 0 01-1-1v-1a1 1 0 011-1zm0 5v1h2v-1h-2zm0-1h2a1 1 0 011 1v1a1 1 0 01-1 1h-2a1 1 0 01-1-1v-1a1 1 0 011-1zm0 5v1h2v-1h-2zm0-1h2a1 1 0 011 1v1a1 1 0 01-1 1h-2a1 1 0 01-1-1v-1a1 1 0 011-1z"></path></g></svg>'},529:function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return c}));var s=r(0),o=r(1),i=r(4),n=r(54);var a="Survey",u=r(76),l=r(185);class c extends s.React.PureComponent{constructor(e){super(e),this.API={Survey123WebForm:null},this.iconSurvey123=r(475),this.state={featureLayerViewDS:null},this._dsManager=s.DataSourceManager.getInstance(),this._isMapViewAddedClickEvent=!1,this.prepare=()=>{const e=this.props.config.portalUrl||this.props.portalUrl||"https://www.arcgis.com",t=!s.portalUrlUtils.isAGOLDomain(e);return Promise.resolve(!0).then(()=>!t||n.a.getSurveyHostUrlFromPortal(e)).then(()=>this.loadSurveyAPI())},this.loadSurveyAPI=()=>{const e=n.a.getSurvey123HostAPIUrl();return this.API.Survey123WebForm?Promise.resolve(this.API.Survey123WebForm):s.moduleLoader.loadModule(e).then(e=>(e&&e.Survey123WebForm?this.API=e:this.API.Survey123WebForm=e,this.API.Survey123WebForm))},this.updateDomId=()=>(this.domId="survey_container_"+(new Date).getTime(),this.domId),this.onActiveViewChange=e=>{e&&e.view&&(this._mapView=e.view,this._mapView.when(()=>{this._mapView.on("click",this.onMapClick)}))},this.onMapClick=e=>{this._mapView.hitTest(e).then(e=>{e.results.length&&e.results.forEach(e=>{const t=e.graphic,r=t.layer.id;if(this.props.useDataSources[0].rootDataSourceId+"-"+r!==this.props.useDataSources[0].dataSourceId)return;const s=t.layer,o=s.objectIdField||"objectid",i=new u({where:`${o} = ${t.attributes[o]}`,outFields:["*"],returnGeometry:!0,outSpatialReference:new l({wkid:4326})});s.queryFeatures(i).then(e=>{e.features&&e.features[0]&&this.featureLayerViewHandler(e.features[0])})})})},this.isDsConfigured=()=>!(!this.props.useDataSources||1!==this.props.useDataSources.length||!this.props.config.activeLinkData),this.doQuery=e=>{const t={geometry:e,spatialRelationship:"intersects",returnGeometry:!0};this.getUsedDataSource().getStatus()!==s.DataSourceStatus.Loading&&this.getUsedDataSource().load(t)},this.dataRender=e=>(e.type===i.ArcGISDataSourceTypes.WebMap&&this.mapViewHandler(e),e.type===s.DataSourceTypes.FeatureLayer&&this.featureLayerViewHandler(null,e),Object(s.jsx)("div",null)),this.checkWebformOptionChanged=e=>{const t=this._formOption;return!Object.is(t,e)&&(!(t||!e)||(t.itemId!==e.itemId||t.surveyItemId!==e.surveyItemId||t.portalUrl!==e.portalUrl||t.token!==e.token||t.surveyStatusCode!==e.surveyStatusCode||(t.hideElements?t.hideElements.asMutable():[]).sort().join(",")!==(e.hideElements?e.hideElements.asMutable():[]).sort().join(",")))},this.updateStyle=()=>{if("safari"===(window.jimuUA.browser?(window.jimuUA.browser.name+"").toLowerCase():"")){const e=document.querySelector("#"+this.domId);e.style.cssText="overflow-y: auto;";e.closest(".widget-content").style.cssText="position: absolute;"}},this.getClientId(),this.listenSurvey123WebformEvent()}componentDidMount(){n.a.setQueryObject(this.props.queryObject),this.prepare()}getUsedDataSource(){const e=this.props.useDataSources;let t=null;if(e&&e.length>0){const r=e[0].dataSourceId;t=this._dsManager.getDataSource(r)}return t}mapViewHandler(e){if(e&&e.view&&!1===this._isMapViewAddedClickEvent){const t=e.view;t.on("click",e=>{const r=t.toMap({x:e.x,y:e.y});if(r){const e=r.latitude,t=r.longitude;this.postMessageToSurvey123Webform({event:"survey123:onDrawEnd",data:{x:t,y:e}})}}),this._isMapViewAddedClickEvent=!0}}featureLayerViewHandler(e,t){let r=null;if(e)r=e;else if(t&&t.getSelectedRecords()){const e=t.getSelectedRecords();r=e>0?e[0]:null}if(this.props.config.activeLinkData&&this.props.config.fieldQuestionMapping){const e=r.attributes||{},t={};let s={},o=!1;this.props.config.fieldQuestionMapping.forEach(i=>{const n=i.field,a=i.question;if("geometry"===n){o=!0;const e=r.geometry;!e||"point"!==e.type||!e.y&&0!==e.y||!e.x&&0!==e.x?(e&&"polyline"===e.type&&e.paths&&e.paths.length||e&&"polygon"===e.type&&e.rings&&e.rings.length)&&(s=e):s={x:e.x,y:e.y}}else{const r=e[n];t[a]=r||""}}),t&&this.webform.setQuestionValue(t),o&&this.webform.setGeometry(s)}}listenSurvey123WebformEvent(){const e=e=>{if(e&&e.data){let t;try{t="string"==typeof e.data?JSON.parse(e.data):e.data&&e.data.payload?"string"==typeof e.data.payload?JSON.parse(e.data.payload):e.data.payload:e.data}catch(e){console.error(e)}const r=t.event,s=t.data;"survey123:onDrawPoint"===r&&this.onDrawPoint(s),"survey123:onFormLoaded"===r&&"survey123:onFormLoaded"===r&&t.contentHeight,"survey123:onSubmitted"===r&&console.log("survey123:onSubmitted!",s)}};window.addEventListener?window.addEventListener("message",e,!1):window.attachEvent("onmessage",e)}getClientId(){var e,t;const r=s.SessionManager.getInstance().getMainSession();this._clientId="",r&&r.clientId?this._clientId=r.clientId:(null===(t=null===(e=Object(s.getAppStore)().getState().appConfig)||void 0===e?void 0:e.attributes)||void 0===t?void 0:t.clientId)&&(this._clientId=Object(s.getAppStore)().getState().appConfig.attributes.clientId)}onDrawPoint(e){console.log("start draw point"),this._mapViewDSFromFeatureLayerView&&this.mapViewHandler(this._mapViewDSFromFeatureLayerView)}postMessageToSurvey123Webform(e){this.survey123webform&&this.survey123webform.contentWindow?this.survey123webform.contentWindow.postMessage(JSON.stringify(e),"*"):console.log("cannot find survey123webform iframe contentWindow!")}buildWebFormConfig(){const e=this.props.config,t={clientId:this._clientId||"survey123hub",container:this.domId||this.updateDomId(),itemId:e.surveyItemId,autoRefresh:3,isDebugMode:!1},r=e.portalUrl||this.props.portalUrl||"https://www.arcgis.com";t.portalUrl=r;const o=this.props.token;o&&(t.portalUrl=r,t.token=o);const i=e.hides||Object(s.Immutable)(["navbar","header","description","footer","theme"]);i.length>0&&(t.hideElements=i);const n=e.defaultValue;n&&"object"==typeof n&&null!=n&&(t.defaultValue=n);const a=this.props.stateProps?this.props.stateProps.surveyStatusCode:0;return a&&(t.surveyStatusCode=a),t}getWebformUrl(){const e=this.props.config,t=e.surveyItemId,r=e.portalUrl||this.props.portalUrl||"https://www.arcgis.com";let s=null;if(t){const o=[];"https://www.arcgis.com"!==r&&o.push("portalUrl="+r),"https://survey123dev.arcgis.com"===n.a.getSurvey123HostUrl()&&"https://www.arcgis.com"===r&&o.push("portalUrl="+r);let i=e.embeds||[];-1===i.indexOf("jsapi")&&(i=i.concat(["jsapi"])),-1===i.indexOf("onSubmitted")&&(i=i.concat(["onSubmitted"])),i.length>0&&o.push("embed="+i.join(","));const a=e.hides||["navbar","header","description","footer","theme"];a.length>0&&o.push("hide="+a.join(","));const u=e.defaultValue;u&&"object"==typeof u&&null!=u&&Object.keys(u).forEach(e=>{o.push(`field:${e}=${u[e]}`)});const l=e.open||"web",c=["web","menu","native"];l&&"web"!==l&&-1!==c.indexOf(l)&&o.push("open="+l);const h=this.props.token;h&&o.push("token="+h),o.push("autoRefresh=3"),s=n.a.getSurvey123WebformUrl(t,{queryParams:o})}return s}renderDS(){var e;let t=null,r=null;const o=this.buildWebFormConfig();this.isDsConfigured()&&(t=this.props.useDataSources[0].dataSourceId,r=this.props.useDataSources[0].rootDataSourceId);const n=this.checkWebformOptionChanged(o);this._formOption=o;if(this.getWebformUrl()&&(!this.webform||n)){document.querySelector("#"+this.domId)&&(document.querySelector("#"+this.domId).innerHTML="",this.webform=null),this.prepare().then(()=>(this.webform=new this.API.Survey123WebForm(o),this.updateStyle(),!0))}return t&&r&&this.isDsConfigured()?Object(s.jsx)(i.JimuMapViewComponent,{useMapWidgetId:null===(e=this.props.useMapWidgetIds)||void 0===e?void 0:e[0],onActiveViewChange:this.onActiveViewChange}):Object(s.jsx)("div",null)}render(){n.a.setQueryObject(this.props.queryObject);let e;return this.getWebformUrl()?(this.domId||this.updateDomId(),e=Object(s.jsx)("div",{className:"survey123__webform"},Object(s.jsx)("div",{className:"embed-container",id:this.domId}))):e=Object(s.jsx)("div",{className:"survey123__noSurvey"},Object(s.jsx)(o.WidgetPlaceholder,{icon:this.iconSurvey123,message:this.props.intl.formatMessage({id:"_widgetLabel",defaultMessage:a}),widgetId:""})),Object(s.jsx)("div",{css:(this.props.theme,s.css`
    &.survey123{
        width: 100%;
        height: 100%;
        overflow: auto;
        
        .title{
            font-weight: bold;
        }
    
        .survey123__noSurvey{
            width:100%;
            height:100%;
            text-align:center;
        }
    
        .survey123__webform{
            width:100%; 
            height:100%;

            .embed-container {
                position: relative; 
                height: 100%;
                // padding-bottom:80%; 
                width: 100%;
            } 
            
            .embed-container iframe, 
            .embed-container object, 
            .embed-container iframe{
                position: absolute; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: 100%;
                border: 0px; 
            } 
            small{
                position: absolute; 
                z-index: 40; 
                bottom: 0; 
                margin-bottom: -15px;
            }
        }    
    }
  `),className:"survey123"},e,this.renderDS())}}c.mapExtraStateProps=e=>({queryObject:e.queryObject})},54:function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));const s=new class{setQueryObject(e){const t=e?e.survey123:"",r=t?decodeURIComponent(t+""):"",s=this._urlParamToJson(r);this.queryObj=s}getSurveyHostUrlFromPortal(e){if(e=e||"https://www.arcgis.com",this.surveyUrlFromPortal||null===this.surveyUrlFromPortal)return Promise.resolve(this.surveyUrlFromPortal);const t=window.esriGeowConfig;if(t&&t.surveyUrl)return this.surveyUrlFromPortal=t.surveyUrl,Promise.resolve(this.surveyUrlFromPortal);let r="";e.endsWith("/")||(e+="/"),r=e+"home/js/arcgisonline/config.js";const s=document.createElement("script");return s.type="text/javascript",s.src=r,new Promise((e,t)=>{s.onload=()=>{const t=window.esriGeowConfig;t&&t.surveyUrl?(this.surveyUrlFromPortal=t.surveyUrl,e(t.surveyUrl)):(this.surveyUrlFromPortal=null,e(null))},s.onerror=()=>{console.log("Failed to get survey url from portal's config.js, will fallback to use the default survey123 url."),this.surveyUrlFromPortal=null,e(null)},document.getElementsByTagName("head")[0].appendChild(s)})}getSurvey123HostUrl(){let e="https://survey123.arcgis.com";this.surveyUrlFromPortal&&(e=this.surveyUrlFromPortal);let t=window.jimuConfig.hostEnv;if(this.queryObj&&this.queryObj.env&&(t=this.queryObj.env+"",t.startsWith("http://")||t.startsWith("https://")))return t;let r=!0;if("https://survey123.arcgis.com"!==e){const t=e.match(/https:\/\/survey123(.[^\.]*)\.arcgis\.com/);r=!(!t||!t.length)}return t&&"prd"!==t&&"prod"!==t&&r&&(e=`https://survey123${t}.arcgis.com`),e}getSurvey123HostAPIUrl(){let e=this.getSurvey123HostUrl()+"/api/jsapi/3.12";return this.queryObj&&this.queryObj.jsapi&&(e=this.getSurvey123HostUrl()+"/api/jsapi/"+this.queryObj.jsapi),e}createSurvey(e,t,r,s){return s=Object.assign({snippet:""},s||{}),Promise.resolve(!0).then(()=>{if(!(e&&t&&r&&r.token&&r.username))throw new Error("missing title, tags, username or token")}).then(()=>{const o=this.getSurvey123HostUrl()+"/api/survey/create",i={title:e,tags:t.join(","),snippet:s.snippet,thumbnailUrl:s.thumbnailUrl,token:r.token,username:r.username,portalUrl:r.portalUrl||"https://www.arcgis.com"};return fetch(o,{mode:"cors",method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(i)}).then(e=>{if(e.ok)return e.json();throw e})})}isPortal(e){return!["www.arcgis.com","devext.arcgis.com","qaext.arcgis.com"].find((t,r)=>-1!==e.indexOf(t))}querySurvey(e,t){return t=Object.assign({isShared:!1,isPublished:!0,isSearchAll:!0,queryFromClient:!1,surveyClientAPI:null},t||{}),Promise.resolve(!0).then(()=>{if(!e||!e.token||!e.username)throw new Error("missing token or username")}).then(()=>{const r={isShared:t.isShared,isPublished:t.isPublished,isSearchAll:t.isSearchAll,token:e.token,username:e.username,portalUrl:e.portalUrl||"https://www.arcgis.com"};if(t.searchSurveyType&&(r.searchSurveyType=t.searchSurveyType),t.queryFromClient)return t.surveyClientAPI?t.surveyClientAPI.survey123.searchSurvey(r).then(e=>{if(e&&e.results)return e.results;throw e}):(console.log("Survey client api is not provided."),null);{let e=this.getSurvey123HostUrl()+"/api/survey/search";return e=`${e}?${Object.keys(r).map(e=>e+"="+r[e]).join("&")}`,fetch(e,{mode:"cors",method:"GET"}).then(e=>{if(e.ok)return e.json();throw e}).then(e=>{if(e&&e.results)return e.results;if(e&&Array.isArray(e))return e;throw e})}})}getSurvey123DesignerUrl(e,t){t=Object.assign({},t||{});let r=`${this.getSurvey123HostUrl()}/surveys/${e}/design?embed=exb`;return t.portalUrl&&"https://www.arcgis.com"!==t.portalUrl&&(r+="&portalUrl="+t.portalUrl),("https://survey123dev.arcgis.com"===this.getSurvey123HostUrl()&&!t.portalUrl||"https://www.arcgis.com"===t.portalUrl)&&(r+="&portalUrl="+t.portalUrl),r}getSurvey123WebformUrl(e,t){t=Object.assign({queryParams:[]},t||{});let r=`${this.getSurvey123HostUrl()}/share/${e}`;return t.queryParams.length>0&&(r+="?"+t.queryParams.join("&")),r}flatQuestions(e){let t=[];return e.forEach(e=>{e.questions?"esriQuestionTypeRepeat"!==e.type&&(t=t.concat(this.flatQuestions(e.questions))):t.push(e)}),t}getSurveyQuestionFields(e,t){return Promise.resolve(!0).then(()=>{if(!e||!t||!t.token)throw new Error("missing surveyItemId or token")}).then(()=>{let r=`${this.getSurvey123HostUrl()}/api/survey/${e}/form`;const s={token:t.token};return r=`${r}?${Object.keys(s).map(e=>e+"="+s[e]).join("&")}`,fetch(r,{mode:"cors",method:"GET"}).then(e=>{if(e.ok)return e.json();throw e})}).then(e=>{const t=[];if(e&&e.questions&&e.questions.length>0){this.flatQuestions(e.questions).forEach(e=>{const r=(e.type+"").replace("esriQuestionType","");(e.fieldName||["geopoint","polyline","polygon"].indexOf(r.toLowerCase())>=0)&&t.push({name:e.fieldName||e.name,label:e.label})})}return t})}_urlParamToJson(e){if(!e)return null;const t=(e+="").split(";");if(t.length<2&&e.split(":").length<2)return e.split(",").length>1?e.split(","):e;{const e={};return t.forEach(t=>{const r=(t+"").split(":");if(r.length>1){const t=r[0];let s=(Array.isArray(r.slice(1))?r.slice(1):[]).join(":");s.length&&"{"===s[0]&&(s=this._stringToJson(s)),"string"==typeof s&&s.split(",").length>1&&(s=s.split(",")),e[t]=s}}),e}}_stringToJson(e){let t=e;try{t=JSON.parse(e)}catch(r){t=e}return t}}},76:function(e,t){e.exports=o}}))}}}));