System.register(["jimu-core","jimu-ui","jimu-layouts/layout-runtime"],(function(e){var t,o,s;return{setters:[function(e){t=e},function(e){o=e},function(e){s=e}],execute:function(){e(function(e){var t={};function o(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=e,o.c=t,o.d=function(e,t,s){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(o.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(s,r,function(t){return e[t]}.bind(null,r));return s},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=520)}({0:function(e,o){e.exports=t},1:function(e,t){e.exports=o},332:function(e,t){e.exports='<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M2 1a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V2a1 1 0 00-1-1H2zm0-1h12a2 2 0 012 2v12a2 2 0 01-2 2H2a2 2 0 01-2-2V2a2 2 0 012-2zM1 4h14v1H1V4zm1.5-1a.5.5 0 110-1 .5.5 0 010 1zm2 0a.5.5 0 110-1 .5.5 0 010 1zm2 0a.5.5 0 110-1 .5.5 0 010 1zm-.646 9.646a.5.5 0 11-.708.708l-3-3a.5.5 0 010-.708l3-3a.5.5 0 11.708.708L3.207 10l2.647 2.646zm4.292 0L12.793 10l-2.647-2.646a.5.5 0 11.708-.708l3 3a.5.5 0 010 .708l-3 3a.5.5 0 11-.708-.708zM8.982 6.62a.5.5 0 01.354.613l-1.553 5.795a.5.5 0 11-.966-.259L8.37 6.973a.5.5 0 01.612-.354z" fill="#000" fill-rule="nonzero"></path></svg>'},42:function(e,t,o){"use strict";var s;o.d(t,"a",(function(){return s})),function(e){e.Url="url",e.Code="code"}(s||(s={}))},520:function(e,t,o){"use strict";o.r(t),o.d(t,"default",(function(){return p}));var s=o(0),r=o(1),n=o(42),i={_widgetLabel:"Embed",embedHint:"Embed by URL or code",unSupportUrl:"It's not a valid URL.",unSupportIframeUrl:"Sorry, this content could not be embedded. It may restrict the embedding of content from other sites."};const a=e=>{try{let t=JSON.stringify(e);return t=encodeURIComponent(t),t}catch(e){console.error(e)}};class l extends s.BaseVersionManager{constructor(){super(...arguments),this.versions=[{version:"1.0.0",description:"The first release.",upgrader:e=>{var t,o;const s=null===(t=null==e?void 0:e.functionConfig)||void 0===t?void 0:t.embedType,r=null===(o=null==e?void 0:e.functionConfig)||void 0===o?void 0:o.content;return s?(e=e.set("embedType",s),e=s===n.a.Url?e.set("staticUrl",r):e.set("embedCode",r)):e=e.set("embedType",n.a.Url),e=e.without("functionConfig")}},{version:"1.4.0",description:"Enhance the URL editor.",upgrader:(e,t)=>{var o,r;const i=null==e?void 0:e.embedType,l=null==e?void 0:e.expression,c=null==e?void 0:e.staticUrl,d=null===(r=null===(o=Object(s.getAppStore)().getState())||void 0===o?void 0:o.appConfig)||void 0===r?void 0:r.widgets[t],u=null==d?void 0:d.useDataSourcesEnabled;if((null==l?void 0:l.name)&&(e=e.set("enableLabel",!0).set("label",l.name)),i===n.a.Url&&c){const t=`<p>${c}</p>`;e=e.set("expression",t)}else if(i===n.a.Url&&l&&!1!==u){const t=(e=>{let t="";const{parts:o}=e;if(o.length>0){let e=!1;const r={name:"",parts:[]};let n=0,i=0,l="";o.forEach(o=>{const{type:c,dataSourceId:d,exp:u}=o;if(e){if(r.name+=u,r.parts.push(o),d&&(l=d),c===s.ExpressionPartType.Operator&&"("===u)n++;else if(c===s.ExpressionPartType.Operator&&")"===u&&(i++,i===n)){n=0,i=0,e=!1;const o=s.utils.getUUID(),c=document&&document.createElement("exp");c.setAttribute("data-uniqueid",o),c.setAttribute("data-dsid",l),c.setAttribute("data-expression",a(r)),c.innerHTML=r.name,t+=c.outerHTML}return!1}if(c===s.ExpressionPartType.Field){const e=s.utils.getUUID(),r=document&&document.createElement("exp");r.setAttribute("data-uniqueid",e),r.setAttribute("data-dsid",d),r.setAttribute("data-expression",a({name:u,parts:[o]})),r.innerHTML=u,t+=r.outerHTML}else c===s.ExpressionPartType.String?t+=u.replace(/(^['|"]*|['|"]*$)/g,""):c===s.ExpressionPartType.Number?t+=u:c===s.ExpressionPartType.Function&&(e=!0,r.name=u,r.parts.push(o))})}return`<p>${t}</p>`})(l);e=e.set("expression",t)}return e}}]}}const c=new l;var d=o(7),u=function(e,t,o,s){return new(o||(o=Promise))((function(r,n){function i(e){try{l(s.next(e))}catch(e){n(e)}}function a(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,a)}l((s=s.apply(e,t||[])).next())}))};class p extends s.React.PureComponent{constructor(e){super(e),this.iframeOnLoad=e=>{this.setState({isResetting:!1})},this.checkSafeDomain=e=>{let t=!1;if(!e)return t;const o=[".arcgis.com",".esri.com"];let s="";e.includes("https://")&&(s=e.substr(8).split("/")[0]);for(const e of o)if(s.includes(e)){t=!0;break}return t},this.processUrl=e=>{var t,o,r;if(!e)return e;const n=e.toLowerCase();if(/https:\/\/vimeo\.com\/.*/.test(n)){const t=(e=s.urlUtils.removeSearchFromUrl(e)).split("/");return"https://player.vimeo.com/video/"+t[t.length-1]}if(/https:\/\/www\.youtube\.com\/watch\?.*v=.*/.test(n)){const o=null===(t=s.queryString.parseUrl(e))||void 0===t?void 0:t.query;return"https://www.youtube.com/embed/"+(null==o?void 0:o.v)}if(/https:\/\/youtu\.be\/.*/.test(n)){const t=(e=s.urlUtils.removeSearchFromUrl(e)).split("/");return"https://www.youtube.com/embed/"+t[t.length-1]}if(/https:\/\/www\.facebook\.com\/.*\/videos\/.*/.test(n))return`https://www.facebook.com/plugins/video.php?href=${n}&show_text=0`;this.checkURLFormat(e)||(e="about:blank");const i=[".maps.arcgis.com",".mapsdevext.arcgis.com",".mapsqa.arcgis.com"];let a="";e.includes("https://")&&(a=e.substr(8).split("/")[0]);let l=!1,c="";for(const e of i)if(a.includes(e)){switch(l=!0,e){case".maps.arcgis.com":c="prod";break;case".mapsdevext.arcgis.com":c="dev";break;case".mapsqa.arcgis.com":c="qa"}break}const d=window.jimuConfig.hostEnv;if(l&&c===d){const t=Object(s.getAppStore)().getState();if(t&&t.user){const s=null===(o=null==t?void 0:t.portalSelf)||void 0===o?void 0:o.urlKey,n=null===(r=null==t?void 0:t.portalSelf)||void 0===r?void 0:r.customBaseUrl;a&&s&&n&&(e=e.replace(a,`${s}.${n}`))}}return e},this.checkURLFormat=e=>{if(!e||""===e)return this.setState({errMessage:this.errMessages.unSupportUrl}),!1;if("about:blank"===e)return!1;if(!new RegExp("^(([h][t]{2}[p][s])?://)").test(e))return this.setState({errMessage:this.errMessages.httpsCheck}),!1;if(new RegExp("^(([h][t]{2}[p][s])?://localhost)").test(e))return!0;const t=e.indexOf(".");return!(t<0||t===e.length-1)||(this.setState({errMessage:this.errMessages.unSupportUrl}),!1)},this.formatMessage=e=>this.props.intl.formatMessage({id:e,defaultMessage:i[e]}),this.fetchUrl=(e,t)=>u(this,void 0,void 0,(function*(){const o=s.SessionManager.getInstance().getMainSession(),r=yield fetch(e,{method:"post",headers:{"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},body:JSON.stringify({token:null==o?void 0:o.token,url:t})}).catch(e=>{});if(!r)return Promise.resolve(null);const n=yield r.json().catch(e=>{});return Promise.resolve(n)})),this.isUsedDataSource=e=>{e||(e=this.props);const{useDataSources:t,useDataSourcesEnabled:o}=e;return o&&t&&t.length>0},this.reload=()=>{const{config:e}=this.props;if(this.ifr)if(e.embedType===n.a.Code){const e=this.ifr.srcdoc;this.ifr.srcdoc=e}else{const e=this.ifr.src;this.ifr.src=e}},this.loadContent=()=>{const{config:e}=this.props,{content:t}=this.state,{embedType:o}=e;this.ifr&&(o===n.a.Code?this.ifr.srcdoc="<script>\n      if(window !== window.parent || window !== window.top){\n        window.parent = undefined\n        window.top = undefined\n        document.cookie = undefined\n        localStorage = undefined\n        sessionStorage = undefined\n      }\n    <\/script>"+t:(this.ifr.removeAttribute("srcdoc"),this.ifr.removeAttribute("src"),setTimeout(()=>{this.ifr&&(this.ifr.src=this.processUrl(t))},100)))},this.onHtmlResolved=e=>{const{config:t}=this.props,{enableLabel:o,label:s}=t,r=e?e.replace(/(^\s*|\s*$)/g,""):"",n=r.indexOf("{")>0&&o&&!!s,i=0===r.indexOf("{")||n;this.setState({content:e,reuseContent:e,resolveErr:i})};const{config:t}=e,{embedType:o,embedCode:r}=t;this.errMessages={httpsCheck:this.formatMessage("httpsUrlMessage"),unSupportUrl:this.formatMessage("unSupportUrl"),unSupportIframeUrl:this.formatMessage("unSupportIframeUrl")},this.checkUrl=this.checkUrl.bind(this);const a={content:o===n.a.Url?t.expression:r,reuseContent:"",loadErr:!1,resolveErr:!1,refreshFlag:!1,refreshInterval:10,refreshTimer:void 0,changeTimerFlag:!1};this.state=a,this.shouldRenderIframeInView=!1}static getDerivedStateFromProps(e,t){if(!e||0===Object.keys(e).length||!t||0===Object.keys(t).length)return null;const{config:o}=e,{autoRefresh:s=!1,autoInterval:r=10}=o,{refreshFlag:n,refreshInterval:i}=t;return s!==n||r!==i?{refreshFlag:s,refreshInterval:r,changeTimerFlag:!0}:null}componentDidMount(){const{config:e}=this.props,{content:t}=this.state;t&&t.trim().length>0&&this.setState({isResetting:!0},()=>{e.embedType===n.a.Url?this.checkUrl(this.processUrl(t)):this.loadContent()})}componentDidUpdate(e,t){var o,r,i,a;const{appMode:l,config:c,sectionNavInfos:u,layoutId:p}=this.props,{embedCode:f,embedType:h,autoRefresh:m,autoInterval:v}=c,g=m!==e.config.autoRefresh||v!==e.config.autoInterval,{content:b,reuseContent:w,refreshFlag:y,refreshInterval:S,refreshTimer:U,changeTimerFlag:x}=this.state,{content:I}=t;if((l!==e.appMode&&l===s.AppMode.Design||g)&&this.reload(),h!==e.config.embedType){const e=h===n.a.Url?w:f;this.setState({loadErr:!1,resolveErr:!1,content:e})}else h===n.a.Code&&e.config.embedCode!==f&&this.setState({content:f});b!==I&&this.setState({isResetting:!!b,loadErr:!1},()=>{h===n.a.Url?this.checkUrl(this.processUrl(b)):this.loadContent()});const C=e.sectionNavInfos;if(this.needLoadContentInView&&u&&C!==u){const e=[];for(const t in u){u[t]!==(null==C?void 0:C[t])&&e.push(t)}const t=Object(s.getAppStore)().getState(),n=null==t?void 0:t.appConfig,l=null===(o=null==t?void 0:t.appRuntimeInfo)||void 0===o?void 0:o.currentPageId,c=d.utils.getCurrentSizeMode(),f=null===(a=null===(i=null===(r=null==n?void 0:n.pages)||void 0===r?void 0:r[l])||void 0===i?void 0:i.layout)||void 0===a?void 0:a[c],h=d.searchUtils.buildLayoutStructure(n,f,l,d.ParentType.Page,c),{sectionId:m}=d.searchUtils.findParentViewId(p,h);e.includes(m)&&this.loadContent()}if(!U&&y){const e=setInterval(()=>{if(h===n.a.Url){if(this.ifr){const e=this.ifr.src;this.ifr.src="",setTimeout(()=>{this.ifr&&(this.ifr.src=e)},100)}}else{const e=this.ifr.srcdoc;this.ifr.srcdoc=e}},60*S*1e3);this.setState({refreshTimer:e})}else U&&!y&&(clearInterval(U),this.setState({refreshTimer:void 0}));if(x&&!y){U&&clearInterval(U);const e=setInterval(()=>{if(h===n.a.Url){if(this.ifr){const e=this.ifr.src;this.ifr.src="",setTimeout(()=>{this.ifr&&(this.ifr.src=e)},100)}}else{const e=this.ifr.srcdoc;this.ifr.srcdoc=e}},60*S*1e3);this.setState({refreshTimer:e,changeTimerFlag:!1})}}checkUrl(e){var t,o,r;const{config:n}=this.props,{enableLabel:i,label:a}=n;if(!this.checkURLFormat(e))return void this.setState({loadErr:!0});this.setState({loadErr:!1});const l=null===(r=null===(o=null===(t=Object(s.getAppStore)())||void 0===t?void 0:t.getState())||void 0===o?void 0:o.appRuntimeInfo)||void 0===r?void 0:r.appMode;if(window.jimuConfig.isInBuilder&&l!==s.AppMode.Run&&!window.jimuConfig.isInPortal||this.loadContent(),!e||!window.jimuConfig.isInBuilder||l===s.AppMode.Run||window.jimuConfig.isInPortal)return;["https://www.facebook.com/plugins/video.php?show_text=0&href=","https://www.youtube.com/embed/","https://player.vimeo.com/video/"].includes(e)?this.setState({loadErr:!1}):0===e.indexOf("{")||e.indexOf("{")>0&&i&&a||this.fetchUrl(window.location.origin+"/rest/check_url",e).then(t=>{var o,s,r;let n=!0;if(t&&t.success){const i=t.data,a=null==i?void 0:i.status,l=['default-src "self"',"frame-ancestors"],c=e=>{let t=!1;return l.map(o=>{e.indexOf(o)>0&&(t=!0)}),t};if(a&&a<400){const t=null===(o=null==i?void 0:i.headers)||void 0===o?void 0:o["content-security-policy"];t&&c(t)&&(n=!1);const a=null===(r=null===(s=null==i?void 0:i.headers)||void 0===s?void 0:s["x-frame-options"])||void 0===r?void 0:r.toLowerCase();a&&("deny"===a?n=!1:"sameorigin"===a&&(this.isOriginSameAsLocation(e)||(n=!1)))}else n=!1}else n=!1;const i={loadErr:!n};n?this.loadContent():(i.isResetting=!1,i.errMessage=this.errMessages.unSupportIframeUrl),this.setState(i)})}isOriginSameAsLocation(e){const t=[".arcgis.com",".esri.com"];var o=window.location,s=/(\w+:)?(?:\/\/)([\w.-]+)?(?::(\d+))?\/?/.exec(e)||[],r={protocol:s[1]||"",host:s[2]||"",port:s[3]||""};let n="";for(const e of t)if(o.host.includes(e)){n=e;break}if(s[2].includes(n))return!0;const i=e=>e.port||{"http:":80,"https:":443}[e.protocol||o.protocol];return!!(r.protocol&&r.protocol==o.protocol&&r.host&&r.host==o.host&&r.host&&i(r)==i(o))}render(){const{isResetting:e,loadErr:t,errMessage:i,resolveErr:a,content:l}=this.state,{theme:c,id:u,config:p}=this.props,{embedCode:f,embedType:h,expression:m,enableLabel:v,label:g}=p;if(h===n.a.Code?!f:!m||"<p><br></p>"===m)return s.React.createElement(r.WidgetPlaceholder,{widgetId:this.props.id,icon:o(332),message:this.formatMessage("embedHint")});let b=!0;return h===n.a.Url&&(b=!this.checkSafeDomain(l)),s.React.createElement(d.ViewVisibilityContext.Consumer,null,({isInView:o,isInCurrentView:d})=>{let f=!0;return this.shouldRenderIframeInView||(f=!o||d,f&&(this.shouldRenderIframeInView=!0)),this.needLoadContentInView=o&&d,s.React.createElement(s.React.Fragment,null,f&&s.React.createElement("div",{style:{width:"100%",height:"100%",position:"relative"},className:"jimu-widget widget-embed"},b?s.React.createElement("iframe",{id:"ifrSandbox",className:"iframe-"+u,style:{width:"100%",height:"100%"},sandbox:"allow-scripts allow-same-origin allow-forms allow-popups allow-presentation allow-popups-to-escape-sandbox",allowFullScreen:!0,onLoad:this.iframeOnLoad,frameBorder:"0",ref:e=>{this.ifr=e},allow:"geolocation","data-testid":"embedSandbox"}):s.React.createElement("iframe",{id:"ifrSafe",className:"iframe-"+u,style:{width:"100%",height:"100%"},allowFullScreen:!0,onLoad:this.iframeOnLoad,frameBorder:"0",ref:e=>{this.ifr=e},allow:"geolocation","data-testid":"embedSafe"}),e&&s.React.createElement("div",{className:"jimu-secondary-loading"}),t&&s.React.createElement("div",{className:"mask text-center",style:{position:"absolute",left:0,right:0,top:0,bottom:0,backgroundColor:c.colors.white}},s.React.createElement("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)"}},s.React.createElement(r.AlertButton,{buttonType:"tertiary",size:"small",type:"warning"}),i)),a&&s.React.createElement("div",{"data-testid":"test-expressionMask",className:"mask text-center",style:{position:"absolute",left:0,right:0,top:0,bottom:0,backgroundColor:c.colors.white}},s.React.createElement("div",{className:!(v&&g)&&"text-truncate",style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"50%"}},v&&g||l)),h===n.a.Url&&s.React.createElement(r.DynamicUrlResolver,{widgetId:u,useDataSources:this.props.useDataSources,value:p.expression,onHtmlResolved:this.onHtmlResolved})))})}}p.versionManager=c,p.mapExtraStateProps=(e,t)=>{var o,s;return{appMode:null===(o=null==e?void 0:e.appRuntimeInfo)||void 0===o?void 0:o.appMode,sectionNavInfos:null===(s=null==e?void 0:e.appRuntimeInfo)||void 0===s?void 0:s.sectionNavInfos}}},7:function(e,t){e.exports=s}}))}}}));