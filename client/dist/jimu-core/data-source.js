System.register(["jimu-core"],(function(e){var t;return{setters:[function(e){t=e}],execute:function(){e(function(e){var t={};function r(i){if(t[i])return t[i].exports;var a=t[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(i,a,function(t){return e[t]}.bind(null,a));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=204)}({1:function(e,r){e.exports=t},2:function(e,t,r){"use strict";var i,a,o,s,n,u,c;r.d(t,"b",(function(){return i})),r.d(t,"c",(function(){return a})),r.d(t,"f",(function(){return o})),r.d(t,"h",(function(){return s})),r.d(t,"e",(function(){return n})),r.d(t,"g",(function(){return u})),r.d(t,"d",(function(){return c})),r.d(t,"a",(function(){return d})),function(e){e.NotCreated="NOT_CREATED",e.Created="CREATED",e.CreateError="CREATE_ERROR",e.NotReady="NOT_READY",e.Unloaded="UNLOADED",e.Loading="LOADING",e.Loaded="LOADED",e.LoadError="LOAD_ERROR",e.Saving="SAVING",e.Saved="SAVED",e.SaveError="SAVE_ERROR",e.Closed="CLOSED",e.Connecting="CONNECTING",e.Connected="CONNECTED",e.Closing="CLOSING"}(i||(i={})),function(e){e.SimpleLocal="SIMPLE_LOCAL",e.CSV="CSV",e.FeatureLayer="FEATURE_LAYER",e.SceneLayer="SCENE_LAYER",e.GroupLayer="GROUP_LAYER",e.FeatureService="FEATURE_SERVICE",e.MapService="MAP_SERVICE",e.SceneService="SCENE_SERVICE"}(a||(a={})),function(e){e.FeatureLayer="Feature Layer",e.Table="Table",e.GroupLayer="Group Layer",e.SceneLayerPoint="Point",e.SceneLayer3DObject="3DObject"}(o||(o={})),function(e){e.FeatureService="FeatureServer",e.MapService="MapServer",e.SceneService="SceneServer"}(s||(s={})),function(e){e.WebMap="Web Map",e.WebScene="Web Scene",e.FeatureService="Feature Service",e.MapService="Map Service",e.SceneService="Scene Service",e.FeatureCollection="Feature Collection"}(n||(n={})),function(e){e.FeatureLayer="feature",e.MapImageLayer="map-image",e.TileLayer="tile",e.GroupLayer="group",e.SceneLayer="scene"}(u||(u={})),function(e){e.InAllData="IN_ALL_DATA",e.InRemoteConfigView="IN_REMOTE_CONFIG_VIEW",e.InConfigView="IN_CONFIG_VIEW",e.InRuntimeView="IN_RUNTIME_VIEW"}(c||(c={}));class d extends Error{constructor(e,t){super(t),this.dataSourceId=e}}},204:function(e,t,r){"use strict";r.r(t),r.d(t,"JimuCoreDataSourceFactory",(function(){return N})),r.d(t,"AbstractDataSource",(function(){return s})),r.d(t,"AbstractLayerFolderDataSource",(function(){return d})),r.d(t,"AbstractLoadableDataSource",(function(){return h})),r.d(t,"AbstractQueriableDataSource",(function(){return p})),r.d(t,"AbstractSetDataSource",(function(){return u})),r.d(t,"AbstractDataRecord",(function(){return D})),r.d(t,"SimpleDataRecordImpl",(function(){return I})),r.d(t,"SimpleDataRecordSetImpl",(function(){return R})),r.d(t,"DataSourceStatus",(function(){return i.b})),r.d(t,"DataSourceTypes",(function(){return i.c})),r.d(t,"SupportedLayerServiceTypes",(function(){return i.f})),r.d(t,"SupportedServiceTypes",(function(){return i.h})),r.d(t,"SupportedItemTypes",(function(){return i.e})),r.d(t,"SupportedLayerTypes",(function(){return i.g})),r.d(t,"QueryScope",(function(){return i.d})),r.d(t,"DataSourceError",(function(){return i.a})),r.d(t,"FeatureDataRecordImpl",(function(){return A})),r.d(t,"CsvDataSourceImpl",(function(){return C})),r.d(t,"FeatureLayerDataSourceImpl",(function(){return O})),r.d(t,"FeatureServiceDataSourceImpl",(function(){return V})),r.d(t,"GroupLayerDataSourceImpl",(function(){return j})),r.d(t,"MapServiceDataSourceImpl",(function(){return E})),r.d(t,"SimpleLocalDataSourceImpl",(function(){return T})),r.d(t,"SceneServiceDataSourceImpl",(function(){return B})),r.d(t,"SceneLayerDataSourceImpl",(function(){return M}));var i=r(2),a=r(1),o=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class s{constructor(e){if(this.isDataSourceSet=!1,this.records=[],Object.assign(this,e),this.originDataSourceJson=e.dataSourceJson,e.dataSourceJson)this.isDataView=!1,this.isLocal=!1,e.dataSourceJson.url&&(this.url=e.dataSourceJson.url);else{if(!e.belongToDataSource)return void console.error("bad DataSourceConstructorOptions.");e.localId?(this.isLocal=!0,this.isDataView=!1):(this.isLocal=!1,this.isDataView=!0)}this.getDataSourceJson().isDataInDataSourceInstance&&(this.sourceRecords=e.sourceRecords,this.url=null),this.isLocal?this.listenSelection=!1:this.listenSelection=!0}get url(){if(!a.dataSourceUtils.getWhetherUseProxy())return this._url;return a.dataSourceUtils.getDataSourceProxyUrl(this._url)||this._url}set url(e){this._url=e}getLabel(){const e=this.getDataSourceJson().label||this.getSchema().label;if(this.isLocal)return this.belongToDataSource.getLabel();if(this.isDataView){const t=this.getMainDataSource().getDataSourceJson(),r=(null==t?void 0:t.dataViews)&&t.dataViews[this.dataViewId];return(null==r?void 0:r.label)||e}return e}getDataSourceJson(){if(this.isDataView||this.isLocal){let e=this.getMainDataSource().getDataSourceJson();return this.dataViewId===a.CONSTANTS.SELECTION_DATA_VIEW_ID&&(e=e.set("isDataInDataSourceInstance",!0)),e}return this.dataSourceJson}setDataSourceJson(e){e?this.dataSourceJson?this.dataSourceJson=this.traverseToMergeDataSourceJson(this.dataSourceJson,e):this.dataSourceJson=e:this.dataSourceJson=this.originDataSourceJson}traverseToMergeDataSourceJson(e,t){if(!e&&!t)return console.error("Can not merge data source json since do not have base data source json or new data source json."),Object(a.Immutable)({});if(!e)return t;if(!t)return e;let r=e.merge(t.asMutable({deep:!0}));return["label","isHidden","useFields","query","dataViews","childDataSourceJsons","schema","url","itemId","portalUrl"].forEach(i=>{t[i]||(r=r.without(i)),t[i]&&"schema"===i&&(r=r.set("schema",t.schema)),!t[i]||"url"!==i&&"portalUrl"!==i&&"itemId"!==i||(r=r.set(i,t[i]),this[i]=t[i],this.canSaveSource()&&this.getAllDerivedDataSources().forEach(e=>{e[i]=t[i]})),e[i]&&"useFields"===i&&(r=t.schema?r.set("useFields",e.useFields.filter(e=>{var r;return!!(null===(r=t.schema.fields)||void 0===r?void 0:r[e])})):r.set("useFields",e.useFields))}),r.childDataSourceJsons&&Object.keys(r.childDataSourceJsons).forEach(i=>{var a;const o=this.traverseToMergeDataSourceJson(null===(a=null==e?void 0:e.childDataSourceJsons)||void 0===a?void 0:a[i],t.childDataSourceJsons[i]);r=r.setIn(["childDataSourceJsons",i],o)}),r}getSchema(){return this.isDataView||this.isLocal?this.getMainDataSource().getSchema():this.schema||{}}getSelectedFields(){var e,t,r,i;let a;if(this.isLocal)return this.belongToDataSource.getSelectedFields();const o=(null===(e=this.getSchema())||void 0===e?void 0:e.fields)?Object.keys(this.getSchema().fields):[];if(a=this.isDataView?null===(r=null===(t=this.getDataSourceJson().dataViews)||void 0===t?void 0:t[this.dataViewId])||void 0===r?void 0:r.outFields:null===(i=this.getDataSourceJson().query)||void 0===i?void 0:i.outFields,!a&&!this.selectedFields)return o;let s=o;return a&&(s=s.filter(e=>a.includes(e))),this.selectedFields&&(s=s.filter(e=>this.selectedFields.includes(e))),s}setSelectedFields(e){this.selectedFields=e}setSchema(e){this.schema=e}fetchSchema(){return o(this,void 0,void 0,(function*(){return yield Promise.resolve(Object(a.Immutable)({}))}))}getFetchedSchema(){return this.isDataView||this.isLocal?this.getMainDataSource().getFetchedSchema():this.fetchedSchema}setFetchedSchema(e){this.fetchedSchema=e}getGeometryType(){return null}getReversedConfigSchema(){if(this.isDataView||this.isLocal)return this.getMainDataSource().getReversedConfigSchema();if(this.reverseSchema)return this.reverseSchema;if(this.isDataSourceSet){const e=this.getDataSourceJson().schema,t={childSchemas:{}};if(!e)return Object(a.Immutable)({});if(!e.childSchemas)return Object(a.Immutable)({label:e.label,childId:e.childId,jimuChildId:e.jimuChildId});Object.keys(e.childSchemas).forEach(r=>{const i=e.childSchemas[r].childId;t.childSchemas[i]?t.childSchemas[i].push(this.getOneReversedConfigSchema(e.childSchemas[r])):t.childSchemas[i]=[this.getOneReversedConfigSchema(e.childSchemas[r])]}),this.reverseSchema=Object(a.Immutable)(t)}else this.reverseSchema=this.getOneReversedConfigSchema(this.getDataSourceJson().schema);return this.reverseSchema}setRecords(e){this.records=e,this.addVersion()}setJsonData(e){console.error("please implement this. setJsonData")}getOneReversedConfigSchema(e){const t={};return e?(t.fields={},Object.keys(e.fields).forEach(r=>{const i=e.fields[r].asMutable({deep:!0});t.fields[i.name]?t.fields[i.name].push(i):t.fields[i.name]=[i]}),e.childId&&(t.childId=e.childId),e.jimuChildId&&(t.jimuChildId=e.jimuChildId),Object(a.Immutable)(t)):Object(a.Immutable)(t)}getStatus(){return Object(a.getAppStore)().getState().dataSourcesInfo[this.id]&&Object(a.getAppStore)().getState().dataSourcesInfo[this.id].status}setStatus(e){Object(a.getAppStore)().dispatch(a.appActions.dataSourceStatusChanged(this.id,e))}getCountStatus(){return Object(a.getAppStore)().getState().dataSourcesInfo[this.id]&&Object(a.getAppStore)().getState().dataSourcesInfo[this.id].countStatus}setCountStatus(e){Object(a.getAppStore)().dispatch(a.appActions.dataSourceCountStatusChanged(this.id,e))}getVersion(){var e;return null===(e=Object(a.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.version}addVersion(){Object(a.getAppStore)().dispatch(a.appActions.dataSourceVersionAdded(this.id))}getSourceVersion(){var e;return this.canSaveSource()?null===(e=Object(a.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.sourceVersion:this.getMainDataSource().getSourceVersion()}addSourceVersion(){this.canSaveSource()&&Object(a.getAppStore)().dispatch(a.appActions.dataSourceSourceVersionAdded(this.id))}getSelectedRecordIdsFromInfo(){var e,t;return(null===(t=null===(e=Object(a.getAppStore)().getState().dataSourcesInfo)||void 0===e?void 0:e[this.id])||void 0===t?void 0:t.selectedIds)||Object(a.Immutable)([])}setSelectedRecordIdsToInfo(e,t){e&&(this.getListenSelection()||this.id===(null==t?void 0:t.id))&&Object(a.getAppStore)().dispatch(a.appActions.dataSourceSelectedIdsChanged(this.id,e))}getRecords(){return this.records}getRecordsWithSelection(){return this.concatRecordsAndSelection(this.getRecords(),this.getSelectedRecords())}concatRecordsAndSelection(e,t){let r=e||[];return null==t||t.forEach(t=>{(null==e?void 0:e.some(e=>(null==e?void 0:e.getId())===(null==t?void 0:t.getId())))||(r=r.concat(t))}),r}clearSourceRecordsNotAddVersion(){this.clearRecordsNotAddVersion(),this.sourceRecords=[]}clearSourceRecords(){this.clearSourceRecordsNotAddVersion(),this.addSourceVersion(),this.addVersion()}setSourceRecords(e){this.canSaveSource()&&(this.clearRecordsNotAddVersion(),a.lodash.defer(()=>{this.setSelectedRecordIdsToInfo([],this.getMainDataSource())}),this.sourceRecords=e.filter(e=>!!e).map(e=>(e.dataSource=this,e)),this.getAllDerivedDataSources().forEach(e=>{e.clearRecords(),a.lodash.defer(()=>{e.setSelectedRecordIdsToInfo([],e.getMainDataSource())})}),this.addSourceVersion(),this.addVersion())}getSourceRecords(){var e;if(!this.canSaveSource())return this.isLocalViewOfSelectionView()?this.belongToDataSource.getSourceRecords():this.getMainDataSource().getSourceRecords();let t=this.sourceRecords||[];if(this.useNoSelectionView()){const r=this.getMainDataSource().getDataView(a.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION);r&&(t=null===(e=r.getRecords())||void 0===e?void 0:e.map(e=>(e.dataSource=this,e)))}return t}useNoSelectionView(){const e=this.sourceRecords||[];return this.isSelectionView()&&0===e.length}canSaveSource(){return!this.isDataView&&!this.isLocal||this.isSelectionView()}getSelectionDataView(){const e=this.isDataView||this.isLocal?this.getMainDataSource().id:this.id;return this.dataSourceManager.getDataViewDataSource(e,a.CONSTANTS.SELECTION_DATA_VIEW_ID)}getSelectedRecords(){const e=this.getSelectionDataView(),t=e?e.getRecords():[],r=this.getSelectedRecordIds();return t.filter(e=>r.includes(e.getId()))}getSelectedRecordIndexes(){if(!Object(a.getAppStore)().getState().dataSourcesInfo[this.id])return[];const e=this.isDataView||this.isLocal?this.getMainDataSource().id:this.id;return Object(a.getAppStore)().getState().dataSourcesInfo[e].selectedIndexes?Object(a.getAppStore)().getState().dataSourcesInfo[e].selectedIndexes.asMutable():Object(a.getAppStore)().getState().dataSourcesInfo[e].selectedIds?Object(a.getAppStore)().getState().dataSourcesInfo[e].selectedIds.asMutable().map(e=>this.getRecords().findIndex(t=>t.getId()==e)):[]}getSelectedRecordIds(){return this.isSelectionView()?this.getMainDataSource().getSelectedRecordIdsFromInfo().asMutable():this.getSelectedRecordIdsFromInfo().asMutable()}nextRecord(){if(this.getSelectedRecordIndexes().length>1)return console.warn('method "nextRecord" only works when single record is selected'),null;if(this.getSelectedRecordIndexes().indexOf(this.getRecords().length-1))throw Error("Reach the end of data.");return Object(a.getAppStore)().dispatch(a.appActions.dataSourceSelectedIndexesChanged(this.id,[this.getSelectedRecordIndexes()[0]++])),this.getSelectedRecords()[0]}prevRecord(){if(this.getSelectedRecordIndexes().length>1)return console.warn('method "prevRecord" only works when single record is selected'),null;if(this.getSelectedRecordIndexes().indexOf(0))throw Error("Reach the start of data.");return Object(a.getAppStore)().dispatch(a.appActions.dataSourceSelectedIndexesChanged(this.id,[this.getSelectedRecordIndexes()[0]--])),this.getSelectedRecords()[0]}getRecord(e){return this.getRecords()[e]}getSourceRecord(e){return this.getSourceRecords()[e]}getRecordById(e){return this.getRecords().filter(t=>t&&t.getId()===e)[0]}getSourceRecordById(e){return this.getSourceRecords().filter(t=>t&&t.getId()===e)[0]}clearSelection(){this.clearOneDsSelection(this.getMainDataSource()),this.getMainDataSource().getAllDerivedDataSources().forEach(e=>this.clearOneDsSelection(e))}clearOneDsSelection(e){Object(a.getAppStore)().dispatch(a.appActions.dataSourceSelectedIndexesChanged(e.id,null)),Object(a.getAppStore)().dispatch(a.appActions.dataSourceSelectedIdsChanged(e.id,null)),e===this.getMainDataSource()&&(a.jimuHistory.changeQueryObjectByDataRecordIds(e.id,null),a.jimuHistory.changeQueryObjectByDataRecordIndexes(e.id,null),this.copySelectionToDataView([]))}updateSelectionStateAndChangeUrl(e,t){const r=this.getMainDataSource();if("byIndex"===e){const e=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),i=t.map(t=>{var r;return null===(r=e[t])||void 0===r?void 0:r.getId()});Object(a.getAppStore)().dispatch(a.appActions.dataSourceSelectedIndexesChanged(this.id,t)),r.getAllDerivedDataSources().forEach(e=>{e.id!==this.dataSourceManager.getDataViewDataSourceId(r.id,a.CONSTANTS.SELECTION_DATA_VIEW_ID)&&e.id!==this.dataSourceManager.getDataViewDataSourceId(r.id,a.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION)&&e.id!==this.id&&Object(a.getAppStore)().dispatch(a.appActions.dataSourceSelectedIdsChanged(e.id,i))}),this===r?a.jimuHistory.changeQueryObjectByDataRecordIndexes(this.id,t):(Object(a.getAppStore)().dispatch(a.appActions.dataSourceSelectedIdsChanged(r.id,i)),a.jimuHistory.changeQueryObjectByDataRecordIds(r.id,i))}else"byId"===e&&(r.getAllDerivedDataSources().forEach(e=>{e.id!==this.dataSourceManager.getDataViewDataSourceId(r.id,a.CONSTANTS.SELECTION_DATA_VIEW_ID)&&e.id!==this.dataSourceManager.getDataViewDataSourceId(r.id,a.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION)&&e.setSelectedRecordIdsToInfo(t,this)}),r.setSelectedRecordIdsToInfo(t,this),a.jimuHistory.changeQueryObjectByDataRecordIds(r.id,t))}selectRecord(e){const t=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecord(e):this.getRecord(e);this.copySelectionToDataView([t]),this.updateSelectionStateAndChangeUrl("byIndex",[e])}selectRecords(e){const t=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),r=e.map(e=>t[e]);this.copySelectionToDataView(r),this.updateSelectionStateAndChangeUrl("byIndex",e)}selectRecordById(e,t){if(this.getSelectedRecordIds().find(t=>t===e))return;let r;r=this.getDataSourceJson().isDataInDataSourceInstance?t||e&&this.getSourceRecordById(e):t||e&&this.getRecordById(e),this.copySelectionToDataView([r]),this.updateSelectionStateAndChangeUrl("byId",[e])}selectRecordsByIds(e,t){const r=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),i=t||e.map(e=>r.find(t=>(null==t?void 0:t.getId())===e));this.copySelectionToDataView(i),this.updateSelectionStateAndChangeUrl("byId",e)}copySelectionToDataView(e){const t=this.getSelectionDataView();t&&(t.setSourceRecords(e.filter(e=>!!e)),t.setRecords(e.filter(e=>!!e)))}getInfo(){return Object(a.getAppStore)().getState().dataSourcesInfo[this.id]||Object(a.Immutable)({})}clearRecords(){this.clearRecordsNotAddVersion(),this.addVersion()}clearRecordsNotAddVersion(){!this.isSelectionView()&&this.getSelectedRecords().length>0&&this.copySelectionToDataView([]),this.records=[]}getIdField(){return this.getSchema()&&this.getSchema().idField||"id"}getRootDataSource(){if(this.isDataView||this.isLocal)return this.getMainDataSource().getRootDataSource();let e=this.parentDataSource;for(;e&&e.parentDataSource;)e=e.parentDataSource;return e}ready(){return o(this,void 0,void 0,(function*(){return yield Promise.resolve({})}))}getOriginDataSources(){return this.isDataView||this.isLocal?this.getMainDataSource().getOriginDataSources():this.getDataSourceJson().originDataSources&&0!==this.getDataSourceJson().originDataSources.length?this.getDataSourceJson().originDataSources.asMutable().map(e=>this.dataSourceManager.getDataSource(e.dataSourceId)):[]}getMainDataSource(){var e;return this.belongToDataSource?null!==(e=this.belongToDataSource.belongToDataSource)&&void 0!==e?e:this.belongToDataSource:this}getDataViews(){return this.getMainDataSource()!==this?[]:this.dataSourceManager.getDataSourcesAsArray().filter(e=>e.belongToDataSource===this&&e.isDataView)}getDataView(e){return this.getDataViews().find(t=>t.dataViewId===e)}getLocalDataSources(){return this.isLocal?[]:this.dataSourceManager.getDataSourcesAsArray().filter(e=>e.belongToDataSource===this&&e.isLocal)}getLocalDataSource(e){return this.getLocalDataSources().find(t=>t.localId===e)}getAllDerivedDataSources(){let e=[];const t=this.getDataViews(),r=this.getLocalDataSources();return e=t.concat(r),t.forEach(t=>{e=e.concat(t.getLocalDataSources())}),e}getSaveStatus(){var e;return null===(e=Object(a.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.saveStatus}setSaveStatus(e){Object(a.getAppStore)().dispatch(a.appActions.dataSourceSaveStatusChanged(this.id,e))}setListenSelection(e){this.listenSelection=e}getListenSelection(){return this.listenSelection}isSelectionView(){return this.isDataView&&this.dataViewId===a.CONSTANTS.SELECTION_DATA_VIEW_ID}isLocalViewOfSelectionView(){return this.isLocal&&this.dataViewId===a.CONSTANTS.SELECTION_DATA_VIEW_ID}addRecord(e){return o(this,void 0,void 0,(function*(){return e?(this.setSaveStatus(i.b.Saving),yield this.doAddRecord(e).then(e=>(this.setSaveStatus(i.b.Saved),e),e=>o(this,void 0,void 0,(function*(){return this.setSaveStatus(i.b.SaveError),yield Promise.reject(e)})))):yield Promise.reject("No record passed in.")}))}doAddRecord(e){return o(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doAddRecordToSourceRecords(e):yield Promise.reject("Editing source is not ready yet.")}))}updateRecord(e){return o(this,void 0,void 0,(function*(){return yield this.updateRecords([e])}))}updateRecords(e){return o(this,void 0,void 0,(function*(){return e&&0!==e.length?(this.setSaveStatus(i.b.Saving),yield this.doUpdateRecords(e).then(e=>(this.setSaveStatus(i.b.Saved),e),e=>o(this,void 0,void 0,(function*(){return this.setSaveStatus(i.b.SaveError),yield Promise.reject(e)})))):yield Promise.reject("No records passed in.")}))}doUpdateRecords(e){return o(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doUpdateRecordsInSourceRecords(e):yield Promise.reject("Editing source is not ready yet.")}))}deleteRecord(e){return o(this,void 0,void 0,(function*(){const t=this.getRecords()[e];return yield this.deleteOneRecord(t)}))}deleteRecordById(e){return o(this,void 0,void 0,(function*(){const t=this.getRecordById(e);return yield this.deleteOneRecord(t)}))}deleteOneRecord(e){return o(this,void 0,void 0,(function*(){return e?(this.setSaveStatus(i.b.Saving),yield this.doDeleteOneRecord(e).then(e=>(this.setSaveStatus(i.b.Saved),e),e=>o(this,void 0,void 0,(function*(){return this.setSaveStatus(i.b.SaveError),yield Promise.reject(e)})))):yield Promise.reject("No record passed in.")}))}doDeleteOneRecord(e){return o(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doDeleteOneRecordFromSourceRecords(e):yield Promise.reject("Editing source is not ready yet.")}))}doDeleteOneRecordFromSourceRecords(e){return o(this,void 0,void 0,(function*(){return this.sourceRecords=this.sourceRecords.filter(t=>t.getId()!==e.getId()),Promise.resolve(!0)}))}doAddRecordToSourceRecords(e){return o(this,void 0,void 0,(function*(){return this.sourceRecords=this.sourceRecords.concat(e),yield Promise.resolve(e)}))}doUpdateRecordsInSourceRecords(e){return o(this,void 0,void 0,(function*(){return e.forEach(e=>{const t=this.sourceRecords.findIndex(t=>t.getId()===e.getId());t>-1&&(this.sourceRecords[t]=e)}),Promise.resolve(!0)}))}destroy(){}}var n=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class u extends s{constructor(){super(...arguments),this.isDataSourceSet=!0}ready(){return n(this,void 0,void 0,(function*(){return yield this.createChildDataSources()}))}destroy(){this.getChildDataSources().forEach(e=>{e&&this.dataSourceManager.destroyDataSource(e.id)})}getChildDataSourceId(e){return a.dataSourceUtils.getChildDataSourceId(this.id,e)}getChildDataSources(){return Object.keys(this.dataSourceManager.getDataSources()).filter(e=>this.dataSourceManager.getDataSource(e).parentDataSource===this).map(e=>this.dataSourceManager.getDataSource(e))}getChildDataSource(e){return this.dataSourceManager.getDataSource(this.getChildDataSourceId(e))}getJimuChildId(e){const t=this.getReversedConfigSchema();return t&&t.childSchemas&&t.childSchemas[e]?t.childSchemas[e].map(e=>e.jimuChildId).asMutable():[e]}}var c=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class d extends u{constructor(e){super(e),e.layer&&(this.layer=e.layer)}ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return c(this,void 0,void 0,(function*(){return yield this.fetchServiceDefinition().then(()=>c(this,void 0,void 0,(function*(){return yield e.ready.call(this)})))}))}fetchSchema(){return c(this,void 0,void 0,(function*(){const e=this.getChildDataSources(),t=yield a.dataSourceUtils.getOriginDataLabel(this.getServiceDefinition(),this.layer,this.getDataSourceJson());let r=Object(a.Immutable)({childSchemas:{},label:t});return e.forEach((e,t)=>{const i=e.getFetchedSchema();r=r.setIn(["childSchemas",e.jimuChildId],i)}),Promise.resolve(r)}))}getServiceDefinition(){return this.isDataView||this.isLocal?this.getMainDataSource().getServiceDefinition():this.serviceDefinition}createChildDataSourcesByUrl(){return c(this,void 0,void 0,(function*(){if(!this.childDataSourcesPromise){let e;this.url&&(e=a.dataSourceUtils.fetchSupportedLayerDefinitions(this.url,this.getServiceDefinition())),this.childDataSourcesPromise=e?e.then(e=>c(this,void 0,void 0,(function*(){const t=[];let r=[];return Object.keys(e).filter(t=>a.dataSourceUtils.isLayerDefinitionTypeSupported(e[t])).forEach(i=>{const o=this.getDsJsonsFromSingleLayerDefinition(a.dataSourceUtils.getDataSourceSourceUrl(i),e[i],r);r=r.concat(o),o.forEach(e=>{const r={id:e.id,dataSourceJson:e,parentDataSource:this,jimuChildId:this.getJimuChildIdFromChildDsId(e.id)};t.push(this.dataSourceManager.createDataSource(r))})}),Promise.allSettled(t).then(e=>e.filter(e=>"fulfilled"===e.status).map(e=>e.value))}))):Promise.resolve([])}return this.childDataSourcesPromise}))}fetchServiceDefinitionByUrl(){return c(this,void 0,void 0,(function*(){return this.getServiceDefinition()?yield Promise.resolve(this.getServiceDefinition()):this.url?yield a.ServiceManager.getInstance().fetchServiceInfo(this.url).then(e=>e.definition).then(e=>e?(e.name||(e.name=a.dataSourceUtils.getServiceLabelFromUrl(this.url)),this.serviceDefinition=e,this.serviceDefinition):null):Promise.reject("Failed to fetch service definition, need url.")}))}getDsJsonsFromSingleLayerDefinition(e,t,r){if(!t)return[];const o=[];let s;return this.getJimuChildIdByJSAPILayerOrServiceDefinition(null,t,e,r).forEach(r=>{var n,u,c,d;const l=this.getDataSourceJson().schema?null===(n=this.getDataSourceJson().schema.childSchemas)||void 0===n?void 0:n[r]:null,h=this.getChildDataSourceId(r);a.dataSourceUtils.isSupportedSingleLayerService(e)?s=a.dataSourceUtils.getSingleDsJsonFromLayerDefinition(h,e,t,null===(u=this.getDataSourceJson().childDataSourceJsons)||void 0===u?void 0:u[r]):a.dataSourceUtils.isSupportedWholeService(e)?s=a.dataSourceUtils.getSingleDsJsonFromWholeServiceDefinition(h,e,t,null===(c=this.getDataSourceJson().childDataSourceJsons)||void 0===c?void 0:c[r]):e||t.type!==i.f.FeatureLayer||(s=a.dataSourceUtils.getSingleDsJsonFromLayerDefinition(h,e,t,(null===(d=this.getDataSourceJson().childDataSourceJsons)||void 0===d?void 0:d[r])?this.getDataSourceJson().childDataSourceJsons[r]:null)),s&&(this.getDataSourceJson().portalUrl&&(s=s.set("portalUrl",this.getDataSourceJson().portalUrl)),this.getDataSourceJson().itemId&&(s=s.set("itemId",this.getDataSourceJson().itemId)),l&&(s=s.set("schema",l)),o.push(s))}),o}getJimuChildIdFromChildDsId(e){return e.split(this.id+"-")[1]}getJimuChildIdByJSAPILayerOrServiceDefinition(e,t,r,i){let o;if(e){const t=a.dataSourceUtils.getFixedLayerIdByLayer(e)||a.dataSourceUtils.getServiceLabelFromUrl(r);o=this.getJimuChildId(t)}else if(t){const e=a.dataSourceUtils.getFixedLayerIdByLayerDefinition(t)||a.dataSourceUtils.getServiceLabelFromUrl(r);o=this.getJimuChildId(e)}else o=[];const s={},n=i.map(e=>this.getJimuChildIdFromChildDsId(e.id));o.forEach((e,t)=>{s[e]||(s[e]={isSameAsExistedJimuChildId:n.some(t=>t===e),indexes:[]}),s[e].indexes.push(t)});let u=[];return Object.keys(s).forEach(e=>{s[e].isSameAsExistedJimuChildId||1!==s[e].indexes.length?!s[e].isSameAsExistedJimuChildId&&s[e].indexes.length>1?s[e].indexes.forEach(t=>{u=0===t?u.concat(e):u.concat(`${e}_${t}`)}):s[e].isSameAsExistedJimuChildId&&s[e].indexes.forEach(t=>{u=u.concat(`${e}_${t+1}`)}):u=u.concat(e)}),u}}var l=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class h extends s{load(){return l(this,void 0,void 0,(function*(){return this.setStatus(i.b.Loading),yield this.doLoad().then(e=>(this.records=e,this.setStatus(i.b.Loaded),this.records))}))}}var S=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))},g=function(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(i=Object.getOwnPropertySymbols(e);a<i.length;a++)t.indexOf(i[a])<0&&Object.prototype.propertyIsEnumerable.call(e,i[a])&&(r[i[a]]=e[i[a]])}return r};const{DEFAULT_QUERY_PAGE_SIZE:y,DATA_VIEW_ID_FOR_NO_SELECTION:f,OUTPUT_DATA_VIEW_ID:v,SELECTION_DATA_VIEW_ID:m}=a.CONSTANTS;class p extends s{constructor(e){super(e),this.pages={},this.pagePromises={},this.throttleQueryRecordsByIdWithCurrentQueryParams=a.lodash.throttle(this.queryRecordsByIdWithCurrentQueryParams,200),this.url=this.getDataSourceJson().url;const t=e.belongToDataSource&&e.belongToDataSource.getStatus()!==i.b.NotReady;this.getDataSourceJson().isOutputFromWidget&&!t?(this.setStatus(i.b.NotReady),this.setCountStatus(i.b.NotReady)):(this.setStatus(i.b.Unloaded),this.setCountStatus(i.b.Unloaded))}ready(){var e,t;if(this.isSelectionView()){const r=this.getMainDataSource().id,i=Object(a.getAppStore)().getState().dataSourcesInfo;let o=(null===(t=null===(e=null==i?void 0:i[r])||void 0===e?void 0:e.selectedIds)||void 0===t?void 0:t.asMutable())||[];return i&&Object.keys(i).forEach(e=>{var t,s;if(a.dataSourceUtils.isDerivedFrom(r,e)){const r=(null===(s=null===(t=i[e])||void 0===t?void 0:t.selectedIds)||void 0===s?void 0:s.asMutable())||[];o=o.concat(r)}}),o=Array.from(new Set(o)),0===o.map(e=>+e).filter(e=>!isNaN(e)).length?Promise.resolve({}):this.queryRecordsByIdWithCurrentQueryParams(o,this.getMainDataSource()).then(e=>{var t;this.getMainDataSource().selectRecordsByIds(null===(t=e.records)||void 0===t?void 0:t.map(e=>e.getId()),e.records)}).catch(e=>{console.error(`Failed set selected records in URL to selection view ${this.id}.`,e)})}return this.isDataView&&this.dataViewId===f?Promise.allSettled([this.load({},{widgetId:f}),this.loadCount({},{widgetId:f})]).then(()=>{var e,t,r;0===this.getMainDataSource().getSelectedRecordIds().filter(e=>!!e).length&&(null===(e=this.getMainDataSource().getDataView(m))||void 0===e||e.clearRecords(),null===(r=null===(t=this.getMainDataSource().getDataView(m))||void 0===t?void 0:t.getAllDerivedDataSources())||void 0===r||r.forEach(e=>{null==e||e.clearRecords()}))}):Promise.resolve({})}getCurrentQueryParams(e){const t=this.getRuntimeQueryParams(e&&e.dataSourceId===this.id?null==e?void 0:e.widgetId:null);return this.getCurrentQueryParamsByQuery(t,e)}getRuntimeQueryParams(e){var t;const r=e?null===(t=this.getInfo().widgetQueries)||void 0===t?void 0:t.without(e):this.getInfo().widgetQueries;return this.getMergedWidgetQueries(r)}getCurrentQueryParamsByQuery(e,t){let r;return this.isLocal?r=this.mergeQueryParams(this.belongToDataSource.getCurrentQueryParams(t),e):this.isDataView?(r=this.mergeQueryParams(this.getConfigQueryParams(),e),r=this.mergeQueryParams(this.getMainDataSource().getCurrentQueryParams(t),r)):(r=this.mergeQueryParams(this.getConfigQueryParams(),e),r=this.mergeQueryParams(this.getRemoteQueryParams(),r)),r}getMergedWidgetQueries(e){let t,r=e&&Object.keys(e)||[];return r=r.sort((e,t)=>e.localeCompare(t)),r.forEach(r=>{t=this.mergeQueryParams(t,e[r])}),t}getCurrentQueryId(){return this.lastQueryId}getRealQueryParams(e,t,r){let o;if("query"===t)r&&r.scope?r.scope===i.d.InAllData?o=e:r.scope===i.d.InRemoteConfigView?o=this.mergeQueryParams(this.getRemoteQueryParams(),e):r.scope===i.d.InConfigView?(o=this.mergeQueryWithConfigQuery(e),o=this.mergeQueryParams(this.getRemoteQueryParams(),o)):o=r.scope===i.d.InRuntimeView?this.mergeQueryParams(this.getCurrentQueryParams(r.excludeQuery),e):e:o=this.mergeQueryParams(this.getCurrentQueryParams(null==r?void 0:r.excludeQuery),e);else{if(!r||!r.widgetId)return console.error("Please pass widget id for load."),null;const t=()=>{let t,i=this.getInfo().widgetQueries||Object(a.Immutable)({});return(null==r?void 0:r.excludeQuery)&&(i=i.without(r.excludeQuery.widgetId)),i=i.set(r.widgetId,e),t=this.getMergedWidgetQueries(i),t=this.getCurrentQueryParamsByQuery(t,null==r?void 0:r.excludeQuery),t};r&&r.scope?r.scope===i.d.InAllData?o=e:r.scope===i.d.InRemoteConfigView?o=this.mergeQueryParams(this.getRemoteQueryParams(),e):r.scope===i.d.InConfigView?(o=this.mergeQueryWithConfigQuery(e),o=this.mergeQueryParams(this.getRemoteQueryParams(),o)):o=r.scope===i.d.InRuntimeView?t():e:o=t()}return o}getDataViewConfig(){return this.isLocal?this.belongToDataSource.getDataViewConfig():this.isDataView?this.getDataSourceJson().dataViews&&this.getDataSourceJson().dataViews[this.dataViewId]:this.getDataSourceJson().query}mergeQueryWithConfigQuery(e){let t;return this.isLocal?this.belongToDataSource.isDataView?(t=this.mergeQueryParams(this.belongToDataSource.getConfigQueryParams(),e),t=this.mergeQueryParams(this.getMainDataSource().getConfigQueryParams(),t)):t=this.mergeQueryParams(this.getConfigQueryParams(),e):this.isDataView?(t=this.mergeQueryParams(this.getConfigQueryParams(),e),t=this.mergeQueryParams(this.getMainDataSource().getConfigQueryParams(),t)):t=this.mergeQueryParams(this.getConfigQueryParams(),e),t}updateQueryParams(e,t){e=this.getQueryWithoutPage(e),a.utils.isDeepEqual(e,this.getInfo().widgetQueries&&this.getInfo().widgetQueries[t])||(Object(a.getAppStore)().dispatch(a.appActions.updateWidgetQuery(this.id,t,e)),this.isSelectionView()&&(this.load({},{widgetId:m}),this.loadCount({},{widgetId:m})))}getQueryPageSize(){var e;return(null===(e=this.getDataViewConfig())||void 0===e?void 0:e.pageSize)||y}getMaxRecordCount(){var e;return(null===(e=this.getDataViewConfig())||void 0===e?void 0:e.maximum)||null}getQueryWithoutPage(e){if(!e)return null;const{pageSize:t,page:r}=e;return g(e,["pageSize","page"])}checkClearLocalCache(e,t,r){const i=this.getQueryWithoutPage(e),o=this.getRealQueryParams(i,"load",r),s=r.refresh||this.getInfo().needRefresh;return!(a.utils.isDeepEqual(o,t)&&!s)}getRecordsByPage(e,t){const r=Object.assign({},this.pages),i=Object.keys(r).map(e=>parseInt(e)).sort((e,t)=>t-e)[0],a=this.getQueryPageSize();let o=t*(e-1),s=o+t-1;const n=this.getMaxRecordCount();null!==n&&(o=Math.min(o,n-1),s=Math.min(s,n-1));const u=[];for(let e=1;e<=i;e++){const t=(e-1)*a;if(!(t+a-1<o||t>s)&&r[e])for(let i=0;i<r[e].length;i++)t+i<o||t+i>s||u.push(r[e][i])}return u}getRecordsByPageWithSelection(e,t){return this.concatRecordsAndSelection(this.getRecordsByPage(e,t),this.getSelectedRecords())}getPagesData(){return this.pages}setPagesData(e){this.pages=e}clearRecordsNotAddVersion(){!this.isSelectionView()&&this.getSelectedRecords().length>0&&this.copySelectionToDataView([]),this.pages={},this.pagePromises={},this.count=null,this.countPromise=null,this.byIdPromise=null}getRecords(){let e=[];const t=[];for(let e=1;e<=Object.keys(this.pages).length&&this.pages[e];e++)t.push(e);return t.forEach(t=>{e=e.concat(this.pages[t])}),null!==this.getMaxRecordCount()&&this.getMaxRecordCount()<e.length?e.slice(0,this.getMaxRecordCount()):e}setRecords(e){const t={},r=this.getQueryPageSize();e.forEach((e,i)=>{const a=Math.ceil((i+1)/r);t[a]||(t[a]=[]),t[a][(i+1)%r-1]=e}),this.setPagesData(t),this.addVersion()}get count(){return this._count}set count(e){this._count=e}getRealQueryPages(e,t){const r=t*(e-1);let i=r+t-1;null!==this.getMaxRecordCount()&&(i=Math.min(i,this.getMaxRecordCount()-1));const a=Math.floor(r/this.getQueryPageSize())+1,o=Math.floor(i/this.getQueryPageSize())+1,s=[];for(let e=a;e<=o;e++)s.push(e);return s}load(e,t={}){return S(this,void 0,void 0,(function*(){if(this.getStatus()===i.b.NotReady)return Promise.resolve([]);(e=Object.assign({},e)).page||(e.page=1),e.pageSize||(e.pageSize=this.getQueryPageSize());const r=this.getRealQueryPages(e.page,e.pageSize);this.checkClearLocalCache(e,this.lastQueryParams,t)&&(Object.keys(this.pages).forEach(e=>{r.includes(parseInt(e))||delete this.pages[e]}),this.pagePromises={},this.count=null,this.countPromise=null),this.updateQueryParams(e,t.widgetId);const o=this.getQueryWithoutPage(e),s=this.getRealQueryParams(o,"load",t),n=r.filter(e=>this.pagePromises[e]).map(e=>S(this,void 0,void 0,(function*(){return yield this.pagePromises[e]})));return n.length===r.length?yield Promise.all(n).then(()=>this.getRecordsByPage(e.page,e.pageSize)):(this.lastQueryParams=s,this.setStatus(i.b.Loading),Object(a.getAppStore)().dispatch(a.appActions.setDataNeedRefresh(this.id,!1)),Promise.all(r.map(t=>S(this,void 0,void 0,(function*(){return yield this.loadByPage(s,e,t)})))).then(t=>{if(!t.find(e=>e))return[];const r=this.isDataView&&this.dataViewId===f,o=this.isSelectionView(),s=this.isLocalViewOfSelectionView();if(!r&&!o&&!s){let e=[];const t=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords();this.getSelectedRecordIds().length>0?e=this.getSelectedRecordIds().map(e=>t.filter(t=>t&&t.getId()===e)[0]):this.getSelectedRecordIndexes().length>0&&(e=this.getSelectedRecordIndexes().map(e=>t[e])),e.filter(e=>!!e).length>0&&this.copySelectionToDataView(e)}return this.isSelectionView()&&this.getMainDataSource().getSelectedRecordIds().filter(e=>!!e).length>0&&this.getMainDataSource().updateSelectionStateAndChangeUrl("byId",this.getRecords().map(e=>e.getId())),this.lastRefreshTime=new Date,this.setStatus(i.b.Loaded),window.jimuConfig.isInBuilder&&Object(a.getAppStore)().getState().appRuntimeInfo.appMode===a.AppMode.Design||this.startAutoRefresh(),this.getRecordsByPage(e.page,e.pageSize)},e=>(console.error(e),this.setStatus(i.b.LoadError),[])))}))}loadByPage(e,t,r){return S(this,void 0,void 0,(function*(){if(this.pagePromises[r])return yield this.pagePromises[r];const i=Object.assign(Object.assign({},e),{page:r,pageSize:this.getQueryPageSize()});return this.pagePromises[r]=this.doQuery(Object(a.Immutable)(i),Object(a.Immutable)(t)).then(e=>{const t=this.getQueryWithoutPage(e.queryParams);return!(!a.utils.isDeepEqual(t,this.lastQueryParams)||"number"==typeof e.sourceVersion&&e.sourceVersion!==this.getSourceVersion())&&(this.pages[e.queryParams.page]=e.records,!0)}),this.pagePromises[r]}))}loadCount(e,t={}){return S(this,void 0,void 0,(function*(){if(this.getCountStatus()===i.b.NotReady)return Promise.resolve(0);if(!this.checkClearLocalCache(e,this.lastCountQueryParams,t)&&this.countPromise)return this.countPromise;const r=this.getRealQueryParams(this.getQueryWithoutPage(e),"load",t);return this.lastCountQueryParams=r,this.setCountStatus(i.b.Loading),this.countPromise=this.doQueryCount(Object(a.Immutable)(r)).then(e=>!a.utils.isDeepEqual(e.queryParams,this.lastCountQueryParams)||"number"==typeof e.sourceVersion&&e.sourceVersion!==this.getSourceVersion()?null:(null===this.getMaxRecordCount()?this.count=e.count:this.count=Math.min(e.count,this.getMaxRecordCount()),this.setCountStatus(i.b.Loaded),this.count),e=>S(this,void 0,void 0,(function*(){return console.error(e),this.setCountStatus(i.b.LoadError),yield Promise.reject(e)}))),this.countPromise}))}query(e,t){return S(this,void 0,void 0,(function*(){if(this.getStatus()===i.b.NotReady)return Promise.resolve({queryParams:Object(a.Immutable)(e),records:[],fields:[],sourceVersion:this.getSourceVersion()});const r=this.getRealQueryParams(e,"query",t);return yield this.doQuery(Object(a.Immutable)(r),Object(a.Immutable)(e)).then(e=>{const t=this.getMaxRecordCount();if(null===t)return e;const r=e.queryParams.page||1,i=e.queryParams.pageSize;return 1!==r&&i?(r-1)*i>t?e.records=[]:(r-1)*i+e.records.length>t&&(e.records=e.records.slice(0,(r-1)*i+e.records.length-t)):e.records.length>t&&(e.records=e.records.slice(0,t)),e})}))}queryCount(e,t){return S(this,void 0,void 0,(function*(){if(this.getCountStatus()===i.b.NotReady)return Promise.resolve({queryParams:Object(a.Immutable)(e),count:0,sourceVersion:this.getSourceVersion()});if(this.isSelectionView()&&0===this.getSourceRecords().length){const r=this.getMainDataSource().getDataView(a.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION);if(r)return r.queryCount(e,t)}const r=this.getRealQueryParams(e,"query",t);return yield this.doQueryCount(Object(a.Immutable)(r)).then(e=>(null===this.getMaxRecordCount()||(e.count=Math.min(e.count,this.getMaxRecordCount())),e))}))}loadById(e,t){return S(this,void 0,void 0,(function*(){return this.getStatus()===i.b.NotReady?Promise.resolve(null):(e===this.lastQueryId&&!t&&this.byIdPromise||(this.lastQueryId=e,this.setStatus(i.b.Loading),this.byIdPromise=this.doQueryById(e).then(e=>(this.setStatus(i.b.Loaded),e),e=>(console.error(e),this.setStatus(i.b.LoadError),null))),this.byIdPromise)}))}queryById(e){return S(this,void 0,void 0,(function*(){return this.getStatus()===i.b.NotReady?Promise.resolve(null):yield this.doQueryById(e)}))}getAutoRefreshInterval(){const e=this.getMainDataSource();let t=e.getDataViewConfig()&&e.getDataViewConfig().refreshInterval;return 0===t?0:(null==t&&(t=e.getSchema().refreshInterval),t)}getLastRefreshTime(){return this.lastRefreshTime}startAutoRefresh(){const e=this.getAutoRefreshInterval();e&&(this.autoRefreshHandle||(Object(a.getAppStore)().dispatch(a.appActions.setDataNeedRefresh(this.id,!1)),this.autoRefreshHandle=setTimeout(()=>{this.stopAutoRefresh(),Object(a.getAppStore)().dispatch(a.appActions.setDataNeedRefresh(this.id,!0))},1e3*e)))}stopAutoRefresh(){this.autoRefreshHandle&&(clearTimeout(this.autoRefreshHandle),this.autoRefreshHandle=null)}getMainDataSource(){return super.getMainDataSource()}getDataViews(){return super.getDataViews()}getDataView(e){return super.getDataView(e)}setSelectedRecordIdsToInfo(e,t){if(!e)return;if(!this.getListenSelection()&&this.id!==(null==t?void 0:t.id))return;const r=!this.isLocal&&!this.isDataView,i=this.dataViewId===v;if(r||i||0===e.length)return void Object(a.getAppStore)().dispatch(a.appActions.dataSourceSelectedIdsChanged(this.id,e));const o=this.getRecords();let s=[],n=[];e.forEach(e=>{o.some(t=>(null==t?void 0:t.getId())===e)?n=n.concat(e):s=s.concat(e)}),n.length!==e.length?this.throttleQueryRecordsByIdWithCurrentQueryParams(s).then(e=>{const t=s.filter(t=>{var r;return null===(r=null==e?void 0:e.records)||void 0===r?void 0:r.some(e=>(null==e?void 0:e.getId())===t)});Object(a.getAppStore)().dispatch(a.appActions.dataSourceSelectedIdsChanged(this.id,n.concat(t)))}).catch(e=>{console.error(`Failed to check whether selected records in ${this.id}. `,e)}):Object(a.getAppStore)().dispatch(a.appActions.dataSourceSelectedIdsChanged(this.id,e))}queryRecordsByIdWithCurrentQueryParams(e,t){const r=e.map(e=>+e).filter(e=>!isNaN(e)),i=this.getCurrentQueryParams(),a=this.mergeQueryParams(i,{objectIds:r});return t?t.query(a):this.query(a)}}class D{getFieldValue(e){return this.getData()[e]}getFormattedFieldValue(e,t){const r=this.dataSource.getSchema().fields[e];if(!r)return this.getFieldValue(e);if(r.format)switch(r.type){case a.JimuFieldType.Date:return this.formatDateField(this.getFieldValue(e),r.format.dateFormat,t);case a.JimuFieldType.Number:return this.formatNumberField(this.getFieldValue(e),r.format.places,r.format.digitSeparator,t);default:return this.getFieldValue(e)}else switch(r.type){case a.JimuFieldType.Date:return null!==this.getFieldValue(e)&&void 0!==this.getFieldValue(e)?t.formatDate(this.getFieldValue(e)):null;case a.JimuFieldType.Number:return null!==this.getFieldValue(e)&&void 0!==this.getFieldValue(e)?t.formatNumber(this.getFieldValue(e)):null;default:return this.getFieldValue(e)}}convertBeforeMappingDataToData(e){const t={},r=this.dataSource.getReversedConfigSchema();return Object.keys(e).forEach(i=>{const a=r&&r.fields&&r.fields[i];a?a.forEach(r=>{t[r.jimuName]=e[i]}):t[i]=e[i]}),t}convertDataToDataBeforeMapping(e){const t={},r=this.dataSource.getSchema();return Object.keys(e).forEach(i=>{const a=r&&r.fields&&r.fields[i]?r.fields[i].name:i;t[a]=e[i]}),t}getFormattedData(e){const t={};return Object.keys(this.getData()).forEach(r=>{t[r]=this.getFormattedFieldValue(r,e)}),t}formatDateField(e,t,r){if(!e)return null;"number"==typeof e&&(e=new Date(e));const i=a.dateUtils.ESRI_DATE_FORMAT_MAP[t];if(!i)return console.warn("Invalid data format "+t),null;let o=a.dateUtils.formatDate(e,i.datePattern,r);if("date and time"===i.selector){const t=a.dateUtils.formatTime(e,i.timePattern,r),s=r.locale||"en";o=o+(a.dateUtils.DATE_TIME_CONNECTOR[s]||a.dateUtils.DATE_TIME_CONNECTOR.common)+t}return o}formatNumberField(e,t,r,i){if(null===e||void 0===typeof e)return null;const a=new Number(e);return r?i.formatNumber(e,{maximumFractionDigits:t,minimumFractionDigits:t}):a.toFixed(t)}}class I extends D{constructor(e,t,r=!0){super(),this.dataSource=t,this.data=r?this.convertBeforeMappingDataToData(e):e}getData(){return this.data}getDataBeforeMapping(){return this.convertDataToDataBeforeMapping(this.data)}toJson(){return this.data}getId(){return this.data.id}setId(){}getGeometry(){return null}}class R{constructor(e){Object.assign(this,e)}}var b=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class A extends D{constructor(e,t,r=!0){var a;super();const o=(null==t?void 0:t.type)===i.c.FeatureLayer&&(null===(a=t)||void 0===a?void 0:a.getAssociatedDataSource());this.dataSource=o||t,r?(e.attributes=this.convertBeforeMappingDataToData(e.attributes),this.feature=e):this.feature=e,this.fillGeometry()}fillGeometry(){var e;if(!this.feature.geometry)return;const t=this.dataSource;this.feature.geometry.spatialReference||(this.feature.geometry.spatialReference=null===(e=t.getLayerDefinition().extent)||void 0===e?void 0:e.spatialReference)}queryAttachments(e){return b(this,void 0,void 0,(function*(){let t=null;const r=this.dataSource;if(t=r&&r.getMainDataSource().url,!t)return yield Promise.resolve([]);const i={attachmentTypes:e,url:t,featureId:this.getId()};return this._queryAllAttachmentsPromise||(this._queryAllAttachmentsPromise=a.dataSourceUtils.queryAllAttachments(i)),yield this._queryAllAttachmentsPromise.then(e=>b(this,void 0,void 0,(function*(){return this.attachmentInfos=e,yield a.dataSourceUtils.filterAttachments(e,i)})))}))}getSymbolPreviewHTML(){return b(this,void 0,void 0,(function*(){return this._isGraphicFeature()?(this._getSymbolPreviewHTMLPromise||(this._getSymbolPreviewHTMLPromise=Object(a.loadArcGISJSAPIModules)(["esri/symbols/support/symbolUtils"]).then(e=>b(this,void 0,void 0,(function*(){let t=null;return[t]=e,yield t.getDisplayedSymbol(this.feature).then(e=>b(this,void 0,void 0,(function*(){const r=document.createElement("div");return r.className="w-100 h-100 d-flex justify-content-center align-items-center",yield t.renderPreviewHTML(e,{node:r})})))})))),yield this._getSymbolPreviewHTMLPromise):yield Promise.resolve(null)}))}getData(){return this.feature.attributes}getFormattedFieldValue(e,t){const r=this.dataSource,i=r&&r.getLayerDefinition&&r.getLayerDefinition();if(!i)return super.getFormattedFieldValue(e,t);const o=a.dataSourceUtils.getDisplayValueForCodedValueOrSubtype(i,e,this.getData());return o.isCodedValueOrSubtype?o.displayValue:super.getFormattedFieldValue(e,t)}getDataBeforeMapping(){return this.convertDataToDataBeforeMapping(this.getData())}getOriginData(){const e=Object.assign({},this.feature);return e.attributes=this.convertDataToDataBeforeMapping(this.getData()),e}toJson(){return this.feature}getId(){return this.feature.attributes[this.dataSource.getIdField()]+""}setId(e){}getGeometry(){if("esri.Graphic"===this.feature.declaredClass){return this.feature.toJSON().geometry}return this.feature.geometry}setFeature(e){this.feature=e,this.fillGeometry()}getFeature(){return this.feature}_isGraphicFeature(){var e;return!!(null===(e=null==this?void 0:this.feature)||void 0===e?void 0:e.layer)}}var P=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class C extends h{constructor(e){super(e),this.type=i.c.CSV,e.dataSourceJson.data?(this.records=e.dataSourceJson.data.asMutable().map(e=>new I(e,this)),this.setStatus(i.b.Loaded)):this.url=e.dataSourceJson.url}doLoad(){return P(this,void 0,void 0,(function*(){return yield fetch(this.url).then(e=>P(this,void 0,void 0,(function*(){return yield e.json()}))).then(e=>e.map(e=>new I(e,this)))}))}}var L=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class O extends p{constructor(e){super(e),this.type=i.c.FeatureLayer;const t=this.getDataSourceJson();this.portalUrl=t.portalUrl,this.itemId=t.itemId,this.layerId=t.layerId,this.getDataSourceJson().isDataInDataSourceInstance?(this.url=null,this.itemId=null,this.portalUrl=null,this.layer=null,this.layerId=null):e.layer?this.layer=e.layer:e.belongToDataSource&&e.belongToDataSource.layer&&(this.layer=e.belongToDataSource.layer),e.associatedDataSource&&this.setAssociatedDataSource(e.associatedDataSource)}setAssociatedDataSource(e){this.associatedDataSource=e}getAssociatedDataSource(){return this.associatedDataSource}setSourceRecords(e){super.setSourceRecords(e),this.canSaveSource()&&(this.sourceRecords=e.filter(e=>!!e).map(e=>this.fixRecordDataSource(e)))}getSourceRecords(){let e=super.getSourceRecords();return this.useNoSelectionView()&&(e=e.map(e=>this.fixRecordDataSource(e))),e}fixRecordDataSource(e){const t=this.getAssociatedDataSource();return e.dataSource=t||this,e}getIdField(){return this.getSchema().idField}getGeometryType(){var e;return this.getDataSourceJson().geometryType||(null===(e=this.getLayerDefinition())||void 0===e?void 0:e.geometryType)}setJsonData(e){this.records=e.map(e=>new A(e,this,!1))}doQuery(e,t){return L(this,void 0,void 0,(function*(){let r={queryParams:e,records:[],sourceVersion:this.getSourceVersion()};if(this.getDataSourceJson().isDataInDataSourceInstance){if(this.getSourceRecords().length>0){const t=this.getSourceRecords();r=yield a.dataSourceUtils.createFeatureLayerByRecords(this,t,this.getSourceVersion()).then(({layer:t,sourceVersion:r})=>L(this,void 0,void 0,(function*(){this.layer=t;const i=yield this.doQueryByLayer(e);return Object.assign(Object.assign({},i),{sourceVersion:r})})))}}else r=this.layer?yield this.doQueryByLayer(e):this.url?yield this.doQueryByUrl(e):yield this.createLayerByItemId().then(()=>L(this,void 0,void 0,(function*(){return yield this.doQueryByLayer(e)})));return r=this.enhanceQueryResult(r,t),r}))}enhanceQueryResult(e,t){var r,i,a;let o=null===(r=e.records)||void 0===r?void 0:r.slice();if(!o)return e;let s=e.queryParams;if((null==t?void 0:t.outStatistics)&&((null===(i=null==t?void 0:t.orderByFields)||void 0===i?void 0:i.length)>0&&(o=this.sortRecordsByFields(o,t.orderByFields),s=s.set("orderByFields",t.orderByFields)),"number"==typeof(null==t?void 0:t.pageSize))){const e=null!==(a=t.page)&&void 0!==a?a:1;o=this.sliceRecordsByPage(o,t.pageSize,e),s=s.set("pageSize",t.pageSize),s=s.set("page",e)}return Object.assign(Object.assign({},e),{records:o,queryParams:s})}sliceRecordsByPage(e,t,r){const i=t*(r-1),a=i+t;return e.slice(i,a)}sortRecordsByFields(e,t){return e.filter(e=>!!e).sort((e,r)=>this.compareRecordsByFields(e,r,t))}compareRecordsByFields(e,t,r){var i,o;let s=0,n=0;for(;s<r.length;){const u=r[s].split(" ")[0];let c=0;if(r[s].split(" ").length>2)c=0;else if(typeof e.getFieldValue(u)!=typeof t.getFieldValue(u)){const r=null===(o=null===(i=this.getSchema())||void 0===i?void 0:i.fields)||void 0===o?void 0:o[u],s=((null==r?void 0:r.type)||a.JimuFieldType.Number)===a.JimuFieldType.String?"string":"number",n=typeof e.getFieldValue(u)===s,d=typeof t.getFieldValue(u)===s;c=n&&!d?1:!n&&d?-1:0}else{const r=e.getFieldValue(u),i=t.getFieldValue(u);c=this.getCompareValueResult(r,i)}if(n="DESC"===r[s].split(" ")[1]?-c:c,0!==n)break;s++}return n}getCompareValueResult(e,t){let r=0;return"string"==typeof e&&"string"==typeof t?r=e.localeCompare?e.localeCompare(t):0:"number"==typeof e&&"number"==typeof t&&(r=e-t),r}doQueryCount(e){return L(this,void 0,void 0,(function*(){if(this.getDataSourceJson().isDataInDataSourceInstance){if(0===this.getSourceRecords().length)return Promise.resolve({queryParams:e,count:0,sourceVersion:this.getSourceVersion()});const t=this.getSourceRecords();return yield a.dataSourceUtils.createFeatureLayerByRecords(this,t,this.getSourceVersion()).then(({layer:t,sourceVersion:r})=>L(this,void 0,void 0,(function*(){this.layer=t;const i=yield this.doQueryCountByLayer(e);return Object.assign(Object.assign({},i),{sourceVersion:r})})))}return this.layer?yield this.doQueryCountByLayer(e):this.url?yield this.doQueryCountByUrl(e):yield this.createLayerByItemId().then(()=>L(this,void 0,void 0,(function*(){return yield this.doQueryCountByLayer(e)})))}))}doAddRecordToServerSideSource(e){return L(this,void 0,void 0,(function*(){return this.layer?yield this.addRecordByLayer(e):this.url?yield this.addRecordByUrl(e):yield this.createLayerByItemId().then(()=>L(this,void 0,void 0,(function*(){return yield this.addRecordByLayer(e)})))}))}doDeleteOneRecordFromServerSideSource(e){return L(this,void 0,void 0,(function*(){return this.layer?yield this.deleteOneRecordByLayer(e):this.url?yield this.deleteOneRecordByUrl(e):yield this.createLayerByItemId().then(()=>L(this,void 0,void 0,(function*(){return yield this.deleteOneRecordByLayer(e)})))}))}doUpdateRecordsInServerSideSource(e){return L(this,void 0,void 0,(function*(){return this.layer?yield this.updateRecordsByLayer(e):this.url?yield this.updateRecordsByUrl(e):yield this.createLayerByItemId().then(()=>L(this,void 0,void 0,(function*(){return yield this.updateRecordsByLayer(e)})))}))}doQueryCountByLayer(e){return L(this,void 0,void 0,(function*(){return yield this.changeJimuQueryToJSAPILayerQuery(e).then(t=>L(this,void 0,void 0,(function*(){return yield this.layer.queryFeatureCount(t).then(t=>({queryParams:e,count:t}))})))}))}doQueryCountByUrl(e){return L(this,void 0,void 0,(function*(){const t=this.changeJimuQueryToRestJSQuery(e);return delete t.resultRecordCount,delete t.resultOffset,t.returnCountOnly||(t.returnCountOnly=!0),yield this._q(t).then(t=>({queryParams:e,count:t.count}))}))}doQueryById(e){return L(this,void 0,void 0,(function*(){return yield this.doQuery(Object(a.Immutable)({objectIds:[parseInt(e)],returnGeometry:!0}),Object(a.Immutable)({objectIds:[parseInt(e)],returnGeometry:!0})).then(e=>e.records[0])}))}queryById(e){const t=Object.create(null,{queryById:{get:()=>super.queryById}});return L(this,void 0,void 0,(function*(){return yield t.queryById.call(this,e)}))}getConfigQueryParams(){const e=this.getDataViewConfig();if(!e)return null;return{where:a.dataSourceUtils.getArcGISSQL(e.where,this).sql,orderByFields:this.getOrderByArray(e.orderBy)}}mergeQueryParams(e,t){let r="";return r=[e&&e.where,t&&t.where].filter(e=>e).join(" and "),Object.assign(Object.assign(Object.assign({},e),t),{where:r})}getCurrentQueryParams(e){const t=super.getCurrentQueryParams(e);return this.applyGDBVersionAndFix(t)}getRealQueryParams(e,t,r){const i=super.getRealQueryParams(e,t,r);return this.applyGDBVersionAndFix(i)}getRemoteQueryParams(){return this.getSchema().filter?{where:this.getSchema().filter}:null}applyGDBVersionAndFix(e){return this.getGDBVersion()&&(e.gdbVersion=this.getGDBVersion()),e=this.fixQueryParam(Object(a.Immutable)(e)).asMutable({deep:!0})}fixQueryParam(e){let t=e;return e.outStatistics&&Object.keys(e).forEach(e=>{["groupByFieldsForStatistics","time","where","outStatistics","geometry","gdbVersion"].includes(e)||(t=t.without(e))}),t}addRecordByLayer(e){return L(this,void 0,void 0,(function*(){const t=(yield a.dataSourceUtils.changeToJSAPIGraphic(e.feature)).clone();return yield this.layer.applyEdits({addFeatures:[t]}).then(e=>{var r,i;const a=null===(r=e.addFeatureResults[0])||void 0===r?void 0:r.objectId;if("number"!=typeof a||(null===(i=e.addFeatureResults[0])||void 0===i?void 0:i.error))return Promise.reject("Adding record failed.");const o=this.getIdField();return t.attributes[o]=a,new A(t,this)})}))}addRecordByUrl(e){return L(this,void 0,void 0,(function*(){const t=a.dataSourceUtils.changeToRestAPIFeature(e.feature),r=Object.assign({},t),i={url:this.url,features:[r]};return yield a.requestUtils.requestWrapper(this.url,e=>L(this,void 0,void 0,(function*(){return i.authentication=e,yield a.esri.restFeatureLayer.addFeatures(i).then(e=>{var t,i;const a=null===(t=e.addResults[0])||void 0===t?void 0:t.objectId;if("number"!=typeof a||!(null===(i=e.addResults[0])||void 0===i?void 0:i.success))return Promise.reject("Adding record failed.");const o=this.getIdField();return r.attributes[o]=a,new A(r,this)})})),1)}))}updateRecordsByLayer(e){return L(this,void 0,void 0,(function*(){const t=yield Promise.all(e.map(e=>L(this,void 0,void 0,(function*(){return yield a.dataSourceUtils.changeToJSAPIGraphic(e.feature).then(e=>e.clone())}))));return this.layer.applyEdits({updateFeatures:t}).then(e=>e.updateFeatureResults.filter(e=>!e.error).length>0)}))}updateRecordsByUrl(e){return L(this,void 0,void 0,(function*(){const t=e.map(e=>Object.assign({},a.dataSourceUtils.changeToRestAPIFeature(e.feature))),r={url:this.url,features:t};return yield a.requestUtils.requestWrapper(this.url,e=>L(this,void 0,void 0,(function*(){return r.authentication=e,yield a.esri.restFeatureLayer.updateFeatures(r).then(e=>e.updateResults.filter(e=>e.success).length>0)})),1)}))}deleteOneRecordByLayer(e){return L(this,void 0,void 0,(function*(){const t=(yield a.dataSourceUtils.changeToJSAPIGraphic(e.feature)).clone();return yield this.layer.applyEdits({deleteFeatures:[t]}).then(e=>e.deleteFeatureResults.filter(e=>!e.error).length>0)}))}deleteOneRecordByUrl(e){return L(this,void 0,void 0,(function*(){const t=Object.assign({},a.dataSourceUtils.changeToRestAPIFeature(e.feature)),r=this.getIdField(),i=t.attributes[r],o={url:this.url,objectIds:[i]};return yield a.requestUtils.requestWrapper(this.url,e=>L(this,void 0,void 0,(function*(){return o.authentication=e,yield a.esri.restFeatureLayer.deleteFeatures(o).then(e=>e.deleteResults.filter(e=>e.success).length>0)})),1)}))}fetchSchema(){return L(this,void 0,void 0,(function*(){return this.getDataSourceJson().isStatistic?yield Promise.resolve(Object(a.Immutable)({})):this.layer?yield this.fetchSchemaWithLayer():yield this.fetchSchemaWithoutLayer()}))}createLayerByItemId(){return L(this,void 0,void 0,(function*(){return this.createFeatureLayerPromise?yield this.createFeatureLayerPromise:(this.layer?this.createFeatureLayerPromise=Promise.resolve(this.layer):this.itemId&&(this.createFeatureLayerPromise=Object(a.loadArcGISJSAPIModules)(["esri/layers/Layer","esri/portal/PortalItem"]).then(e=>L(this,void 0,void 0,(function*(){const t=e[0],r=e[1];return yield t.fromPortalItem({portalItem:new r({id:this.itemId,portal:{url:this.portalUrl}})})}))).then(e=>L(this,void 0,void 0,(function*(){return(null==e?void 0:e.type)===i.g.FeatureLayer?(this.layer=e,yield Promise.resolve(this.layer)):(null==e?void 0:e.type)===i.g.GroupLayer?yield e.loadAll().then(e=>L(this,void 0,void 0,(function*(){const t=e.layers.toArray().find(e=>""+e.layerId===this.layerId||a.dataSourceUtils.fixLayerId(e.title||e.id)===this.jimuChildId);return(null==t?void 0:t.type)===i.g.FeatureLayer?(this.layer=t,Promise.resolve(this.layer)):Promise.reject("Feaure layer data source error: failed to create feature layer with specific layer id.")}))):void 0})))),this.createFeatureLayerPromise)}))}fetchSchemaWithoutLayer(){return L(this,void 0,void 0,(function*(){const e=this.url?a.ServiceManager.getInstance().fetchServiceInfo(this.url):Promise.resolve(null);return yield e.then(e=>this.itemId?a.requestUtils.requestWrapper(this.getDataSourceJson().portalUrl,t=>L(this,void 0,void 0,(function*(){return yield Promise.all([a.esri.restPortal.getItemData(this.itemId,{portal:a.portalUrlUtils.getPortalRestUrl(this.portalUrl),authentication:t}),a.esri.restPortal.getItem(this.itemId,{portal:a.portalUrlUtils.getPortalRestUrl(this.portalUrl),authentication:t})]).then(([t,r])=>{var i;const a=t&&t.layers&&t.layers[this.layerId],o=(null==e?void 0:e.definition)?this.getUpdatedLayerDefinition(a,e.definition):null==a?void 0:a.layerDefinition;return!this.parentDataSource&&o&&(o.name=(null==r?void 0:r.title)||o.name),{serviceDefinition:o,fieldInfos:a&&a.popupInfo&&a.popupInfo.fieldInfos,filter:(null===(i=null==a?void 0:a.layerDefinition)||void 0===i?void 0:i.definitionExpression)?`(${a.layerDefinition.definitionExpression})`:null,refreshInterval:60*(null==a?void 0:a.refreshInterval)}})}))):{serviceDefinition:null==e?void 0:e.definition,fieldInfos:null,filter:null,refreshInterval:null}).then(({serviceDefinition:e,fieldInfos:t,filter:r,refreshInterval:i})=>{var o,s,n,u;const c={fields:{},idField:(null==e?void 0:e.idField)||(null===(s=null===(o=null==e?void 0:e.fields)||void 0===o?void 0:o.find(e=>"esriFieldTypeOID"===e.type))||void 0===s?void 0:s.name)||"OBJECTID",filter:r,refreshInterval:i,label:(null===(n=this.layer)||void 0===n?void 0:n.title)||(null==e?void 0:e.name)};return this.layerDefinition=e,null===(u=null==e?void 0:e.fields)||void 0===u||u.forEach(e=>{const r=t&&t.find(t=>t.fieldName===e.name);c.fields[e.name]=a.dataSourceUtils.convertFieldToJimuField(e,r)}),Object(a.Immutable)(c)})}))}fetchSchemaWithLayer(){return L(this,void 0,void 0,(function*(){return yield this.layer.load().then(()=>{var e,t;this.updateLayerDefinitionByLayer();const r={fields:{},idField:this.layer.objectIdField||(null===(t=null===(e=this.layer.fields)||void 0===e?void 0:e.find(e=>"oid"===e.type))||void 0===t?void 0:t.name)||"OBJECTID",filter:this.layer.definitionExpression?`(${this.layer.definitionExpression})`:null,refreshInterval:60*this.layer.refreshInterval,label:this.layer.title};return this.layer.fields.forEach(e=>{const t=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos&&this.layer.popupTemplate.fieldInfos.find(t=>t.fieldName===e.name);r.fields[e.name]=a.dataSourceUtils.convertFieldToJimuField(e.toJSON(),null==t?void 0:t.toJSON())}),Object(a.Immutable)(r)})}))}updateLayerDefinitionByLayer(){let e=this.layer.sourceJSON;const t=this.layer.renderer;if(t&&t.toJSON()){const r=t.toJSON();if("uniqueValue"===r.type){let t=this.layer.sourceJSON.types;r.field1!==this.layer.sourceJSON.typeIdField&&(t=[],r.uniqueValueInfos.map(e=>{t.push({id:e.value,name:e.label,domain:{}})})),e=Object.assign({name:this.layer.title},e,{drawingInfo:{renderer:r},typeIdField:r.field1,types:t})}}this.layerDefinition=e}getLayerDefinition(){return a.dataSourceUtils.getLayerDefinition(this)}getFieldCodedValueList(e,t){let r="";const i=this.getSchema().fields;return Object.keys(i).some(t=>t===e&&(r=i[t].name,!0)),a.dataSourceUtils.getCodedValueListForCodedValueOrSubtypeField(this.getLayerDefinition(),r,t)}getGDBVersion(){return this.getInfo().gdbVersion}changeGDBVersion(e){Object(a.getAppStore)().dispatch(a.appActions.changeDataSourceGDBVersion(this.id,e)),this.layer&&(this.layer.gdbVersion=e)}getUpdatedLayerDefinition(e,t){let r=t;if(e&&e.layerDefinition){let i;const a=e.layerDefinition.drawingInfo;if(a){if(a.renderer&&"uniqueValue"===a.renderer.type){let r=t.types;a.renderer.field1!==t.typeIdField&&(r=[],a.renderer.uniqueValueInfos.map(e=>{r.push({id:e.value,name:e.label,domain:{}})})),i={defaultVisibility:e.layerDefinition.defaultVisibility,drawingInfo:e.layerDefinition.drawingInfo,typeIdField:a.renderer.field1,types:r}}}else e.layerDefinition.defaultVisibility!==t.defaultVisibility&&(i={defaultVisibility:e.layerDefinition.defaultVisibility});r=Object.assign({},r,i)}return r}getOrderByArray(e){var t;return null!==(t=null==e?void 0:e.map(e=>e.jimuFieldName+" "+e.order).asMutable())&&void 0!==t?t:[]}changeJimuQueryToRestJSQuery(e){var t;if(!e)return null;const r=this.fixQueryParam(e).asMutable({deep:!0});if("number"==typeof r.pageSize){const e=null!==(t=r.page)&&void 0!==t?t:1;r.resultOffset=(e-1)*r.pageSize,r.resultRecordCount=r.pageSize,null!==this.getMaxRecordCount()&&(1===e?r.resultRecordCount=Math.min(this.getMaxRecordCount(),r.pageSize):e*r.pageSize>this.getMaxRecordCount()&&(r.resultRecordCount=this.getMaxRecordCount()-(e-1)*r.pageSize)),delete r.page,delete r.pageSize}return Array.isArray(r.orderByFields)&&(r.orderByFields=r.orderByFields.join(",")),Array.isArray(r.groupByFieldsForStatistics)&&(r.groupByFieldsForStatistics=r.groupByFieldsForStatistics.join(",")),r}changeJimuQueryToJSAPILayerQuery(e){return L(this,void 0,void 0,(function*(){return a.dataSourceUtils.changeJimuFeatureLayerQueryToJSAPILayerQuery(this,e)}))}doQueryByUrl(e){var t;return L(this,void 0,void 0,(function*(){const r=this.changeJimuQueryToRestJSQuery(e);if(r.returnCountOnly)return console.error("To query count, please use queryCount."),yield Promise.reject("To query count, please use queryCount.");if(r.outFields&&"*"!==r.outFields&&"*"!==r.outFields[0]){const e=null===(t=this.getLayerDefinition())||void 0===t?void 0:t.typeIdField;e&&!r.outFields.includes(e)&&r.outFields.push(e)}return yield this._q(r).then(t=>{const r=Object.keys(this.getSchema().fields).filter(e=>t.fields&&t.fields.find(t=>t.name===this.getSchema().fields[e].name));return{queryParams:e,fields:r,records:t.features.map(e=>new A(e,this))}})}))}doQueryByLayer(e){return L(this,void 0,void 0,(function*(){return yield this.changeJimuQueryToJSAPILayerQuery(e).then(t=>L(this,void 0,void 0,(function*(){var r;const i=t;if(i.outFields&&"*"!==i.outFields[0]){const e=null===(r=this.getLayerDefinition())||void 0===r?void 0:r.typeIdField;e&&!i.outFields.includes(e)&&i.outFields.push(e)}return yield this.layer.queryFeatures(i).then(t=>{const r=t.features.map(e=>new A(e,this)),i=Object.keys(this.getSchema().fields).filter(e=>t.fields&&t.fields.find(t=>t.name===this.getSchema().fields[e].name));return{queryParams:e,records:r,fields:i}})})))}))}_q(e){return L(this,void 0,void 0,(function*(){const t=Object.assign({url:this.url},e);return yield a.requestUtils.requestWrapper(this.url,e=>L(this,void 0,void 0,(function*(){return t.authentication=e,yield a.esri.restFeatureLayer.queryFeatures(t)})),1)}))}allowToExportData(){var e,t,r;if(this.isDataView||this.isLocal)return this.getMainDataSource().allowToExportData();if(this.getDataSourceJson().isOutputFromWidget&&1===(null===(e=this.getDataSourceJson().originDataSources)||void 0===e?void 0:e.length)){const e=null===(t=this.getDataSourceJson().originDataSources[0])||void 0===t?void 0:t.dataSourceId,r=e&&this.dataSourceManager.getDataSource(e);return r?r.allowToExportData():(console.error("Origin data source is not created, allow to export data by default. Output data source id is ",this.id),Promise.resolve(!0))}return!this.getDataSourceJson().disableExport?null!==(r=this.allowExportRemoteCheckPromise)&&void 0!==r?r:this.allowToExportDataInRemote():Promise.resolve(!1)}allowToExportDataInRemote(){return L(this,void 0,void 0,(function*(){return this.allowExportRemoteCheckPromise=a.dataSourceUtils.isDataSourceSubscriberOrPremium(this.getDataSourceJson()).then(e=>!e&&this.allowToExportDataInItem()),this.allowExportRemoteCheckPromise}))}allowToExportDataInItem(){return L(this,void 0,void 0,(function*(){try{if(!this.itemId)return!0;const e=Object(a.getAppStore)().getState().portalUrl,t=yield a.esri.restPortal.getItem(this.itemId,{portal:a.portalUrlUtils.getPortalRestUrl(e),authentication:a.SessionManager.getInstance().getMainSession()}),r=Object(a.getAppStore)().getState().user,i="org_admin"===(null==r?void 0:r.role);if(r&&"self"===(null==t?void 0:t.contentOrigin)){if(i)return!0;return!!(r&&(null==t?void 0:t.owner)===r.username)||this.getWhetherAllowToExportInItemSetting()}return this.getWhetherAllowToExportInItemSetting()}catch(e){return console.log(`Failed to get whether data source ${this.id} allows to export data, `,e),!0}}))}getWhetherAllowToExportInItemSetting(){var e;return L(this,void 0,void 0,(function*(){if(this.url){const t=yield a.requestUtils.requestWrapper(this.url,e=>L(this,void 0,void 0,(function*(){return yield a.esri.restRequest.request(this.url,{authentication:e,httpMethod:"GET"})})),1);return!!(null===(e=null==t?void 0:t.capabilities)||void 0===e?void 0:e.includes("Extract"))}return!0}))}getPopupInfo(){return L(this,void 0,void 0,(function*(){return yield a.dataSourceUtils.getPopupInfo(this)}))}supportSymbol(){return a.dataSourceUtils.supportSymbol(this)}supportAttachment(){return a.dataSourceUtils.supportAttachment(this)}createJSAPILayerByDataSource(){return a.dataSourceUtils.createJSAPILayerByDataSource(this)}get layer(){var e,t,r;if(this.getDataSourceJson().isOutputFromWidget&&!this.getDataSourceJson().isDataInDataSourceInstance&&1===(null===(e=this.getDataSourceJson().originDataSources)||void 0===e?void 0:e.length)){const e=null===(t=this.getDataSourceJson().originDataSources[0])||void 0===t?void 0:t.dataSourceId,a=e&&this.dataSourceManager.getDataSource(e);if((null==a?void 0:a.type)===i.c.FeatureLayer&&(null==a?void 0:a.layer))return a.layer;if((null==a?void 0:a.type)===i.c.SceneLayer&&(null===(r=null==a?void 0:a.getAssociatedDataSource())||void 0===r?void 0:r.layer))return a.getAssociatedDataSource().layer}return this._layer}set layer(e){this._layer=e}}var w=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class V extends d{constructor(){super(...arguments),this.type=i.c.FeatureService}fetchServiceDefinition(){return w(this,void 0,void 0,(function*(){return yield this.fetchServiceDefinitionByUrl()}))}createChildDataSources(){return w(this,void 0,void 0,(function*(){return yield this.createChildDataSourcesByUrl()}))}}var F=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class j extends d{constructor(){super(...arguments),this.type=i.c.GroupLayer}fetchServiceDefinition(){return F(this,void 0,void 0,(function*(){return this.url?yield this.fetchServiceDefinitionByUrl():this.layer?yield Promise.resolve(this.getServiceDefinitionByLayer()):this.getDataSourceJson().itemId?yield this.fetchServiceDefnitionByItem():yield Promise.reject("Failed to fetch service definition, need url or layer or item id.")}))}createChildDataSources(){return F(this,void 0,void 0,(function*(){return this.layer?yield this.createChildDataSourcesByLayer():this.url?yield this.createChildDataSourcesByUrl():this.getDataSourceJson().itemId?yield this.createChildDataSourcesByItem():yield Promise.reject("Failed to create child data source, need url or layer or item id.")}))}createChildDataSourcesByLayer(){return F(this,void 0,void 0,(function*(){if(!this.childDataSourcesPromise){let e;if(this.layer.type===i.g.GroupLayer){const t=this.layer;e=t.loadAll().then(()=>F(this,void 0,void 0,(function*(){var e;const r=(null===(e=t.layers)||void 0===e?void 0:e.toArray())||[];return yield Promise.allSettled(r.filter(e=>a.dataSourceUtils.isJSAPILayerTypeSupported(e)).map(e=>F(this,void 0,void 0,(function*(){var t,r,o;if(e.type===i.g.SceneLayer){if(e.associatedLayer)return yield Promise.resolve(e);{const i=e;return yield a.dataSourceUtils.fetchAssociatedFeatureLayerUrl(a.dataSourceUtils.getUrlByLayer(i),""+i.layerId,null===(t=i.portalItem)||void 0===t?void 0:t.id,null===(o=null===(r=i.portalItem)||void 0===r?void 0:r.portal)||void 0===o?void 0:o.url).then(e=>e?i:Promise.reject("Scene layer does not have associated layer"))}}return Promise.resolve(e)})))).then(e=>e.filter(e=>"fulfilled"===e.status).map(e=>e.value)).then(e=>F(this,void 0,void 0,(function*(){return yield Promise.allSettled(e.map(e=>F(this,void 0,void 0,(function*(){return yield this.fetchLayerDefinitionFromLayer(e)}))))}))).then(e=>e.filter(e=>"fulfilled"===e.status).map(e=>e.value).filter(e=>a.dataSourceUtils.isLayerDefinitionTypeSupported(e.def)||a.dataSourceUtils.isJSAPILayerTypeSupported(e.layer)))})))}else{const t=this.layer;e=t.load().then(()=>F(this,void 0,void 0,(function*(){var e;const r=(null===(e=t.sublayers)||void 0===e?void 0:e.toArray())||[];return yield Promise.allSettled(r.map(e=>F(this,void 0,void 0,(function*(){return yield this.fetchLayerDefinitionFromLayer(e)})))).then(e=>{const t=e.filter(e=>"fulfilled"===e.status).map(e=>e.value);let r=[];return t.forEach(e=>{a.dataSourceUtils.isLayerDefinitionTypeSupported(e.def)&&(r=r.concat(e))}),r})})))}this.childDataSourcesPromise=e.then(e=>F(this,void 0,void 0,(function*(){const t=[];let r=[];return e.forEach(e=>{const i=a.dataSourceUtils.getDataSourceSourceUrl(e.url),o=e.def?this.getDsJsonsFromSingleLayerDefinition(i,e.def,r):this.getDsJsonsFromSingleLayer(i,e.layer,r);r=r.concat(o),o.forEach(r=>{const i={id:r.id,dataSourceJson:r,parentDataSource:this,jimuChildId:this.getJimuChildIdFromChildDsId(r.id),layer:e.layer};t.push(this.dataSourceManager.createDataSource(i))})}),Promise.allSettled(t).then(e=>e.filter(e=>"fulfilled"===e.status).map(e=>e.value))})))}return this.childDataSourcesPromise}))}createChildDataSourcesByItem(){return F(this,void 0,void 0,(function*(){if(!this.childDataSourcesPromise){const e=a.requestUtils.requestWrapper(this.getDataSourceJson().portalUrl,e=>F(this,void 0,void 0,(function*(){return yield a.esri.restPortal.getItemData(this.getDataSourceJson().itemId,{portal:a.portalUrlUtils.getPortalRestUrl(this.getDataSourceJson().portalUrl),authentication:e}).then(e=>{var t;return((null===(t=null==e?void 0:e.layers)||void 0===t?void 0:t.map(e=>e.layerDefinition))||[]).filter(e=>e.type===i.f.FeatureLayer)})})));this.childDataSourcesPromise=e.then(e=>F(this,void 0,void 0,(function*(){const t=[];let r=[];return e.forEach(e=>{const i=this.getDsJsonsFromSingleLayerDefinition(null,e,r);r=r.concat(i),i.forEach(e=>{const r={id:e.id,dataSourceJson:e,parentDataSource:this,jimuChildId:this.getJimuChildIdFromChildDsId(e.id)};t.push(this.dataSourceManager.createDataSource(r))})}),Promise.allSettled(t).then(e=>e.filter(e=>"fulfilled"===e.status).map(e=>e.value))})))}return this.childDataSourcesPromise}))}getServiceDefinitionByLayer(){return this.getServiceDefinition()?this.getServiceDefinition():(this.serviceDefinition={name:this.layer.title},this.serviceDefinition)}fetchServiceDefnitionByItem(){return F(this,void 0,void 0,(function*(){return this.getServiceDefinition()?yield Promise.resolve(this.getServiceDefinition()):yield a.requestUtils.requestWrapper(this.getDataSourceJson().portalUrl,e=>F(this,void 0,void 0,(function*(){return yield a.esri.restPortal.getItem(this.getDataSourceJson().itemId,{portal:a.portalUrlUtils.getPortalRestUrl(this.getDataSourceJson().portalUrl),authentication:e}).then(e=>(this.serviceDefinition={name:e.title},this.serviceDefinition))})))}))}fetchLayerDefinitionFromLayer(e){return F(this,void 0,void 0,(function*(){const t=a.dataSourceUtils.getUrlByLayer(e),r=a.dataSourceUtils.isSupportedService(t),i=a.dataSourceUtils.isJSAPILayerTypeSupported(e);return r||i?t?yield a.ServiceManager.getInstance().fetchServiceInfo(t).then(r=>({layer:e,url:t,def:r.definition})):Promise.reject("Id of feature collection layer in group layer changes every time reload page"):yield Promise.reject(`Layer type is not supported. Layer is ${e}.`)}))}getDsJsonsFromSingleLayer(e,t,r){if(!t)return[];const o=[];let s;return this.getJimuChildIdByJSAPILayerOrServiceDefinition(t,null,e,r).forEach(r=>{var n,u;const c=this.getDataSourceJson().schema?null===(n=this.getDataSourceJson().schema.childSchemas)||void 0===n?void 0:n[r]:null,d=this.getChildDataSourceId(r),l=null===(u=this.getDataSourceJson().childDataSourceJsons)||void 0===u?void 0:u[r];t.type===i.g.GroupLayer?s=Object(a.Immutable)({id:d,type:i.c.GroupLayer}):t.type===i.g.FeatureLayer?s=Object(a.Immutable)({id:d,type:i.c.FeatureLayer,layerId:""+t.layerId}):t.type===i.g.SceneLayer?s=Object(a.Immutable)({id:d,type:i.c.SceneLayer,layerId:""+t.layerId}):t.type!==i.g.MapImageLayer&&t.type!==i.g.TileLayer||(s=Object(a.Immutable)({id:d,type:i.c.MapService})),s&&(this.getDataSourceJson().portalUrl&&(s=s.set("portalUrl",this.getDataSourceJson().portalUrl)),this.getDataSourceJson().itemId&&(s=s.set("itemId",this.getDataSourceJson().itemId)),c&&(s=s.set("schema",c)),e&&(s=s.set("url",e)),s=l?s.merge(l.asMutable({deep:!0})):s,o.push(s.set("jimuChildId",r)))}),o}}var J=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class E extends d{constructor(){super(...arguments),this.type=i.c.MapService}fetchServiceDefinition(){return J(this,void 0,void 0,(function*(){return yield this.fetchServiceDefinitionByUrl()}))}createChildDataSources(){return J(this,void 0,void 0,(function*(){return this.layer?yield this.createChildDataSourcesByLayer():yield this.createChildDataSourcesByUrl()}))}createChildDataSourcesByLayer(){return J(this,void 0,void 0,(function*(){if(!this.childDataSourcesPromise){const e=this.layer.load().then(()=>J(this,void 0,void 0,(function*(){var e;const t=(null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray())||[];return yield Promise.allSettled(t.map(e=>J(this,void 0,void 0,(function*(){return yield this.fetchLayerDefinitionFromSubLayer(e)})))).then(e=>{const t=e.filter(e=>"fulfilled"===e.status).map(e=>e.value);let r=[];return t.forEach(e=>{a.dataSourceUtils.isLayerDefinitionTypeSupported(e.def)&&(r=r.concat(e))}),r})})));this.childDataSourcesPromise=e.then(e=>J(this,void 0,void 0,(function*(){const t=[];let r=[];return e.forEach(e=>{const i=this.getDsJsonsFromSingleLayerDefinition(a.dataSourceUtils.getDataSourceSourceUrl(e.url),e.def,r);r=r.concat(i),i.forEach(r=>{const i={id:r.id,dataSourceJson:r,parentDataSource:this,jimuChildId:this.getJimuChildIdFromChildDsId(r.id),layer:e.layer};t.push(this.dataSourceManager.createDataSource(i))})}),Promise.allSettled(t).then(e=>e.filter(e=>"fulfilled"===e.status).map(e=>e.value))})))}return this.childDataSourcesPromise}))}fetchLayerDefinitionFromSubLayer(e){return J(this,void 0,void 0,(function*(){const t=a.dataSourceUtils.getUrlByLayer(e);return t&&a.dataSourceUtils.isSupportedService(t)?yield a.ServiceManager.getInstance().fetchServiceInfo(t).then(r=>({layer:e,url:t,def:r.definition})):yield Promise.resolve(null)}))}}var Q=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class T extends s{constructor(){super(...arguments),this.type=i.c.SimpleLocal}updateRecoreds(e){this.records=e,this.addVersion()}addRecord(e){return Q(this,void 0,void 0,(function*(){return e.getId()||e.setId(Object(a.uuidv1)()),this.records.push(e),this.addVersion(),yield Promise.resolve(e)}))}updateRecord(e){return Q(this,void 0,void 0,(function*(){const t=this.records.findIndex(t=>t.getId()===e.getId());return this.records.splice(t,1,e),this.addVersion(),Promise.resolve(!0)}))}deleteRecord(e){return Q(this,void 0,void 0,(function*(){return this.records.splice(e,1),this.addVersion(),yield Promise.resolve(!0)}))}}var U=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class B extends d{constructor(){super(...arguments),this.type=i.c.SceneService}fetchServiceDefinition(){return U(this,void 0,void 0,(function*(){return yield this.fetchServiceDefinitionByUrl()}))}createChildDataSources(){return U(this,void 0,void 0,(function*(){return yield this.createChildDataSourcesByUrl()}))}}var x=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function n(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}u((i=i.apply(e,t||[])).next())}))};class M extends p{constructor(e){var t,r;super(e),this.type=i.c.SceneLayer;const o=this.getDataSourceJson();if(this.portalUrl=o.portalUrl,this.itemId=o.itemId,this.layerId=o.layerId,e.layer&&(this.layer=e.layer),e.belongToDataSource&&e.belongToDataSource.layer&&(this.layer=e.belongToDataSource.layer),this.isLocal){const r=null===(t=e.belongToDataSource)||void 0===t?void 0:t.getAssociatedDataSource();r&&a.DataSourceManager.getInstance().createLocalDataSource(r,this.localId)}else if(this.isDataView){const t=null===(r=e.belongToDataSource)||void 0===r?void 0:r.getAssociatedDataSource();t&&a.DataSourceManager.getInstance().createDataView(t,this.dataViewId)}this.getAssociatedDataSource()&&(Object(a.observeStore)(this.onInfoChange.bind(this),["dataSourcesInfo",this.getAssociatedDataSource().id]),this.getAssociatedDataSource().setAssociatedDataSource(this))}ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return x(this,void 0,void 0,(function*(){return yield Promise.all([this.fetchLayerDefinition(),this.createAssociatedDataSource()]).then(()=>x(this,void 0,void 0,(function*(){return yield e.ready.call(this)}))).then(()=>{this.getAssociatedDataSource()&&Object(a.observeStore)(this.onInfoChange.bind(this),["dataSourcesInfo",this.getAssociatedDataSource().id])})}))}onInfoChange(){this.getAssociatedDataSource()&&!a.utils.isDeepEqual(this.getInfo().without("instanceStatus"),this.getAssociatedDataSource().getInfo().without("instanceStatus"))&&Object(a.getAppStore)().dispatch(a.appActions.updateDataSourceInfo(this.id,this.getAssociatedDataSource().getInfo().without("instanceStatus").set("instanceStatus",this.getInfo().instanceStatus)))}createAssociatedDataSource(){return x(this,void 0,void 0,(function*(){return this.associatedDataSource?yield Promise.resolve(this.associatedDataSource):this.layer?yield this._createAssociatedDataSourceWithLayer().then(e=>e||this._createAssociatedDataSourceWithUrl()):this._createAssociatedDataSourceWithUrl()}))}_createAssociatedDataSourceWithLayer(){return x(this,void 0,void 0,(function*(){const e=this._getNewAssociatedDataSourceId();return yield this.layer.load().then(()=>x(this,void 0,void 0,(function*(){if(!this.layer.associatedLayer)return null;let t=Object(a.Immutable)({id:e,type:i.c.FeatureLayer,url:a.dataSourceUtils.getUrlByLayer(this.layer.associatedLayer)});t=this._mergeAssociatedDataSourceJson(t);const r={id:e,dataSourceJson:t,layer:this.layer.associatedLayer,associatedDataSource:this};return yield this.dataSourceManager.createDataSource(r)}))).then(e=>(this.associatedDataSource=e,this.associatedDataSource))}))}_createAssociatedDataSourceWithUrl(){return x(this,void 0,void 0,(function*(){const e=this._getNewAssociatedDataSourceId();return yield a.dataSourceUtils.fetchAssociatedFeatureLayerDefinition(this.url,this.layerId,this.itemId,this.portalUrl).then(t=>{if(!t)return Promise.reject("Can not find associated feature layer");let r=a.dataSourceUtils.getSingleDsJsonFromLayerDefinition(e,t.url,t.def);return r=this._mergeAssociatedDataSourceJson(r),r}).then(e=>x(this,void 0,void 0,(function*(){const t={id:e.id,dataSourceJson:e,associatedDataSource:this};return yield this.dataSourceManager.createDataSource(t)}))).then(e=>(this.associatedDataSource=e,this.associatedDataSource))}))}_getNewAssociatedDataSourceId(){return this.getDataSourceJson().id+"-associated_data_source"}fetchLayerDefinition(){return x(this,void 0,void 0,(function*(){const e=this.url;return e?this.getLayerDefinition()?yield Promise.resolve(this.getLayerDefinition()):yield a.ServiceManager.getInstance().fetchServiceInfo(e).then(e=>e.definition).then(e=>e?(this.layerDefinition=e,e):null):yield Promise.resolve(null)}))}getLayerDefinition(){return a.dataSourceUtils.getLayerDefinition(this)}fetchSchema(){return x(this,void 0,void 0,(function*(){const e=yield a.dataSourceUtils.getOriginDataLabel(this.getLayerDefinition(),this.layer,this.getDataSourceJson()),t=Object(a.Immutable)({label:e}),r=yield this.getAssociatedDataSource()?this.getAssociatedDataSource().fetchSchema():Promise.reject({});return r?r.merge(t):t}))}getSchema(){var e;const t=null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSchema(),r=super.getSchema();return t?t.merge(r):r}setSchema(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setSchema(e)}setDataSourceJson(e){super.setDataSourceJson(e);const t=this.getAssociatedDataSource();if(t){const e=this._mergeAssociatedDataSourceJson(t.getDataSourceJson());t.setDataSourceJson(e)}}getFetchedSchema(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getFetchedSchema()}setFetchedSchema(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setFetchedSchema(e)}getReversedConfigSchema(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getReversedConfigSchema()}getSelectedFields(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSelectedFields()}setSelectedFields(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setSelectedFields(e)}getIdField(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getIdField()}setJsonData(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setJsonData(e)}queryById(e){var t,r;return x(this,void 0,void 0,(function*(){return null!==(r=yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.queryById(e))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}))}addRecord(e){var t;return x(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.addRecord(e)}))}updateRecord(e){var t;return x(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.updateRecord(e)}))}updateRecords(e){var t;return x(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.updateRecords(e)}))}deleteRecord(e){var t;return x(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.deleteRecord(e)}))}deleteRecordById(e){var t;return x(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.deleteRecordById(e)}))}doQuery(e,t){var r,i;return x(this,void 0,void 0,(function*(){return null!==(i=yield null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.doQuery(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}doQueryById(e){var t,r;return x(this,void 0,void 0,(function*(){return null!==(r=yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.doQueryById(e))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}))}doQueryCount(e){var t,r;return x(this,void 0,void 0,(function*(){return null!==(r=yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.doQueryCount(e))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}))}getConfigQueryParams(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getConfigQueryParams()}getRemoteQueryParams(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getRemoteQueryParams()}getCurrentQueryParams(e){var t;return e&&this.fixExcludeQuery(e),null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getCurrentQueryParams(e)}getRuntimeQueryParamsgetRuntimeQueryParams(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRuntimeQueryParams(e)}getCurrentQueryId(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getCurrentQueryId()}mergeQueryParams(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.mergeQueryParams(e,t)}getFieldCodedValueList(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.getFieldCodedValueList(e,t)}getRealQueryParams(e,t,r){var i;return r&&this.fixQueryOptions(r),null===(i=this.getAssociatedDataSource())||void 0===i?void 0:i.getRealQueryParams(e,t,r)}updateQueryParams(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.updateQueryParams(e,t)}getGDBVersion(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getGDBVersion()}getQueryPageSize(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getQueryPageSize()}getMaxRecordCount(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getMaxRecordCount()}getRecordsByPage(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.getRecordsByPage(e,t)}getPagesData(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getPagesData()}setPagesData(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setPagesData(e)}getRealQueryPages(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.getRealQueryPages(e,t)}load(e,t={}){var r,i;return x(this,void 0,void 0,(function*(){return t&&this.fixQueryOptions(t),null!==(i=yield null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.load(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}loadCount(e,t={}){var r,i;return x(this,void 0,void 0,(function*(){return t&&this.fixQueryOptions(t),null!==(i=yield null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.loadCount(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}query(e,t){var r,i;return x(this,void 0,void 0,(function*(){return t&&this.fixQueryOptions(t),null!==(i=yield null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.query(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}queryCount(e,t){var r,i;return x(this,void 0,void 0,(function*(){return t&&this.fixQueryOptions(t),null!==(i=yield null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.queryCount(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}loadById(e,t){var r,i;return x(this,void 0,void 0,(function*(){return null!==(i=yield null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.loadById(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}changeGDBVersion(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.changeGDBVersion(e)}getAssociatedDataSource(){if(!this.isDataView&&!this.isLocal)return this.associatedDataSource;const e=this._getRealAssociatedDataSourceId();return a.DataSourceManager.getInstance().getDataSource(e)}getAssociatedDataSourceById(e){return this.dataSourceManager.getDataSource(e).getAssociatedDataSource()}fixQueryOptions(e){e&&e.excludeQuery&&this.fixExcludeQuery(e.excludeQuery)}fixExcludeQuery(e){(null==e?void 0:e.dataSourceId)&&this.getAssociatedDataSourceById(e.dataSourceId)&&(e.dataSourceId=this.getAssociatedDataSourceById(e.dataSourceId).id)}_getRealAssociatedDataSourceId(){var e;let t;const r=null===(e=this.belongToDataSource)||void 0===e?void 0:e.getAssociatedDataSource();return t=this.isLocal?a.DataSourceManager.getInstance().getLocalDataSourceId(null==r?void 0:r.id,this.localId):this.isDataView?a.DataSourceManager.getInstance().getDataViewDataSourceId(null==r?void 0:r.id,this.dataViewId):this.associatedDataSource.id,t}clearRecords(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.clearRecords()}setRecords(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setRecords(e)}getRecords(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getRecords()}getSelectedRecords(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSelectedRecords()}nextRecord(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.nextRecord()}prevRecord(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.prevRecord()}getRecord(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRecord(e)}getRecordById(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRecordById(e)}clearRecordsNotAddVersion(){var e;super.clearRecordsNotAddVersion(),null===(e=this.getAssociatedDataSource())||void 0===e||e.clearRecordsNotAddVersion()}clearSelection(){var e;super.clearSelection(),null===(e=this.getAssociatedDataSource())||void 0===e||e.clearSelection()}addVersion(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.addVersion()}selectRecord(e){var t;super.selectRecord(e),null===(t=this.getAssociatedDataSource())||void 0===t||t.selectRecord(e)}selectRecords(e){var t;super.selectRecords(e),null===(t=this.getAssociatedDataSource())||void 0===t||t.selectRecords(e)}selectRecordById(e,t){var r;super.selectRecordById(e,t),null===(r=this.getAssociatedDataSource())||void 0===r||r.selectRecordById(e,t)}selectRecordsByIds(e,t){var r;super.selectRecordsByIds(e,t),null===(r=this.getAssociatedDataSource())||void 0===r||r.selectRecordsByIds(e,t)}destroy(){const e=this.getAssociatedDataSource();e&&this.dataSourceManager.destroyDataSource(e.id)}supportSymbol(){return a.dataSourceUtils.supportSymbol(this)}supportAttachment(){return a.dataSourceUtils.supportAttachment(this)}createJSAPILayerByDataSource(){return a.dataSourceUtils.createJSAPILayerByDataSource(this)}_mergeAssociatedDataSourceJson(e){return null==e?void 0:e.set("query",this.getDataSourceJson().query).set("dataViews",this.getDataSourceJson().dataViews).set("schema",this.getDataSourceJson().schema)}get count(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.count}set count(e){this.getAssociatedDataSource()&&(this.getAssociatedDataSource().count=e)}getPopupInfo(){return x(this,void 0,void 0,(function*(){return yield a.dataSourceUtils.getPopupInfo(this)}))}allowToExportData(){const e=!this.getDataSourceJson().disableExport;return Promise.resolve(e)}}class N{createDataSource(e){var t;const r=null!==(t=e.dataSourceJson)&&void 0!==t?t:e.belongToDataSource.getMainDataSource().getDataSourceJson(),a=e.dataViewId&&r.dataViews&&r.dataViews[e.dataViewId]&&r.dataViews[e.dataViewId].type||r.type;return a===i.c.CSV?new C(e):a===i.c.FeatureLayer?new O(e):a===i.c.FeatureService?new V(e):a===i.c.GroupLayer?new j(e):a===i.c.MapService?new E(e):a===i.c.SceneService?new B(e):a===i.c.SceneLayer?new M(e):a===i.c.SimpleLocal?new T(e):void console.error("Unimplemented data source type.",r.type)}}t.default=N}}))}}}));