System.register(["jimu-core","jimu-layouts/layout-runtime","jimu-for-builder/service","jimu-core/react"],(function(e){var t,i,o,n;return{setters:[function(e){t=e},function(e){i=e},function(e){o=e},function(e){n=e}],execute:function(){e(function(e){var t={};function i(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,o){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(o,n,function(t){return e[t]}.bind(null,n));return o},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=124)}({0:function(e,i){e.exports=t},1:function(e,t,i){"use strict";t.a={frameworkAction_TriggerLayer:"Trigger data",frameworkAction_SetData:"Select data",frameworkAction_ActionLayer:"Action data",frameworkAction_Conditions:"Conditions",frameworkAction_RelateMessage:"Trigger / action connection",frameworkAction_TriggerLayerField:"Select a trigger field",frameworkAction_None:"none",frameworkAction_Equals:"equals",frameworkAction_ActionLayerField:"Select an action field",frameworkAction_MoreConditions:"More conditions",frameworkAction_SetExpression:"Please set your expression first.",frameworkAction_ChooseLayer:"Select data",frameworkAction_AutoBind:"Auto bound.",frameworkAction_NoLayer:"No data.",frameworkAction_QueryByExtent:"Query by current extent",foldable:"Foldable",billboard:"Billboard",jewelrybox:"JewelryBox",launchpad:"Launchpad",introduction:"Introduction",gallery:"Gallery",general:"General",blankfullscreen:"Blank fullscreen",blankscrollable:"Blank scrolling",scenic:"Scenic",exhibition:"Exhibition",journey:"Journey",ribbon:"Ribbon",snapshot:"Snapshot",epic:"Epic",summary:"Summary",quicknavigation:"Quick navigation",parallax:"Parallax",dashboard:"Dashboard",pocket:"Pocket",dart:"Dart",timeline:"Timeline",monitor:"Monitor",dash:"Dash",reveal:"Reveal",indicator:"Indicator",block1:"Block 1",block2:"Block 2",block3:"Block 3",block4:"Block 4",block5:"Block 5",block6:"Block 6",dialog1:"Confirm",dialog2:"Alert",dialog3:"Simple",dialog4:"Vogue",dialog5:"Novel",dialog6:"Sidebar",dialog7:"Tooltip",dialogTitle:"Title",screenGroup1:"Cascade",screenGroup2:"Index",screenGroup3:"Stream",screenGroup4:"Guide",screenGroup5:"Showcase",screenGroup6:"Slideshow",screenGroup7:"Portfolio",screenGroup8:"Melt",screenGroup9:"Flyer",indicatorDescription:"Indicator provides a multi-page layout with a unique collection of widgets designed to create a modern dashboard.",monitorDescription:"Monitor is a single-page template that includes a combination of widgets built to organize, track, and display your data visualizations using a dashboard layout.",dashDescription:"Dash is a template designed to display key metrics using charts, maps, cards, and text widgets.",revealDescription:"Reveal allows you to create a narrative tour highlighting important data points with the use of tables, charts, and bookmarks.",foldableDescription:"Foldable is a template with a simple, open interface that focuses on the map, featuring a header and a controller widget.",billboardDescription:"Billboard was created with simplicity in mind; it contains a map and a controller widget.",jewelryboxDescription:"JewelryBox is a template created to display features in a list combined with a map.",launchpadDescription:"Launchpad is a template designed with the emphasis on the map and a controller widget anchored at the bottom of the page.",introductionDescription:"Introduction is a template with a modular layout designed to showcase your images and striking headlines.",galleryDescription:"Gallery is a template designed with prominent thumbnail images to highlight your rich content.",generalDescription:"General provides a long scrolling template created to share the stories behind your content.",blankfullscreenDescription:"A blank template to create your own design in a fullscreen app.",blankscrollableDescription:"A blank template to create your design in a scrolling page.",scenicDescription:"Scenic allows you to create a narrative tour using the bookmark widget in a multi-page layout.",exhibitionDescription:"Exhibition provides a multi-page layout for building a website that highlights your images and content using cards, list, and map widgets.",journeyDescription:"Journey is a template created that uses the bookmark widget and a map to provide an interactive tour experience.",ribbonDescription:"Ribbon is a template designed with the emphasis on the bookmark to control the navigation of the map.",snapshotDescription:"Snapshot is a template designed to showcase your captivating images with the use of a section, views navigation, and cards.",epicDescription:"Epic provides a long scrolling template designed for building a website experience.",summaryDescription:"Summary is a template created to be used as a secondary or ending page that focuses on short text descriptions and actionable links to additional content.",timelineDescription:"Timeline is a template designed to display your images and content in chronological order.",quicknavigationDescription:"Quick navigation allows you to quickly switch between multiple views and bookmarks on a single page.",parallaxDescription:"Parallax allows you to add a hero image layout in your experience.",dashboardDescription:"Dashboard is designed to provide a view of your geographic information and data through multiple widgets that work together on a single screen.",pocketDescription:"Pocket is a template created to display your bookmarks in an interactive slider to help navigate the features on your map.",dartDescription:"Dart is a template that focuses on the map, the widgets are placed inside a fixed panel positioned at the bottom of the map.",block1Description:"Block 1",block2Description:"Block 2",block3Description:"Block 3",block4Description:"Block 4",block5Description:"Block 5",block6Description:"Block 6",screenGroup1Description:"Screen group 1",screenGroup2Description:"Screen group 2",screenGroup3Description:"Screen group 3",screenGroup4Description:"Screen group 4",screenGroup5Description:"Screen group 5",screenGroup6Description:"Screen group 6",screenGroup7Description:"Screen group 7",screenGroup8Description:"Screen group 8",screenGroup9Description:"Screen group 9",subTitlePlaceholder:"Here is the subtitle",titlePlaceholder:"Here is the title",defaultTextPlaceholder:"Double click to edit text",copyrightPlaceholder:"Copyright info",appItemCopy:"copy",cardTitle:"Card title",bookmark:"Bookmark",card:"Card",number:"Number"}},11:function(e,t){e.exports='<svg viewBox="0 0 12 40" xmlns="http://www.w3.org/2000/svg"><path d="M6 30v10H0v-1h5v-9h1zM3.162 18.582a.5.5 0 010 .71l-1.416 1.421a2.497 2.497 0 00-.003 3.545c.983.983 2.56.98 3.544-.003l1.42-1.42a.504.504 0 01.712.713L6 24.968a3.502 3.502 0 01-4.967 0 3.501 3.501 0 010-4.967l1.416-1.422a.504.504 0 01.713.003zm4.967-.71a.5.5 0 010 .71L4.58 22.129a.504.504 0 01-.713-.712l3.548-3.548a.504.504 0 01.713.003zm2.838-2.838a3.501 3.501 0 010 4.967l-1.42 1.419a.504.504 0 01-.713-.712l1.423-1.417a2.5 2.5 0 000-3.547 2.502 2.502 0 00-3.547 0l-1.42 1.419a.504.504 0 01-.713-.712l1.42-1.42a3.506 3.506 0 014.97.003zM6 0v10H5V1H0V0h6z" fill="#A8A8A8" fill-rule="evenodd"></path></svg>'},124:function(e,t,i){"use strict";i.r(t),i.d(t,"getAppConfigAction",(function(){return Ge})),i.d(t,"AppConfigAction",(function(){return Fe})),i.d(t,"BaseWidgetSetting",(function(){return d.a})),i.d(t,"WidgetSettingManager",(function(){return S})),i.d(t,"AppStateReduxStoreExtension",(function(){return H})),i.d(t,"BuilderStateReduxStoreExtension",(function(){return h})),i.d(t,"BuilderStateResourceExtension",(function(){return X})),i.d(t,"AppMessageManager",(function(){return v})),i.d(t,"AppDataActionManager",(function(){return ze})),i.d(t,"GuideManager",(function(){return Ve})),i.d(t,"AppStateHistoryExtension",(function(){return K})),i.d(t,"builderAppSync",(function(){return n})),i.d(t,"appBuilderSync",(function(){return s})),i.d(t,"templateUtils",(function(){return p})),i.d(t,"utils",(function(){return a})),i.d(t,"helpUtils",(function(){return r})),i.d(t,"BuilderKeyboardComponent",(function(){return Dt})),i.d(t,"appConfigUtils",(function(){return o})),i.d(t,"defaultMessages",(function(){return $e.a})),i.d(t,"AppWidgetManager",(function(){return Ne})),i.d(t,"ExtActionKeys",(function(){return N})),i.d(t,"appStateActions",(function(){return q})),i.d(t,"appStateHistoryActions",(function(){return $})),i.d(t,"AppStateHistoryActionKeys",(function(){return V})),i.d(t,"BuilderStateActionTypes",(function(){return u})),i.d(t,"builderActions",(function(){return g})),i.d(t,"builderActionKeys",(function(){return u})),i.d(t,"builderStateResourceActions",(function(){return Y})),i.d(t,"BuilderStateResourceActionKeys",(function(){return Z})),i.d(t,"AppResourceManager",(function(){return ie})),i.d(t,"init",(function(){return kt})),i.d(t,"loadI18nMessage",(function(){return Rt.a}));var o={};i.r(o),i.d(o,"getUniqueId",(function(){return D})),i.d(o,"getUniqueLabel",(function(){return A})),i.d(o,"isFirstLevelPage",(function(){return j})),i.d(o,"isPageHasSubPage",(function(){return L})),i.d(o,"getRealPageCount",(function(){return O})),i.d(o,"getSubRealPageCount",(function(){return x})),i.d(o,"getRealPageCountExcludeOnePage",(function(){return P})),i.d(o,"isRealPage",(function(){return M})),i.d(o,"getCleanAppConfig",(function(){return T})),i.d(o,"removeOrphanItems",(function(){return E})),i.d(o,"buildAppConfigStructure",(function(){return U})),i.d(o,"buildPageStructure",(function(){return k})),i.d(o,"buildDialogStructure",(function(){return R})),i.d(o,"buildHeaderStructure",(function(){return _})),i.d(o,"buildFooterStructure",(function(){return B})),i.d(o,"buildLayoutStructure",(function(){return W})),i.d(o,"buildWidgetStructure",(function(){return G})),i.d(o,"buildSectionStructure",(function(){return F})),i.d(o,"buildScreenGroupStructure",(function(){return z}));var n={};i.r(n),i.d(n,"publishAppConfigChangeToApp",(function(){return ne})),i.d(n,"publishAppInfoChangeToApp",(function(){return se})),i.d(n,"publishDialogInfosChangeToApp",(function(){return ae})),i.d(n,"publishAppModeChangeToApp",(function(){return re})),i.d(n,"publishPageChangeToApp",(function(){return pe})),i.d(n,"publishDialogChangeToApp",(function(){return ue})),i.d(n,"publishChangeSelectionToApp",(function(){return de})),i.d(n,"publishChangeWidgetStatePropToApp",(function(){return ce})),i.d(n,"publishChangeWidgetMutableStatePropToApp",(function(){return le})),i.d(n,"publishKeyboardToApp",(function(){return ge})),i.d(n,"publishChangeBrowserSizeModeToApp",(function(){return he})),i.d(n,"publishChangeSessionToApp",(function(){return fe})),i.d(n,"publichChangeZoomScaleToApp",(function(){return ye})),i.d(n,"publichActivePagePartChangeToApp",(function(){return me})),i.d(n,"publishAnimationPreviewToApp",(function(){return Se})),i.d(n,"publishSectionNavInfoToApp",(function(){return Ce})),i.d(n,"publishScreenGroupNavInfoToApp",(function(){return Ie})),i.d(n,"publishTocHoverInfoToApp",(function(){return ve})),i.d(n,"listenAppEvents",(function(){return we}));var s={};i.r(s),i.d(s,"listenBuilderEvents",(function(){return Ae})),i.d(s,"publishAppSessionChangeToBuilder",(function(){return je})),i.d(s,"publishAppStateChangeToBuilder",(function(){return Le})),i.d(s,"publishAppIsLoadedToBuilder",(function(){return Oe})),i.d(s,"letBuilderPopupChooseWidget",(function(){return xe})),i.d(s,"letBuilderAddResource",(function(){return Pe})),i.d(s,"letBuilderClearResource",(function(){return Me})),i.d(s,"letBuilderResponseToKeyboard",(function(){return Te})),i.d(s,"letBuilderShowLayoutToolbar",(function(){return Ee})),i.d(s,"clearLastAppConfigFromHistory",(function(){return Ue})),i.d(s,"publishIsBusyToBuilder",(function(){return ke})),i.d(s,"publishConfirmDeleteToApp",(function(){return Re}));var a={};i.r(a),i.d(a,"getDefaultTocPageIcon",(function(){return Ke})),i.d(a,"getDefaultTocDialogIcon",(function(){return Je})),i.d(a,"getDefaultSectionIcon",(function(){return Qe})),i.d(a,"getPageListByDialogId",(function(){return Ze}));var r={};i.r(r),i.d(r,"isSupportLanguage",(function(){return tt})),i.d(r,"getBuildAppsHelpLink",(function(){return it})),i.d(r,"getHomeHelpLink",(function(){return ot})),i.d(r,"getWhatsNewLink",(function(){return nt})),i.d(r,"getWidgetHelpLink",(function(){return st}));var p={};i.r(p),i.d(p,"processForTemplate",(function(){return pt})),i.d(p,"updateWidgetByTemplate",(function(){return ut})),i.d(p,"createWidgetFromTemplate",(function(){return dt})),i.d(p,"createSectionFromTemplate",(function(){return ct})),i.d(p,"createLayoutFromTemplate",(function(){return lt})),i.d(p,"createViewFromTemplate",(function(){return gt})),i.d(p,"createPageFromTemplate",(function(){return ht})),i.d(p,"createScreenGroupFromTemplate",(function(){return ft})),i.d(p,"createScreenFromTemplate",(function(){return yt})),i.d(p,"createDialogFromTemplate",(function(){return mt})),i.d(p,"applyPageTemplateToHeader",(function(){return St})),i.d(p,"applyPageTemplateToFooter",(function(){return Ct})),i.d(p,"applyPageTemplateToBody",(function(){return It})),i.d(p,"applyTemplateToDialog",(function(){return vt}));var u,d=i(5),c=i(4),l=i(0);!function(e){e.SelectTemplate="SELECT_TEMPLATE",e.OpenChooseWidgetPopup="OPEN_CHOOSE_WIDGET_POPUP",e.CloseChooseWidgetPopup="CLOSE_CHOOSE_WIDGET_POPUP",e.WidgetSettingClassLoaded="WIDGET_SETTING_CLASS_LOADED",e.WidgetsRemoved="WIDGETS_REMOVED",e.WidgetsAdded="WIDGETS_ADDED",e.ChangeCurrentApp="CHANGE_CURRENT_APP",e.RefreshAppList="REFRSH_APPLIST",e.SetLayoutTools="SET_LAYOUT_TOOLS",e.StartGuide="START_GUIDE",e.StopGuide="STOP_GUIDE",e.WidgetSettingI18nMessageLoaded="WIDGET_SETTING_I18N_MESSAGE_LOADED",e.ConfirmDeleteContentChanged="CONFIRM_DELETE_CONTENT_CHANGED"}(u||(u={}));const g={selectTemplate:e=>({type:u.SelectTemplate,templateName:e}),refreshAppListAction:e=>({type:u.RefreshAppList,isRefresh:e}),openChooseWidgetPopup:(e,t)=>({type:u.OpenChooseWidgetPopup,layoutId:e,layoutItemId:t}),closeChooseWidgetPopup:()=>({type:u.CloseChooseWidgetPopup}),widgetSettingClassLoaded:e=>({type:u.WidgetSettingClassLoaded,wigetUri:e}),widgetsAdded:e=>({type:u.WidgetsAdded,widgets:e}),widgetsRemoved:e=>({type:u.WidgetsRemoved,widgetIds:e}),changeCurrentApp:e=>({type:u.ChangeCurrentApp,appId:e}),setLayoutTools:e=>({type:u.SetLayoutTools,tools:e}),startGuide:e=>({type:u.StartGuide,guideId:e}),stopGuide:()=>({type:u.StopGuide}),widgetSettingI18nMessageLoaded:(e,t)=>({type:u.WidgetSettingI18nMessageLoaded,widgetName:e,i18nMessages:t}),confirmDeleteContentChanged:e=>({type:u.ConfirmDeleteContentChanged,itemToDelete:e})};class h{constructor(){this.id="builder-state-redux-store-extension"}getActions(){return Object.keys(u).map(e=>u[e])}getInitLocalState(){return Object(l.Immutable)({templateName:null,showChooseWidgetPopup:!1,currentAppId:null,refreshAppList:!1,isMobile:!1,currentGuideId:null,widgetSettingI18nMessages:Object(l.Immutable)({}),widgetsSettingClassStatus:Object(l.Immutable)({})})}getReducer(){return(e,t,i)=>{switch(t.type){case u.SelectTemplate:return e.set("templateName",t.templateName);case u.OpenChooseWidgetPopup:return e.set("showChooseWidgetPopup",!0).set("currentLayout",Object(l.Immutable)({layoutId:t.layoutId,layoutItemId:t.layoutItemId}));case u.CloseChooseWidgetPopup:return e.set("showChooseWidgetPopup",!1);case u.WidgetSettingClassLoaded:return e=e.setIn(["widgetsSettingClassStatus",t.wigetUri],!0),function(e,t){var i,o;const n=(null===(o=null===(i=e.appStateInBuilder)||void 0===i?void 0:i.appConfig)||void 0===o?void 0:o.widgets)||{};return Object.keys(n).filter(e=>n[e].uri===t)}(i,t.wigetUri).forEach(t=>{e=e.setIn(["widgetsSettingRuntimeInfo",t,"isClassLoaded"],!0)}),e;case u.WidgetsAdded:return t.widgets.forEach(t=>{e.widgetsSettingClassStatus[t.widgetUri]&&(e=e.setIn(["widgetsSettingRuntimeInfo",t.widgetId,"isClassLoaded"],!0))}),e;case u.WidgetsRemoved:return e.set("widgetsSettingRuntimeInfo",e.widgetsSettingRuntimeInfo.without(...t.widgetIds));case u.ChangeCurrentApp:return(e=this.getInitLocalState()).set("currentAppId",t.appId).set("widgetsSettingRuntimeInfo",{});case u.RefreshAppList:return e.set("refreshAppList",t.isRefresh);case u.SetLayoutTools:return e.set("toolbarConfig",t.tools);case u.StartGuide:return e.set("currentGuideId",t.guideId);case u.StopGuide:return e.set("currentGuideId",null);case u.WidgetSettingI18nMessageLoaded:return e.setIn(["widgetSettingI18nMessages",t.widgetName],t.i18nMessages);case u.ConfirmDeleteContentChanged:{const{itemToDelete:i}=t;return e.set("contentToDelete",i)}default:return e}}}getStoreKey(){return"builder"}}var f=function(e,t,i,o){return new(i||(i=Promise))((function(n,s){function a(e){try{p(o.next(e))}catch(e){s(e)}}function r(e){try{p(o.throw(e))}catch(e){s(e)}}function p(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};const{getLocaleToLoad:y,loadLocaleMessages:m}=l.i18n;class S{constructor(){this.settings={},Object(l.observeStore)(this.onStoreChange.bind(this),["appStateInBuilder","appConfig","widgets"])}static getInstance(){return S.instance||(S.instance=new S,window._widgetSettingManager=S.instance),S.instance}getWidgetUri(e){var t,i,o;const n=null===(t=Object(l.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig;return null===(o=null===(i=null==n?void 0:n.widgets)||void 0===i?void 0:i[e])||void 0===o?void 0:o.uri}getWidgetManifestByUri(e){var t,i,o;const n=null===(i=null===(t=Object(l.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig)||void 0===i?void 0:i.widgets,s=Object.keys(n||{}).find(t=>n[t].uri===e);return null===(o=n[s])||void 0===o?void 0:o.manifest}updateWidgetCache(e,t){this.settings[e]||(this.settings[e]={});for(const i in t)this.settings[e][i]=t[i]}getWidgetSettingClass(e){var t;return null===(t=this.settings[this.getWidgetUri(e)])||void 0===t?void 0:t.settingClazz}deleteWidgetSettingClass(e){delete this.settings[this.getWidgetUri(e)]}getItemSettingClass(e){var t;return null===(t=this.settings[this.getWidgetUri(e)])||void 0===t?void 0:t.itemSettingClazz}getSettingI18nMessagesByUri(e){var t;return null===(t=this.settings[e])||void 0===t?void 0:t.settingI18nMessage}deleteAllWidgetSettingClasses(){this.settings={}}loadWidgetSettingClass(e){var t,i,o;return f(this,void 0,void 0,(function*(){const n=null===(o=null===(i=null===(t=Object(l.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig)||void 0===i?void 0:i.widgets)||void 0===o?void 0:o[e];if(!n)return yield Promise.resolve(null);if(!n.manifest)return yield Promise.resolve(null);const s=this.getWidgetUri(e);return this.loadWidgetSettingClassByUri(s)}))}checkWidgetUriInConfig(e){var t,i;const o=(null===(i=null===(t=Object(l.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig)||void 0===i?void 0:i.widgets)||{};return!!Object.keys(o).find(t=>o[t].uri===e)}loadWidgetSettingClassByUri(e){return this.settings[e]||(this.settings[e]={}),this.settings[e].settingClazzPromise&&this.settings[e].settingClazzPromise,this.settings[e].settingClazzPromise=this.loadRawSettingClass(e).then(()=>f(this,void 0,void 0,(function*(){return yield this.loadI18nMessagesForSetting(e)}))).then(()=>{const t=this.injectWidgetSettingProps(e);return this.settings[e].settingClazz=t,Object(l.getAppStore)().dispatch(g.widgetSettingClassLoaded(e)),t}),this.settings[e].settingClazzPromise}loadRawSettingClass(e){return f(this,void 0,void 0,(function*(){const t=this.getWidgetManifestByUri(e);let i=e+"dist/setting/setting";return t.properties.hasSettingPage||(i="jimu-for-builder/json-editor-setting"),yield this.loadWidgetSettingDependency(e).then(()=>f(this,void 0,void 0,(function*(){return yield l.moduleLoader.loadModule(i)}))).then(t=>{const i=t.default?t.default:t;return this.settings[e].rawSettingClazz=i,i})}))}loadI18nMessagesForSetting(e){return f(this,void 0,void 0,(function*(){if(this.settings[e]||(this.settings[e]={}),this.settings[e].settingI18nMessagePromise)return yield this.settings[e].settingI18nMessagePromise;const t=this.getWidgetManifestByUri(e);if(!t)return yield Promise.resolve({});if(t.translatedLocales){let i=Object(l.getAppStore)().getState().appContext.locale;i=y(i,t.translatedLocales),this.settings[e].settingI18nMessagePromise=i?m(e+"dist/setting/translations",i):Promise.resolve({})}else this.settings[e].settingI18nMessagePromise=Promise.resolve({});return yield this.settings[e].settingI18nMessagePromise.then(i=>(Object(l.getAppStore)().dispatch(g.widgetSettingI18nMessageLoaded(t.name,i)),this.settings[e].settingI18nMessage=i,i))}))}loadWidgetSettingDependency(e){return f(this,void 0,void 0,(function*(){const t=this.getWidgetManifestByUri(e);if(!t.settingDependency)return yield Promise.resolve();const i="string"==typeof t.settingDependency?[t.settingDependency]:t.settingDependency;return yield Object(l.loadDependencies)(i)}))}loadItemSettingClass(e){var t,i,o;return f(this,void 0,void 0,(function*(){const n=null===(o=null===(i=null===(t=Object(l.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig)||void 0===i?void 0:i.widgets)||void 0===o?void 0:o[e];return n&&n.manifest?yield this.loadItemSettingClassByUri(this.getWidgetUri(e)):yield Promise.resolve(null)}))}loadItemSettingClassByUri(e){return f(this,void 0,void 0,(function*(){return this.settings[e]||(this.settings[e]={}),this.settings[e].itemSettingClazzPromise&&this.settings[e].itemSettingClazzPromise,this.settings[e].itemSettingClazzPromise=this.loadRawItemSettingClass(e).then(t=>(this.settings[e].itemSettingClazz=t,t)),this.settings[e].itemSettingClazzPromise}))}loadRawItemSettingClass(e){return f(this,void 0,void 0,(function*(){const t=e+"dist/setting/item-setting";return yield l.moduleLoader.loadModule(t).then(e=>e.default?e.default:e)}))}injectWidgetSettingProps(e){if(!this.checkWidgetUriInConfig(e))return null;const t=this.settings[e].rawSettingClazz,i=Object(l.injectIntl)(t),o=l.themeUtils.withTheme(i),n=this.getWidgetManifestByUri(e),s=n.name,a=this.settings[e].settingI18nMessage;class r extends c.PureComponent{render(){if(n.version!==this.props.version)return null;const e={messages:a};const t=Object.assign({},a,this.props.appI18nMessages);return c.createElement(l.IntlProvider,{locale:this.props.locale,defaultLocale:this.props.locale,messages:t},c.createElement(o,Object.assign({},this.props,e)))}}r.displayName=`WidgetSettingWrapper(${s})`;return l.ReactRedux.connect((e,i)=>{const o={queryObject:e.queryObject,user:e.user,token:e.token,portalUrl:e.portalUrl,portalSelf:e.portalSelf,locale:e.appContext.locale,appI18nMessages:e.appI18nMessages},n=i.widgetId,s=e.appStateInBuilder.appConfig.widgets[n];if(!s)return{};const a=Object.assign(o,s,i);return Object.assign(a,t.mapExtraStateProps?t.mapExtraStateProps(e,a):{})})(r)}onStoreChange(e,t){e&&t&&Object.keys(e).forEach(e=>{t[e]||this.deleteWidgetSettingClass(e)})}}var C=function(e,t,i,o){return new(i||(i=Promise))((function(n,s){function a(e){try{p(o.next(e))}catch(e){s(e)}}function r(e){try{p(o.throw(e))}catch(e){s(e)}}function p(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};const{getTranslatedLocale:I}=l.i18n;class v{constructor(){this.actionSettings={}}static getInstance(){return v.instance||(v.instance=new v),v.instance}getAllActions(){const e=this.getAppMessageManager();return e?e.getActions():[]}getAction(e,t){const i=this.getAppMessageManager();return i?i.getAction(e,t):null}getAppMessageManager(){return window._appWindow._messageManager?window._appWindow._messageManager:null}getActionSettingComponentUri(e,t,i){if(e.getSettingComponentUri)return e.getSettingComponentUri(t,i);if(e.widgetId){const t=Object(l.getAppStore)().getState().appStateInBuilder.appConfig.widgets[e.widgetId].manifest.messageActions.find(t=>t.name===e.name);return t?t.settingUri:null}return null}getFilteredActions(e){if(window._appWindow._messageManager){const t=window._appWindow._messageManager.getActions(),i=[];for(let o=0;o<t.length;o++)t[o].filterMessageType(e)&&i.push(t[o]);return i}return[]}getConvertedSettingUri(e,t){const i=this.getAllActions();let o=null;for(let n=0;n<i.length;n++)if(e.includes(i[n].id)){const e=i[n].widgetId;if(e){const s=Object(l.getAppStore)().getState().appStateInBuilder.appConfig.widgets[e],a=s.manifest.messageActions;let r=null;if(a)for(let e=0;e<a.length;e++)a[e].name===i[n].name&&(r=a[e]);return r&&t?(o=s.context.isRemote?null:s.uri+"dist/"+t,o):null}return t}return o}loadActionSettingClass(e,t){var i;return C(this,void 0,void 0,(function*(){const o=t?this.getConvertedSettingUri(e.actionId,t):null;if(o||Promise.resolve(null),this.actionSettings[o]||(this.actionSettings[o]={}),null===(i=this.actionSettings[o])||void 0===i?void 0:i.clazzPromise)return yield this.actionSettings[o].clazzPromise;const n=e.widgetId,s=Object(l.getAppStore)().getState().appStateInBuilder.appConfig.widgets[n];return this.actionSettings[o].clazzPromise=this.loadRawSettingClass(o).then(e=>C(this,void 0,void 0,(function*(){return S.getInstance().loadI18nMessagesForSetting(s&&s.uri).then(t=>this.injectActionSettingProps(e,t,s&&s.id))}))).then(e=>(this.actionSettings[o].clazz=e,e)),this.actionSettings[o].clazzPromise}))}loadRawSettingClass(e){return C(this,void 0,void 0,(function*(){return this.actionSettings[e].rawClazzPromise?yield this.actionSettings[e].rawClazzPromise:this.actionSettings[e].rawClazzPromise=l.moduleLoader.loadModule(e).then(t=>(t=t.default?t.default:t,this.actionSettings[e].rawClazz=t))}))}injectActionSettingProps(e,t,i){const o=Object(l.injectIntl)(e),n=Object(l.getAppStore)().getState().appStateInBuilder.appConfig.widgets[i];let s=null;s=i&&n?Object(l.getAppStore)().getState().appStateInBuilder.appConfig.widgets[i].manifest.name:"Framework";class a extends l.React.PureComponent{constructor(e){super(e)}render(){const e={messages:t},s=Object(l.getAppStore)().getState().appI18nMessages;let a=null;i&&n?(a=I(Object(l.getAppStore)().getState().appContext.locale,n.manifest.translatedLocales.asMutable()),a||(a=n.manifest.translatedLocales&&n.manifest.translatedLocales[0]),a||(a=Object(l.getAppStore)().getState().appContext.locale)):a=Object(l.getAppStore)().getState().appContext.locale;const r=Object.assign({},t,s);return l.React.createElement(l.IntlProvider,{locale:a,messages:r},l.React.createElement(o,Object.assign({},this.props,e)))}}a.displayName=`ActionSettingWrapper(${s})`;for(const t in e)a[t]||(a[t]=e[t]);return a}registerActionRawSettingClass(e,t){this.actionSettings[e]||(this.actionSettings[e]={}),this.actionSettings[e].rawClazz=t,this.actionSettings[e].rawClazzPromise=Promise.resolve(t),this.actionSettings[e].settingI18nMessages={},this.actionSettings[e].settingI18nMessagesPromise=Promise.resolve({})}getActionRawSettingClass(e){return this.actionSettings[e].rawClazz}}var b=i(2);function w(e,t,i){const{layoutId:o,layoutItemId:n}=e;if(!i[o])return i;if(!i[o].content[n])return i;const s=i[o];let a=Object(l.Immutable)(i);if(s.order&&s.order.includes(n)){const e=[];s.order.forEach(t=>{t!==n&&e.push(t)}),a=a.setIn([o,"order"],e)}return t&&(a=a.setIn([o,"content"],a[o].content.without(n))),a}const{getUniqueId:D,getUniqueLabel:A}=l.appConfigUtils;function j(e,t){return!!e.pageStructure.find(e=>!!e[t])}function L(e,t){const i=e.pageStructure.find(e=>!!e[t]);return i&&i[t].length>0}function O(e){let t=0;return Object.keys(e.pages).forEach((i,o)=>{M(e,i)&&t++}),t}function x(e,t){if(!j(e,t))return 0;let i=0;return e.pageStructure.forEach((o,n)=>{const s=Object.keys(o)[0];s===t&&o[s].forEach(t=>{M(e,t)&&i++})}),i}function P(e,t){let i=0;return M(e,t)&&(i=1),O(e)-x(e,t)-i}function M(e,t){const i=e.pages[t];return!!i&&i.type===l.PageType.Normal}function T(e){let t=e.asMutable({deep:!0});var i;return Object.keys(t.widgets).forEach(e=>{var i,o,n;const s=t.widgets[e];s.label===(null===(i=s.manifest)||void 0===i?void 0:i.name)&&delete s.label,s.icon===s.context.folderUrl+"icon.svg"&&delete s.icon,"object"==typeof s.icon&&(s.icon.svg!==s.context.folderUrl+"icon.svg"||"#fff"!==(null===(o=s.icon.properties)||void 0===o?void 0:o.color)&&(null===(n=s.icon.properties)||void 0===n?void 0:n.color)||delete s.icon),delete s.context,delete s.manifest,delete s._originManifest}),t.layouts=(i=t.layouts,Object.keys(i).forEach(e=>{const t=i[e];delete t.id,t.content&&Object.keys(t.content).forEach(e=>{delete t.content[e].id})}),i),t=l.appConfigUtils.cleanPortalInfoFromResource(t),t}function E(e,t){var i;e=U(e),t&&console.log("AppConfigTree:",e);let o=!1;return Object.keys(null!==(i=e.layouts)&&void 0!==i?i:{}).forEach(i=>{var n;const s=e.layouts[i];if(s.parent){if(t)return;delete s.parent,Object.keys(null!==(n=s.content)&&void 0!==n?n:{}).forEach(e=>{delete s.content[e].parent})}else t?(console.error("Unused.",i),o=!0):delete e.layouts[i]}),Object.keys(e.widgets||{}).forEach(i=>{var n;const s=e.widgets[i],a=null===(n=e.preloadWidgets)||void 0===n?void 0:n.includes(i);let r=!1;if(e.messageConfigs&&(r=Object.keys(e.messageConfigs).some(t=>{const o=e.messageConfigs[t];return o.widgetId===i||o.actions.some(e=>e.widgetId===i)})),s.parent||a||r){if(t)return;delete s.parent}else t?(console.error("Unused.",i),o=!0):delete e.widgets[i]}),Object.keys(e.screens||{}).forEach(i=>{const n=e.screens[i];if(n.parent){if(t)return;delete n.parent}else t?(console.error("Unused.",i),o=!0):delete e.screens[i]}),Object.keys(e.views||{}).forEach(i=>{const n=e.views[i];if(n.parent){if(t)return;delete n.parent}else t?(console.error("Unused.",i),o=!0):delete e.views[i]}),Object.keys(e.screenGroups||{}).forEach(i=>{const n=e.screenGroups[i];if(n.parent){if(t)return;delete n.parent}else t?(console.error("Unused.",i),o=!0):delete e.screenGroups[i]}),Object.keys(e.screens||{}).forEach(i=>{const n=e.screens[i];if(n.parent){if(t)return;delete n.parent}else t?(console.error("Unused.",i),o=!0):delete e.screens[i]}),o&&alert("This is for testing. Has unused contents, please open console to have a look."),e}function U(e){return e=B(e=_(e=R(e=k(e))))}function k(e){var t;return Object.keys(null!==(t=e.pages)&&void 0!==t?t:{}).forEach(t=>{const i=e.pages[t];Object.keys(i.layout||{}).forEach(o=>{var n;const s=i.layout[o];null!=(null===(n=e.layouts)||void 0===n?void 0:n[s])&&(e=W(e,{type:l.LayoutParentType.Page,id:t},o,s))})}),e}function R(e){var t;return Object.keys(null!==(t=e.dialogs)&&void 0!==t?t:{}).forEach(t=>{const i=e.dialogs[t];Object.keys(i.layout).forEach(o=>{var n;const s=i.layout[o];null!=(null===(n=e.layouts)||void 0===n?void 0:n[s])&&(e=W(e,{type:l.LayoutParentType.Dialog,id:t},o,s))})}),e}function _(e){var t;return Object.keys((null===(t=e.header)||void 0===t?void 0:t.layout)||{}).forEach(t=>{var i;const o=e.header.layout[t];null!=(null===(i=e.layouts)||void 0===i?void 0:i[o])&&(e=W(e,{type:l.LayoutParentType.Header,id:"header"},t,o))}),e}function B(e){var t;return Object.keys((null===(t=e.footer)||void 0===t?void 0:t.layout)||{}).forEach(t=>{var i;const o=e.footer.layout[t];null!=(null===(i=e.layouts)||void 0===i?void 0:i[o])&&(e=W(e,{type:l.LayoutParentType.Footer,id:"footer"},t,o))}),e}function W(e,t,i,o){var n;const s=e.layouts[o];return null!=s&&(s.id=o,s.parent=t,Object.keys(null!==(n=s.content)&&void 0!==n?n:{}).forEach(t=>{const o=s.content[t];switch(o.parent=s.id,o.id=t,o.type){case l.LayoutItemType.Widget:e=G(e,i,o);break;case l.LayoutItemType.Section:e=F(e,i,o);break;case l.LayoutItemType.ScreenGroup:e=z(e,i,o)}})),e}function G(e,t,i){var o;const n=e.widgets[i.widgetId];if(null!=n){n.id=i.widgetId,n.parent=null!==(o=n.parent)&&void 0!==o?o:{},null==n.parent[t]&&(n.parent[t]=[]);null==n.parent[t].find(e=>e.layoutId===i.parent&&e.layoutItemId===i.id)&&n.parent[t].push({layoutId:i.parent,layoutItemId:i.id}),null!=n.layouts&&Object.keys(n.layouts).forEach(t=>{var i;Object.keys(null!==(i=n.layouts[t])&&void 0!==i?i:{}).forEach(i=>{const o=n.layouts[t][i];e=W(e,{type:l.LayoutParentType.Widget,id:n.id},i,o)})})}return e}function F(e,t,i){var o;const n=e.sections[i.sectionId];if(null!=n){n.id=i.sectionId,n.parent=null!==(o=n.parent)&&void 0!==o?o:{},null==n.parent[t]&&(n.parent[t]=[]);null==n.parent[t].find(e=>e.layoutId===i.parent&&e.layoutItemId===i.id)&&n.parent[t].push({layoutId:i.parent,layoutItemId:i.id}),n.views.forEach(t=>{const i=e.views[t];i.id=t,i.parent=n.id,Object.keys(i.layout).forEach(t=>{const o=i.layout[t];e=W(e,{type:l.LayoutParentType.View,id:i.id},t,o)})})}return e}function z(e,t,i){var o;const n=e.screenGroups[i.screenGroupId];return null!=n&&(n.id=i.screenGroupId,n.parent=null!==(o=n.parent)&&void 0!==o?o:{},n.parent[t]={layoutId:i.parent,layoutItemId:i.id},n.screens.forEach(t=>{var i;const o=e.screens[t];o.id=t,o.parent=n.id,Object.keys(o.main.layout).forEach(t=>{const i=o.main.layout[t];e=W(e,{type:l.LayoutParentType.Screen,id:o.id},t,i)}),null!=(null===(i=o.panel)||void 0===i?void 0:i.layout)&&Object.keys(o.panel.layout).forEach(t=>{const i=o.panel.layout[t];e=W(e,{type:l.LayoutParentType.Screen,id:o.id},t,i)})})),e}var N;window._getCleanAppConfig=T,window._checkAppConfig=()=>{var e,t,i;let o;o=window.jimuConfig.isBuilder?null===(t=null===(e=Object(l.getAppStore)().getState().appStateInBuilder)||void 0===e?void 0:e.appConfig)||void 0===t?void 0:t.asMutable({deep:!0}):null===(i=Object(l.getAppStore)().getState().appConfig)||void 0===i?void 0:i.asMutable({deep:!0}),E(o,!0)},function(e){e.InAppAppStateChanged="IN_APP_APP_STATE_CHANGED",e.InBuilderAppConfigChanged="IN_BUILDER_APP_CONFIG_CHANGED"}(N||(N={}));const q={inAppAppStateChanged:e=>({type:N.InAppAppStateChanged,appState:e}),inBuilderAppConfigChanged:e=>({type:N.InBuilderAppConfigChanged,appConfig:e})};class H{constructor(){this.id="builder-app-state-redux-store-extension"}getActions(){return Object.keys(N).map(e=>N[e])}getInitLocalState(){return null}getReducer(){return(e,t,i)=>{switch(t.type){case N.InAppAppStateChanged:return t.appState;case N.InBuilderAppConfigChanged:return l.appConfigUtils.updateStateWhenAppConfigChange(e,t.appConfig);default:return e}}}getStoreKey(){return"appStateInBuilder"}}var V;!function(e){e.InBuilderPutAppConfigIntoHistory="IN_BUILDER_PUT_APPCONFIG_INTO_HISTORY",e.InBuilderRemoveLastAppConfigFromHistory="IN_BUILDER_REMOVE_LAST_APPCONFIG_FROM_HISTORY",e.InBuilderAppConfigUndo="IN_BUILDER_APPCONFIG_UNDO",e.InBuilderAppConfigRedo="IN_BUILDER_APPCONFIG_REDO",e.InBuilderAppConfigRedoClear="IN_BUILDER_APPCONFIG_REDOCLEAR",e.InBuilderAppConfigClear="IN_BUILDER_APPCONFIG_CLEAR"}(V||(V={}));const $={InBuilderAppConfigUndo:()=>({type:V.InBuilderAppConfigUndo}),InBuilderAppConfigRedo:()=>({type:V.InBuilderAppConfigRedo}),InBuilderPutAppConfigIntoHistory:e=>({type:V.InBuilderPutAppConfigIntoHistory,appState:e}),InBuilderRemoveLastAppConfigFromHistory:()=>({type:V.InBuilderRemoveLastAppConfigFromHistory}),InBuilderAppConfigRedoClear:()=>({type:V.InBuilderAppConfigRedoClear}),InBuilderAppConfigClear:()=>({type:V.InBuilderAppConfigClear})};class K{constructor(){this.id="app-state-history-extension"}getActions(){return[V.InBuilderPutAppConfigIntoHistory,V.InBuilderRemoveLastAppConfigFromHistory,V.InBuilderAppConfigUndo,V.InBuilderAppConfigRedo,V.InBuilderAppConfigRedoClear,V.InBuilderAppConfigClear]}getInitLocalState(){return{past:[],future:[]}}getReducer(){return(e,t,i)=>{switch(t.type){case V.InBuilderAppConfigUndo:return this.handleAppStateUndo(e);case V.InBuilderAppConfigRedo:return this.handleAppStateRedo(e);case V.InBuilderPutAppConfigIntoHistory:return this.handleAppStateAdd(e,t.appState);case V.InBuilderRemoveLastAppConfigFromHistory:return this.handleAppStateRemoveLast(e);case V.InBuilderAppConfigRedoClear:return this.handleAppStateRedoClear(e);case V.InBuilderAppConfigClear:return this.handleAppStateClear(e);default:return e}}}handleAppStateUndo(e){if(e.past.length<2)return console.warn("Can not undo since no history there"),e;const t=e.past[e.past.length-2],i=e.past[e.past.length-1],o=e.past.slice(0,e.past.length-1),n=[i].concat(e.future);return l.lodash.defer(()=>{ne(t)}),e.merge({past:o,future:n})}handleAppStateRedo(e){if(e.future.length<1)return console.warn("Can not redo since no history there"),e;const t=e.future[0],i=e.future.slice(1),o=e.past.concat([t]);return l.lodash.defer(()=>{ne(t)}),e.merge({past:o,future:i})}handleAppStateAdd(e,t){if(null!==t&&(e.past.length>0&&e.past[e.past.length-1]!==t||0===e.past.length)){const i=e.past.concat([t]);return e.set("past",i).set("future",[])}return e}handleAppStateRemoveLast(e){if(e.past.length>1){const t=e.past.slice(0,e.past.length-1);return e.set("past",t)}return e}handleAppStateRedoClear(e){return e.set("future",[])}handleAppStateClear(e){return e.set("future",[]).set("past",[])}getStoreKey(){return"appStateHistory"}}var J,Q,Z;!function(e){e.AppConfigChanged="app_config_changed",e.AppInfoChanged="app_info_changed",e.PortalSelfChanged="portal_self_changed",e.DialogInfosChanged="dialog_infos_changed",e.UserSignIn="user_sign_in",e.SetMainPortal="set_main_portal",e.ChangeAppMode="change_app_mode",e.ChangePage="change_page",e.ChangeDialog="change_dialog",e.ChangeSelection="change_selection",e.ChangeWidgetStateProp="change_widget_state_prop",e.ChangeWidgetMutableStateProp="change_widget_mutable_state_prop",e.ChangeZoomScale="change_zoom_scale",e.BuilderTriggerKeyboard="builder_trigger_keyboard",e.ChangeBrowserSizeMode="change_browser_size_mode",e.BuilderSessionChanged="builder_session_changed",e.ActivePagePartChanged="active_page_part_changed",e.AnimationPreview="animation_preview",e.SectionNavInfoChanged="section_navinfo_changed",e.ScreenGroupNavInfoChanged="screengroup_navinfo_changed",e.TocHoverInfoChanged="toc_hover_info_changed"}(J||(J={})),function(e){e.AppStateChanged="app_state_changed",e.AppSessionChanged="app_session_changed",e.PopupChooseWidget="popup_choose_widget",e.AppAddResource="app_add_resource",e.AppClearResources="app_clear_resources",e.AppTriggerKeyboard="app_trigger_keyboard",e.SetLayoutTools="app_set_layout_tools",e.ClearLastAppConfigFromHistory="clear_last_app_config_from_history",e.SetIsBusy="app_set_isbusy",e.AppIsLoaded="app_is_loaded",e.ConfirmDelete="confirm_delete"}(Q||(Q={})),function(e){e.AddResource="ADD_RESOURCE",e.UpdateResource="UPDATE_RESOURCE",e.ClearResources="CLEAR_RESOURCES"}(Z||(Z={}));const Y={AddResource:(e,t)=>({type:Z.AddResource,resourceKey:e,resourceItemInfo:t}),UpdateResource:(e,t)=>({type:Z.UpdateResource,resourceKey:e,resourceItemInfo:t}),ClearResources:()=>({type:Z.ClearResources})};class X{constructor(){this.id="builder-state-resource-extension"}getActions(){return Object.keys(Z).map(e=>Z[e])}getInitLocalState(){return Object(l.Immutable)({})}getReducer(){return(e,t,i)=>{switch(t.type){case Z.AddResource:case Z.UpdateResource:return e.set(t.resourceKey,t.resourceItemInfo);case Z.ClearResources:return Object(l.Immutable)({});default:return e}}}getStoreKey(){return"resourcesInfo"}}var ee=i(3),te=function(e,t,i,o){return new(i||(i=Promise))((function(n,s){function a(e){try{p(o.next(e))}catch(e){s(e)}}function r(e){try{p(o.throw(e))}catch(e){s(e)}}function p(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};class ie{constructor(){this.resourceMap={},this.blobToResourceMap={},this.resourcesInDraft={},this.getResourcesInDraft=()=>this.resourcesInDraft,this.setResourcesInDraft=e=>{this.resourcesInDraft=e},this.getResourcesInAppConfig=e=>te(this,void 0,void 0,(function*(){const t=this.getAppId(),i={},o=[];let n=null;const s=new RegExp("^\\$\\{appResourceUrl\\}+(.)");const a={matchFunction:function(e){return s.test(e)},matchHandle:function(e){i[e.value]=e.value}};return l.appConfigUtils.replaceAppConfigNodeValue(e,a).then(()=>te(this,void 0,void 0,(function*(){return yield ee.appServices.getAppResources({id:t,isLocalApp:window.jimuConfig.isDevEdition}).then(e=>te(this,void 0,void 0,(function*(){if(n=e&&e.resources,n)for(let e=0;e<n.length;e++){const t="${appResourceUrl}/"+n[e].resource;i[t]&&o.push({url:i[t],fileName:n[e].resource.split("/")[n[e].resource.split("/").length-1],created:n[e].created,size:n[e].size})}return yield Promise.resolve(o)})))})))})),this.setImageResourcesInDraft=e=>{const t=this.getResourcesInDraft();t.imageResources=e,this.setResourcesInDraft(t)},this.getImageResourcesInDraft=(e,t)=>te(this,void 0,void 0,(function*(){if(this.resourcesInDraft.imageResources)return yield Promise.resolve(this.resourcesInDraft.imageResources);{const t=l.SessionManager.getInstance().getMainSession(),i=Object(ee.getResourceOrigin)({isLocalApp:window.jimuConfig.isDevEdition})+e+"/resources",o=Object(ee.getResourceOrigin)({isLocalApp:window.jimuConfig.isDevEdition})+e+"/resources/images/image-resources-list.json?token="+(null==t?void 0:t.token);return yield fetch(""+o,{cache:"no-cache"}).then(e=>te(this,void 0,void 0,(function*(){return 404===e.status?yield Promise.resolve(null):yield e.json()}))).then(e=>te(this,void 0,void 0,(function*(){if(e){const o=e;return Object.keys(o).forEach(e=>{o[e].url=o[e].url.replace("${appResourceUrl}",i)+"?token="+(null==t?void 0:t.token)}),Promise.resolve(o)}return this.uploadImageResourcesConfig({}).then(e=>te(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})))}))).catch(e=>te(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject(null)})))}})),this.updateImageResourceItemInfo=e=>{const t=this.getAppId();this.getImageResourcesInDraft(t).then(t=>{const i=Object.assign({},e);delete i.blobUrl,delete i.type,t[i.fileName.split(".")[0]]=i,this.setImageResourcesInDraft(t)})},this.uploadImageResourcesConfig=e=>te(this,void 0,void 0,(function*(){const t=e||{},i={appId:this.getAppId(),file:new Blob([JSON.stringify(t)],{type:"application/json"}),resourcesPrefix:"images",fileName:"image-resources-list.json",type:l.ResourceType.Image};return ie.getInstance().upLoadFileToResource(i).then(()=>te(this,void 0,void 0,(function*(){return yield Promise.resolve(t)})),()=>te(this,void 0,void 0,(function*(){return yield Promise.reject(null)})))})),this.cleanValueInImageResourcesConfig=(e,t)=>te(this,void 0,void 0,(function*(){return this.getAppId()!==e&&(this.resourcesInDraft.imageResources=null),t.length>0?yield this.getImageResourcesInDraft(e).then(e=>te(this,void 0,void 0,(function*(){if(e){const i=[];for(let o=0;o<t.length;o++){const n=Object.keys(e);let s=!0;for(let i=0;i<n.length;i++){const a=n[i];if(e[a].resourcesPrefix+"/"+e[a].fileName===t[o]&&e[a].referedIds.length>0){s=!1;break}}s&&i.push(t[o])}return yield Promise.resolve(i)}return yield Promise.resolve(t)}))):yield Promise.resolve(t)}))}static getInstance(){return ie._instance||(ie._instance=new ie,window._appResourceManager=ie._instance),window._appResourceManager}getResourceItem(e){return this.resourceMap[e]}getResourceMap(){return this.resourceMap}setResourceItem(e,t){this.resourceMap[e]?this.resourceMap[e]=Object.assign(this.resourceMap[e],t):this.resourceMap[e]=t,Object(l.getAppStore)().dispatch(Y.AddResource(e,this.resourceMap[e])),this.blobToResourceMap[t.blobUrl]={id:t.id,resourceUrl:t.resourceUrl}}clearResources(e){for(const e in this.resourceMap)this.resourceMap[e]&&window.URL.revokeObjectURL(this.resourceMap[e].blobUrl);this.resourceMap={},this.blobToResourceMap={},this.removeUnnecessaryResources(e),Object(l.getAppStore)().dispatch(Y.ClearResources())}getAppId(){return Object(l.getAppStore)().getState().appStateInBuilder&&Object(l.getAppStore)().getState().appStateInBuilder.appId}addAppItemResource(e){return te(this,void 0,void 0,(function*(){const t=l.SessionManager.getInstance().getMainSession();return yield ee.appServices.getAppInfo({id:e.appId,isLocalApp:window.jimuConfig.isDevEdition}).then(i=>te(this,void 0,void 0,(function*(){return yield ee.appServices.addAppResource({id:e.appId,resource:e.file,name:e.fileName,owner:i.owner,params:{resourcesPrefix:e.resourcesPrefix},authentication:t}).then(t=>te(this,void 0,void 0,(function*(){return this.setResourceItemInfoStatus(e,l.AjaxState.Success),yield Promise.resolve(t)})),t=>te(this,void 0,void 0,(function*(){return this.setResourceItemInfoStatus(e,l.AjaxState.Error),yield Promise.reject(t)})))})))}))}getAppItemResources(e){return te(this,void 0,void 0,(function*(){return yield ee.appServices.getAppResources({id:e.appId,isLocalApp:window.jimuConfig.isDevEdition})}))}updateAppItemResource(e){return te(this,void 0,void 0,(function*(){const t=l.SessionManager.getInstance().getMainSession();return yield ee.appServices.getAppInfo({id:e.appId,isLocalApp:window.jimuConfig.isDevEdition}).then(i=>te(this,void 0,void 0,(function*(){return yield ee.appServices.updateAppResource({id:e.appId,resource:e.file,name:e.fileName,owner:i.owner,params:{resourcesPrefix:e.resourcesPrefix},authentication:t}).then(t=>te(this,void 0,void 0,(function*(){return this.setResourceItemInfoStatus(e,l.AjaxState.Success),yield Promise.resolve(t)})),t=>te(this,void 0,void 0,(function*(){return this.setResourceItemInfoStatus(e,l.AjaxState.Error),yield Promise.reject(t)})))})))}))}removeAppItemResource(e){return te(this,void 0,void 0,(function*(){const t=l.SessionManager.getInstance().getMainSession(),i=e.appId?e.appId:this.getAppId();return yield ee.appServices.getAppInfo({id:i,isLocalApp:window.jimuConfig.isDevEdition}).then(o=>te(this,void 0,void 0,(function*(){return yield ee.appServices.removeAppResource({id:i,owner:o.owner,resource:e.fileName,authentication:t}).then(e=>te(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})),e=>te(this,void 0,void 0,(function*(){return yield Promise.reject(e)})))})))}))}getLocalCacheResourceUrl(e){return te(this,void 0,void 0,(function*(){try{const t=window.URL.createObjectURL(e.file);return e.url=t,e.blobUrl=t,this.upLoadFileToResource(e),yield Promise.resolve(e)}catch(e){return yield Promise.reject(e)}}))}getBlobByBlobUrl(e){return te(this,void 0,void 0,(function*(){return yield new Promise((function(t,i){const o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.onload=function(e){if(200==this.status){const e=this.response;return t(e)}return i()},o.onerror=function(e){return i()},o.send()}))}))}getResourcePrefix(e){if(e.resourcesPrefix)return e.resourcesPrefix;let t="";return t=e.type===l.ResourceType.Image?e.widgetId?"images/"+e.widgetId:"images/templates":e.type===l.ResourceType.Config?"config":"templates",t}upLoadFileToResource(e){return te(this,void 0,void 0,(function*(){const t=e.appId?e.appId:this.getAppId(),i=e.fileName,o=e.originalName,n=this.getResourcePrefix(e);e.resourcesPrefix=n;const s="${appResourceUrl}/"+(n?n+"/":"")+i,a=Object(l.uuidv1)(),r={id:a,appId:t,fileName:i,originalName:o,resourcesPrefix:n,url:e.url,blobUrl:e.blobUrl,resourceUrl:s,type:e.type,status:l.AjaxState.Fetching,widgetId:e.widgetId,owner:e.owner},p=Object.assign({},r);p.file=e.file;const u=this.getAppItemResources(p).then(e=>te(this,void 0,void 0,(function*(){const t=this,i=p.resourcesPrefix;if(e&&e.resources){const o=e.resources;if(0===o.length)return yield t.addAppItemResource(p);{let e=!1;for(let t=0;t<o.length;t++)if(o[t].resource===(i?i+"/":"")+p.fileName){e=!0;break}return e?yield t.updateAppItemResource(p):yield t.addAppItemResource(p)}}throw"return value from getAppItemResources is not right"}))).catch(e=>te(this,void 0,void 0,(function*(){return console.error(e),this.setResourceItemInfoStatus(p,l.AjaxState.Error),yield Promise.reject()})));return p.promise=u,this.setResourceItem(a,r),yield u}))}setAppConfigLocalFileToResource(e){return te(this,void 0,void 0,(function*(){return yield this.setConfigLocalFileToResource(e)}))}uploadImageConfigFileToPortal(e,t){return te(this,void 0,void 0,(function*(){const i=e,o={};return yield this.getResourcesInAppConfig(Object.assign({},t)).then(e=>te(this,void 0,void 0,(function*(){const t={},n=[];for(let t=0;t<e.length;t++){const i=e[t].fileName.split(".")[0];n.push(i)}return Object.keys(i).forEach(e=>{i[e].referedIds=[];const o=i[e].originId;(n.includes(o)||n.includes(e))&&(t[e]=i[e],t[o]=i[o])}),Object.keys(t).forEach(e=>{t[e].referedIds=[];const i=t[e].originId;i!==e&&(o[i]?o[i].referedIds.push(e):(o[i]=Object.assign({},t[i]),o[i].referedIds=[e]))}),Object.keys(o).forEach(e=>{t[e]&&(t[e].referedIds=o[e].referedIds)}),this.setConfigLocalFileToResource(t).then(e=>te(this,void 0,void 0,(function*(){return yield this.uploadImageResourcesConfig(e)})))})))}))}setConfigLocalFileToResource(e){return te(this,void 0,void 0,(function*(){const t=this.blobToResourceMap,i=new RegExp("^blob:http(s?)://(.)"),o=[];const n={matchFunction:function(e){return i.test(e)},matchHandle:function(e){const i=e.obj,n=e.key;let s=e.value;s=t[e.value],!o.includes(s.id)&&o.push(s.id),"number"==typeof e.i?i[n][e.i]=s.resourceUrl:i[n]=s.resourceUrl}};return l.appConfigUtils.replaceAppConfigNodeValue(e,n).then(e=>te(this,void 0,void 0,(function*(){return yield this.checkResourcesUploadStatus(o).then(t=>te(this,void 0,void 0,(function*(){return t===l.AjaxState.Success?yield Promise.resolve(e):yield Promise.reject()})))})))}))}checkResourcesUploadStatus(e){return te(this,void 0,void 0,(function*(){if(e.length>0){const t=[];for(let i=0;i<e.length;i++)t.push(this.resourceMap[e[i]].promise);return yield Promise.all(t).then(()=>te(this,void 0,void 0,(function*(){return yield Promise.resolve(l.AjaxState.Success)})),()=>te(this,void 0,void 0,(function*(){return yield Promise.resolve(l.AjaxState.Error)}))).catch(e=>te(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject()})))}return yield Promise.resolve(l.AjaxState.Success)}))}uploadAppConfigFileToPortal(e,t,i){return te(this,void 0,void 0,(function*(){const o=new Blob([JSON.stringify(t)],{type:"application/json"}),n={appId:e,file:o,fileName:"config.json",type:l.ResourceType.Config,owner:i};return yield this.upLoadFileToResource(n).then(()=>te(this,void 0,void 0,(function*(){return yield Promise.resolve()})),()=>te(this,void 0,void 0,(function*(){return yield Promise.reject()})))}))}getConfigFromItemResource(e){return te(this,void 0,void 0,(function*(){const t=l.SessionManager.getInstance().getMainSession();var i=(new Date).getTime();const o=Object(ee.getResourceOrigin)({isLocalApp:window.jimuConfig.isDevEdition})+e+"/resources/config/config.json?token="+(null==t?void 0:t.token)+"&f=json&timestamp="+i;return yield fetch(""+o,{cache:"no-cache"}).then(e=>te(this,void 0,void 0,(function*(){return yield e.json()}))).then(e=>e).catch(e=>te(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject(null)})))}))}setResourceItemInfoStatus(e,t){this.resourceMap&&this.resourceMap[e.id]&&(e.status=t,delete e.file,this.setResourceItem(e.id,e))}removeUnnecessaryResources(e){if(!e)return;let t=null;t=window.jimuConfig.isDevEdition?window.location.origin+"/apps/"+e+"/resources/":l.portalUrlUtils.getHostUrlByOrgUrl(Object(l.getAppStore)().getState().portalUrl)+"/sharing/rest/content/items/"+e+"/resources/";let i=null;try{ee.appServices.getAppResources({id:e,isLocalApp:window.jimuConfig.isDevEdition},{httpMethod:"GET"}).then(o=>{i=o&&o.resources;let n=!1;if(i)for(let e=0;e<i.length;e++)if("config/config.json"===i[e].resource||"images/image-resources-list.json"===i[e].resource){n=!0;break}ee.appServices.getAppConfig({id:e,isLocalApp:window.jimuConfig.isDevEdition}).then(o=>{const s=new RegExp("^\\$\\{appResourceUrl\\}+(.)"),a=new RegExp("^"+t),r={};const p={matchFunction:function(e){return s.test(e)||a.test(e)},matchHandle:function(e){r[e.value]=e.value}};l.appConfigUtils.replaceAppConfigNodeValue(o,p).then(()=>te(this,void 0,void 0,(function*(){return n?yield this.getConfigFromItemResource(e):yield Promise.resolve({})}))).then(e=>{l.appConfigUtils.replaceAppConfigNodeValue(e,p)}).then(()=>{const o=[];if(i){for(let e=0;e<i.length;e++)"config/config.json"!==i[e].resource&&"images/image-resources-list.json"!==i[e].resource&&(r["${appResourceUrl}/"+i[e].resource.replace("_compress","")]||r[t+i[e].resource.replace("_compress","")]||o.push(i[e].resource));this.cleanValueInImageResourcesConfig(e,o).then(t=>{t.map(t=>{this.removeAppItemResource({appId:e,fileName:t})})})}})})})}catch(e){console.error(e)}}}var oe=function(e,t,i,o){return new(i||(i=Promise))((function(n,s){function a(e){try{p(o.next(e))}catch(e){s(e)}}function r(e){try{p(o.throw(e))}catch(e){s(e)}}function p(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};function ne(e){be("to_app."+J.AppConfigChanged,e)}function se(e){be("to_app."+J.AppInfoChanged,e)}function ae(e){be("to_app."+J.DialogInfosChanged,e)}function re(e){be("to_app."+J.ChangeAppMode,e)}function pe(e){be("to_app."+J.ChangePage,e)}function ue(e){be("to_app."+J.ChangeDialog,e)}function de(e){be("to_app."+J.ChangeSelection,e)}function ce(e){be("to_app."+J.ChangeWidgetStateProp,e)}function le(e){be("to_app."+J.ChangeWidgetMutableStateProp,e)}function ge(e){be("to_app."+J.BuilderTriggerKeyboard,e)}function he(e){be("to_app."+J.ChangeBrowserSizeMode,e)}function fe(){be("to_app."+J.BuilderSessionChanged,l.SessionManager.getInstance().getSessions())}function ye(e){be("to_app."+J.ChangeZoomScale,e)}function me(e){be("to_app."+J.ActivePagePartChanged,e)}function Se(e){be("to_app."+J.AnimationPreview,e)}function Ce(e,t){be("to_app."+J.SectionNavInfoChanged,{sectionId:e,navInfo:t})}function Ie(e,t){be("to_app."+J.ScreenGroupNavInfoChanged,{screenGroupId:e,activeIndex:t})}function ve(e,t){be("to_app."+J.TocHoverInfoChanged,{layoutInfo:e,hovered:t})}function be(e,t){window._builderPubsub.publishSync(e,t)}function we(){window._builderPubsub.subscribe("to_builder."+Q.AppSessionChanged,(e,t)=>{l.SessionManager.getInstance().syncSessionsFromOtherWindow(t)}),window._builderPubsub.subscribe("to_builder",(function(e,t){console.debug(e,t)})),window._builderPubsub.subscribe("to_builder."+Q.AppStateChanged,(e,t)=>{var i;if(Object(l.getAppStore)().getState().builder.currentAppId!==t.appId&&Object(l.getAppStore)().dispatch(g.changeCurrentApp(t.appId)),!Object(l.getAppStore)().getState().appStateInBuilder||Object(l.getAppStore)().getState().appStateInBuilder.appConfig!==t.appConfig){const e=t.appConfig,o=null===(i=Object(l.getAppStore)().getState().appStateInBuilder)||void 0===i?void 0:i.appConfig;if(e&&o){if(Object.keys(e.widgets||{}).find(t=>e.widgets[t]&&o.widgets[t]&&e.widgets[t].version!==o.widgets[t].version))return void Object(l.getAppStore)().dispatch(q.inAppAppStateChanged(t));const i=Object.keys(o.widgets).filter(t=>!e.widgets[t]);Object(l.getAppStore)().dispatch(g.widgetsRemoved(i));const n=Object.keys(e.widgets).filter(e=>!o.widgets[e]).map(t=>({widgetId:t,widgetUri:e.widgets[t].uri}));Object(l.getAppStore)().dispatch(g.widgetsAdded(n))}Object(l.getAppStore)().dispatch($.InBuilderPutAppConfigIntoHistory(t.appConfig))}Object(l.getAppStore)().dispatch(q.inAppAppStateChanged(t))}),window._builderPubsub.subscribe("to_builder."+Q.PopupChooseWidget,(e,t)=>{Object(l.getAppStore)().dispatch(g.openChooseWidgetPopup(t.layoutId,t.layoutItemId))}),window._builderPubsub.subscribe("to_builder."+Q.AppAddResource,(e,t)=>{const i=ie.getInstance();i.getBlobByBlobUrl(t.file).then(e=>oe(this,void 0,void 0,(function*(){t.file=e,i.upLoadFileToResource(t),t.type===l.ResourceType.Image&&t.originId&&ie.getInstance().updateImageResourceItemInfo(t)})))}),window._builderPubsub.subscribe("to_builder."+Q.AppClearResources,(e,t)=>{ie.getInstance().clearResources(t)}),window._builderPubsub.subscribe("to_builder."+Q.AppTriggerKeyboard,(e,t)=>{l.keyboardUtils.triggerEvent(t)}),window._builderPubsub.subscribe("to_builder."+Q.SetLayoutTools,(e,t)=>{Object(l.getAppStore)().dispatch(g.setLayoutTools(t))}),window._builderPubsub.subscribe("to_builder."+Q.ClearLastAppConfigFromHistory,e=>{Object(l.getAppStore)().dispatch($.InBuilderRemoveLastAppConfigFromHistory())}),window._builderPubsub.subscribe("to_builder."+Q.SetIsBusy,(e,t)=>{Object(l.getAppStore)().dispatch(l.appActions.setIsBusy(t))}),window._builderPubsub.subscribe("to_builder."+Q.ConfirmDelete,(e,t)=>{Object(l.getAppStore)().dispatch(g.confirmDeleteContentChanged(t))}),window._builderPubsub.subscribe("to_builder."+Q.AppIsLoaded,(e,t)=>{var i;const o=l.SessionManager.getInstance().getMainPortal();be("to_app."+J.SetMainPortal,o),be("to_app."+J.PortalSelfChanged,Object(l.getAppStore)().getState().portalSelf),l.portalUtils.getAppInfo(null===(i=Object(l.getAppStore)().getState().queryObject)||void 0===i?void 0:i.id).then(e=>{be("to_app."+J.AppInfoChanged,e)}),Object(l.getAppStore)().getState().user&&be("to_app."+J.UserSignIn,Object(l.getAppStore)().getState().user),fe()})}let De;try{De=window.parent&&window.parent._builderPubsub}catch(e){console.error("Can access parent.")}function Ae(){if(!De)return;De.unsubscribe("to_app");const e=Object(l.getAppStore)();De.subscribe("to_app",(function(e,t){console.debug(e,t)})),De.subscribe("to_app."+J.AppConfigChanged,(function(t,i){const o=e.getState();if(o.appRuntimeInfo.currentPageId&&!i.pages[o.appRuntimeInfo.currentPageId]){const e=Object.keys(i.pages).find(e=>i.pages[e].isDefault);l.jimuHistory.changePage(e)}e.dispatch(l.appActions.appConfigChanged(i))})),De.subscribe("to_app."+J.AppInfoChanged,(function(t,i){e.dispatch(l.appActions.appInfoChanged(i))})),De.subscribe("to_app."+J.PortalSelfChanged,(function(t,i){if(e.dispatch(l.appActions.setPortalSelf(i)),!i.isPortal){const t=`https://${i.urlKey}.${i.customBaseUrl}`;i.urlKey&&!l.portalUrlUtils.isSamePortalUrl(e.getState().portalUrl,t)&&e.dispatch(l.appActions.setPortalInfo(t))}})),De.subscribe("to_app."+J.UserSignIn,(function(t,i){e.dispatch(l.appActions.userSignIn(i))})),De.subscribe("to_app."+J.SetMainPortal,(function(t,i){e.dispatch(l.appActions.setPortalInfo(i.portalUrl,i.clientId)),l.SessionManager.getInstance().setMainPortal(i)})),De.subscribe("to_app."+J.DialogInfosChanged,(function(t,i){e.dispatch(l.appActions.dialogInfosChanged(i))})),De.subscribe("to_app."+J.ChangeAppMode,(function(t,i){e.dispatch(l.appActions.appModeChanged(i))})),De.subscribe("to_app."+J.ChangeWidgetStateProp,(function(t,i){e.dispatch(l.appActions.widgetStatePropChange(i.widgetId,i.propKey,i.value))})),De.subscribe("to_app."+J.ChangeWidgetMutableStateProp,(function(e,t){l.MutableStoreManager.getInstance().updateStateValue(t.widgetId,t.propKey,t.value)})),De.subscribe("to_app."+J.ChangePage,(function(e,t){const i=Object(l.getAppStore)().getState().appConfig.pages[t];i.type===l.PageType.Link||i.type===l.PageType.Folder||l.urlUtils.parseAppPath(location.pathname).pageId===t?Object(l.getAppStore)().dispatch(l.appActions.currentPageChanged(t)):l.jimuHistory.changePage(t)})),De.subscribe("to_app."+J.ChangeDialog,(function(t,i){l.jimuHistory.changeDialog(i),e.dispatch(l.appActions.currentDialogChanged(i))})),De.subscribe("to_app."+J.ChangeSelection,(function(t,i){e.dispatch(l.appActions.selectionChanged(i))})),De.subscribe("to_app."+J.BuilderTriggerKeyboard,(function(e,t){l.keyboardUtils.triggerEvent(t)})),De.subscribe("to_app."+J.ChangeBrowserSizeMode,(function(t,i){e.dispatch(l.appActions.browserSizeModeChanged(i))})),De.subscribe("to_app."+J.BuilderSessionChanged,(function(e,t){l.SessionManager.getInstance().syncSessionsFromOtherWindow(t)})),De.subscribe("to_app."+J.ChangeZoomScale,(function(t,i){e.dispatch(l.appActions.zoomScaleChange(i))})),De.subscribe("to_app."+J.ActivePagePartChanged,(function(t,i){e.dispatch(l.appActions.activePagePartChanged(i))})),De.subscribe("to_app."+J.AnimationPreview,(function(t,i){e.dispatch(l.appActions.setupAnimationPreview(i))})),De.subscribe("to_app."+J.SectionNavInfoChanged,(function(t,i){e.dispatch(l.appActions.sectionNavInfoChanged(i.sectionId,i.navInfo))})),De.subscribe("to_app."+J.ScreenGroupNavInfoChanged,(function(t,i){e.dispatch(l.appActions.screenGroupNavInfoChanged(i.screenGroupId,i.activeIndex))})),De.subscribe("to_app."+J.TocHoverInfoChanged,(function(e,t){const{layoutInfo:i,hovered:o}=t,{layoutId:n,layoutItemId:s}=i,a=document.querySelector(`div.builder-layout-item[data-layoutid="${n}"][data-layoutitemid="${s}"]`);a&&(o?a.classList.add("hovered"):a.classList.remove("hovered"))}))}function je(){_e("to_builder."+Q.AppSessionChanged,l.SessionManager.getInstance().getSessions())}function Le(){_e("to_builder."+Q.AppStateChanged,Object(l.getAppStore)().getState())}function Oe(){_e("to_builder."+Q.AppIsLoaded)}function xe(e,t){_e("to_builder."+Q.PopupChooseWidget,{layoutId:e,layoutItemId:t})}function Pe(e){_e("to_builder."+Q.AppAddResource,e)}function Me(e){_e("to_builder."+Q.AppClearResources,e)}function Te(e){_e("to_builder."+Q.AppTriggerKeyboard,e)}function Ee(e){_e("to_builder."+Q.SetLayoutTools,e)}function Ue(){_e("to_builder."+Q.ClearLastAppConfigFromHistory)}function ke(e){_e("to_builder."+Q.SetIsBusy,e)}function Re(e){_e("to_builder."+Q.ConfirmDelete,e)}function _e(e,t){De&&De.publishSync(e,t)}function Be(){return window.jimuConfig.isBuilder?Object(l.getAppStore)().getState().appStateInBuilder.browserSizeMode:Object(l.getAppStore)().getState().browserSizeMode}function We(e){var t,i;return(null==e?void 0:e.widgetType)===l.WidgetType.Layout||null!==(i=null===(t=null==e?void 0:e.properties)||void 0===t?void 0:t.hasEmbeddedLayout)&&void 0!==i&&i}function Ge(e){return e||(e=function(){const e=Object(l.getAppStore)().getState();return window.jimuConfig.isBuilder?e&&e.appStateInBuilder&&e.appStateInBuilder.appConfig:e&&e.appConfig}()),new Fe(e)}class Fe{constructor(e){this.clearDeletedWidgetMessageAction=(e,t)=>{this.getDeletedWidgetsMessageConfigs(e,t).forEach(e=>{this.removeMessageAction(e)})},this.getDeletedWidgetsMessageConfigs=(e,t)=>{const i=e.messageConfigs,o=t.messageConfigs,n=[];if(!i)return n;const s=Object.keys(i),a=Object.keys(o);for(let e=0;e<s.length;e++)a.includes(s[e])||n.push(i[s[e]]);return n},this.removeMessageAction=e=>{var t;null===(t=null==e?void 0:e.actions)||void 0===t||t.forEach(t=>{const i=v.getInstance().getAction(t.widgetId,t.actionName);i&&i.onRemoveListen(e.messageType,e.widgetId)})},this.duplicatedContentMaps=null,this.appConfig=e}exec(e=!1){if(window.jimuConfig.isBuilder){Object(l.getAppStore)().dispatch({type:"IN_BUILDER_APPCONFIG_REDOCLEAR"}),e&&Object(l.getAppStore)().dispatch($.InBuilderRemoveLastAppConfigFromHistory()),ne(this.appConfig);const t=Object(l.getAppStore)().getState().appStateInBuilder.appConfig,i=this.appConfig,o=Object.keys(t.widgets).filter(e=>!i.widgets[e]);Object(l.getAppStore)().dispatch(g.widgetsRemoved(o)),this.clearDeletedWidgetMessageAction(t,i);const n=Object.keys(i.widgets).filter(e=>!t.widgets[e]).map(e=>({widgetId:e,widgetUri:i.widgets[e].uri}));Object(l.getAppStore)().dispatch(g.widgetsAdded(n)),Object(l.getAppStore)().dispatch(q.inBuilderAppConfigChanged(this.appConfig)),Object(l.getAppStore)().dispatch($.InBuilderPutAppConfigIntoHistory(this.appConfig))}else{e&&Ue();const t=Object(l.getAppStore)().getState().appConfig,i=this.appConfig;this.clearDeletedWidgetMessageAction(t,i),Object(l.getAppStore)().dispatch(l.appActions.appConfigChanged(this.appConfig))}return this}editWidgetConfig(e,t){return this.appConfig.widgets[e]?(this.appConfig=this.appConfig.setIn(["widgets",e,"config"],t),this):this}editWidget(e,t){if(!this.appConfig.widgets[e.id])return this;const i=this.appConfig.widgets[e.id];let o=i;return t&&(t.forEach(e=>{e.isOutputFromWidget||(e.isOutputFromWidget=!0)}),o=o.set("outputDataSources",t.map(e=>e.id))),Object.keys(e).forEach(t=>{null===e[t]&&("outputDataSourcesJson"===t&&e.outputDataSources&&e.outputDataSources.forEach(e=>this.removeDataSource(e)),o=o.without(t),delete e[t])}),i.outputDataSources&&i.outputDataSources.forEach(e=>{o.outputDataSources&&o.outputDataSources.includes(e)||this.removeDataSource(e)}),o.outputDataSources&&o.outputDataSources.forEach(e=>{const o=t&&t.find(t=>t.id===e);o&&(i.outputDataSources&&i.outputDataSources.includes(e)?this.editDataSource(Object(l.Immutable)(o)):this.addDataSource(Object(l.Immutable)(o)))}),o=o.merge(e),e.useDataSources&&o.layouts&&o.manifest.properties.passDataSourceToChildren&&this.copyUseDataSourceToAllChildWidgets(i,o),this.appConfig=this.appConfig.setIn(["widgets",e.id],o),this}editWidgetProperty(e,t,i){if(!this.appConfig.widgets||!this.appConfig.widgets[e])return this;if("outputDataSources"===t)return console.error("Please use editWidget to update outputDataSources."),this;const o=this.appConfig.widgets[e];return o.getIn([t])===i?this:this.editWidget(o.set(t,i).asMutable({deep:!0}))}createWidget(e,t=!0){return this.appConfig=this.appConfig.setIn(["widgets",e.id],e),t&&We(e.manifest)&&(this.createLayoutsForWidget(e,Be()),e=this.appConfig.widgets[e.id]),this.appConfig=this.appConfig.setIn(["widgets",e.id],e),e}removeWidget(e){if(!this.appConfig.widgets||!this.appConfig.widgets[e])return this;const t=this.appConfig.widgets[e];return b.searchUtils.getLayoutInfosHoldcontent(this.appConfig,l.LayoutItemType.Widget,e).forEach(e=>{this.removeLayoutItem(e,!1)}),t.outputDataSources&&t.outputDataSources.forEach(e=>this.removeDataSource(e)),this.appConfig=this.removeWidgetMessageAndAction(this.appConfig,e),this.appConfig=this.removeDataActionProvidedByWidget(this.appConfig,e),t.layouts&&Object.keys(t.layouts).forEach(e=>{const i=t.layouts[e];Object.keys(i).forEach(e=>{this.removeLayout(i[e],!0)})}),this.appConfig=this.appConfig.set("widgets",this.appConfig.widgets.without(e)),this}duplicateWidget(e){if(!e||!this.appConfig.widgets[e])return null;const t=this.appConfig.widgets[e];let i=t.set("id",D(this.appConfig,"widget")).set("label",this.getDuplicateLabel("widgets",t.label));if(We(i.manifest)&&(this.appConfig=this.appConfig.setIn(["widgets",i.id],i),i=this.doDuplicateEmbedWidgetContent(i)),"controller"===t.manifest.name&&(i=this.fixWidgetIdInControllerWidgetAfterCopy(t,i)),this.duplicateWidgetMessageConfig(e,i.id),i.outputDataSources){const e=i.outputDataSources.map(e=>this.duplicateDataSource(e).id);i=i.set("outputDataSources",e)}return this.appConfig=this.appConfig.setIn(["widgets",i.id],i),i}fixWidgetIdInControllerWidgetAfterCopy(e,t){var i,o,n,s,a,r,p;if(!(null===(o=null===(i=e.config)||void 0===i?void 0:i.behavior)||void 0===o?void 0:o.openStarts)||(null===(a=null===(s=null===(n=e.config)||void 0===n?void 0:n.behavior)||void 0===s?void 0:s.openStarts)||void 0===a?void 0:a.length)<=0)return t;const u=null===(p=null===(r=e.config)||void 0===r?void 0:r.behavior)||void 0===p?void 0:p.openStarts,d=[];return u.forEach(i=>{const o=this.appConfig.layouts[e.layouts.controller.LARGE],n=this.appConfig.layouts[t.layouts.controller.LARGE];null==o||o.order.forEach((e,t)=>{if(o.content[e].widgetId===i){const e=n.content[n.order[t]].widgetId;d.push(e)}})}),t.setIn(["config","behavior","openStarts"],d)}createSection(){const e=this.createEmptyLayoutJson(this.appConfig).set("type",l.LayoutType.FixedLayout);this.appConfig=this.appConfig.setIn(["layouts",e.id],e);const t=Object(l.Immutable)({id:D(this.appConfig,"view"),label:A(this.appConfig,"view",l.i18n.getIntl().formatMessage({id:"view"}))}).setIn(["layout",Object(l.getAppStore)().getState().browserSizeMode],e.id);this.appConfig=this.appConfig.setIn(["views",t.id],t);const i=D(this.appConfig,"section"),o=A(this.appConfig,"section",l.i18n.getIntl().formatMessage({id:"section"})),n=Object(l.Immutable)({id:i,label:o,views:[t.id]});return this.appConfig=this.appConfig.setIn(["sections",n.id],n),n}removeSection(e){if(!this.appConfig.sections||!this.appConfig.sections[e])return this;return b.searchUtils.getLayoutInfosHoldcontent(this.appConfig,l.LayoutItemType.Section,e).forEach(e=>{this.removeLayoutItem(e,!1)}),this.removeSectionContent(e),this.appConfig=this.appConfig.set("sections",this.appConfig.sections.without(e)),this}editSection(e){if(!this.appConfig.sections[e.id])return this;const t=this.appConfig.sections[e.id];return e.views.length!==t.views.length?(console.error("Can not add/remove view."),this):(this.appConfig=this.appConfig.setIn(["sections",e.id],e),this)}editSectionProperty(e,t,i){if(!this.appConfig.sections||!this.appConfig.sections[e])return this;const o=this.appConfig.sections[e];return o.getIn([t])===i?this:this.editSection(o.set(t,i))}editScreenGroupProperty(e,t,i){if(!this.appConfig.screenGroups||!this.appConfig.screenGroups[e])return this;return this.appConfig.screenGroups[e].getIn([t])===i||(this.appConfig=this.appConfig.setIn(["screenGroups",e,t],i)),this}duplicateSection(e){if(!e||!this.appConfig.sections[e])return null;const t=this.appConfig.sections[e];let i=t.set("id",D(this.appConfig,"section")).set("label",this.getDuplicateLabel("sections",t.label));this.appConfig=this.appConfig.setIn(["sections",i.id],i);const o=t.views&&t.views.map(e=>this.duplicateView(e,i.id,!1).id);return i=i.set("views",o),this.appConfig=this.appConfig.setIn(["sections",i.id],i),i}editView(e){return this.appConfig=this.appConfig.setIn(["views",e.id],e),this}addView(e,t){if(this.appConfig.views&&this.appConfig.views[e.id])return this;if(!this.appConfig.sections[t])return this;let i;this.appConfig.sections&&this.appConfig.sections[t]&&this.appConfig.sections[t].views?(i=this.appConfig.sections[t].views.asMutable(),i.push(e.id)):i=[e.id];const{type:o,id:n}=b.searchUtils.getContentRootContainerInfo(this.appConfig,t,l.LayoutItemType.Section,Be()),s={},a=e=>{const t=Object(l.Immutable)({}).merge({id:D(this.appConfig,"layout"),type:l.LayoutType.FixedLayout});s[e]=t,this.addLayout(s[e])};return o===l.RootContainerType.Header||o===l.RootContainerType.Footer?Object.keys(this.appConfig[n].layout).forEach(e=>a(e)):o===l.RootContainerType.Page?Object.keys(this.appConfig.pages[n].layout).forEach(e=>a(e)):o===l.RootContainerType.Dialog&&Object.keys(this.appConfig.dialogs[n].layout).forEach(e=>a(e)),Object.keys(s).forEach(t=>{e=e.setIn(["layout",t],s[t].id)}),this.appConfig=this.appConfig.setIn(["views",e.id],e).setIn(["sections",t,"views"],Object(l.Immutable)(i)),this}duplicateView(e,t,i){if(!this.appConfig.views||!this.appConfig.views[e])return null;let o=this.appConfig.views[e].set("id",D(this.appConfig,"view"));if(o=o.set("label",this.getDuplicateLabel("views",o.label)),this.appConfig=this.appConfig.setIn(["views",o.id],o),o=o.set("layout",this.doDuplicateContainerContent(l.ContainerType.View,e)),this.appConfig=this.appConfig.setIn(["views",o.id],o),i){let e=this.appConfig.sections[t];e=e.set("views",e.views.concat(o.id)),this.appConfig=this.appConfig.setIn(["sections",e.id],e)}return o}removeView(e,t){if(!(this.appConfig.views&&this.appConfig.views[e]&&this.appConfig.sections[t]&&this.appConfig.sections[t].views))return this;if(!this.appConfig.sections||!this.appConfig.sections[t]||1===this.appConfig.sections[t].views.length||!this.appConfig.sections[t].views.includes(e))return this;const i=this.appConfig.sections[t].views.flatMap(t=>t===e?[]:[t]);return this.appConfig=this.appConfig.setIn(["sections",t,"views"],i),this.removeContainerContent(l.ContainerType.View,e),this.appConfig=this.appConfig.set("views",this.appConfig.views.without(e)),this}moveViewInSection(e,t,i,o){if(!(this.appConfig.sections&&this.appConfig.sections[e]&&this.appConfig.views&&this.appConfig.views[t]&&this.appConfig.views[i]))return this;if(i===t)return console.error("viewId is same to targetViewId."),this;let n=this.appConfig.sections[e].views.asMutable();n=n.filter(e=>e!==t);let s=n.indexOf(i);return"below"===o&&s++,n=n.slice(0,s).concat(t).concat(n.slice(s)),this.appConfig=this.appConfig.setIn(["sections",e,"views"],n),this}createScreenGroup(){const e=D(this.appConfig,"screenGroup"),t=A(this.appConfig,"screenGroup",l.i18n.getIntl().formatMessage({id:"screenGroup"})),i=Object(l.Immutable)({id:e,label:t,screens:[],transitionType:l.ScreenTransitionType.Fade});return this.appConfig=this.appConfig.setIn(["screenGroups",i.id],i),i}editScreen(e){return this.appConfig=this.appConfig.setIn(["screens",e.id],e),this}moveScreenInGroup(e,t,i,o){var n;if(!(null===(n=this.appConfig.screenGroups)||void 0===n?void 0:n[e])||t===i)return this;const s=this.appConfig.screenGroups[e].screens.asMutable(),a=s[t],r=s[i];s.splice(t,1);const p=s.indexOf(r);return"below"===o?s.splice(p,1,r,a):s.splice(p,1,a,r),this.appConfig=this.appConfig.setIn(["screenGroups",e,"screens"],s),this}removeScreenByIndex(e,t){var i,o;const n=null===(o=null===(i=this.appConfig.screenGroups)||void 0===i?void 0:i[t])||void 0===o?void 0:o.screens,s=null==n?void 0:n[e];return this.removeScreen(s,t)}removeScreenGroup(e){var t;if(!(null===(t=this.appConfig.screenGroups)||void 0===t?void 0:t[e]))return this;this.appConfig.screenGroups[e].screens&&this.appConfig.screenGroups[e].screens.forEach(t=>{this.removeScreen(t,e,!0)});return b.searchUtils.getLayoutInfosHoldcontent(this.appConfig,l.LayoutItemType.ScreenGroup,e).forEach(e=>{this.removeLayoutItem(e,!1)}),this.appConfig=this.appConfig.set("screenGroups",this.appConfig.screenGroups.without(e)),this}removeScreen(e,t,i=!1){var o,n,s,a;if(!(null===(o=this.appConfig.screens)||void 0===o?void 0:o[e])||!(null===(s=null===(n=this.appConfig.screenGroups)||void 0===n?void 0:n[t])||void 0===s?void 0:s.screens))return this;if(1===this.appConfig.screenGroups[t].screens.length&&!i||!this.appConfig.screenGroups[t].screens.includes(e))return this;const r=this.appConfig.screenGroups[t].screens.flatMap(t=>t===e?[]:[t]);this.appConfig=this.appConfig.setIn(["screenGroups",t,"screens"],r);const p=this.appConfig.screens[e];return Object.keys((null===(a=p.panel)||void 0===a?void 0:a.layout)||{}).forEach(e=>{const t=p.panel.layout[e];this.removeLayout(t,!0)}),Object.keys(p.main.layout).forEach(e=>{const t=p.main.layout[e];this.removeLayout(t,!0)}),this.appConfig=this.appConfig.set("screens",this.appConfig.screens.without(e)),this}duplicateScreenByIndex(e,t,i=!0){var o,n;const s=null===(n=null===(o=this.appConfig.screenGroups)||void 0===o?void 0:o[t])||void 0===n?void 0:n.screens,a=null==s?void 0:s[e];return this.duplicateScreen(a,t,i)}duplicateScreen(e,t,i=!0){var o;if(!this.appConfig.screens[e])return null;let n=this.appConfig.screens[e].set("id",D(this.appConfig,"screen"));if(n=n.set("label",this.getDuplicateLabel("screens",n.label)),this.appConfig=this.appConfig.setIn(["screens",n.id],n),(null===(o=n.panel)||void 0===o?void 0:o.layout)&&Object.keys(n.panel.layout).forEach(e=>{const t=this.duplicateLayout(n.panel.layout[e],!0);this.appConfig=this.appConfig.setIn(["layouts",t.id],t),n=n.setIn(["panel","layout",e],t.id)}),Object.keys(n.main.layout).forEach(e=>{const t=this.duplicateLayout(n.main.layout[e],!0);this.appConfig=this.appConfig.setIn(["layouts",t.id],t),n=n.setIn(["main","layout",e],t.id)}),this.appConfig=this.appConfig.setIn(["screens",n.id],n),i){let i=this.appConfig.screenGroups[t];const o=i.screens.asMutable(),s=o.indexOf(e);o.splice(s,1,e,n.id),i=i.set("screens",o),this.appConfig=this.appConfig.setIn(["screenGroups",i.id],i)}return n}duplicateScreenGroup(e){if(!this.appConfig.screenGroups[e])return null;const t=this.appConfig.screenGroups[e];let i=t.set("id",D(this.appConfig,"screenGroup")).set("label",this.getDuplicateLabel("screenGroups",t.label));this.appConfig=this.appConfig.setIn(["screenGroups",i.id],i);const o=t.screens.map(e=>this.duplicateScreen(e,i.id,!1).id);return i=i.set("screens",o),this.appConfig=this.appConfig.setIn(["screenGroups",i.id],i),i}editPage(e){return this.appConfig=this.appConfig.setIn(["pages",e.id],e),this}editPageProperty(e,t,i){if(!this.appConfig.pages||!this.appConfig.pages[e])return this;const o=this.appConfig.pages[e];return o.getIn([t])===i?this:this.editPage(o.setIn([t],i))}addPage(e){return this.appConfig.pages&&this.appConfig.pages[e.id]||(this.appConfig=this.appConfig.setIn(["pages",e.id],e),this.appConfig=this.appConfig.set("pageStructure",this.appConfig.pageStructure.concat([{[e.id]:[]}]))),this}duplicatePage(e,t=!1){if(!this.appConfig.pages||!this.appConfig.pages[e])return null;this.duplicatedContentMaps={};let i=this.appConfig.pages[e].set("id",D(this.appConfig,"page"));i=i.set("label",this.getDuplicateLabel("pages",i.label)),this.appConfig=this.appConfig.setIn(["pages",i.id],i),i.isDefault&&(i=i.set("isDefault",!1)),i.type!==l.PageType.Link&&i.type!==l.PageType.Folder&&(i=i.set("layout",this.doDuplicateContainerContent(l.ContainerType.Page,i.id)));const o=this.appConfig.pageStructure.find(t=>!!t[e]),n=[];if(o&&o[e].forEach(e=>{const t=this.duplicatePage(e,!0);n.push(t.id)}),!t)if(o){if(this.appConfig=this.appConfig.set("pageStructure",this.appConfig.pageStructure.concat([{[i.id]:[]}])),n.length>0){const e=i.id;let t=this.appConfig.pageStructure.length-1;t<0&&(t=0),this.appConfig=this.appConfig.setIn(["pageStructure",t+"",e],n)}}else this.appConfig.pageStructure.some((t,o)=>{const n=Object.keys(t).find(i=>t[i].includes(e));if(n)return this.appConfig=this.appConfig.setIn(["pageStructure",o+"",n],this.appConfig.pageStructure[o][n].concat(i.id)),!0});return this.appConfig=this.appConfig.setIn(["pages",i.id],i),this.duplicatedContentMaps=null,i}movePageIntoPage(e,t){return this.appConfig.pages&&this.appConfig.pages[e]&&this.appConfig.pages[t]?e===t?(console.error("SubPage is same to ParentPage."),this):j(this.appConfig,t)?L(this.appConfig,e)?(console.error("SubPage has sub page(s)."),this):(this.removePageFromPageStructure(e),this.movePageIntoPageForPageStructure(e,t),this):(console.error("ParentPage is not on the first aspect."),this):this}orderPageToPage(e,t,i){if(!this.appConfig.pages||!this.appConfig.pages[t]||!this.appConfig.pages[e])return this;if(t===e)return console.error("pageId is same to targetPageId."),this;const o=!j(this.appConfig,t);if((L(this.appConfig,e)||this.appConfig.pages[e].type===l.PageType.Folder)&&o)return console.error("page structure allow two aspects only"),this;const n=this.appConfig.pageStructure.find(t=>!!t[e]);return this.removePageFromPageStructure(e),o?this.appConfig.pageStructure.some((o,n)=>{const s=Object.keys(o)[0];let a=o[s].indexOf(t);if(a>-1){let t=this.appConfig.pageStructure[n][s];return"bottom"===i&&(a+=1),t=t.slice(0,a).concat([e]).concat(t.slice(a)),this.appConfig=this.appConfig.setIn(["pageStructure",n+"",s],t),!0}}):this.appConfig.pageStructure.some((o,s)=>{if(Object.keys(o)[0]===t){"bottom"===i&&(s+=1);const t=this.appConfig.pageStructure.slice(0,s).concat([n||{[e]:[]}]).concat(this.appConfig.pageStructure.slice(s));return this.appConfig=this.appConfig.set("pageStructure",t),!0}}),this}removePage(e,t){if(!this.appConfig.pages||!this.appConfig.pages[e])return this;const i=this.appConfig.pages[e];i.type!==l.PageType.Folder&&i.type!==l.PageType.Link&&this.removeContainerContent(l.ContainerType.Page,e);const{pageStructure:o}=this.appConfig,n=o&&o.find(t=>!!t[e]);return n&&n[e].length>0&&n[e].forEach(e=>{this.removePage(e)}),this.removePageFromPageStructure(e),this.appConfig=this.appConfig.set("pages",this.appConfig.pages.without(e)),t&&this.setHomePage(t),this}setHomePage(e){return this.editPageProperty(e,"isDefault",!0)}replaceHomePage(e){return Object.keys(this.appConfig.pages).some((e,t)=>{const i=this.appConfig.pages[e];if(i.isDefault)return this.editPageProperty(i.id,"isDefault",!1),!0}),this.editPageProperty(e,"isDefault",!0)}editDialog(e){const t=this.appConfig.dialogs[e.id].mode;if(t!==e.mode){const i=this.appConfig.dialogs.asMutable({deep:!0});Object.keys(i).map(o=>{const n=i[o];n.id===e.id?i[o]=Object.assign({},e.asMutable({deep:!0}),{index:Object.keys(i).filter(e=>i[e].mode!==t).length}):n.mode===t&&n.index>e.index&&(n.index=n.index-1)}),this.appConfig=this.appConfig.set("dialogs",Object(l.Immutable)(i))}else this.appConfig=this.appConfig.setIn(["dialogs",e.id],e);return this}editDialogProperty(e,t,i){if(!this.appConfig.dialogs||!this.appConfig.dialogs[e])return this;const o=this.appConfig.dialogs[e];return o.getIn([t])===i?this:this.editDialog(o.setIn([t],i))}removeDialog(e){const t=this.appConfig.dialogs;if(!t||!t[e])return this;this.removeContainerContent(l.ContainerType.Dialog,e);const i=t[e].mode,o=t[e].index,n=t.without(e).asMutable({deep:!0});return Object.keys(n).map(e=>{const t=n[e];t.mode===i&&t.index>o&&(t.index=t.index-1)}),this.appConfig=this.appConfig.set("dialogs",Object(l.Immutable)(n)),this}duplicateDialog(e){const t=this.appConfig.dialogs;let i=t[e];if(!t||!i)return null;this.duplicatedContentMaps={};const o=Object.keys(Object.keys(t).filter(e=>t[e].mode===i.mode)).length;return i=i.set("id",D(this.appConfig,"dialog")).set("index",o).set("isSplash",!1).set("label",this.getDuplicateLabel("dialogs",i.label)).set("layout",this.doDuplicateContainerContent(l.ContainerType.Dialog,i.id)),this.appConfig=this.appConfig.setIn(["dialogs",i.id],i),this.duplicatedContentMaps=null,i}orderDialogToDialog(e,t,i){const o=this.appConfig.dialogs.asMutable({deep:!0}),n=o[e],s=o[t];if(!o||!n||!s)return this;if(t===e)return console.error("dialogId is same to targetDialogId."),this;let a;return s.index>n.index?(a="top"===i?s.index-1:s.index,Object.keys(o).map(t=>{const i=o[t];i.mode===s.mode&&i.id!==e&&i.index>n.index&&i.index<=a&&(i.index=i.index-1)})):(a="top"===i?s.index:s.index+1,Object.keys(o).map(t=>{const i=o[t];i.mode===s.mode&&i.id!==e&&i.index>=a&&i.index<n.index&&(i.index=i.index+1)})),o[e]=Object.assign({},n,{index:a,mode:s.mode}),this.appConfig=this.appConfig.set("dialogs",Object(l.Immutable)(o)),this}replaceSplashDialog(e){let t="";return Object.keys(this.appConfig.dialogs).some(e=>{const i=this.appConfig.dialogs[e];if(i.isSplash)return this.editDialogProperty(i.id,"isSplash",!1),t=i.id,!0}),!t||t&&e!==t?this.editDialogProperty(e,"isSplash",!0):this}createLayoutForSizeModeForHeader(e,t){if(!this.appConfig.header)return this;const i=this.createLayoutForSizeModeForOneLayout(e,t,this.appConfig.header.layout);return i&&(this.appConfig=this.appConfig.setIn(["header","layout",e],i.id)),this}removeSizeModeLayoutFromHeader(e){return this.appConfig.header.layout?(this.removeSizeModeLayout(this.appConfig.header.layout[e],e),this.appConfig=this.appConfig.setIn(["header","layout"],this.appConfig.header.layout.without(e)),this):this}createLayoutForSizeModeForFooter(e,t){if(!this.appConfig.footer)return this;const i=this.createLayoutForSizeModeForOneLayout(e,t,this.appConfig.footer.layout);return i&&(this.appConfig=this.appConfig.setIn(["footer","layout",e],i.id)),this}removeSizeModeLayoutFromFooter(e){return this.appConfig.footer.layout?(this.removeSizeModeLayout(this.appConfig.footer.layout[e],e),this.appConfig=this.appConfig.setIn(["footer","layout"],this.appConfig.footer.layout.without(e)),this):this}copyLayoutContent(e,t){const i=this.appConfig.layouts[e];return i?(this.appConfig=this.appConfig.setIn(["layouts",t],i.set("id",t)),this):this}createLayoutForSizeModeForPageBody(e,t,i){if(!this.appConfig.pages[i])return this;const o=this.appConfig.pages[i],n=this.createLayoutForSizeModeForOneLayout(e,t,o.layout);return n&&(this.appConfig=this.appConfig.setIn(["pages",i,"layout",e],n.id)),this}removeSizeModeLayoutFromPageBody(e,t){if(!this.appConfig.pages[e]||!this.appConfig.pages[e].layout)return this;const i=this.appConfig.pages[e];return this.removeSizeModeLayout(i.layout[t],t),this.appConfig=this.appConfig.setIn(["pages",e,"layout"],i.layout.without(t)),this}createLayoutForSizeModeForDialog(e,t,i){if(!this.appConfig.dialogs[i])return this;const o=this.appConfig.dialogs[i],n=this.createLayoutForSizeModeForOneLayout(e,t,o.layout);return n&&(this.appConfig=this.appConfig.setIn(["dialogs",i,"layout",e],n.id).setIn(["dialogs",i,"sizeMode",e],o.sizeMode.LARGE)),this}removeSizeModeLayoutFromDialog(e,t){if(!this.appConfig.dialogs[e]||!this.appConfig.dialogs[e].layout)return this;const i=this.appConfig.dialogs[e];return this.removeSizeModeLayout(i.layout[t],t),this.appConfig=this.appConfig.setIn(["dialogs",e,"layout"],i.layout.without(t)).setIn(["dialogs",e,"sizeMode"],i.sizeMode.without(t)),this}createLayoutForSizeModeForOneLayout(e,t,i){if(!i||!i[t]||i[e])return;let o=this.duplicateLayout(i[t],!1);o=this.transformLayout(o,t,e);const n=b.searchUtils.getContentsInLayout(this.appConfig.layouts[o.id],l.LayoutItemType.Widget),s=b.searchUtils.getContentsInLayout(this.appConfig.layouts[o.id],l.LayoutItemType.Section),a=b.searchUtils.getContentsInLayout(this.appConfig.layouts[o.id],l.LayoutItemType.ScreenGroup);n.filter(e=>this.appConfig.widgets&&this.appConfig.widgets[e]&&this.appConfig.widgets[e].manifest.properties.hasEmbeddedLayout).forEach(i=>{var o;Object.keys(null!==(o=this.appConfig.widgets[i].layouts)&&void 0!==o?o:{}).forEach(o=>{const n=this.createLayoutForSizeModeForOneLayout(e,t,this.appConfig.widgets[i].layouts[o]);n&&(this.appConfig=this.appConfig.setIn(["widgets",i,"layouts",o,e],n.id))})});return n.filter(e=>this.appConfig.widgets&&this.appConfig.widgets[e]&&this.appConfig.widgets[e].manifest.widgetType===l.WidgetType.Layout).forEach(i=>{const n=D(this.appConfig,"widget");let s=this.appConfig.widgets[i].set("id",n);this.appConfig=this.appConfig.setIn(["widgets",n],s);let a=b.searchUtils.getContainerLayoutItem(o,i,l.LayoutItemType.Widget);a=a.set("widgetId",n),o=o.setIn(["content",a.id],a),Object.keys(s.layouts).forEach(i=>{const o=this.createLayoutForSizeModeForOneLayout(e,t,s.layouts[i]);o&&(s=s.setIn(["layouts",i],s.layouts[i].without(t).set(e,o.id)))}),this.appConfig=this.appConfig.setIn(["widgets",n],s)}),s.forEach(i=>{this.appConfig.sections[i]&&this.appConfig.sections[i].views.forEach(i=>{if(this.appConfig.views[i]&&this.appConfig.views[i].layout[t]){const o=this.createLayoutForSizeModeForOneLayout(e,t,this.appConfig.views[i].layout);o&&(this.appConfig=this.appConfig.setIn(["views",i,"layout",e],o.id))}})}),a.forEach(i=>{this.appConfig.screenGroups[i]&&this.appConfig.screenGroups[i].screens.forEach(i=>{var o,n,s;const a=this.appConfig.screens[i];if(null===(n=null===(o=a.panel)||void 0===o?void 0:o.layout)||void 0===n?void 0:n[t]){const o=this.createLayoutForSizeModeForOneLayout(e,t,a.panel.layout);o&&(this.appConfig=this.appConfig.setIn(["screens",i,"panel","layout",e],o.id))}if(null===(s=a.main.layout)||void 0===s?void 0:s[t]){const o=this.createLayoutForSizeModeForOneLayout(e,t,a.main.layout);o&&(this.appConfig=this.appConfig.setIn(["screens",i,"main","layout",e],o.id))}})}),this.appConfig=this.appConfig.setIn(["layouts",o.id],o),o}removeSizeModeLayout(e,t){const i=b.searchUtils.getContentsInLayoutRecursive(this.appConfig,e,l.LayoutItemType.Widget,t,!0),o=b.searchUtils.getContentsInLayoutRecursive(this.appConfig,e,l.LayoutItemType.Section,t,!0),n=b.searchUtils.getContentsInLayoutRecursive(this.appConfig,e,l.LayoutItemType.ScreenGroup,t,!0);return i.forEach(e=>{const i=this.appConfig.widgets[e];i&&i.layouts&&Object.keys(i.layouts).forEach(o=>{i.layouts[o][t]&&(this.removeLayout(i.layouts[o][t],!0),this.appConfig.widgets[e]&&(this.appConfig=this.appConfig.setIn(["widgets",e,"layouts",o],i.layouts[o].without(t))))})}),o.forEach(e=>{const i=this.appConfig.sections[e];i&&i.views&&i.views.forEach(e=>{const i=this.appConfig.views[e];i&&i.layout[t]&&(this.removeLayout(i.layout[t],!0),this.appConfig=this.appConfig.setIn(["views",e,"layout"],i.layout.without(t)))})}),n.forEach(e=>{var i;const o=this.appConfig.screenGroups[e];null===(i=null==o?void 0:o.screens)||void 0===i||i.forEach(e=>{var i,o,n,s;const a=this.appConfig.screens[e];(null===(o=null===(i=null==a?void 0:a.panel)||void 0===i?void 0:i.layout)||void 0===o?void 0:o[t])&&(this.removeLayout(a.panel.layout[t],!0),this.appConfig=this.appConfig.setIn(["screens",e,"panel","layout"],a.panel.layout.without(t))),(null===(s=null===(n=null==a?void 0:a.main)||void 0===n?void 0:n.layout)||void 0===s?void 0:s[t])&&(this.removeLayout(a.main.layout[t],!0),this.appConfig=this.appConfig.setIn(["screens",e,"main","layout"],a.main.layout.without(t)))})}),this.removeLayout(e,!0),this}createEmptyLayoutForWidgetOnCurrentSizeMode(e,t,i,o){let n=this.createEmptyLayoutJson(this.appConfig);return n=n.set("label",i),o&&(n=n.set("type",o)),this.appConfig=this.appConfig.setIn(["layouts",n.id],n).setIn(["widgets",e,"layouts",t,Be()],n.id),n.id}removeLayoutFromWidget(e,t){var i,o,n;return(null===(i=this.appConfig.widgets[e])||void 0===i?void 0:i.layouts)&&(null===(o=this.appConfig.widgets[e])||void 0===o?void 0:o.layouts[t])?(Object.keys(null===(n=this.appConfig.widgets[e])||void 0===n?void 0:n.layouts[t]).forEach(i=>{var o;const n=null===(o=this.appConfig.widgets[e])||void 0===o?void 0:o.layouts[t][i];this.removeLayout(n,!0)}),this.appConfig=this.appConfig.setIn(["widgets",e,"layouts"],this.appConfig.widgets[e].layouts.without(t)),this):this}addItemIntoLayout(e,t,i,o){const n=this.appConfig.layouts[e],s=[].concat(n.order||[]);return i>=0&&i<=s.length?s.splice(i,0,t.id):s.push(t.id),this.updateLayout(e,"order",s),this.appConfig=this.appConfig.setIn(["layouts",e,"content",t.id],t),o=o||this.appConfig.mainSizeMode,t.type===l.LayoutItemType.Widget&&this.updateWidgetDataSourceBeforeChangingLayout(t.widgetId,e),t.type===l.LayoutItemType.Widget&&this.appConfig.widgets[t.widgetId]&&this.appConfig.widgets[t.widgetId].layouts?Object.keys(this.appConfig.widgets[t.widgetId].layouts).forEach(e=>{const i=this.createLayoutForSizeModeForOneLayout(Be(),o,this.appConfig.widgets[t.widgetId].layouts[e]);i&&(this.appConfig=this.appConfig.setIn(["widgets",t.widgetId,"layouts",e,Be()],i.id))}):t.type===l.LayoutItemType.Section&&this.appConfig.sections[t.sectionId]&&this.appConfig.sections[t.sectionId].views&&this.appConfig.sections[t.sectionId].views.forEach(e=>{const t=this.createLayoutForSizeModeForOneLayout(Be(),o,this.appConfig.views[e].layout);t&&(this.appConfig=this.appConfig.setIn(["views",e,"layout",Be()],t.id))}),{layoutId:e,layoutItemId:t.id}}moveLayoutItemToAnotherLayout(e,t,i,o){var n,s;const{layoutId:a}=e;Object(l.invariant)(a!==t.layoutId,"move item to another layout should have different layoutId");const r=b.searchUtils.findLayoutItem(this.appConfig,e);if(!r)return e;const p=this.appConfig.layouts[t.layoutId];r.type===l.LayoutItemType.Widget&&r.widgetId&&this.updateWidgetDataSourceBeforeChangingLayout(r.widgetId,t.layoutId);let u=this.appConfig.layouts;if(r.type===l.LayoutItemType.Widget||r.type===l.LayoutItemType.Section){const t=b.searchUtils.getWidgetIdThatUseTheLayoutId(this.appConfig,e.layoutId);if(t){const i=b.searchUtils.getBrowserSizeModeByLayoutIdAndWidgetId(this.appConfig,e.layoutId,t);b.searchUtils.getRelatedLayoutInfosInWidgetByLayoutInfo(this.appConfig,e,t,i).forEach(e=>{u=w(e,!0,u)}),this.appConfig=this.appConfig.set("layouts",u)}else this.appConfig=this.appConfig.set("layouts",w(e,!0,u))}else this.appConfig=this.appConfig.set("layouts",w(e,!0,u));const d=function(e,t){const i=b.utils.getMaximumId(t[e])+1;let o=Object(l.Immutable)(t);const n={id:""+i};return o=o.setIn([e,"content",n.id],n),{layoutInfo:{layoutId:e,layoutItemId:n.id},layouts:o}}(t.layoutId,this.appConfig.layouts),c=d.layoutInfo;this.appConfig=this.appConfig.set("layouts",d.layouts),this.updateLayoutItem(c,"type",r.type).updateLayoutItem(c,"setting",{style:{transform:null===(s=null===(n=r.setting)||void 0===n?void 0:n.style)||void 0===s?void 0:s.transform}}).updateLayoutItem(c,"bbox",i);const g=[].concat(p.order||[]);return o>=0&&o<=g.length?g.splice(o,0,c.layoutItemId):g.push(c.layoutItemId),this.updateLayout(t.layoutId,"order",g),r.type===l.LayoutItemType.Widget?this.updateLayoutItem(c,"widgetId",r.widgetId):r.type===l.LayoutItemType.Section&&this.updateLayoutItem(c,"sectionId",r.sectionId),c}setLayoutItemToPending(e,t){return b.searchUtils.findLayoutItem(this.appConfig,e)?(this.appConfig=this.appConfig.setIn(["layouts",e.layoutId,"content",e.layoutItemId,"isPending"],t),this):this}duplicateLayoutItem(e,t,i,o,n=!1){var s;if(!this.appConfig.layouts||!this.appConfig.layouts[e])return null;if(!this.appConfig.layouts||!this.appConfig.layouts[t])return null;const a=b.searchUtils.findLayoutItem(this.appConfig,{layoutId:e,layoutItemId:i}),r=b.utils.getMaximumId(this.appConfig.layouts[t])+1+"";let p=a.set("id",r),u=this.appConfig.layouts[t].order||Object(l.Immutable)([]),d=u.length;if(n&&(d=this.appConfig.layouts[e].order.findIndex(e=>e===i)),u.length<d&&(d=u.length),u=u.slice(0,d).concat(p.id).concat(u.slice(d)),this.appConfig=this.appConfig.setIn(["layouts",t,"content",p.id],p),this.updateLayout(t,"order",u),!o)return{layoutId:t,layoutItemId:p.id};const c=a.widgetId||a.sectionId||a.screenGroupId,g=!(null===(s=this.duplicatedContentMaps)||void 0===s?void 0:s[c]);if(a.type===l.LayoutItemType.Widget&&a.widgetId)if(g){const e=this.duplicateWidget(a.widgetId);p=p.set("widgetId",e.id),this.duplicatedContentMaps&&(this.duplicatedContentMaps[a.widgetId]=e.id)}else p=p.set("widgetId",this.duplicatedContentMaps[a.widgetId]);else if(a.type===l.LayoutItemType.Section&&a.sectionId)if(g){const e=this.duplicateSection(a.sectionId);p=p.set("sectionId",e.id),this.duplicatedContentMaps&&(this.duplicatedContentMaps[a.sectionId]=e.id)}else p=p.set("sectionId",this.duplicatedContentMaps[a.sectionId]);else if(a.type===l.LayoutItemType.ScreenGroup&&a.screenGroupId)if(g){const e=this.duplicateScreenGroup(a.screenGroupId);p=p.set("screenGroupId",e.id),this.duplicatedContentMaps&&(this.duplicatedContentMaps[a.screenGroupId]=e.id)}else p=p.set("screenGroupId",this.duplicatedContentMaps[a.screenGroupId]);return this.appConfig=this.appConfig.setIn(["layouts",t,"content",p.id],p),{layoutId:t,layoutItemId:p.id}}removeLayoutItem(e,t){const i=b.searchUtils.findLayoutItem(this.appConfig,e);if(!i)return this;t&&this.checkWhetherRemoveContent(e)&&(i.type===l.LayoutItemType.Widget?this.removeWidget(i.widgetId):i.type===l.LayoutItemType.Section?this.removeSection(i.sectionId):i.type===l.LayoutItemType.ScreenGroup&&this.removeScreenGroup(i.screenGroupId));const o=w(e,!0,this.appConfig.layouts);return this.appConfig=this.appConfig.set("layouts",o),this.clearRedundantLayout(e)}checkWhetherRemoveContent(e){const t=b.searchUtils.findLayoutItem(this.appConfig,e);if(!t)return!1;let i;t.type===l.LayoutItemType.Widget?i=t.widgetId:t.type===l.LayoutItemType.Section?i=t.sectionId:t.type===l.LayoutItemType.ScreenGroup&&(i=t.screenGroupId);return!(b.searchUtils.getLayoutInfosHoldcontent(this.appConfig,t.type,i).length>1)}clearRedundantLayout(e){return this.clearEmptyRowInFlowLayout(e),this.clearMaintainedColumnInRowWidget(e),this.clearGridLayout(e),this}removeLayout(e,t){return this.appConfig.layouts[e]?(b.searchUtils.getLayoutItemIds(this.appConfig,e,!0).forEach(i=>{const o={layoutId:e,layoutItemId:i};this.removeLayoutItem(o,t)}),this.appConfig=this.appConfig.set("layouts",this.appConfig.layouts.without(e)),this):this}replaceLayout(e,t){const i=this.appConfig.layouts;return this.appConfig=this.appConfig.set("layouts",i.set(e,i[t]).setIn([e,"id"],e).without(t)),this}resetLayout(e,t){return this.appConfig.layouts[e]?(b.searchUtils.getLayoutItemIds(this.appConfig,e,!0).forEach(i=>{const o={layoutId:e,layoutItemId:i};this.removeLayoutItem(o,t)}),this):this}duplicateLayoutItems(e,t,i){var o;const n=this.appConfig.layouts[e];if(!n)return this;return(null!==(o=n.order)&&void 0!==o?o:[]).forEach(e=>{n.content[e].isPending||this.duplicateLayoutItem(n.id,t,e,i)}),this}duplicateLayout(e,t){const i=this.appConfig.layouts[e];if(!i)return null;const o=i.set("id",D(this.appConfig,"layout"));return this.appConfig=this.appConfig.setIn(["layouts",o.id],o.without("content","order")),i.content&&this.duplicateLayoutItems(e,o.id,t),this.appConfig.layouts[o.id]}editLayoutSetting(e,t){return t=(this.appConfig.layouts[e.layoutId].setting||Object(l.Immutable)({})).merge(t),this.updateLayout(e.layoutId,"setting",t)}editLayoutType(e,t){return this.updateLayout(e.layoutId,"type",t)}editLayoutItemSetting(e,t){if(t){const i=b.searchUtils.findLayoutItem(this.appConfig,e);if(i){return t=(i.setting||Object(l.Immutable)({})).merge(t),this.updateLayoutItem(e,"setting",t)}}return this}editLayoutItemSize(e,t,i){var o;if(0===t||0===i)return this;const{layoutId:n,layoutItemId:s}=e,a=this.appConfig.layouts[n],r=null===(o=null==a?void 0:a.content)||void 0===o?void 0:o[s];if(!a||!r)return this;let p=r.setting||Object(l.Immutable)({});if(a.type===l.LayoutType.FixedLayout){const o=r.bbox.set("width",t+"px").set("height",i+"px");return p=p.setIn(["autoProps","width"],!1).setIn(["autoProps","height"],!1),this.editLayoutItemBBox(e,o).editLayoutItemSetting(e,p)}return p=p.setIn(["autoProps","width"],!1).setIn(["autoProps","height"],!1).set("heightMode","ratio").set("aspectRatio",Number((i/t).toFixed(2))),this.editLayoutItemSetting(e,p)}editLayoutItemBBox(e,t){return this.updateLayoutItem(e,"bbox",t)}exchangeWidthAndHeight(){var e,t,i,o,n;let s;const a=Object(l.getAppStore)().getState();if(s=window.jimuConfig.isBuilder?null===(t=null===(e=null==a?void 0:a.appStateInBuilder)||void 0===e?void 0:e.appRuntimeInfo)||void 0===t?void 0:t.selection:null===(i=null==a?void 0:a.appRuntimeInfo)||void 0===i?void 0:i.selection,!s)return this;const{layoutId:r}=s,p=this.appConfig.layouts[r];if((null==p?void 0:p.type)===l.LayoutType.FixedLayout){const e=b.searchUtils.findLayoutItem(this.appConfig,s);if(e){let t=e.bbox,i=!1,a=null!==(o=e.setting)&&void 0!==o?o:Object(l.Immutable)({});const r=null!==(n=a.autoProps)&&void 0!==n?n:{right:!0,bottom:!0};t=t.set("width",t.height).set("height",t.width),["left","right","top","bottom"].forEach(e=>{r[e]&&(t=t.without(e))}),this.editLayoutItemBBox(s,t),null==r.width&&null==r.height||(a=a.setIn(["autoProps","width"],r.height).setIn(["autoProps","height"],r.width),i=!0),"ratio"===a.heightMode&&(a=a.set("heightMode","fixed"),i=!0),i&&this.editLayoutItemSetting(s,a)}}return this}updateLayoutItem(e,t,i){if(b.searchUtils.findLayoutItem(this.appConfig,e)){const{layoutId:o,layoutItemId:n}=e;this.appConfig=this.appConfig.setIn(["layouts",o,"content",n,t],i)}return this}editLayoutItemIndex(e,t,i){const{layoutId:o}=e,n=this.appConfig.layouts[o].order;return!n||i<0&&i>n.length||this.adjustIndexOfLayoutItem(e,t,i),this}editLayoutOrder(e,t){return this.updateLayout(e.layoutId,"order",t)}addLayout(e){return this.appConfig.layouts&&this.appConfig.layouts[e.id]||(this.appConfig=this.appConfig.setIn(["layouts",e.id],e)),this}copyUseDataSourceToAllChildWidgets(e,t){const i=b.searchUtils.getChildrenContents(this.appConfig,t.id,l.LayoutItemType.Widget,!0),o=t.useDataSources&&t.useDataSources.map(e=>e.without("fields"))[0],n=e.useDataSources&&e.useDataSources.map(e=>e.without("fields"))[0];return o&&n&&o.dataSourceId===n.dataSourceId||i.forEach(e=>{let t=this.appConfig.widgets[e];t.useDataSources&&n&&t.useDataSources.find(e=>e.dataSourceId===n.dataSourceId)&&(t=t.set("useDataSources",t.useDataSources.filter(e=>e.dataSourceId!==n.dataSourceId))),o&&(t=t.set("useDataSources",t.useDataSources?t.useDataSources.concat(o):[o]).set("useDataSourcesEnabled",!0)),this.appConfig=this.appConfig.setIn(["widgets",e],t)}),this}clearEmptyRowInFlowLayout(e){var t,i,o;const n=this.appConfig.layouts[e.layoutId];if((null!==(i=null===(t=null==n?void 0:n.order)||void 0===t?void 0:t.length)&&void 0!==i?i:0)>0)return this;const s=b.searchUtils.getWidgetIdThatUseTheLayoutId(this.appConfig,e.layoutId);if(s){const e=this.appConfig.widgets[s];if("row"===(null===(o=null==e?void 0:e.manifest)||void 0===o?void 0:o.name)){let e;Object.keys(this.appConfig.layouts).some(t=>{var i,o;if((null===(o=null===(i=this.appConfig.layouts)||void 0===i?void 0:i[t])||void 0===o?void 0:o.type)===l.LayoutType.FlowLayout){const i=b.searchUtils.getContainerLayoutItem(this.appConfig.layouts[t],s,l.LayoutItemType.Widget);if(i)return e={layoutId:t,layoutItemId:i.id},!0}}),e&&this.removeLayoutItem(e,!0)}}return this}clearMaintainedColumnInRowWidget(e){var t,i,o,n;const s=this.appConfig.layouts[e.layoutId],a=null!==(i=null===(t=null==s?void 0:s.order)||void 0===t?void 0:t.length)&&void 0!==i?i:0;if(a>1)return this;const r=b.searchUtils.getWidgetIdThatUseTheLayoutId(this.appConfig,e.layoutId);if(r){const t=this.appConfig.widgets[r];if("column"===(null===(o=null==t?void 0:t.manifest)||void 0===o?void 0:o.name)){const t=b.searchUtils.getLayoutInfosHoldcontent(this.appConfig,l.LayoutItemType.Widget,r);if(t&&t.length>0){const i=t[0],o=this.appConfig.layouts[i.layoutId].content[i.layoutItemId];if((null===(n=null==o?void 0:o.setting)||void 0===n?void 0:n.maintainedByLayout)&&1===a)return this.extractWidgetFromMaintainedColumn(i,r,{layoutId:e.layoutId,layoutItemId:s.order[0]})}}}return this}clearGridLayout(e){const{layoutId:t,layoutItemId:i}=e;let o=this.appConfig.layouts[t];if(!o||o.type!==l.LayoutType.GridLayout)return this;const n=o.content[i];if(n){const s=w(e,!0,this.appConfig.layouts);if(this.appConfig=this.appConfig.set("layouts",s),o=this.appConfig.layouts[t],n&&n.parentId){const e=n.parentId,s=o.content[n.parentId],a=[].concat(s.items),r=a.indexOf(i);r>=0&&a.splice(r,1),a.length>1?this.appConfig=this.appConfig.setIn(["layouts",t,"content",e],s.set("items",a)):1===a.length&&this.compactGridContainer(t,e,a[0])}}else Object.keys(o.content||{}).some(e=>{let n=o.content[e].items;if(n&&n.length>0){const o=n.indexOf(i);if(o>=0)return n=[].concat(n),n.splice(o,1),this.appConfig=this.appConfig.setIn(["layouts",t,"content",e,"items"],n),1===n.length&&this.compactGridContainer(t,e,n[0]),!0}});return this}addDataSource(e){return this.appConfig.dataSources&&this.appConfig.dataSources[e.id]||(this.appConfig=this.appConfig.setIn(["dataSources",e.id],e)),this}addDataSources(e){return e.forEach(e=>{this.appConfig.dataSources&&this.appConfig.dataSources[e.id]||(this.appConfig=this.appConfig.setIn(["dataSources",e.id],e))}),this}removeDataSource(e){return this.appConfig.dataSources&&this.appConfig.dataSources[e]?(this.appConfig=this.appConfig.set("dataSources",this.appConfig.dataSources.without(e)),this.appConfig.widgets&&Object.entries(this.appConfig.widgets).forEach(([t,i])=>{i.useDataSources&&i.useDataSources.find(t=>this.isUseDataSourceShouldBeRemoved(t,e))&&(this.appConfig=this.appConfig.setIn(["widgets",t,"useDataSources"],i.useDataSources.filter(t=>!this.isUseDataSourceShouldBeRemoved(t,e))))}),this.appConfig.widgets&&Object.entries(this.appConfig.widgets).forEach(([t,i])=>{i.outputDataSources&&i.outputDataSources.find(t=>t===e)&&(this.appConfig=this.appConfig.setIn(["widgets",t,"outputDataSources"],i.outputDataSources.filter(t=>t!==e)))}),this.appConfig.messageConfigs&&Object.keys(this.appConfig.messageConfigs).forEach(t=>{const i=this.appConfig.messageConfigs[t];i.useDataSources&&i.useDataSources.find(t=>this.isUseDataSourceShouldBeRemoved(t,e))&&(this.appConfig=this.appConfig.setIn(["messageConfigs",t,"useDataSources"],i.useDataSources.filter(t=>!this.isUseDataSourceShouldBeRemoved(t,e))))}),Object.entries(this.appConfig.dataSources).forEach(([t,i])=>{i.originDataSources&&i.originDataSources.find(t=>this.isUseDataSourceShouldBeRemoved(t,e))&&this.removeDataSource(t)}),this):this}isUseDataSourceShouldBeRemoved(e,t){return!e||e.dataSourceId===t||e.mainDataSourceId===t||e.rootDataSourceId===t}editDataSource(e){return this.appConfig=this.appConfig.setIn(["dataSources",e.id],e),this}duplicateDataSource(e){if(!this.appConfig.dataSources||!this.appConfig.dataSources[e])return null;const t=this.appConfig.dataSources[e],i=t.set("id",D(this.appConfig,"dataSource")).set("label",this.getDuplicateLabel("dataSources",t.label));return this.addDataSource(i),i}addAppProxy(e){return this.appConfig.appProxies&&this.appConfig.appProxies[e.id]||(this.appConfig=this.appConfig.setIn(["appProxies",e.id],e)),this}editAppProxy(e){return this.appConfig=this.appConfig.setIn(["appProxies",e.id],e),this}removeAppProxy(e){return this.appConfig.appProxies&&this.appConfig.appProxies[e]?(this.appConfig=this.appConfig.set("appProxies",this.appConfig.appProxies.without(e)),this):this}addMessage(e){return this.appConfig=this.appConfig.setIn(["messageConfigs",e.id],e),this}editMessage(e){return this.appConfig=this.appConfig.setIn(["messageConfigs",e.id],e),this}removeMessage(e){return this.appConfig.messageConfigs&&this.appConfig.messageConfigs[e.id]?(this.appConfig=this.appConfig.set("messageConfigs",this.appConfig.messageConfigs.without(e.id)),this):this}duplicateWidgetMessageConfig(e,t){const i=this.appConfig.messageConfigs;if(!i)return this;Object.keys(i).forEach(o=>{if(i[o].widgetId===e){const e=i[o].set("id",D(this.appConfig,"messageConfig")).set("widgetId",t);this.appConfig=this.appConfig.setIn(["messageConfigs",e.id],e)}}),Object.keys(i).forEach(o=>{if(i[o].actions){const n=[];i[o].actions.forEach(i=>{if(i.widgetId===e){const e=i.set("widgetId",t);n.push(e)}}),n.length>0&&(this.appConfig=this.appConfig.setIn(["messageConfigs",i[o].id,"actions"],i[o].actions.concat(n)))}})}removeDataActionProvidedByWidget(e,t){var i;const o=e.widgets[t];if(!(null===(i=o.manifest)||void 0===i?void 0:i.dataActions)||0===o.manifest.dataActions.length)return e;const n=o.manifest.dataActions.map(e=>e.name);let s=e;return Object.keys(e.widgets).forEach(i=>{let o=e.widgets[i];o.dataActions&&n.forEach(e=>{var n,a;const r=null===(n=o.dataActions)||void 0===n?void 0:n[e];if(r){const n=null===(a=r.actions)||void 0===a?void 0:a.without(t);0===Object.keys(n||{}).length?(o=o.set("dataActions",o.dataActions.without(e)),0===Object.keys(o.dataActions).length&&(o=o.without("dataActions"))):o=o.setIn(["dataActions","actions"],n),s=s.setIn(["widgets",i],o)}})}),s}removeWidgetMessageAndAction(e,t){const i=e.messageConfigs;if(!i)return e;const o=Object.keys(i);let n=Object(l.Immutable)({});for(let e=0;e<o.length;e++)i[o[e]].widgetId!==t&&(n=n.setIn([i[o[e]].id],i[o[e]]));const s=Object.keys(n);for(let e=0;e<s.length;e++){const o=n[s[e]].actions;if(0!==o.length){const a=o.filter(e=>e.widgetId!==t),r=Object.assign([],a);n=n.setIn([i[s[e]].id,"actions"],r)}}return e.set("messageConfigs",n)}editTheme(e){return this.appConfig=this.appConfig.set("theme",e),this}editCustomTheme(e){return this.appConfig=this.appConfig.set("customTheme",e),this}editHeader(e,t){return this.appConfig=this.appConfig.set("header",e),t&&t.forEach(e=>this.addLayout(e)),this}editFooter(e,t){return this.appConfig=this.appConfig.set("footer",e),t&&t.forEach(e=>this.addLayout(e)),this}setViewportSize(e,t){return this.appConfig=this.appConfig.setIn(["forBuilderAttributes","viewPortSize",e],t),this}setLockLayout(e){return this.appConfig=this.appConfig.setIn(["forBuilderAttributes","lockLayout"],e),this}editAttributes(e){return this.appConfig=this.appConfig.setIn(["attributes"],e),this}mergeUseDataSource(e,t){if(!e.useDataSources)return t;const i=e.useDataSources.map(e=>e.without("fields"));return t.useDataSources?(i.forEach(e=>{e.dataViewId?t.useDataSources.find(t=>t.dataSourceId===e.dataSourceId&&t.dataViewId===e.dataViewId)||(t=t.set("useDataSources",t.useDataSources.concat([e]))):t.useDataSources.find(t=>t.dataSourceId===e.dataSourceId)||(t=t.set("useDataSources",t.useDataSources.concat([e])))}),t.set("useDataSourcesEnabled",!0)):t.set("useDataSources",i).set("useDataSourcesEnabled",!0)}updateWidgetDataSourceBeforeChangingLayout(e,t){if(!this.appConfig.widgets[e])return this;let i=this.appConfig.widgets[e];const o=b.searchUtils.getWidgetIdThatUseTheLayoutId(this.appConfig,t);if(o){const e=this.appConfig.widgets[o];e.manifest.properties.passDataSourceToChildren&&(i=this.mergeUseDataSource(e,i),this.appConfig=this.appConfig.setIn(["widgets",i.id],i))}return this}getDuplicateLabel(e,t){const i=l.i18n.getIntl().formatMessage({id:"copy"}).toLocaleLowerCase();let o=`${t} ${i}`,n=1;for(;this.appConfig[e]&&Object.keys(this.appConfig[e]).find(t=>{var i;return(null===(i=this.appConfig[e][t])||void 0===i?void 0:i.label)===o});)n++,o=`${t} ${i} ${n}`;return o}compactGridContainer(e,t,i){let o=this.appConfig.layouts[e];const n=o.content[t];let s=w({layoutId:e,layoutItemId:t},!0,this.appConfig.layouts);this.appConfig=this.appConfig.set("layouts",s).setIn(["layouts",e,"content",i,"parentId"],n.parentId).setIn(["layouts",e,"content",i,"bbox"],n.bbox),o=this.appConfig.layouts[e],o.setting.rootItemId===t&&(this.appConfig=this.appConfig.setIn(["layouts",e,"setting","rootItemId"],i));const a=o.content[n.parentId];if(a){const r=o.content[i],p=[].concat(a.items),u=p.indexOf(t);r.direction!==a.direction?p.splice(u,1,i):(s=w({layoutId:e,layoutItemId:i},!0,this.appConfig.layouts),this.appConfig=this.appConfig.set("layouts",s),o=this.appConfig.layouts[e],p.splice(u,1,...r.items),r.items.forEach(t=>{const i=o.content[t];"V"===r.direction?this.appConfig=this.appConfig.setIn(["layouts",e,"content",t,"bbox"],{width:"100%",height:parseFloat(r.bbox.height)*parseFloat(i.bbox.height)/100+"%"}):this.appConfig=this.appConfig.setIn(["layouts",e,"content",t,"bbox"],{height:"100%",width:parseFloat(r.bbox.width)*parseFloat(i.bbox.width)/100+"%"}),this.appConfig=this.appConfig.setIn(["layouts",e,"content",t,"parentId"],n.parentId)})),this.appConfig=this.appConfig.setIn(["layouts",e,"content",n.parentId,"items"],p)}}extractWidgetFromMaintainedColumn(e,t,i){const o=this.appConfig.layouts[i.layoutId].content[i.layoutItemId],n=this.appConfig.layouts[e.layoutId].content[e.layoutItemId],s=n.bbox;return this.editLayoutItemSetting(e,n.setting.set("maintainedByLayout",!1)),this.updateLayoutItem(e,"type",o.type).updateLayoutItem(e,"widgetId",o.widgetId).updateLayoutItem(e,"sectionId",o.sectionId).editLayoutItemBBox(e,s.set("height",o.bbox.height)).editLayoutItemSetting(e,o.setting),this.updateLayoutItem(i,"widgetId",null).updateLayoutItem(i,"sectionId",null),this.removeWidget(t)}adjustIndexOfLayoutItem(e,t,i){const{layoutId:o}=e;Object(l.invariant)(o===t.layoutId,"adjust index should happened in the same layout");const n=this.appConfig.layouts[o];let s=[].concat(n.order||[]);const a=s.indexOf(e.layoutItemId);return s[a]=null,s.splice(i,0,e.layoutItemId),s=s.filter(e=>null!==e),this.appConfig=this.appConfig.setIn(["layouts",o,"order"],s),this}createLayoutsForWidget(e,t){return(e.manifest.layouts||[]).forEach(i=>{let o=this.createEmptyLayoutJson(this.appConfig);i.type&&(o=o.set("type",i.type)),o=o.set("label",e.manifest.i18nMessages[`_layout_${i.name}_label`]||i.label),this.appConfig=this.appConfig.setIn(["layouts",o.id],o).setIn(["widgets",e.id,"layouts",i.name,t],o.id)}),this}removePageFromPageStructure(e){if(!this.appConfig.pageStructure)return this;return this.appConfig.pageStructure.find(t=>!!t[e])?this.appConfig=this.appConfig.set("pageStructure",this.appConfig.pageStructure.flatMap(t=>t[e]?[]:[t])):this.appConfig.pageStructure.forEach((t,i)=>{const o=Object.keys(t).find(i=>t[i].includes(e));if(o)return this.appConfig=this.appConfig.setIn(["pageStructure",i+"",o],t[o].flatMap(t=>t===e?[]:[t])),!0}),this}doDuplicateContainerContent(e,t){const i=this.getContainerJson(e,t);if(!i.layout)return null;let o=i;return Object.keys(i.layout).forEach(e=>{const t=i.layout[e],n=this.duplicateLayout(t,!0);this.appConfig=this.appConfig.setIn(["layouts",n.id],n),o=o.setIn(["layout",e],n.id)}),o.layout}doDuplicateEmbedWidgetContent(e){let t=e;return e&&e.layouts&&Object.keys(e.layouts).forEach(i=>{const o=e.layouts[i];Object.keys(o).forEach(o=>{const n=this.duplicateLayout(e.layouts[i][o],!0);t=t.setIn(["layouts",i,o],n.id),this.appConfig=this.appConfig.setIn(["layouts",n.id],n)})}),t}createEmptyLayoutJson(e){const t=D(e,"layout");return Object(l.Immutable)({id:t})}movePageIntoPageForPageStructure(e,t){return this.appConfig.pageStructure?(this.appConfig.pageStructure.some((i,o)=>{const n=Object.keys(i).find(e=>e===t);if(n)return this.appConfig=this.appConfig.setIn(["pageStructure",o+"",n],this.appConfig.pageStructure[o][n].concat([e])),!0}),this):this}removeContainerContent(e,t){const i=this.getContainerJson(e,t).layout;return Object.keys(i).forEach(o=>{const n=i[o];this.removeLayout(n,!0),e===l.ContainerType.Header?this.appConfig=this.appConfig.setIn(["header","layout"],this.appConfig.header.layout.without(o)):e===l.ContainerType.Footer?this.appConfig=this.appConfig.setIn(["footer","layout"],this.appConfig.footer.layout.without(o)):e===l.ContainerType.ScreenMain?this.appConfig=this.appConfig.setIn(["screens",t,"main","layout"],this.appConfig.screens[t].main.layout.without(o)):e===l.ContainerType.ScreenPanel?this.appConfig=this.appConfig.setIn(["screens",t,"panel","layout"],this.appConfig.screens[t].panel.layout.without(o)):this.appConfig=this.appConfig.setIn([e,t,"layout"],this.appConfig[e][t].layout.without(o))}),this}getContainerJson(e,t){return e===l.ContainerType.Footer||e===l.ContainerType.Header?this.appConfig[e]:e===l.ContainerType.ScreenMain?this.appConfig.screens[t].main:e===l.ContainerType.ScreenPanel?this.appConfig.screens[t].panel:this.appConfig[e][t]}removeSectionContent(e){return this.appConfig.sections[e].views&&this.appConfig.sections[e].views.forEach(e=>{this.removeContainerContent(l.ContainerType.View,e),0===Object.keys(this.appConfig.views[e].layout).length&&(this.appConfig=this.appConfig.set("views",this.appConfig.views.without(e)))}),this}updateLayout(e,t,i){return this.appConfig.layouts[e]&&(this.appConfig=this.appConfig.setIn(["layouts",e,t],i)),this}transformLayout(e,t,i){let o;o=window.jimuConfig.isBuilder?window._appWindow&&window._appWindow._extensionManager:l.ExtensionManager.getInstance();const n=o.getExtensions(l.extensionSpec.ExtensionPoints.LayoutTransformer);if(n.length>0){const o=n.find(t=>t.layoutType===e.type);o&&o.transformLayout&&(e=o.transformLayout(e,t,i))}return e}}class ze{constructor(){this.actionSettings={}}static getInstance(){return ze.instance||(ze.instance=new ze),ze.instance}loadAllActionSettingClasses(){const e=Ge();return Object.keys(e.appConfig.widgets||{}).forEach(t=>{var i,o;const n=e.appConfig.widgets[t];(null===(o=null===(i=n.manifest)||void 0===i?void 0:i.dataActions)||void 0===o?void 0:o.length)>0&&n.manifest.dataActions.forEach(e=>{if(e.settingUri){const t=`${n.uri}dist/${e.settingUri}`;this.actionSettings[t]||(this.actionSettings[t]=l.moduleLoader.loadModule(t,["default"]).then(e=>e.default))}})}),this.actionSettings}}class Ne extends l.WidgetManager{static getInstance(){return window.jimuConfig.isBuilder?window._appWindow&&window._appWindow._widgetManager:l.WidgetManager.getInstance()}}var qe=function(e,t,i,o){return new(i||(i=Promise))((function(n,s){function a(e){try{p(o.next(e))}catch(e){s(e)}}function r(e){try{p(o.throw(e))}catch(e){s(e)}}function p(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};const He={"opening-tour":"OnboardingGuide","whats-new":"WhatsNewGuide"};class Ve{constructor(){this.guideModules={}}static getInstance(){return Ve.instance||(Ve.instance=new Ve,window._guideManager=Ve.instance),Ve.instance}registerGuideModule(e,t){this.guideModules[e]||(this.guideModules[e]=t)}getGuideModule(e){return qe(this,void 0,void 0,(function*(){if(this.guideModules[e])return yield Promise.resolve(this.guideModules[e]);const t=/(^|\/)widgets\//.test(e),i=t?e+"/dist/guide/guide":"jimu-ui/basic/guide";return yield l.moduleLoader.loadModule(i).then(i=>{const o=t?null==i?void 0:i.default:null==i?void 0:i[He[e]];return this.registerGuideModule(e,o),o})}))}}var $e=i(1);function Ke(e){let t;return t=e.type===l.PageType.Folder?i(36):e.type===l.PageType.Link?i(37):i(38),t}function Je(){return i(39)}function Qe(){return i(40)}function Ze(e,t){const i=[];return Object.keys(e).some(o=>{e[o].autoOpenDialogId===t&&i.push({id:o,label:e[o].label})}),i}var Ye=function(e,t,i,o){return new(i||(i=Promise))((function(n,s){function a(e){try{p(o.next(e))}catch(e){s(e)}}function r(e){try{p(o.throw(e))}catch(e){s(e)}}function p(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};const Xe=i(41),et=["en","de","es","fr","ja","ru","zh-cn"];function tt(){const e=window.locale.toLowerCase();let t=!1;if(et.includes(e))t=!0;else{const i=e.split("-")[0];for(let e=0;e<et.length;e++)if(i===et[e].split("-")[0]){t=!0;break}}return t}function it(e){return Ye(this,void 0,void 0,(function*(){return yield at("build-apps",e)}))}function ot(){return Ye(this,void 0,void 0,(function*(){return window.jimuConfig.isDevEdition?yield at(void 0,"home",!0):yield at("get-started","what-is-arcgis-experience-builder",!0)}))}function nt(){return Ye(this,void 0,void 0,(function*(){return yield at("get-started","whats-new",!0)}))}function st(e){return Ye(this,void 0,void 0,(function*(){return yield at("widgets",e)}))}function at(e,t,i){var o;return Ye(this,void 0,void 0,(function*(){let n,s=null;if(t=t.toLowerCase(),window.jimuConfig.isDevEdition){n="https://developers.arcgis.com/experience-builder/";const i=Xe.dev;s=e?`${i[e].prefix}${i[e][t]}`:""+i[t];let o=n+"#";return s?(o=n+s,yield Promise.resolve(o)):yield Promise.resolve(o)}{const a=null===(o=l.SessionManager.getInstance().getMainPortal())||void 0===o?void 0:o.portalUrl;if(window.jimuConfig.isInPortal){const o=window.locale||"en",n=Xe.portal;s=e?""+n[e][t]:""+n[t];const r={"Content-Type":"text/json"},p=function(e,t){let i="";const o=Object(l.getAppStore)().getState().portalSelf,n=null==o?void 0:o.helpBase.split("/");if(null==n?void 0:n.includes("https:")){const e=tt()?window.locale:"en";i=n.slice(0,3).join("/")+"/"+e}else i=e+"/"+(null==n?void 0:n[2])+"/"+t;return i}(a,o),u=p.includes("https:")?p+"/experience-builder":p;return yield fetch(a+"/sharing/rest/portals/helpmap?f=json",{method:"get",headers:r}).then(e=>Ye(this,void 0,void 0,(function*(){return yield e.json()}))).then(e=>Ye(this,void 0,void 0,(function*(){if(e&&e.helpMap&&e.helpMap.m&&s&&e.helpMap.m[s]){const t=p+"/"+e.helpMap.m[s];return yield Promise.resolve(t)}return i?yield Promise.resolve(u):yield ot()}))).catch(e=>Ye(this,void 0,void 0,(function*(){return console.warn(e),i?yield Promise.resolve(u):yield ot()})))}{const i=Xe.online;s=e?`${i[e].prefix}${i[e][t]}`:""+i[t];n="https://"+(a.includes("maps.arcgis.com")||a.includes("www.arcgis.com")?"doc":"docdev")+".arcgis.com/en/experience-builder/";let o=n+"#";if(!s)return yield Promise.resolve(o);if(o=n+s,tt()){l.portalUrlUtils.getPortalSelfInfoUrl(a);const e=function(e,t,i){let o;const n=Object(l.getAppStore)().getState().portalSelf;if(n&&n.helpBase){try{const e=n.helpBase.split("/").slice(0,4);o=e.join("/")+"/experience-builder/"}catch(e){return i}return o?o+t:i}return i}(0,s,o);return yield Promise.resolve(e)}return yield Promise.resolve(o)}}}))}var rt=function(e,t,i,o){return new(i||(i=Promise))((function(n,s){function a(e){try{p(o.next(e))}catch(e){s(e)}}function r(e){try{p(o.throw(e))}catch(e){s(e)}}function p(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};function pt(e,t,i){(null==e?void 0:e.config)&&l.appConfigUtils.fixLayoutIds(e.config);const o=t?l.i18n.getIntl(t,"setting"):l.i18n.getIntl();return e=l.utils.replaceI18nPlaceholdersInObject(e,o,i)}function ut(e,t,i,o,n,s){var a,r,p,u,d;return rt(this,void 0,void 0,(function*(){const s=Ge(e);let c=null===(a=null==e?void 0:e.widgets)||void 0===a?void 0:a[i];if(!c)return yield Promise.resolve(e);const l=null==t?void 0:t.config,g=null===(r=null==l?void 0:l.widgets)||void 0===r?void 0:r[o],h=[];if(g&&(g.config&&s.editWidgetConfig(i,g.config),g.style&&s.editWidgetProperty(i,"style",g.style),e=s.appConfig,g.layouts)){const i=g.layouts,o=[];Object.keys(i).forEach(e=>{var t,n;const s=i[e]||{},a=(null!==(n=null===(t=c.manifest)||void 0===t?void 0:t.layouts)&&void 0!==n?n:[]).find(t=>t.name===e);Object.keys(s).forEach(t=>{o.push({layoutName:e,sizeMode:t,layoutId:s[t],layoutLabel:null==a?void 0:a.label})})});for(let i=0;i<o.length;i+=1){const{layoutName:s,sizeMode:a,layoutId:r,layoutLabel:l}=o[i],g=yield lt(e,t,r,n);e=g.appConfig;const f=g.newLayoutId;h.push(f);const y=null===(u=null===(p=null==c?void 0:c.layouts)||void 0===p?void 0:p[s])||void 0===u?void 0:u[a];y&&(e=Ge(e).removeLayout(y,!0).appConfig),e=e.setIn(["widgets",c.id,"layouts",s,a],f).setIn(["layouts",f,"label"],(null===(d=null==c?void 0:c.manifest)||void 0===d?void 0:d.i18nMessages[`_layout_${s}_label`])||l||s)}}return c=e.widgets[c.id],c.layouts&&Object.keys(c.layouts).forEach(t=>{const i=c.layouts[t];Object.keys(i).forEach(t=>{const o=i[t];if(h.includes(o))return;const n=e.layouts[o];n.content&&Object.keys(n.content).forEach(t=>{const i=n.content[t];e=Ge(e).removeLayoutItem({layoutId:n.id,layoutItemId:i.id},!0).appConfig})})}),Promise.resolve(e)}))}function dt(e,t,i,o,n=!1){var s;return rt(this,void 0,void 0,(function*(){if(o[i])return yield Promise.resolve({appConfig:e,newWidgetId:o[i]});let a=Ge(e);const r=t.config.widgets[i],p=[],u={uri:r.uri},d=yield Ne.getInstance().handleNewWidgetJson(u),c=l.appConfigUtils.getUniqueId(a.appConfig,"widget");if(d.id=c,n){const e=l.i18n.getIntl().formatMessage({id:"block"});d.label=l.appConfigUtils.getUniqueLabel(a.appConfig,"widget",e)}else d.label=null,l.appConfigUtils.addWidgetDefaultLabelAndIcon(a.appConfig,d);a.createWidget(Object(l.Immutable)(d),!1),o[i]=c;let g=a.appConfig;if((null===(s=r.useMapWidgetIds)||void 0===s?void 0:s.length)>0)for(let e=0;e<r.useMapWidgetIds.length;e++){const i=yield dt(g,t,r.useMapWidgetIds[e],o);g=i.appConfig,p.push(i.newWidgetId)}return a=Ge(g),p.length>0&&a.editWidgetProperty(c,"useMapWidgetIds",p),g=yield ut(a.appConfig,t,c,i,o),yield Promise.resolve({appConfig:g,newWidgetId:c})}))}function ct(e,t,i,o){return rt(this,void 0,void 0,(function*(){if(o[i])return yield Promise.resolve({appConfig:e,newSectionId:o[i]});let n=e;const s=t.config.sections[i],a=l.appConfigUtils.getUniqueId(e,"section");n=n.setIn(["sections",a],s).setIn(["sections",a,"id"],a).setIn(["sections",a,"label"],l.appConfigUtils.getUniqueLabel(e,"section",l.i18n.getIntl().formatMessage({id:"section"})));const r=[];for(let e=0;e<s.views.length;e+=1){const i=s.views[e],a=yield gt(n,t,i,o);n=a.appConfig,r.push(a.newViewId)}return n=n.setIn(["sections",a,"views"],r),o[i]=a,yield Promise.resolve({appConfig:n,newSectionId:a})}))}function lt(e,t,i,o){return rt(this,void 0,void 0,(function*(){let n=e;const s=t.config,a=s.layouts[i],r=l.appConfigUtils.getUniqueId(e,"layout");n=n.setIn(["layouts",r],a).setIn(["layouts",r,"id"],r);const p=[];Object.keys(a.content||{}).forEach(e=>{const t=a.content[e];t.type===l.LayoutItemType.Widget&&t.widgetId&&s.widgets[t.widgetId]?p.push({type:l.LayoutItemType.Widget,layoutItemId:e,widgetId:t.widgetId}):t.type===l.LayoutItemType.Section&&t.sectionId&&s.sections[t.sectionId]?p.push({type:l.LayoutItemType.Section,layoutItemId:e,sectionId:t.sectionId}):t.type===l.LayoutItemType.ScreenGroup&&t.screenGroupId&&s.screenGroups[t.screenGroupId]&&p.push({type:l.LayoutItemType.ScreenGroup,layoutItemId:e,screenGroupId:t.screenGroupId})});for(let e=0;e<p.length;e+=1){const{type:i,layoutItemId:s,widgetId:u,sectionId:d,screenGroupId:c}=p[e];if(i===l.LayoutItemType.Widget){const e=yield dt(n,t,u,o,a.type===l.LayoutType.FlowLayout);n=e.appConfig;const i=e.newWidgetId;n=n.setIn(["layouts",r,"content",s,"widgetId"],i)}else if(i===l.LayoutItemType.Section){const e=yield ct(n,t,d,o);n=e.appConfig;const i=e.newSectionId;n=n.setIn(["layouts",r,"content",s,"sectionId"],i)}else if(i===l.LayoutItemType.ScreenGroup){const e=yield ft(n,t,c,o);n=e.appConfig;const i=e.newScreenGroupId;n=n.setIn(["layouts",r,"content",s,"screenGroupId"],i)}}return Promise.resolve({appConfig:n,newLayoutId:r})}))}function gt(e,t,i,o){return rt(this,void 0,void 0,(function*(){let n=e;const s=t.config.views[i],a=l.appConfigUtils.getUniqueId(e,"view");n=n.setIn(["views",a],s).setIn(["views",a,"id"],a).setIn(["views",a,"label"],l.appConfigUtils.getUniqueLabel(e,"view",l.i18n.getIntl().formatMessage({id:"view"})));const r=[];Object.keys(s.layout||{}).forEach(e=>{r.push({sizeMode:e,layoutId:s.layout[e]})});for(let e=0;e<r.length;e+=1){const{sizeMode:i,layoutId:s}=r[e],p=yield lt(n,t,s,o);n=p.appConfig;const u=p.newLayoutId;n=n.setIn(["views",a,"layout",i],u)}return Promise.resolve({appConfig:n,newViewId:a})}))}function ht(e,t,i){return rt(this,void 0,void 0,(function*(){let o=e;if(!t.config){const e=yield ee.appServices.getDefaultTemplateConfig({template:t.name,name:t.name});if(t.config=e,!t.config)return yield Promise.resolve({appConfig:o,newPageId:""});l.appConfigUtils.fixLayoutIds(t.config),l.utils.replaceI18nPlaceholdersInObject(t.config,l.i18n.getIntl(),$e.a)}const n=t.config,s=Object.keys(n.pages)[0],a=n.pages[s],r=l.appConfigUtils.getUniqueId(e,"page"),p=l.appConfigUtils.getUniqueLabel(e,"page",l.i18n.getIntl().formatMessage({id:"page"}));o=o.setIn(["pages",r],a).setIn(["pages",r,"id"],r).setIn(["pages",r,"isVisible"],!0).setIn(["pages",r,"isDefault"],!1).setIn(["pages",r,"label"],p).setIn(["pages",r,"header"],!1).setIn(["pages",r,"footer"],!1);const u=[];Object.keys(a.layout||{}).forEach(e=>{u.push({sizeMode:e,layoutId:a.layout[e]})});for(let e=0;e<u.length;e+=1){const{sizeMode:n,layoutId:s}=u[e],a=yield lt(o,t,s,i);o=a.appConfig;const p=a.newLayoutId;o=o.setIn(["pages",r,"layout",n],p)}return Promise.resolve({appConfig:o,newPageId:r})}))}function ft(e,t,i,o){return rt(this,void 0,void 0,(function*(){if(o[i])return yield Promise.resolve({appConfig:e,newScreenGroupId:o[i]});let n=e;const s=t.config.screenGroups[i],a=l.appConfigUtils.getUniqueId(e,"screenGroup");n=n.setIn(["screenGroups",a],s).setIn(["screenGroups",a,"id"],a).setIn(["screenGroups",a,"label"],l.appConfigUtils.getUniqueLabel(e,"screenGroup",l.i18n.getIntl().formatMessage({id:"screenGroup"})));const r=[];for(let e=0;e<s.screens.length;e+=1){const i=s.screens[e],a=yield yt(n,t,i,o);n=a.appConfig,r.push(a.newScreenId)}return n=n.setIn(["screenGroups",a,"screens"],r),o[i]=a,yield Promise.resolve({appConfig:n,newScreenGroupId:a})}))}function yt(e,t,i,o){var n;return rt(this,void 0,void 0,(function*(){let s=e;const a=t.config.screens[i],r=l.appConfigUtils.getUniqueId(e,"screen");s=s.setIn(["screens",r],a).setIn(["screens",r,"id"],r).setIn(["screens",r,"label"],l.appConfigUtils.getUniqueLabel(e,"screen",l.i18n.getIntl().formatMessage({id:"screen"})));const p=[];Object.keys((null===(n=a.panel)||void 0===n?void 0:n.layout)||{}).forEach(e=>{p.push({sizeMode:e,isSide:!0,layoutId:a.panel.layout[e]})}),Object.keys(a.main.layout||{}).forEach(e=>{p.push({sizeMode:e,isSide:!1,layoutId:a.main.layout[e]})});for(let e=0;e<p.length;e+=1){const{sizeMode:i,layoutId:n,isSide:a}=p[e],u=yield lt(s,t,n,o);s=u.appConfig;const d=u.newLayoutId;s=a?s.setIn(["screens",r,"panel","layout",i],d):s.setIn(["screens",r,"main","layout",i],d)}return Promise.resolve({appConfig:s,newScreenId:r})}))}function mt(e,t,i){return rt(this,void 0,void 0,(function*(){let o=e;const n=t.config,s=Object.keys(n.dialogs)[0],a=n.dialogs[s],r=l.appConfigUtils.getUniqueId(e,"dialog"),p=l.appConfigUtils.getUniqueLabel(e,"dialog",l.i18n.getIntl().formatMessage({id:"dialog"})),u=Object.keys(Object.keys(o.dialogs).filter(e=>o.dialogs[e].mode===a.mode)).length;o=o.setIn(["dialogs",r],a).setIn(["dialogs",r,"id"],r).setIn(["dialogs",r,"label"],p).setIn(["dialogs",r,"index"],u).setIn(["dialogs",r,"isSplash"],!1).setIn(["dialogs",r,"closeWhenClickOverlay"],a.closeWhenClickOverlay).setIn(["dialogs",r,"sizeMode"],a.sizeMode);const d=[];Object.keys(a.layout||{}).forEach(e=>{d.push({sizeMode:e,layoutId:a.layout[e]})});for(let e=0;e<d.length;e+=1){const{sizeMode:n,layoutId:s}=d[e],a=yield lt(o,t,s,i);o=a.appConfig;const p=a.newLayoutId;o=o.setIn(["dialogs",r,"layout",n],p)}return Promise.resolve({appConfig:o,newDialogId:r})}))}function St(e,t){var i,o,n,s;return rt(this,void 0,void 0,(function*(){if(!(null===(i=null==t?void 0:t.config)||void 0===i?void 0:i.header))return yield Promise.resolve({appConfig:e});const a=null===(o=null==e?void 0:e.header)||void 0===o?void 0:o.layout;if(a){let{appConfig:i,updatedSizeModeLayout:o}=yield bt(e,a,t,Object(l.Immutable)(null===(s=null===(n=null==t?void 0:t.config)||void 0===n?void 0:n.header)||void 0===s?void 0:s.layout));return i=i.setIn(["header","layout"],o),Object.keys(t.config.header).forEach(e=>{"layout"!==e&&null!=t.config.header[e]&&(i=i.setIn(["header",e],t.config.header[e]))}),Promise.resolve({appConfig:i})}return Promise.resolve({appConfig:e})}))}function Ct(e,t){var i,o,n,s;return rt(this,void 0,void 0,(function*(){if(!(null===(i=null==t?void 0:t.config)||void 0===i?void 0:i.footer))return yield Promise.resolve({appConfig:e});const a=null===(o=null==e?void 0:e.footer)||void 0===o?void 0:o.layout;if(a){let{appConfig:i,updatedSizeModeLayout:o}=yield bt(e,a,t,Object(l.Immutable)(null===(s=null===(n=null==t?void 0:t.config)||void 0===n?void 0:n.footer)||void 0===s?void 0:s.layout));return i=i.setIn(["footer","layout"],o),Object.keys(t.config.footer).forEach(e=>{"layout"!==e&&null!=t.config.footer[e]&&(i=i.setIn(["footer",e],t.config.footer[e]))}),Promise.resolve({appConfig:i})}return Promise.resolve({appConfig:e})}))}function It(e,t,i){var o,n,s,a,r;return rt(this,void 0,void 0,(function*(){if(!i.config){const t=yield ee.appServices.getDefaultTemplateConfig({template:i.name,name:i.name});if(i.config=t,!i.config)return yield Promise.resolve({appConfig:e});l.appConfigUtils.fixLayoutIds(i.config),l.utils.replaceI18nPlaceholdersInObject(i.config,l.i18n.getIntl(),$e.a)}const p=Object.keys(i.config.pages)[0],u=null===(n=null===(o=null==e?void 0:e.pages)||void 0===o?void 0:o[t])||void 0===n?void 0:n.layout;if(u){let{appConfig:o,updatedSizeModeLayout:n}=yield bt(e,u,i,Object(l.Immutable)(null===(r=null===(a=null===(s=null==i?void 0:i.config)||void 0===s?void 0:s.pages)||void 0===a?void 0:a[p])||void 0===r?void 0:r.layout));return o=o.setIn(["pages",t,"layout"],n),["mode","maxWidth","bodyBackgroundColor","bodyBackgroundIMage","bodyBackgroundPosition"].forEach(e=>{const n=i.config.pages[p][e];"layout"!==e&&null!=n&&(o=o.setIn(["pages",t,e],n))}),Promise.resolve({appConfig:o})}return Promise.resolve({appConfig:e})}))}function vt(e,t,i){var o,n,s;return rt(this,void 0,void 0,(function*(){const a=Object.keys(i.config.dialogs)[0],r=null===(o=null==e?void 0:e.dialogs)||void 0===o?void 0:o[t],p=null==r?void 0:r.layout;if(p){const o=null===(s=null===(n=null==i?void 0:i.config)||void 0===n?void 0:n.dialogs)||void 0===s?void 0:s[a];let{appConfig:u,updatedSizeModeLayout:d}=yield bt(e,p,i,Object(l.Immutable)(null==o?void 0:o.layout));const c=r.mode===o.mode,g=c?r.index:Object.keys(Object.keys(u.dialogs).filter(e=>u.dialogs[e].mode===o.mode)).length;return u=u.setIn(["dialogs",t,"layout"],d).setIn(["dialogs",t,"index"],g),["sizeMode","mode","overlayColor","dialogBackground","interactionType","interactionStyles","confirmBeforeClose","alwaysShowConfirmation","closeWhenClickOverlay"].forEach(e=>{u=u.setIn(["dialogs",t,e],o[e])}),c||Object.keys(u.dialogs).forEach(e=>{const t=u.dialogs[e];t.mode===r.mode&&t.index>r.index&&(u=u.setIn(["dialogs",t.id,"index"],t.index-1))}),Promise.resolve({appConfig:u})}return Promise.resolve({appConfig:e})}))}function bt(e,t,i,o){return rt(this,void 0,void 0,(function*(){if(!o)return yield Promise.resolve({appConfig:e,updatedSizeModeLayout:t});const n={};let s=e,a=t;const r=Object.keys(o);for(let e=0;e<r.length;e+=1){const t=r[e],p=a[t];if(p){const e=s.layouts[p];if(e&&e.content&&Object.keys(e.content).length>0)continue;s=s.set("layouts",s.layouts.without(p))}const u=yield lt(s,i,o[t],n);s=u.appConfig,a=a.set(t,u.newLayoutId)}return yield Promise.resolve({updatedSizeModeLayout:a,appConfig:s})}))}class wt extends l.React.PureComponent{constructor(){super(...arguments),this.isSupportKeyboard=()=>{let e=!1;return window.jimuConfig.isBuilder&&"home"!==this.props.currentPageId&&"template"!==this.props.currentPageId?(e=!0,e):e},this.switchAppMode=()=>{var e,t;(null===(t=null===(e=Object(l.getAppStore)().getState().appStateInBuilder)||void 0===e?void 0:e.appRuntimeInfo)||void 0===t?void 0:t.appMode)===l.AppMode.Run?re(l.AppMode.Design):re(l.AppMode.Run)},this.undo=()=>{this.props.stateHistory.past.length<=1||Object(l.getAppStore)().dispatch($.InBuilderAppConfigUndo())},this.redo=()=>{this.props.stateHistory.future.length<=0||Object(l.getAppStore)().dispatch($.InBuilderAppConfigRedo())},this.onKeyboardTrigger=e=>{e.key.includes("-manual")||ge(e)},this.isMac=()=>/macintosh|mac os x/i.test(navigator.userAgent)}render(){return this.isMac()?this.isSupportKeyboard()?l.React.createElement(l.Keyboard,{onKeyboardTrigger:this.onKeyboardTrigger,bindings:{"shift+alt+keyx":()=>this.switchAppMode(),"command+keyz":()=>this.undo(),"command+shift+keyz":()=>this.redo()}}):null:this.isSupportKeyboard()?l.React.createElement(l.Keyboard,{onKeyboardTrigger:this.onKeyboardTrigger,bindings:{"shift+alt+keyx":()=>this.switchAppMode(),"ctrl+keyz":()=>this.undo(),"ctrl+shift+keyz":()=>this.redo()}}):null}}var Dt=l.ReactRedux.connect(e=>({currentPageId:e.appRuntimeInfo.currentPageId,stateHistory:e.appStateHistory}))(wt);function At(e){var t,i,o,n,s;const{widgetId:a,useDataSource:r,messageType:p,arcGISDataSourceTypes:u}=e,d=null===(i=null===(t=Object(l.getAppStore)().getState())||void 0===t?void 0:t.appStateInBuilder)||void 0===i?void 0:i.appConfig,c=null===(o=null==d?void 0:d.widgets)||void 0===o?void 0:o[a];let g=!1;const h=function(e,t){var i,o,n,s;const a=null===(o=null===(i=Object(l.getAppStore)().getState())||void 0===i?void 0:i.appStateInBuilder)||void 0===o?void 0:o.appConfig,r=null===(n=null==a?void 0:a.widgets)||void 0===n?void 0:n[e],p=[],u=l.DataSourceManager.getInstance();return null===(s=null==r?void 0:r.useDataSources)||void 0===s||s.forEach(e=>{const i=u.getDataSource(e.dataSourceId);(null==i?void 0:i.type)!==t.WebMap&&(null==i?void 0:i.type)!==t.WebScene||p.push(e.dataSourceId)}),p.length>0?Object(l.Immutable)(p):null}(a,u),f=jt(a,p)?1===(null===(n=null==c?void 0:c.outputDataSources)||void 0===n?void 0:n.length):1===(null===(s=null==c?void 0:c.useDataSources)||void 0===s?void 0:s.length);h&&0===h.length&&c&&c.useDataSources&&1===c.useDataSources.length&&(g=!0),!h&&f&&(g=!0);return{isReadOnly:g,useDataSources:r&&r.dataSourceId?Object(l.Immutable)([r.asMutable({deep:!0})]):null,fromRootDsIds:h,fromDsIds:h?null:function(e,t){var i;const o=function(e,t){var i,o,n;const s=jt(e,t),a=null===(o=null===(i=Object(l.getAppStore)().getState())||void 0===i?void 0:i.appStateInBuilder)||void 0===o?void 0:o.appConfig,r=null===(n=null==a?void 0:a.widgets)||void 0===n?void 0:n[e];return s?Lt(null==r?void 0:r.outputDataSources):null==r?void 0:r.useDataSources}(e,t);return Object(l.Immutable)(null!==(i=null==o?void 0:o.map(e=>null==e?void 0:e.mainDataSourceId))&&void 0!==i?i:[])}(a,p)}}function jt(e,t){return function(e,t){var i,o,n,s;const a=null===(o=null===(i=Object(l.getAppStore)().getState())||void 0===i?void 0:i.appStateInBuilder)||void 0===o?void 0:o.appConfig,r=null===(n=null==a?void 0:a.widgets)||void 0===n?void 0:n[e],p=null===(s=null==r?void 0:r.manifest)||void 0===s?void 0:s.publishMessages;let u=null;return p.forEach(e=>{const i=e;(null==i?void 0:i.messageCarryData)&&(null==i?void 0:i.messageType)==t&&(u=null==i?void 0:i.messageCarryData)}),u}(e,t)==l.MessageCarryData.OutputDataSource}function Lt(e){var t;const i=null!==(t=null==e?void 0:e.map(e=>({dataSourceId:e,mainDataSourceId:e,rootDataSourceId:null})))&&void 0!==t?t:[];return Object(l.Immutable)(i)}function Ot(e){var t,i,o,n,s,a,r,p,u,d,c,g;const{widgetId:h,oldUseDataSource:f,messageType:y,arcGISDataSourceTypes:m}=e,S=Object(l.getAppStore)().getState().appStateInBuilder.appConfig,C=l.DataSourceManager.getInstance(),I=S.widgets[h];let v=null,b=!1;const w=jt(h,y),D=w?Lt(null==I?void 0:I.outputDataSources):null==I?void 0:I.useDataSources,A=(null==D?void 0:D[0])&&(null===(t=null==D?void 0:D[0])||void 0===t?void 0:t.dataSourceId);if(!A)return null;const j=null===(i=C.getDataSource(A))||void 0===i?void 0:i.getDataSourceJson();if(!j||j.type!==m.WebMap&&j.type!==m.WebScene||(b=!0),b){let e=!1;if(I&&I.useDataSources)for(let t=0;t<I.useDataSources.length;t++)if(I.useDataSources[t].dataSourceId===f.rootDataSourceId){e=!0;break}v=e?f:null}else{let e=!1;if(D)for(let t=0;t<(null==D?void 0:D.length);t++){const i=w?null===(n=null===(o=C.getDataSource(f.dataSourceId))||void 0===o?void 0:o.getMainDataSource())||void 0===n?void 0:n.id:f.dataSourceId;if((w?null===(r=null===(a=C.getDataSource(null===(s=null==D?void 0:D[t])||void 0===s?void 0:s.dataSourceId))||void 0===a?void 0:a.getMainDataSource())||void 0===r?void 0:r.id:null===(p=null==D?void 0:D[t])||void 0===p?void 0:p.dataSourceId)==i){e=!0;break}}v=e?f:1===(null==D?void 0:D.length)?Object(l.Immutable)({dataSourceId:null===(u=null==D?void 0:D[0])||void 0===u?void 0:u.dataSourceId,mainDataSourceId:null===(d=null==D?void 0:D[0])||void 0===d?void 0:d.mainDataSourceId,dataViewId:null===(c=null==D?void 0:D[0])||void 0===c?void 0:c.dataViewId,rootDataSourceId:null===(g=null==D?void 0:D[0])||void 0===g?void 0:g.rootDataSourceId}):null}return v}function xt(e){return!(!e.messageUseDataSource||!e.actionUseDataSource)&&!(e.messageUseDataSource.mainDataSourceId!==e.actionUseDataSource.mainDataSourceId||!function(e){return!e.messageUseDataSource.rootDataSourceId&&!e.actionUseDataSource.rootDataSourceId||e.messageUseDataSource.rootDataSourceId===e.actionUseDataSource.rootDataSourceId}(e))}class Pt extends l.React.PureComponent{constructor(e){super(e),this.modalStyle={position:"absolute",top:"0",bottom:"0",width:"259px",height:"auto",borderRight:"",borderBottom:"",paddingBottom:"1px"},this.getInitConfig=()=>{var e,t,i,o,n,s,a,r,p,u,d;const{messageWidgetId:c,messageType:g}=this.props,h=Object(l.getAppStore)().getState().appStateInBuilder.appConfig.widgets[c],f=l.DataSourceManager.getInstance();let y=null,m=null,S=!0;if(this.props.config.messageUseDataSource)y=Ot({widgetId:c,oldUseDataSource:this.props.config.messageUseDataSource,messageType:g,arcGISDataSourceTypes:this.state.ArcGISDataSourceTypes});else{const s=jt(c,g)?Lt(null==h?void 0:h.outputDataSources):null==h?void 0:h.useDataSources;if((null==s?void 0:s[0])&&1===(null==s?void 0:s.length)){const a=null===(e=f.getDataSource(null==s?void 0:s[0].dataSourceId))||void 0===e?void 0:e.getDataSourceJson();y=!a||a.type!==this.state.ArcGISDataSourceTypes.WebMap&&a.type!==this.state.ArcGISDataSourceTypes.WebScene?Object(l.Immutable)({dataSourceId:null===(t=null==s?void 0:s[0])||void 0===t?void 0:t.dataSourceId,mainDataSourceId:null===(i=null==s?void 0:s[0])||void 0===i?void 0:i.mainDataSourceId,dataViewId:null===(o=null==s?void 0:s[0])||void 0===o?void 0:o.dataViewId,rootDataSourceId:null===(n=null==s?void 0:s[0])||void 0===n?void 0:n.rootDataSourceId}):null}}if(void 0!==this.props.config.enableQueryWithCurrentExtent&&(S=this.props.config.enableQueryWithCurrentExtent),this.props.config.actionUseDataSource){const e=null===(a=null===(s=this.props.config)||void 0===s?void 0:s.actionUseDataSource)||void 0===a?void 0:a.dataSourceId,t=null===(p=null===(r=this.props.config)||void 0===r?void 0:r.actionUseDataSource)||void 0===p?void 0:p.rootDataSourceId;m=(null===(u=f.getDataSource(e))||void 0===u?void 0:u.getDataSourceJson())||(null===(d=f.getDataSource(t))||void 0===d?void 0:d.getDataSourceJson())?this.props.config.actionUseDataSource:null}else m=null;return m&&m.dataSourceId?{messageUseDataSource:y,actionUseDataSource:m,sqlExprObj:this.props.config.sqlExprObj,enableQueryWithCurrentExtent:S}:{messageUseDataSource:y,actionUseDataSource:m,sqlExprObj:null,enableQueryWithCurrentExtent:S}},this.handleTriggerLayerChange=e=>{e&&e.length>0?this.handleTriggerLayerSelected(e[0]):this.handleRemoveLayerForTriggerLayer()},this.handleActionLayerChange=e=>{e&&e.length>0?this.handleActionLayerSelected(e[0]):this.handleRemoveLayerForActionLayer()},this.handleTriggerLayerSelected=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",e)})},this.handleActionLayerSelected=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",e).set("sqlExprObj",null)})},this.handleRemoveLayerForTriggerLayer=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",null)})},this.handleRemoveLayerForActionLayer=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",null).set("sqlExprObj",null)})},this.showSqlExprPopup=()=>{this.setState({isSqlExprShow:!0})},this.toggleSqlExprPopup=()=>{this.setState({isSqlExprShow:!this.state.isSqlExprShow})},this.onSqlExprBuilderChange=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("sqlExprObj",e)})},this.onMessageFieldSelected=(e,t)=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",{dataSourceId:this.props.config.messageUseDataSource.dataSourceId,mainDataSourceId:this.props.config.messageUseDataSource.mainDataSourceId,dataViewId:this.props.config.messageUseDataSource.dataViewId,rootDataSourceId:this.props.config.messageUseDataSource.rootDataSourceId,fields:e.map(e=>e.jimuName)})})},this.onActionFieldSelected=(e,t)=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",{dataSourceId:this.props.config.actionUseDataSource.dataSourceId,mainDataSourceId:this.props.config.actionUseDataSource.mainDataSourceId,dataViewId:this.props.config.actionUseDataSource.dataViewId,rootDataSourceId:this.props.config.actionUseDataSource.rootDataSourceId,fields:e.map(e=>e.jimuName)})})},this.swicthEnabledDataRelationShip=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("enabledDataRelationShip",e)})},this.swicthEnabledQueryWithCurrentExtent=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("enableQueryWithCurrentExtent",e)})},this.checkIsDisableDataView=e=>{var t,i,o,n;if(this.props.messageType===l.MessageType.DataRecordsSelectionChange)return!0;const s=null===(i=null===(t=Object(l.getAppStore)().getState())||void 0===t?void 0:t.appStateInBuilder)||void 0===i?void 0:i.appConfig,a=null===(o=null==s?void 0:s.widgets)||void 0===o?void 0:o[e];if(a){return"Map"===(null===(n=null==a?void 0:a.manifest)||void 0===n?void 0:n.label)}return!1},this.modalStyle.borderRight="1px solid black",this.modalStyle.borderBottom="1px solid black",this.state={isShowLayerList:!1,currentLayerType:null,isSqlExprShow:!1}}componentDidMount(){l.moduleLoader.loadModules(["jimu-ui","jimu-ui/advanced/setting-components","jimu-ui/advanced/data-source-selector","jimu-arcgis","jimu-ui/advanced/sql-expression-builder"]).then(e=>{this.setState({Button:e[0].Button,Icon:e[0].Icon,Switch:e[0].Switch,Collapse:e[0].Collapse,SettingSection:e[1].SettingSection,SettingRow:e[1].SettingRow,FieldSelector:e[2].FieldSelector,AllDataSourceTypes:e[2].AllDataSourceTypes,DataSourceSelector:e[2].DataSourceSelector,ArcGISDataSourceTypes:e[3].ArcGISDataSourceTypes,SqlExpressionBuilderPopup:e[4].SqlExpressionBuilderPopup,DSSelectorTypes:Object(l.Immutable)([e[2].AllDataSourceTypes.FeatureLayer,e[2].AllDataSourceTypes.SceneLayer])},()=>{const e=this.getInitConfig();this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",e.messageUseDataSource).set("actionUseDataSource",e.actionUseDataSource).set("sqlExprObj",e.sqlExprObj)})})})}getStyle(e){return l.css`
      .setting-header {
        padding: ${l.polished.rem(10)} ${l.polished.rem(16)} ${l.polished.rem(0)} ${l.polished.rem(16)}
      }

      .deleteIcon {
        cursor: pointer;
        opacity: .8;
      }

      .deleteIcon:hover {
        opacity: 1;
      }

      .sql-expr-display {
        width: 100%;
        height: auto;
        min-height: 60px;
        line-height: 25px;
        padding: 3px 5px;
        color: ${e.colors.palette.dark[300]};
        border: 1px solid ${e.colors.palette.light[500]};
      }

      .relate-panel-left {
        flex: auto;
        .action-select-chooser {
          margin-top: ${l.polished.rem(12)};
        }
      }
    `}render(){var e,t;const{Button:o,Icon:n,Switch:s,Collapse:a,SettingSection:r,SettingRow:p,FieldSelector:u,AllDataSourceTypes:d,DataSourceSelector:c,ArcGISDataSourceTypes:g,SqlExpressionBuilderPopup:h}=this.state,{messageWidgetId:f,messageType:y,config:m,theme:S}=this.props;if(!(o&&n&&s&&a&&r&&p&&u&&d&&c&&g&&h))return null;const C=At({widgetId:f,useDataSource:m.messageUseDataSource,messageType:y,arcGISDataSourceTypes:g}),I=m.actionUseDataSource&&l.DataSourceManager.getInstance().getDataSource(m.actionUseDataSource.dataSourceId);return this.props.messageType===l.MessageType.ExtentChange?Object(l.jsx)("div",{css:this.getStyle(this.props.theme)},Object(l.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_ActionLayer",defaultMessage:$e.a.frameworkAction_ActionLayer})},Object(l.jsx)(c,{types:this.state.DSSelectorTypes,useDataSources:this.props.config.actionUseDataSource?Object(l.Immutable)([this.props.config.actionUseDataSource]):Object(l.Immutable)([]),closeDataSourceListOnChange:!0,disableAddData:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleActionLayerChange,widgetId:this.props.widgetId,enableToSelectOutputDsFromSelf:!0})),Object(l.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_Conditions",defaultMessage:$e.a.frameworkAction_Conditions})},Object(l.jsx)(p,{label:this.props.intl.formatMessage({id:"frameworkAction_QueryByExtent",defaultMessage:$e.a.frameworkAction_QueryByExtent})},Object(l.jsx)(s,{checked:this.props.config.enableQueryWithCurrentExtent,onChange:e=>{this.swicthEnabledQueryWithCurrentExtent(e.target.checked)}})),Object(l.jsx)(p,{label:Object(l.jsx)(o,{className:"p-0",type:"link",disabled:!this.props.config.actionUseDataSource,onClick:this.showSqlExprPopup},this.props.intl.formatMessage({id:"frameworkAction_MoreConditions",defaultMessage:$e.a.frameworkAction_MoreConditions}))}),Object(l.jsx)(p,null,this.props.config.actionUseDataSource&&Object(l.jsx)(l.DataSourceComponent,{useDataSource:this.props.config.actionUseDataSource},e=>Object(l.jsx)(h,{dataSource:e,mode:l.SqlExpressionMode.Simple,isOpen:this.state.isSqlExprShow,toggle:this.toggleSqlExprPopup,expression:this.props.config.sqlExprObj,onChange:e=>{this.onSqlExprBuilderChange(e)},id:"filter-widget-sql-expression-builder-popup"})),Object(l.jsx)("div",{className:"sql-expr-display body-1"},this.props.config.sqlExprObj&&I?l.dataSourceUtils.getArcGISSQL(this.props.config.sqlExprObj,I).displaySQL:this.props.intl.formatMessage({id:"frameworkAction_SetExpression",defaultMessage:$e.a.frameworkAction_SetExpression}))))):Object(l.jsx)("div",{css:this.getStyle(this.props.theme)},Object(l.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_TriggerLayer",defaultMessage:$e.a.frameworkAction_TriggerLayer})},Object(l.jsx)(c,{types:this.state.DSSelectorTypes,useDataSources:C.useDataSources,fromRootDsIds:C.fromRootDsIds,fromDsIds:C.fromDsIds,closeDataSourceListOnChange:!0,disableRemove:()=>C.isReadOnly,disableDataSourceList:C.isReadOnly,disableAddData:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleTriggerLayerChange,widgetId:this.props.messageWidgetId,disableDataView:!0,hideDataView:this.checkIsDisableDataView(this.props.messageWidgetId),enableToSelectOutputDsFromSelf:!0})),Object(l.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_ActionLayer",defaultMessage:$e.a.frameworkAction_ActionLayer})},Object(l.jsx)(c,{types:this.state.DSSelectorTypes,useDataSources:this.props.config.actionUseDataSource?Object(l.Immutable)([this.props.config.actionUseDataSource]):Object(l.Immutable)([]),closeDataSourceListOnChange:!0,disableAddData:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleActionLayerChange,widgetId:this.props.widgetId,enableToSelectOutputDsFromSelf:!0})),this.props.config&&this.props.config.actionUseDataSource&&this.props.config.messageUseDataSource&&Object(l.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_Conditions",defaultMessage:$e.a.frameworkAction_Conditions})},Object(l.jsx)(p,{label:this.props.intl.formatMessage({id:"frameworkAction_RelateMessage",defaultMessage:$e.a.frameworkAction_RelateMessage})},Object(l.jsx)(s,{checked:this.props.config.enabledDataRelationShip,onChange:e=>{this.swicthEnabledDataRelationShip(e.target.checked)}})),Object(l.jsx)(p,null,Object(l.jsx)(a,{isOpen:this.props.config.enabledDataRelationShip,className:"w-100"},xt(m)&&Object(l.jsx)("div",{className:"w-100 border p-1 mr-2"},this.props.intl.formatMessage({id:"frameworkAction_AutoBind",defaultMessage:$e.a.frameworkAction_AutoBind})),!xt(m)&&Object(l.jsx)("div",{className:"w-100 d-flex align-items-center"},Object(l.jsx)("div",{className:"d-flex flex-column relate-panel-left"},Object(l.jsx)(u,{className:"w-100",useDataSources:Object(l.Immutable)([null===(e=this.props.config.messageUseDataSource)||void 0===e?void 0:e.asMutable({deep:!0})]),isDataSourceDropDownHidden:!0,placeholder:this.props.intl.formatMessage({id:"frameworkAction_TriggerLayerField",defaultMessage:$e.a.frameworkAction_TriggerLayerField}),onChange:this.onMessageFieldSelected,useDropdown:!0,isSearchInputHidden:!0,selectedFields:this.props.config.messageUseDataSource&&this.props.config.messageUseDataSource.fields?this.props.config.messageUseDataSource.fields:Object(l.Immutable)([])}),Object(l.jsx)(u,{className:"w-100 action-select-chooser",placeholder:this.props.intl.formatMessage({id:"frameworkAction_ActionLayerField",defaultMessage:$e.a.frameworkAction_ActionLayerField}),useDataSources:Object(l.Immutable)([null===(t=this.props.config.actionUseDataSource)||void 0===t?void 0:t.asMutable({deep:!0})]),isDataSourceDropDownHidden:!0,onChange:this.onActionFieldSelected,useDropdown:!0,isSearchInputHidden:!0,selectedFields:this.props.config.actionUseDataSource&&this.props.config.actionUseDataSource.fields?this.props.config.actionUseDataSource.fields:Object(l.Immutable)([])})),Object(l.jsx)(n,{autoFlip:!0,className:"flex-none",width:12,height:40,color:S.colors.dark[400],icon:i(11)})))),Object(l.jsx)(p,null,Object(l.jsx)(o,{type:"link",disabled:!this.props.config.actionUseDataSource,className:"w-100 d-flex justify-content-start",onClick:this.showSqlExprPopup},Object(l.jsx)("div",{className:"w-100 text-truncate",style:{textAlign:"start"}},this.props.intl.formatMessage({id:"frameworkAction_MoreConditions",defaultMessage:$e.a.frameworkAction_MoreConditions}))),this.props.config.actionUseDataSource&&Object(l.jsx)(l.DataSourceComponent,{useDataSource:this.props.config.actionUseDataSource},e=>Object(l.jsx)(h,{dataSource:e,mode:l.SqlExpressionMode.Simple,isOpen:this.state.isSqlExprShow,toggle:this.toggleSqlExprPopup,expression:this.props.config.sqlExprObj,onChange:e=>{this.onSqlExprBuilderChange(e)},id:"filter-widget-sql-expression-builder-popup"}))),Object(l.jsx)(p,null,Object(l.jsx)("div",{className:"sql-expr-display"},this.props.config.sqlExprObj&&I?l.dataSourceUtils.getArcGISSQL(this.props.config.sqlExprObj,I).displaySQL:this.props.intl.formatMessage({id:"frameworkAction_SetExpression",defaultMessage:$e.a.frameworkAction_SetExpression})))))}}Pt.defaultProps={config:Object(l.Immutable)({messageUseDataSource:null,actionUseDataSource:null,sqlExprObj:null,enabledDataRelationShip:!0,enableQueryWithCurrentExtent:!0})};var Mt=l.ReactRedux.connect(e=>({dataSources:e.appStateInBuilder&&e.appStateInBuilder.appConfig&&e.appStateInBuilder.appConfig.dataSources,dataSourcesInfo:e.appStateInBuilder&&e.appStateInBuilder.dataSourcesInfo}))(l.themeUtils.withTheme(Pt));class Tt extends l.React.PureComponent{constructor(e){super(e),this.modalStyle={position:"absolute",top:"0",bottom:"0",width:"259px",height:"auto",borderRight:"",borderBottom:"",paddingBottom:"1px"},this.getInitConfig=()=>{var e,t,i,o,n,s,a,r,p,u,d;const{messageWidgetId:c,messageType:g}=this.props,h=Object(l.getAppStore)().getState().appStateInBuilder.appConfig.widgets[c],f=l.DataSourceManager.getInstance();let y=null,m=null;if(this.props.config.messageUseDataSource)y=Ot({widgetId:c,oldUseDataSource:this.props.config.messageUseDataSource,messageType:g,arcGISDataSourceTypes:this.state.ArcGISDataSourceTypes});else{const s=jt(c,g)?Lt(null==h?void 0:h.outputDataSources):null==h?void 0:h.useDataSources;if((null==s?void 0:s[0])&&1===(null==s?void 0:s.length)){const a=null===(e=f.getDataSource(null==s?void 0:s[0].dataSourceId))||void 0===e?void 0:e.getDataSourceJson();y=!a||a.type!==this.state.ArcGISDataSourceTypes.WebMap&&a.type!==this.state.ArcGISDataSourceTypes.WebScene?Object(l.Immutable)({dataSourceId:null===(t=null==s?void 0:s[0])||void 0===t?void 0:t.dataSourceId,mainDataSourceId:null===(i=null==s?void 0:s[0])||void 0===i?void 0:i.mainDataSourceId,dataViewId:null===(o=null==s?void 0:s[0])||void 0===o?void 0:o.dataViewId,rootDataSourceId:null===(n=null==s?void 0:s[0])||void 0===n?void 0:n.rootDataSourceId}):null}}if(this.props.config.actionUseDataSource){const e=null===(a=null===(s=this.props.config)||void 0===s?void 0:s.actionUseDataSource)||void 0===a?void 0:a.dataSourceId,t=null===(p=null===(r=this.props.config)||void 0===r?void 0:r.actionUseDataSource)||void 0===p?void 0:p.rootDataSourceId;m=(null===(u=f.getDataSource(e))||void 0===u?void 0:u.getDataSourceJson())||(null===(d=f.getDataSource(t))||void 0===d?void 0:d.getDataSourceJson())?this.props.config.actionUseDataSource:null}else m=null;return m&&m.dataSourceId?{messageUseDataSource:y,actionUseDataSource:m,sqlExprObj:this.props.config.sqlExprObj}:{messageUseDataSource:y,actionUseDataSource:m,sqlExprObj:null}},this.handleTriggerLayerChange=e=>{e&&e.length>0?this.handleTriggerLayerSelected(e[0]):this.handleRemoveLayerForTriggerLayer()},this.handleActionLayerChange=e=>{e&&e.length>0?this.handleActionLayerSelected(e[0]):this.handleRemoveLayerForActionLayer()},this.handleTriggerLayerSelected=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",e)})},this.handleActionLayerSelected=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",e).set("sqlExprObj",null)})},this.handleRemoveLayerForTriggerLayer=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",null)})},this.handleRemoveLayerForActionLayer=()=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",null).set("sqlExprObj",null)})},this.showSqlExprPopup=()=>{this.setState({isSqlExprShow:!0})},this.toggleSqlExprPopup=()=>{this.setState({isSqlExprShow:!this.state.isSqlExprShow})},this.onSqlExprBuilderChange=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("sqlExprObj",e)})},this.onMessageFieldSelected=(e,t)=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",{dataSourceId:this.props.config.messageUseDataSource.dataSourceId,mainDataSourceId:this.props.config.messageUseDataSource.mainDataSourceId,dataViewId:this.props.config.messageUseDataSource.dataViewId,rootDataSourceId:this.props.config.messageUseDataSource.rootDataSourceId,fields:e.map(e=>e.jimuName)})})},this.onActionFieldSelected=(e,t)=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("actionUseDataSource",{dataSourceId:this.props.config.actionUseDataSource.dataSourceId,mainDataSourceId:this.props.config.actionUseDataSource.mainDataSourceId,dataViewId:this.props.config.actionUseDataSource.dataViewId,rootDataSourceId:this.props.config.actionUseDataSource.rootDataSourceId,fields:e.map(e=>e.jimuName)})})},this.swicthEnabledDataRelationShip=e=>{this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("enabledDataRelationShip",e)})},this.modalStyle.borderRight="1px solid black",this.modalStyle.borderBottom="1px solid black",this.state={isShowLayerList:!1,currentLayerType:null,isSqlExprShow:!1}}componentDidMount(){l.moduleLoader.loadModules(["jimu-ui","jimu-ui/advanced/setting-components","jimu-ui/advanced/data-source-selector","jimu-arcgis","jimu-ui/advanced/sql-expression-builder"]).then(e=>{this.setState({Button:e[0].Button,Icon:e[0].Icon,Switch:e[0].Switch,Collapse:e[0].Collapse,SettingSection:e[1].SettingSection,SettingRow:e[1].SettingRow,FieldSelector:e[2].FieldSelector,AllDataSourceTypes:e[2].AllDataSourceTypes,DataSourceSelector:e[2].DataSourceSelector,ArcGISDataSourceTypes:e[3].ArcGISDataSourceTypes,SqlExpressionBuilderPopup:e[4].SqlExpressionBuilderPopup,DSSelectorTypes:Object(l.Immutable)([e[2].AllDataSourceTypes.FeatureLayer,e[2].AllDataSourceTypes.SceneLayer])},()=>{const e=this.getInitConfig();this.props.onSettingChange({actionId:this.props.actionId,config:this.props.config.set("messageUseDataSource",e.messageUseDataSource).set("actionUseDataSource",e.actionUseDataSource).set("sqlExprObj",e.sqlExprObj)})})})}getStyle(e){return l.css`
      .setting-header {
        padding: ${l.polished.rem(10)} ${l.polished.rem(16)} ${l.polished.rem(0)} ${l.polished.rem(16)}
      }

      .deleteIcon {
        cursor: pointer;
        opacity: .8;
      }

      .deleteIcon:hover {
        opacity: 1;
      }

      .sql-expr-display {
        width: 100%;
        height: auto;
        min-height: 60px;
        line-height: 25px;
        padding: 3px 5px;
        color: ${e.colors.palette.dark[300]};
        border: 1px solid ${e.colors.palette.light[500]};
      }

      .relate-panel-left {
        flex: auto;
        .action-select-chooser {
          margin-top: ${l.polished.rem(12)};
        }
      }
    `}render(){var e,t;const{Button:o,Icon:n,Switch:s,Collapse:a,SettingSection:r,SettingRow:p,FieldSelector:u,AllDataSourceTypes:d,DataSourceSelector:c,ArcGISDataSourceTypes:g,SqlExpressionBuilderPopup:h}=this.state,{messageWidgetId:f,messageType:y,config:m,theme:S}=this.props;if(!(o&&n&&s&&a&&r&&p&&u&&d&&c&&g&&h))return null;const C=At({widgetId:f,useDataSource:m.messageUseDataSource,messageType:y,arcGISDataSourceTypes:g}),I=this.props.config.actionUseDataSource&&l.DataSourceManager.getInstance().getDataSource(this.props.config.actionUseDataSource.dataSourceId);return Object(l.jsx)("div",{css:this.getStyle(this.props.theme)},Object(l.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_TriggerLayer",defaultMessage:$e.a.frameworkAction_TriggerLayer})},Object(l.jsx)(c,{types:this.state.DSSelectorTypes,useDataSources:C.useDataSources,fromRootDsIds:C.fromRootDsIds,fromDsIds:C.fromDsIds,closeDataSourceListOnChange:!0,disableRemove:()=>C.isReadOnly,disableDataSourceList:C.isReadOnly,disableAddData:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleTriggerLayerChange,widgetId:this.props.messageWidgetId,hideDataView:!0,enableToSelectOutputDsFromSelf:!0})),Object(l.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_ActionLayer",defaultMessage:$e.a.frameworkAction_ActionLayer})},Object(l.jsx)(c,{types:this.state.DSSelectorTypes,useDataSources:this.props.config.actionUseDataSource?Object(l.Immutable)([this.props.config.actionUseDataSource]):Object(l.Immutable)([]),closeDataSourceListOnChange:!0,disableAddData:!0,hideTypeDropdown:!0,mustUseDataSource:!0,onChange:this.handleActionLayerChange,widgetId:this.props.widgetId,hideDataView:!0,enableToSelectOutputDsFromSelf:!0})),this.props.config&&this.props.config.actionUseDataSource&&this.props.config.messageUseDataSource&&Object(l.jsx)(r,{title:this.props.intl.formatMessage({id:"frameworkAction_Conditions",defaultMessage:$e.a.frameworkAction_Conditions})},Object(l.jsx)(p,{label:this.props.intl.formatMessage({id:"frameworkAction_RelateMessage",defaultMessage:$e.a.frameworkAction_RelateMessage})},Object(l.jsx)(s,{checked:this.props.config.enabledDataRelationShip,onChange:e=>{this.swicthEnabledDataRelationShip(e.target.checked)}})),Object(l.jsx)(p,null,Object(l.jsx)(a,{isOpen:this.props.config.enabledDataRelationShip,className:"w-100"},xt(m)&&Object(l.jsx)("div",{className:"w-100 border p-1 mr-2"},this.props.intl.formatMessage({id:"frameworkAction_AutoBind",defaultMessage:$e.a.frameworkAction_AutoBind})),!xt(m)&&Object(l.jsx)("div",{className:"w-100 d-flex align-items-center"},Object(l.jsx)("div",{className:"d-flex flex-column relate-panel-left"},Object(l.jsx)(u,{className:"w-100",useDataSources:Object(l.Immutable)([null===(e=this.props.config.messageUseDataSource)||void 0===e?void 0:e.asMutable({deep:!0})]),isDataSourceDropDownHidden:!0,placeholder:this.props.intl.formatMessage({id:"frameworkAction_TriggerLayerField",defaultMessage:$e.a.frameworkAction_TriggerLayerField}),onChange:this.onMessageFieldSelected,useDropdown:!0,isSearchInputHidden:!0,selectedFields:this.props.config.messageUseDataSource&&this.props.config.messageUseDataSource.fields?this.props.config.messageUseDataSource.fields:Object(l.Immutable)([])}),Object(l.jsx)(u,{className:"w-100 action-select-chooser",placeholder:this.props.intl.formatMessage({id:"frameworkAction_ActionLayerField",defaultMessage:$e.a.frameworkAction_ActionLayerField}),useDataSources:Object(l.Immutable)([null===(t=this.props.config.actionUseDataSource)||void 0===t?void 0:t.asMutable({deep:!0})]),isDataSourceDropDownHidden:!0,onChange:this.onActionFieldSelected,useDropdown:!0,isSearchInputHidden:!0,selectedFields:this.props.config.actionUseDataSource&&this.props.config.actionUseDataSource.fields?this.props.config.actionUseDataSource.fields:Object(l.Immutable)([])})),Object(l.jsx)(n,{autoFlip:!0,className:"flex-none",width:12,height:40,color:S.colors.dark[400],icon:i(11)})))),Object(l.jsx)(p,null,Object(l.jsx)(o,{type:"link",disabled:!this.props.config.actionUseDataSource,className:"w-100 d-flex justify-content-start",onClick:this.showSqlExprPopup},Object(l.jsx)("div",{className:"w-100 text-truncate",style:{textAlign:"start"}},this.props.intl.formatMessage({id:"frameworkAction_MoreConditions",defaultMessage:$e.a.frameworkAction_MoreConditions}))),this.props.config.actionUseDataSource&&Object(l.jsx)(l.DataSourceComponent,{useDataSource:this.props.config.actionUseDataSource},e=>Object(l.jsx)(h,{dataSource:e,mode:l.SqlExpressionMode.Simple,isOpen:this.state.isSqlExprShow,toggle:this.toggleSqlExprPopup,expression:this.props.config.sqlExprObj,onChange:e=>{this.onSqlExprBuilderChange(e)},id:"filter-widget-sql-expression-builder-popup"}))),Object(l.jsx)(p,null,Object(l.jsx)("div",{className:"sql-expr-display"},this.props.config.sqlExprObj&&I?l.dataSourceUtils.getArcGISSQL(this.props.config.sqlExprObj,I).displaySQL:this.props.intl.formatMessage({id:"frameworkAction_SetExpression",defaultMessage:$e.a.frameworkAction_SetExpression})))))}}Tt.defaultProps={config:Object(l.Immutable)({messageUseDataSource:null,actionUseDataSource:null,sqlExprObj:null,enabledDataRelationShip:!0})};var Et=l.ReactRedux.connect(e=>({dataSources:e.appStateInBuilder&&e.appStateInBuilder.appConfig&&e.appStateInBuilder.appConfig.dataSources,dataSourcesInfo:e.appStateInBuilder&&e.appStateInBuilder.dataSourcesInfo}))(l.themeUtils.withTheme(Tt)),Ut=function(e,t,i,o){return new(i||(i=Promise))((function(n,s){function a(e){try{p(o.next(e))}catch(e){s(e)}}function r(e){try{p(o.throw(e))}catch(e){s(e)}}function p(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};function kt(){return Ut(this,void 0,void 0,(function*(){return v.getInstance().registerActionRawSettingClass("filter-data-record-action",Mt),v.getInstance().registerActionRawSettingClass("select-data-record-action",Et),yield Promise.resolve({})}))}var Rt=i(6)},2:function(e,t){e.exports=i},3:function(e,t){e.exports=o},36:function(e,t){e.exports='<svg viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg"><path d="M1 0h3a1 1 0 011 1v1h6a1 1 0 011 1v8a1 1 0 01-1 1H1a1 1 0 01-1-1V1a1 1 0 011-1zm0 1v10h10V3H4V1H1zm0 3.5h10v1H1v-1z" fill="#000" fill-rule="nonzero"></path></svg>'},37:function(e,t){e.exports='<svg viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg"><path d="M7.42 8.839a.5.5 0 010 .71L6 10.966a3.502 3.502 0 01-4.967 0 3.501 3.501 0 010-4.966l1.416-1.422a.504.504 0 01.713.712L1.746 6.713a2.497 2.497 0 00-.003 3.545c.983.983 2.56.98 3.544-.003l1.42-1.42a.504.504 0 01.712.004zm1.415-2.132l1.422-1.416a2.5 2.5 0 000-3.547 2.502 2.502 0 00-3.547 0L5.29 3.163a.504.504 0 01-.713-.712l1.42-1.42a3.506 3.506 0 014.97.003 3.501 3.501 0 010 4.967L9.547 7.42a.504.504 0 01-.713-.712zm-4.967.71l3.548-3.548a.504.504 0 01.713.713L4.58 8.129a.504.504 0 01-.713-.712z" fill-rule="nonzero"></path></svg>'},38:function(e,t){e.exports='<svg viewBox="0 0 10 12" xmlns="http://www.w3.org/2000/svg"><path d="M1 0h8a1 1 0 011 1v10a1 1 0 01-1 1H1a1 1 0 01-1-1V1a1 1 0 011-1zm0 1v10h8V1H1zm2 2h4a.5.5 0 010 1H3a.5.5 0 010-1zm0 2.5h4a.5.5 0 010 1H3a.5.5 0 010-1z" fill="#000" fill-rule="nonzero"></path></svg>'},39:function(e,t){e.exports='<svg viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg"><path d="M11 0l.117.007A1 1 0 0112 1v7l-.007.117A1 1 0 0111 9H4l-4 3V1L.007.883A1 1 0 011 0h10zm0 1H1v9l2.667-2H11V1zM8.5 5a.5.5 0 010 1h-5a.5.5 0 010-1h5zm0-2a.5.5 0 010 1h-5a.5.5 0 010-1h5z" fill="#C5C5C5" fill-rule="nonzero"></path></svg>'},4:function(e,t){e.exports=n},40:function(e,t){e.exports='<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12 0a2 2 0 012 2v4h4a2 2 0 012 2v10a2 2 0 01-2 2H8a2 2 0 01-2-2v-4H2a2 2 0 01-2-2V2a2 2 0 012-2h10zm6 7h-4v5a2 2 0 01-2 2H7v4a1 1 0 001 1h10a1 1 0 001-1V8a1 1 0 00-1-1zm-6-6H2a1 1 0 00-1 1v10a1 1 0 001 1h4V8a2 2 0 012-2h5V2a1 1 0 00-1-1zm1 6H8a1 1 0 00-1 1v5h5a1 1 0 001-1V7z" fill="#000" fill-rule="nonzero"></path></svg>'},41:function(e){e.exports=JSON.parse('{"online":{"home":"#","get-started":{"prefix":"get-started/","what-is-arcgis-experience-builder":"what-is-arcgis-experience-builder.htm","whats-new":"whats-new.htm"},"build-apps":{"prefix":"build-apps/","add-a-page":"add-a-page.htm","add-a-dialog":"add-windows.htm","add-screen-groups":"add-screen-groups.htm","select-data":"select-data.htm"},"widgets":{"prefix":"configure-widgets/","overview":"widgets-overview.htm","table":"table-widget.htm","button":"button-widget.htm","bookmark":"bookmark-widget.htm","card":"card-widget.htm","chart":"chart-widget.htm","column":"column-widget.htm","coordinate-conversion":"coordinate-conversion-widget.htm","divider":"divider-widget.htm","embed":"embed-widget.htm","feature-info":"feature-info-widget.htm","filter":"filter-widget.htm","fixed":"fixed-panel-widget.htm","fly-controller":"fly-controller-widget.htm","image":"image-widget.htm","legend":"legend-widget.htm","list":"list-widget.htm","arcgis-map":"map-widget.htm","map-layers":"map-layers-widget.htm","branch-version-management":"branch-version-management-widget.htm","menu":"menu-widget.htm","placeholder":"placeholder-widget.htm","query":"query-widget.htm","row":"row-widget.htm","section":"section-widget.htm","share":"share-widget.htm","sidebar":"sidebar-widget.htm","survey123":"survey-widget.htm","text":"text-widget.htm","navigator":"view-navigation-widget.htm","controller":"widget-controller-widget.htm"}},"portal":{"home":"120001864","get-started":{"what-is-arcgis-experience-builder":"120001877","whats-new":"120002535"},"build-apps":{"add-a-page":"120001863","add-a-dialog":"120002539","add-screen-groups":"120002592","select-data":"120002590"},"widgets":{"overview":"#","table":"120002591","button":"120001841","bookmark":"120002536","card":"120002537","chart":"120002727","column":"120001842","coordinate-conversion":"120002728","divider":"120002538","embed":"120001843","feature-info":"120001844","filter":"120001845","fixed":"120001846","fly-controller":"120001847","image":"120001848","legend":"120001849","list":"120001850","arcgis-map":"120001851","map-layers":"120001852","branch-version-management":"120002654","menu":"120001853","placeholder":"120001854","query":"120002729","row":"120001855","section":"120001856","share":"120001857","sidebar":"120001858","survey123":"120001859","text":"120001860","navigator":"120001861","controller":"120001862"}},"dev":{"home":"#","get-started":{"prefix":"guide/","what-is-arcgis-experience-builder":"getting-started-widget","whats-new":"whats-new"},"build-apps":{"prefix":"guide/","add-a-page":"add-a-page","add-a-dialog":"add-windows","add-screen-groups":"add-screen-groups","select-data":"select-data"},"widgets":{"prefix":"guide/","overview":"widgets-overview","table":"table-widget","button":"button-widget","bookmark":"bookmark-widget","card":"card-widget","chart":"chart-widget","column":"column-widget","coordinate-conversion":"coordinate-conversion-widget","divider":"divider-widget","embed":"embed-widget","feature-info":"feature-info-widget","filter":"filter-widget","fixed":"fixed-panel-widget","fly-controller":"fly-controller-widget","image":"image-widget","legend":"legend-widget","list":"list-widget","arcgis-map":"map-widget","map-layers":"map-layers-widget","branch-version-management":"branch-version-management-widget","menu":"menu-widget","placeholder":"placeholder-widget","query":"query-widget","row":"row-widget","section":"section-widget","share":"share-widget","sidebar":"sidebar-widget","survey123":"survey-widget","text":"text-widget","navigator":"view-navigation-widget","controller":"widget-controller-widget"}}}')},5:function(e,t,i){"use strict";var o=i(0);class n extends o.React.PureComponent{}t.a=n},6:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var o=i(0),n=i(1),s=function(e,t,i,o){return new(i||(i=Promise))((function(n,s){function a(e){try{p(o.next(e))}catch(e){s(e)}}function r(e){try{p(o.throw(e))}catch(e){s(e)}}function p(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}p((o=o.apply(e,t||[])).next())}))};function a(){return s(this,void 0,void 0,(function*(){const e=Object(o.getAppStore)().getState().appContext.locale;return yield function(e,t){return s(this,void 0,void 0,(function*(){return(e=o.i18n.getLocaleToLoad(e,t))?yield o.i18n.loadLocaleMessages("jimu-for-builder/lib/translations",e).then(e=>e):Promise.resolve(n.a)}))}(e,o.translatedLocales).then(e=>(e&&Object(o.getAppStore)().dispatch(o.appActions.i18nMessagesLoaded("jimu-for-builder",e)),e))}))}}}))}}}));